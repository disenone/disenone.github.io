{
    "version": "https://jsonfeed.org/version/1",
    "title": "Disenone's Wiki",
    "home_page_url": "https://wiki.disenone.site/",
    "feed_url": "https://wiki.disenone.site/feed_json_created.json",
    "description": "\u65e0\u6b62\u5883",
    "icon": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/43/Feed-icon.svg/128px-Feed-icon.svg.png",
    "authors": [
        {
            "name": "Disenone"
        }
    ],
    "language": "zh",
    "items": [
        {
            "id": "https://wiki.disenone.site/en/blog/",
            "url": "https://wiki.disenone.site/en/blog/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Blog",
            "content_html": "<h1>Blog</h1>",
            "image": null,
            "date_published": "2024-04-17T18:34:58.980966+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/blog/",
            "url": "https://wiki.disenone.site/blog/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Blog",
            "content_html": "<h1>Blog</h1>",
            "image": null,
            "date_published": "2024-04-17T18:34:44.440717+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/ue-%E7%BC%96%E8%BE%91%E5%99%A8%E6%8F%92%E4%BB%B6-EditorPlus/",
            "url": "https://wiki.disenone.site/ue-%E7%BC%96%E8%BE%91%E5%99%A8%E6%8F%92%E4%BB%B6-EditorPlus/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "UE \u7f16\u8f91\u5668\u63d2\u4ef6 UE.EditorPlus \u8bf4\u660e\u6587\u6863",
            "content_html": "<p><meta property=\"og:title\" content=\"UE \u7f16\u8f91\u5668\u63d2\u4ef6 EditorPlus \u8bf4\u660e\u6587\u6863\" /></p>\n<h1>UE \u7f16\u8f91\u5668\u63d2\u4ef6 UE.EditorPlus \u8bf4\u660e\u6587\u6863</h1>\n<h2>\u4ecb\u7ecd\u89c6\u9891</h2>\n<p><img alt=\"type:video\" src=\"assets/img/2024-ue-editorplus/market/video.mp4\"></p>\n<h2>\u63d2\u4ef6\u6e90\u7801</h2>\n<p><a href=\"https://github.com/disenone/UE.EditorPlus\">UE.EditorPlus</a></p>\n<h2>\u9879\u76ee\u6dfb\u52a0\u6e90\u7801\u63d2\u4ef6 EU.EditorPlus</h2>\n<p>\u53c2\u8003\u6587\u6863\uff1a</p>\n<ul>\n<li>\u4e2d\u6587\uff1a<a href=\"https://wiki.disenone.site/ue-%E9%80%9A%E8%BF%87%E6%8F%92%E4%BB%B6%E6%BA%90%E7%A0%81%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6/\">UE \u901a\u8fc7\u63d2\u4ef6\u6e90\u7801\u6dfb\u52a0\u63d2\u4ef6</a></li>\n<li>English: <a href=\"https://wiki.disenone.site/en/ue-%E9%80%9A%E8%BF%87%E6%8F%92%E4%BB%B6%E6%BA%90%E7%A0%81%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6/\">UE adds plugins through the plugin source code</a></li>\n</ul>\n<h2>\u63d2\u4ef6\u8bf4\u660e</h2>\n<p>UE.EditorPlus \u662f\u4e00\u4e2a UE \u7f16\u8f91\u5668\u63d2\u4ef6\uff0c\u63d0\u4f9b\u4e86\u4e00\u79cd\u65b9\u4fbf\u7684\u65b9\u5f0f\u6765\u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355\uff0c\u5e76\u652f\u6301\u9ad8\u7ea7\u65b9\u5f0f\u6765\u6269\u5c55\uff0c\u540c\u65f6\u5305\u542b\u4e86\u4e00\u4e9b\u5b9e\u7528\u7684\u7f16\u8f91\u5668\u5de5\u5177\u3002\u672c\u63d2\u4ef6\u652f\u6301 UE5.3+\u3002</p>\n<h2>\u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355</h2>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/menu.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/toolbar.png\"></p>\n<h3>\u8bf4\u660e</h3>\n<p>\u652f\u6301\u591a\u79cd\u65b9\u5f0f\u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355\uff1a</p>\n<ul>\n<li>\u8def\u5f84\u65b9\u5f0f\uff1a<code>RegisterPathAction(\"/&lt;MenuBar&gt;Bar/&lt;SubMenu&gt;SubMenu/&lt;Command&gt;Action\")</code></li>\n<li>\u5b9e\u4f8b\u5316\u65b9\u5f0f\uff1a<code>EP_NEW_MENU(FEditorPlusMenuBar)(\"Bar\")</code></li>\n<li>\u6df7\u5408\u65b9\u5f0f\uff1a<code>RegisterPath(\"/&lt;MenuBar&gt;Bar/&lt;SubMenu&gt;SubMenu/&lt;Command&gt;Action\",EP_NEW_MENU(FEditorPlusCommand)(\"Action\")</code></li>\n</ul>\n<h3>\u8def\u5f84\u65b9\u5f0f</h3>\n<p>\u53ef\u4ee5\u901a\u8fc7\u8fd9\u6837\u7684\u65b9\u5f0f\u6765\u6ce8\u518c\u4e00\u4e2a\u7f16\u8f91\u5668\u83dc\u5355\u6307\u4ee4\uff1a</p>\n<p><code>cpp\nFEditorPlusPath::RegisterPathAction(\n    \"/&lt;MenuBar&gt;Bar/&lt;SubMenu&gt;SubMenu/&lt;Command&gt;Action\",\n    FExecuteAction::CreateLambda([]\n        {\n            // do action\n        })\n);</code></p>\n<p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u7f16\u8f91\u5668\u83dc\u5355\u680f Help \u540e\u9762\u589e\u52a0\u4e00\u4e2a\u83dc\u5355\u680f Bar\uff0cBar \u91cc\u9762\u589e\u52a0\u4e00\u4e2a\u5b50\u83dc\u5355 SubMenu\uff0c SubMenu \u91cc\u9762\u589e\u52a0\u4e00\u4e2a\u547d\u4ee4 Action\u3002</p>\n<p>\u5b8c\u6574\u7684\u8def\u5f84\u683c\u5f0f\u4f1a\u662f\u8fd9\u6837\u7684\uff1a<code>/&lt;Hook&gt;HookName/&lt;Type1&gt;Name1/&lt;Type2&gt;Name2</code>\uff0c\u7b2c\u4e00\u4e2a\u8def\u5f84\u5fc5\u987b\u662f <code>&lt;Hook&gt;</code>\uff0c\u76ee\u524d\u652f\u6301\u7684\u7c7b\u578b\u548c\u9650\u5236\uff1a</p>\n<ul>\n<li><code>&lt;Hook&gt;</code>\uff1a\u8868\u793a\u9700\u8981\u5728\u54ea\u4e2a Hook \u7684\u4f4d\u7f6e\u4e0a\u751f\u6210\u83dc\u5355\uff0c\u540e\u7eed\u8def\u5f84\u4e0d\u80fd\u6709 <code>&lt;Hook&gt;</code></li>\n<li><code>&lt;MenuBar&gt;</code>\uff1a\u83dc\u5355\u680f\uff0c\u540e\u9762\u8def\u5f84\u4e0d\u80fd\u6709 <code>&lt;Hook&gt;, &lt;MenuBar&gt;, &lt;ToolBar&gt;</code></li>\n<li><code>&lt;ToolBar&gt;</code>: \u5de5\u5177\u680f\uff0c\u540e\u9762\u8def\u5f84\u4e0d\u80fd\u6709 <code>&lt;Hook&gt;, &lt;MenuBar&gt;, &lt;ToolBar&gt;</code></li>\n<li><code>&lt;Section&gt;</code>\uff1a\u83dc\u5355\u5206\u8282\uff0c\u540e\u9762\u8def\u5f84\u4e0d\u80fd\u6709 <code>&lt;Hook&gt;, &lt;MenuBar&gt;, &lt;Section&gt;</code></li>\n<li><code>&lt;Separator&gt;</code>\uff1a\u83dc\u5355\u5206\u9694\u7b26\uff0c\u540e\u9762\u8def\u5f84\u4e0d\u80fd\u6709 <code>&lt;Hook&gt;, &lt;MenuBar&gt;</code></li>\n<li><code>&lt;SubMenu&gt;</code>\uff1a\u5b50\u83dc\u5355\uff0c\u540e\u9762\u8def\u5f84\u4e0d\u80fd\u6709 <code>&lt;Hook&gt;, &lt;MenuBar&gt;</code></li>\n<li><code>&lt;Command&gt;</code>\uff1a\u83dc\u5355\u547d\u4ee4\uff0c\u540e\u9762\u4e0d\u80fd\u6709\u4efb\u4f55\u8def\u5f84</li>\n<li><code>&lt;Widget&gt;</code>\uff1a\u66f4\u591a\u53ef\u6269\u5c55\u5b9a\u5236\u7684 Slate UI \u7ec4\u4ef6\uff0c\u540e\u9762\u4e0d\u80fd\u6709\u4efb\u4f55\u8def\u5f84</li>\n</ul>\n<p>\u66f4\u7b80\u6613\u7684\u8def\u5f84\u5f62\u5f0f\uff1a<code>/BarName/SubMenuName1/SubMenuName2/CommandName</code>\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u7c7b\u578b\uff0c\u9ed8\u8ba4\u8def\u5f84\u7684\u7b2c\u4e00\u4e2a\u662f <code>&lt;MenuBar&gt;</code>\uff0c\u4e2d\u95f4\u7684\u662f <code>&lt;SubMenu&gt;</code>\uff0c\u6700\u540e\u7684\u662f <code>&lt;Command&gt;</code>\u3002</p>\n<p>\u5982\u679c\u6ca1\u6709\u6307\u5b9a <code>&lt;Hook&gt;</code> \u5219\u81ea\u52a8\u6700\u524d\u9762\u52a0\u4e0a <code>&lt;Hook&gt;Help</code>\uff0c\u8868\u793a\u5728 Help \u83dc\u5355\u540e\u9762\u6dfb\u52a0\u83dc\u5355\u680f\u3002</p>\n<h3>\u5b9e\u4f8b\u5316\u65b9\u5f0f</h3>\n<p>\u8def\u5f84\u65b9\u5f0f\u662f\u81ea\u52a8\u628a\u6240\u6709\u8282\u70b9\u6839\u636e\u7c7b\u578b\u548c\u9ed8\u8ba4\u53c2\u6570\u5b9e\u4f8b\u5316\u51fa\u6765\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u81ea\u5df1\u63a7\u5236\u5b9e\u4f8b\u5316\uff0c\u53ef\u4ee5\u66f4\u7ec6\u81f4\u63a7\u5236\u6269\u5c55\u7684\u5185\u5bb9\u3002</p>\n<p><code>cpp\nEP_NEW_MENU(FEditorPlusMenuBar)(\"MyBar\", \"MyBar\", LOCTEXT(\"MyBar\", \"MyBar\"), LOCTEXT(\"MyBarTips\", \"MyBarTips\"))\n-&gt;RegisterPath()\n-&gt;Content({\n    EP_NEW_MENU(FEditorPlusSubMenu)(\"MySubMenu\")\n    -&gt;Content({\n        EP_NEW_MENU(FEditorPlusCommand)(\"MyAction\")\n        -&gt;BindAction(FExecuteAction::CreateLambda([]\n            {\n                // do action\n            })),\n    })\n});</code></p>\n<p>\u5b9e\u4f8b\u5316 <code>MyBar</code> \u7684\u65f6\u5019\u53ef\u4ee5\u4f20\u5165 Hook \u540d\u5b57\uff0c\u672c\u5730\u5316\u540d\u5b57\uff0c\u672c\u5730\u5316\u63d0\u793a\u53c2\u6570\uff08<code>\"MyBar\", LOCTEXT(\"MyBar\", \"MyBar\"), LOCTEXT(\"MyBarTips\", \"MyBarTips\")</code>\uff09\u3002\u4e0a\u9762\u4ee3\u7801\u5c31\u76f8\u5f53\u4e8e\u8def\u5f84\u65b9\u5f0f <code>/&lt;Hook&gt;Help/&lt;MenuBar&gt;MyBar/&lt;SubMenu&gt;MySubMenu/&lt;Command&gt;MyAction</code>\u3002</p>\n<h3>\u6df7\u5408\u65b9\u5f0f</h3>\n<p>\u5f53\u7136\u8fd8\u53ef\u4ee5\u4e24\u79cd\u65b9\u5f0f\u6df7\u5408\u4f7f\u7528\uff1a</p>\n<p><code>cpp\nFEditorPlusPath::RegisterPath(\n    \"/&lt;MenuBar&gt;Bar/&lt;SubMenu&gt;SubMenu/&lt;Command&gt;Action\",\n    EP_NEW_MENU(FEditorPlusCommand)(\"Action\")\n    -&gt;BindAction(FExecuteAction::CreateLambda([]\n        {\n            // do action\n        })),\n);</code></p>\n<p>\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u63d2\u4ef6\u4f1a\u81ea\u52a8\u5b9e\u4f8b\u5316\u4e2d\u95f4\u8def\u5f84\u7684\u8282\u70b9\uff0c\u6700\u540e\u7684\u8def\u5f84\u4f7f\u7528\u7528\u6237\u81ea\u5df1\u5b9e\u4f8b\u5316\u7684\u8282\u70b9\u3002</p>\n<h3>\u66f4\u591a\u7528\u4f8b</h3>\n<p>\u5934\u6587\u4ef6:</p>\n<p>```cpp</p>\n<h1>include <EditorPlusPath.h></h1>\n<p>```</p>\n<p>\u8def\u5f84\u65b9\u5f0f\u6307\u5b9a\u672c\u5730\u5316\u8bed\u8a00\uff0c<code>EP_FNAME_HOOK_AUTO</code> \u8868\u793a\u81ea\u52a8\u4f7f\u7528\u8def\u5f84\u540d\u5b57\u4f5c\u4e3a <code>Hook</code> \u540d\u5b57\uff1a</p>\n<p><code>cpp\nFEditorPlusPath::RegisterPathAction(\n        \"/Bar/Action\",\n        FExecuteAction::CreateLambda([]\n        {\n            // do action\n        }),\n        EP_FNAME_HOOK_AUTO,\n        LOCTEXT(\"Action\", \"Action\"),\n        LOCTEXT(\"ActionTips\", \"ActionTips\"));</code></p>\n<p>\u901a\u8fc7\u8def\u5f84\u83b7\u53d6\u8282\u70b9\u5e76\u8bbe\u7f6e\u672c\u5730\u5316\u6587\u672c\uff1a</p>\n<p><code>cpp\nFEditorPlusPath::GetNodeByPath(\"/MenuTest\")\n    -&gt;SetFriendlyName(LOCTEXT(\"MenuTest\", \"MenuTest\"))\n    -&gt;SetFriendlyTips(LOCTEXT(\"MenuTestTips\", \"MenuTestTips\"));</code></p>\n<p>\u8def\u5f84\u672b\u7aef\u6dfb\u52a0\u4e00\u4e2a Slate UI \u63a7\u4ef6</p>\n<p><code>cpp\nFEditorPlusPath::RegisterPath(\n    \"/&lt;MenuBar&gt;Bar/&lt;SubMenu&gt;SubMenu/&lt;Widget&gt;Widget\",\n    EP_NEW_MENU(FEditorPlusWidget)(\"Widget\", LOCTEXT(\"Widget\", \"Widget\"))\n        -&gt;BindWidget(SNew(SHorizontalBox)));\n);</code></p>\n<p>\u5728 UE \u81ea\u5e26\u7684 Hook \u91cc\u9762\u6dfb\u52a0\u65b0\u7684\u8282\u70b9</p>\n<p><code>cpp\nFEditorPlusPath::RegisterPath(\"&lt;Hook&gt;EpicGamesHelp/&lt;Separator&gt;ExtendSeparator\")</code></p>\n<p>\u591a\u6b21\u58f0\u660e\u76f8\u540c\u7684\u8def\u5f84\uff0c\u90fd\u88ab\u8bc6\u522b\u6210\u540c\u4e00\u4e2a\u8def\u5f84\uff0c\u56e0\u6b64\u53ef\u4ee5\u4e0d\u65ad\u6269\u5c55\u76f8\u540c\u7684\u8def\u5f84</p>\n<p><code>cpp\nFEditorPlusPath::RegisterPathAction(\"/MenuTest/SubMenu1/SubMenu1/Path1\", Action, EP_FNAME_HOOK_AUTO, LOCTEXT(\"Path1\", \"Path1\"), LOCTEXT(\"Path1Tips\", \"Path1Tips\"));\nFEditorPlusPath::RegisterPathAction(\"/MenuTest/SubMenu1/SubMenu1/Path2\", Action, EP_FNAME_HOOK_AUTO, LOCTEXT(\"Path2\", \"Path2\"), LOCTEXT(\"Path2Tips\", \"Path2Tips\"));</code></p>\n<p>\u4e3a\u4e00\u4e2a\u8282\u70b9\u7ee7\u7eed\u6269\u5c55\u8def\u5f84</p>\n<p><code>cpp\nauto node = FEditorPlusPath::GetNodeByPath(\"/MenuTest\");\nFEditorPlusPath::RegisterChildPath(node, \"&lt;SubMenu&gt;Sub/&lt;Separator&gt;Sep\");</code></p>\n<p>\u5220\u9664\u4e00\u4e2a\u8def\u5f84</p>\n<p><code>cpp\nFEditorPlusPath::UnregisterPath(\"/MenuTest/SubMenu1/SubMenu1/Path1\");</code></p>\n<p>\u6269\u5c55\u5de5\u5177\u680f\n<code>cpp\nFEditorPlusPath::RegisterPath(\"/&lt;Hook&gt;ProjectSettings/&lt;ToolBar&gt;MenuTestToolBar\")\n-&gt;Content({\n    EP_NEW_MENU(FEditorPlusCommand)(\"ToolBarCommand1\")\n    -&gt;BindAction(...)\n});</code></p>\n<h3>\u63a5\u53e3\u8bf4\u660e</h3>\n<p>```cpp\nclass EDITORPLUS_API FEditorPlusPath\n{\npublic:</p>\n<pre><code>static TSharedPtr&lt;FEditorPlusMenuBase&gt; RegisterPath(const FString&amp; Path, const TSharedPtr&lt;FEditorPlusMenuBase&gt;&amp; Menu=nullptr);\nstatic TSharedPtr&lt;FEditorPlusMenuBase&gt; RegisterPath(const FString&amp; Path, const FText&amp; FriendlyName, const FText&amp; FriendlyTips);\nstatic TSharedPtr&lt;FEditorPlusMenuBase&gt; RegisterPathAction(\n    const FString&amp; Path, const FExecuteAction&amp; ExecuteAction, const FName&amp; Hook=EP_FNAME_HOOK_AUTO,\n    const FText&amp; FriendlyName=FText::GetEmpty(), const FText&amp; FriendlyTips=FText::GetEmpty());\n\nstatic TSharedPtr&lt;FEditorPlusMenuBase&gt; RegisterChildPath(\n    const TSharedRef&lt;FEditorPlusMenuBase&gt;&amp; InParent, const FString&amp; Path, const TSharedPtr&lt;FEditorPlusMenuBase&gt;&amp; Menu=nullptr);\nstatic TSharedPtr&lt;FEditorPlusMenuBase&gt; RegisterChildPath(\n    const TSharedRef&lt;FEditorPlusMenuBase&gt;&amp; InParent, const FString&amp; Path, const FText&amp; FriendlyName, const FText&amp; FriendlyTips);\nstatic TSharedPtr&lt;FEditorPlusMenuBase&gt; RegisterChildPathAction(\n    const TSharedRef&lt;FEditorPlusMenuBase&gt;&amp; InParent, const FString&amp; Path, const FExecuteAction&amp; ExecuteAction,\n    const FName&amp; Hook=EP_FNAME_HOOK_AUTO, const FText&amp; FriendlyName=FText::GetEmpty(), const FText&amp; FriendlyTips=FText::GetEmpty());\n\nstatic bool UnregisterPath(\n    const FString&amp; Path, const TSharedPtr&lt;FEditorPlusMenuBase&gt;&amp; Leaf=nullptr);\n\nstatic TSharedPtr&lt;FEditorPlusMenuBase&gt; GetNodeByPath(const FString&amp; Path);\n</code></pre>\n<p>};\n```</p>\n<ul>\n<li><code>RegisterPath</code>\uff1a\u751f\u6210\u8def\u5f84\u83dc\u5355</li>\n<li><code>RegisterPathAction</code>\uff1a\u751f\u6210\u8def\u5f84\u83dc\u5355\uff0c\u5e76\u81ea\u52a8\u4e3a\u672b\u7aef <code>&lt;Command&gt;</code> \u8282\u70b9\u7ed1\u5b9a\u64cd\u4f5c</li>\n<li><code>RegisterChildPath</code>\uff1a\u4e3a\u6307\u5b9a\u8282\u70b9\u7ee7\u7eed\u751f\u6210\u5b50\u8def\u5f84</li>\n<li><code>RegisterChildPathAction</code>\uff1a\u4e3a\u6307\u5b9a\u8282\u70b9\u7ee7\u7eed\u751f\u6210\u5b50\u8def\u5f84\uff0c\u5e76\u81ea\u52a8\u7ed1\u5b9a\u64cd\u4f5c</li>\n<li><code>UnregisterPath</code>\uff1a\u5220\u9664\u8def\u5f84\uff0c<code>Leaf</code> \u5728\u6709\u591a\u4e2a\u540c\u540d\u7684\u672b\u7aef\u8282\u70b9\u53ef\u4ee5\u6307\u5b9a\u4e25\u683c\u5339\u914d\u3002\u5220\u9664\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u56de\u6eaf\u4e2d\u95f4\u8282\u70b9\uff0c\u4e00\u65e6\u4e2d\u95f4\u8282\u70b9\u6ca1\u6709\u4efb\u4f55\u5b50\u8282\u70b9\u4e5f\u4f1a\u88ab\u5220\u9664</li>\n<li><code>GetNodeByPath</code>\uff1a\u6839\u636e\u8def\u5f84\u83b7\u53d6\u8282\u70b9</li>\n</ul>\n<p>\u8282\u70b9\u7c7b\u578b</p>\n<p>```cpp\n// base class of all node\nclass EDITORPLUS_API FEditorPlusMenuBase: public TSharedFromThis<FEditorPlusMenuBase> {}</p>\n<p>class EDITORPLUS_API FEditorPlusHook: public TEditorPlusMenuBaseRoot {}</p>\n<p>class EDITORPLUS_API FEditorPlusMenuBar: public TEditorPlusMenuBaseNode {}</p>\n<p>class EDITORPLUS_API FEditorPlusToolBar: public TEditorPlusMenuBaseNode {}</p>\n<p>class EDITORPLUS_API FEditorPlusSection: public TEditorPlusMenuBaseNode {}</p>\n<p>class EDITORPLUS_API FEditorPlusSeparator: public TEditorPlusMenuBaseNode{}</p>\n<p>class EDITORPLUS_API FEditorPlusSubMenu: public TEditorPlusMenuBaseNode {}</p>\n<p>class EDITORPLUS_API FEditorPlusCommand: public TEditorPlusMenuBaseLeaf {}</p>\n<p>class EDITORPLUS_API FEditorPlusWidget: public TEditorPlusMenuBaseLeaf {}\n```</p>\n<p>\u66f4\u591a\u6837\u4f8b\u548c\u63a5\u53e3\u8bf4\u660e\u8bf7\u53c2\u8003\u6e90\u7801 <a href=\"https://github.com/disenone/UE.EditorPlus\">UE.EditorPlus</a>\uff0c\u6d4b\u8bd5\u7528\u4f8b <a href=\"https://github.com/disenone/UE.EditorPlus/blob/ue5.3/Source/EditorPlusTools/Private/MenuTest/MenuTest.cpp\">MenuTest.cpp</a></p>\n<h3>\u6a21\u5757\u5316\u7ba1\u7406</h3>\n<p>UE.EditorPlus \u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6a21\u5757\u5316\u7ba1\u7406\u6269\u5c55\u83dc\u5355\u7684\u6846\u67b6\uff0c\u652f\u6301\u63d2\u4ef6\u52a0\u8f7d\u548c\u5378\u8f7d\u7684\u65f6\u5019\uff0c\u81ea\u52a8\u52a0\u8f7d\u548c\u5378\u8f7d\u6269\u5c55\u7684\u83dc\u5355</p>\n<p>\u8ba9\u83dc\u5355\u7c7b\u7ee7\u627f <code>IEditorPlusToolInterface</code>\uff0c\u5e76\u8986\u5199 <code>OnStartup</code> \u548c <code>OnShutdown</code> \u51fd\u6570\u3002<code>OnStartup</code> \u8d1f\u8d23\u521b\u5efa\u83dc\u5355\uff0c<code>OnShutdown</code> \u8d1f\u8d23\u8c03\u7528\u8282\u70b9\u7684 <code>Destroy</code> \u51fd\u6570\u6e05\u7406\u83dc\u5355\u3002\u5355\u8282\u70b9\u7684\u5f15\u7528\u6570\u5f520\uff0c\u5219\u4f1a\u6267\u884c\u81ea\u52a8\u6e05\u7406\u3002</p>\n<p>```cpp\nclass FMenuTest: public IEditorPlusToolInterface\n{\npublic:\n    virtual void OnStartup() override;\n    virtual void OnShutdown() override;\n}</p>\n<p>void FMenuTest::OnStartup()\n{\n    BuildPathMenu();\n    BuildCustomMenu();\n    BuildMixMenu();\n    BuildExtendMenu();\n}</p>\n<p>void FMenuTest::OnShutdown()\n{\n    for(auto Menu: Menus)\n    {\n        if(Menu.IsValid()) Menu-&gt;Destroy();\n    }\n    Menus.Empty();\n}\n```</p>\n<p>\u83dc\u5355\u7ba1\u7406\u7c7b\u7ee7\u627f <code>IEditorPlusToolManagerInterface</code>\uff0c\u5e76\u8986\u5199 <code>AddTools</code> \u51fd\u6570\uff0c\u5728 <code>AddTools</code> \u91cc\u9762\u6dfb\u52a0\u83dc\u5355\u7c7b</p>\n<p>```cpp\nclass FEditorPlusToolsImpl: public IEditorPlusToolManagerInterface\n{\npublic:\n    virtual void AddTools() override;\n}</p>\n<p>void FEditorPlusToolsImpl::AddTools()\n{\n    if (!Tools.Num())\n    {\n        Tools.Emplace(MakeShared<FMenuTest>());\n    }</p>\n<p>}\n```</p>\n<p>\u63d2\u4ef6\u52a0\u8f7d\u548c\u5378\u8f7d\u7684\u65f6\u5019\u5206\u522b\u8c03\u7528\u7ba1\u7406\u7c7b\u7684 <code>StartupTools</code> \u548c <code>ShutdownTools</code> \u51fd\u6570</p>\n<p>```cpp\nvoid FEditorPlusToolsModule::StartupModule()\n{\n    Impl = FEditorPlusToolsImpl::Get();\n    Impl-&gt;StartupTools();</p>\n<p>}\nvoid FEditorPlusToolsModule::ShutdownModule()\n{\n    Impl-&gt;ShutdownTools();\n}\n```</p>\n<p>\u5b8c\u6210\u4ee5\u4e0a\u9002\u914d\uff0c\u5219\u53ef\u4ee5\u81ea\u52a8\u5728\u52a0\u8f7d\u548c\u5378\u8f7d\u63d2\u4ef6\u7684\u65f6\u5019\uff0c\u81ea\u52a8\u52a0\u8f7d\u548c\u5378\u8f7d\u6269\u5c55\u7684\u83dc\u5355\u3002</p>\n<h2>\u7f16\u8f91\u5668\u5de5\u5177</h2>\n<p>UE.EditorPlus \u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5b9e\u7528\u7684\u7f16\u8f91\u5668\u5de5\u5177</p>\n<h2>\u521b\u5efa\u7f16\u8f91\u5668\u7a97\u53e3</h2>\n<p>\u4f7f\u7528 EditorPlus\uff0c\u53ef\u4ee5\u5f88\u7b80\u5355\u7684\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7f16\u8f91\u5668\u7a97\u53e3</p>\n<p>```cpp\n// register spawn tab\nTab = MakeShared<FEditorPlusTab>(LOCTEXT(\"ClassBrowser\", \"ClassBrowser\"), LOCTEXT(\"ClassBrowserTip\", \"Open the ClassBrowser\"));\nTab-&gt;Register<SClassBrowserTab>();</p>\n<p>// register menu action to spawn tab\nFEditorPlusPath::RegisterPathAction(\n    \"/EditorPlusTools/ClassBrowser\",\n    FExecuteAction::CreateSP(Tab.ToSharedRef(), &amp;FEditorPlusTab::TryInvokeTab),\n);\n```</p>\n<p><code>SClassBrowserTab</code> \u662f\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684 UI \u63a7\u4ef6</p>\n<p><code>cpp\nclass SClassBrowserTab final : public SCompoundWidget\n{\n    SLATE_BEGIN_ARGS(SClassBrowserTab)\n    {}\n    SLATE_END_ARGS()\n    // ...\n}</code></p>\n<h3>ClassBrowser</h3>\n<p>ClassBrowser \u662f\u4e00\u4e2a UE Class \u67e5\u770b\u5668\uff0c\u901a\u8fc7\u83dc\u5355 EditorPlusTools -&gt; ClassBrowser \u6765\u6253\u5f00</p>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/classbrowser_menu.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/classbrowser.png\"></p>\n<p>\u57fa\u4e8e UE \u7684\u53cd\u5c04\u6765\u5b9e\u73b0\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u67e5\u770b UE \u5404\u79cd\u7c7b\u578b\u7684\u6210\u5458\u4fe1\u606f\uff0c\u8bf4\u660e\u63d0\u793a\u7b49\uff0c\u652f\u6301\u6a21\u7cca\u641c\u7d22\uff0c\u5e76\u80fd\u8df3\u8f6c\u6253\u5f00\u7236\u7c7b\u7684\u4fe1\u606f\u3002</p>\n<h3>MenuCollections</h3>\n<p>MenuCollections \u662f\u4e00\u4e2a\u83dc\u5355\u547d\u4ee4\u5feb\u901f\u67e5\u627e\u548c\u6536\u85cf\u5de5\u5177\uff0c\u80fd\u591f\u5e2e\u52a9\u4f60\u5feb\u901f\u627e\u5230\u9700\u8981\u6267\u884c\u7684\u83dc\u5355\u547d\u4ee4\uff0c\u5e76\u53ef\u4ee5\u6536\u85cf\u5e38\u7528\u547d\u4ee4\uff0c\u63d0\u5347\u6548\u7387\u3002</p>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/menucollection_find.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/menucollection_star.png\"></p>\n<h3>SlateResourceBrowser</h3>\n<p>SlateResourceBrowser \u662f\u4e00\u4e2a\u53ef\u4ee5\u5feb\u901f\u67e5\u770b Slate UI \u8d44\u6e90\u7684\u5de5\u5177\uff0c\u80fd\u591f\u5e2e\u52a9\u4f60\u6d4f\u89c8\u548c\u67e5\u627e\u9700\u8981\u7684\u7f16\u8f91\u5668\u8d44\u6e90\uff0c\u65b9\u4fbf\u6269\u5c55\u7f16\u8f91\u5668\u3002</p>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/slateresourcebrowser_color.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/slateresourcebrowser_icon.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/slateresourcebrowser_font.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2024-ue-editorplus/slateresourcebrowser_widgetstyle.png\"></p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2024-01-13T03:55:10+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/py-Python%E6%9D%82%E8%B0%882-Python312-%E7%83%AD%E6%9B%B4%E6%96%B0/",
            "url": "https://wiki.disenone.site/py-Python%E6%9D%82%E8%B0%882-Python312-%E7%83%AD%E6%9B%B4%E6%96%B0/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Python \u6742\u8c08 2 - Python3.12 \u70ed\u66f4\u65b0",
            "content_html": "<p><meta property=\"og:title\" content=\"Python \u6742\u8c08 2 - Python3.12 \u70ed\u66f4\u65b0\" /></p>\n<h1>Python \u6742\u8c08 2 - Python3.12 \u70ed\u66f4\u65b0</h1>\n<blockquote>\n<p>\u8bb0\u5f55\u5982\u4f55\u5728 Python3.12 \u4e2d\u5b9e\u73b0\u70ed\u66f4\u65b0</p>\n</blockquote>\n<h2>\u70ed\u66f4\u65b0</h2>\n<p>\u70ed\u66f4\u65b0\uff08Hot Reload\uff09\u53ef\u4ee5\u7406\u89e3\u5728\u4e0d\u9700\u8981\u91cd\u542f\u7a0b\u5e8f\u7684\u60c5\u51b5\u4e0b\u5bf9\u5176\u8fdb\u884c\u66f4\u65b0\u7684\u6280\u672f\u3002\u8fd9\u9879\u6280\u672f\u5728\u6e38\u620f\u884c\u4e1a\u6709\u5e7f\u6cdb\u7684\u5e94\u7528\uff0c\u5f00\u53d1\u8005\u5bf9\u6e38\u620f\u95ee\u9898\u8fdb\u884c\u4fee\u590d\u7684\u65f6\u5019\uff0c\u4e3a\u4e86\u4e0d\u5bf9\u73a9\u5bb6\u9020\u6210\u5f71\u54cd\uff0c\u5f80\u5f80\u9700\u8981\u91c7\u7528\u4e00\u4e9b\u9759\u9ed8\u66f4\u65b0\u7684\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u70ed\u66f4\u65b0\u3002</p>\n<h2>Python \u70ed\u66f4\u65b0</h2>\n<p>Python \u672c\u8eab\u662f\u52a8\u6001\u8bed\u8a00\uff0c\u4e00\u5207\u7686\u662f\u5bf9\u8c61\uff0c\u662f\u6709\u80fd\u529b\u505a\u5230\u70ed\u66f4\u65b0\u7684\u3002\u6211\u4eec\u53ef\u4ee5\u7c97\u7565\u628a Python \u4e2d\u7684\u9700\u8981\u70ed\u66f4\u7684\u5bf9\u8c61\u5206\u6210\u4e24\u79cd\uff1a\u6570\u636e \u548c \u51fd\u6570\u3002</p>\n<p>\u6570\u636e\uff0c\u53ef\u4ee5\u7406\u89e3\u6210\u6e38\u620f\u4e2d\u7684\u6570\u503c\u6216\u8005\u8bbe\u5b9a\uff0c\u8b6c\u5982\u73a9\u5bb6\u7684\u7b49\u7ea7\uff0c\u88c5\u5907\u7b49\u7b49\u4e00\u4e9b\u6570\u636e\uff0c\u90e8\u5206\u6570\u636e\u662f\u4e0d\u5e94\u8be5\u70ed\u66f4\u7684\uff08\u8b6c\u5982\u73a9\u5bb6\u5f53\u524d\u7b49\u7ea7\uff0c\u73a9\u5bb6\u8eab\u4e0a\u62e5\u6709\u54ea\u4e9b\u88c5\u5907\uff0c\u8fd9\u4e9b\u6570\u636e\u7684\u4fee\u6539\u4e0d\u5e94\u8be5\u901a\u8fc7\u70ed\u66f4\u6765\u5b9e\u73b0\uff09\uff0c\u90e8\u5206\u6570\u636e\u662f\u6211\u4eec\u60f3\u8981\u70ed\u66f4\u7684\uff08\u8b6c\u5982\u88c5\u5907\u7684\u57fa\u7840\u6570\u503c\u8bbe\u5b9a\uff0c\u6280\u80fd\u7684\u57fa\u7840\u6570\u503c\u8bbe\u5b9a\uff0cUI \u4e0a\u7684\u6587\u5b57\u7b49\u7b49\uff09\u3002</p>\n<p>\u51fd\u6570\uff0c\u53ef\u4ee5\u7406\u89e3\u6210\u6e38\u620f\u903b\u8f91\uff0c\u8fd9\u57fa\u672c\u90fd\u662f\u6211\u4eec\u60f3\u8981\u70ed\u66f4\u7684\uff0c\u903b\u8f91\u9519\u8bef\u57fa\u672c\u90fd\u9700\u8981\u901a\u8fc7\u70ed\u66f4\u65b0\u51fd\u6570\u6765\u5b9e\u73b0\u3002</p>\n<p>\u4e0b\u9762\u6211\u4eec\u6765\u5177\u4f53\u770b\u770b\u6709\u4ec0\u4e48\u65b9\u6cd5\u53ef\u4ee5\u5bf9 Python3.12 \u6267\u884c\u70ed\u66f4\u65b0\u3002</p>\n<h2>Hotfix</h2>\n<p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u6211\u4eec\u53eb\u505a Hotfix\uff0c\u901a\u8fc7\u8ba9\u7a0b\u5e8f\uff08\u5ba2\u6237\u7aef\u7a0b\u5e8f / \u670d\u52a1\u7aef\u7a0b\u5e8f\u90fd\u53ef\u4ee5\uff09\u6267\u884c\u4e00\u6bb5\u7279\u5b9a\u7684 Python \u4ee3\u7801\uff0c\u5b9e\u73b0\u5bf9\u6570\u636e\u548c\u51fd\u6570\u7684\u70ed\u66f4\u65b0\u3002\u4e00\u6bb5\u7b80\u5355\u7684 Hotfix \u4ee3\u7801\u53ef\u80fd\u662f\u8fd9\u6837\uff1a</p>\n<p>```python</p>\n<h1>hotfix code</h1>\n<h1>hotfix data</h1>\n<p>import weapon_data\nweapon_data.gun.damage = 100</p>\n<h1>hotfix func</h1>\n<p>import player\ndef new_fire_func(self, target):\n    target.health -= weapon_data.gun.damage\n    # ...\nplayer.Player.fire_func = new_fire_func\n```</p>\n<p>\u4ee5\u4e0a\u4ee3\u7801\u7b80\u5355\u5c55\u793a Hotfix \u7684\u5199\u6cd5\uff0c\u6570\u636e / \u51fd\u6570\u4fee\u6539\u4e4b\u540e\uff0c\u7a0b\u5e8f\u540e\u7eed\u8bbf\u95ee\u7684\u65f6\u5019\u5c31\u4f1a\u8bfb\u5230\u65b0\u7684\u6570\u636e / \u51fd\u6570\u6765\u6267\u884c\u3002</p>\n<p>\u5982\u679c\u4f60\u6bd4\u8f83\u7ec6\u81f4\uff0c\u4f60\u53ef\u80fd\u4f1a\u6709\u4e00\u4e2a\u7591\u95ee\uff1a\u90a3\u5982\u679c\u5176\u4ed6\u4ee3\u7801\u91cc\u9762\u5f15\u7528\u4f4f\u4e86\u8fd9\u4e9b\u9700\u8981\u4fee\u6539\u6570\u636e\u548c\u51fd\u6570\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\u4e8b\u60c5\uff1f</p>\n<p>```python</p>\n<h1>attack.py module</h1>\n<p>player_fire = player.Player.fire_func</p>\n<p>def player_attack_by_gun(player, target):\n    player_fire(player, target)\n    # ...\n```</p>\n<p>\u7b54\u6848\u662f\uff0c\u524d\u9762\u7684 Hotfix \u5bf9\u8fd9\u79cd\u60c5\u51b5\u662f\u4e0d\u751f\u6548\u7684\uff0c<code>fire_func</code> \u8fd9\u4e2a\u51fd\u6570\u76f8\u5f53\u4e8e\u5728\u5176\u4ed6\u6a21\u5757\u591a\u4e86\u4e00\u4efd\u526f\u672c\uff0c\u8be5\u6a21\u5757\u4e2d\u8c03\u7528\u7684\u662f\u51fd\u6570\u7684\u526f\u672c\uff0c\u6211\u4eec\u4fee\u6539\u51fd\u6570\u672c\u4f53\u5bf9\u526f\u672c\u4e0d\u751f\u6548\u3002</p>\n<p>\u6240\u4ee5\u9700\u8981\u6ce8\u610f\uff0c\u4e00\u822c\u4ee3\u7801\u4e2d\u5c3d\u91cf\u51cf\u5c11\u6a21\u5757\u7ea7\u522b\u7684\u6570\u636e\u5f15\u7528\u548c\u51fd\u6570\u5f15\u7528\uff0c\u907f\u514d\u51fa\u73b0\u8fd9\u79cd Hotfix \u4e0d\u751f\u6548\u7684\u60c5\u51b5\uff0c\u5982\u679c\u4ee3\u7801\u5df2\u7ecf\u662f\u8fd9\u6837\u5199\u7684\uff0cHotfix \u9700\u8981\u591a\u505a\u4e00\u4e9b\u5de5\u4f5c\uff1a</p>\n<p>```python</p>\n<h1>hotfix code</h1>\n<h1>...</h1>\n<p>import attack\nattack.player_fire = player.Player.fire_func</p>\n<p>```</p>\n<p>\u5728\u5bf9\u6570\u636e / \u51fd\u6570\u672c\u4f53 Hotfix \u4fee\u6539\u4e4b\u540e\uff0c\u518d\u989d\u5916\u5bf9\u5f15\u7528\u7684\u5730\u65b9\u8fdb\u884c\u4fee\u6539\u3002\u8fd9\u4e9b\u989d\u5916\u7684\u4fee\u6539\u5f88\u5bb9\u6613\u88ab\u9057\u6f0f\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u662f\u5efa\u8bae\uff0c\u4ece\u4ee3\u7801\u89c4\u8303\u4e0a\u6765\u5c3d\u91cf\u907f\u514d\u591a\u5904\u5f15\u7528\u7684\u5199\u6cd5\u3002</p>\n<p>\u7efc\u4e0a\uff0cHotfix \u80fd\u6ee1\u8db3\u70ed\u66f4\u7684\u57fa\u672c\u9700\u6c42\uff0c\u540c\u65f6\u5b58\u5728\u4ee5\u4e0b\u95ee\u9898\uff1a</p>\n<ul>\n<li>\u5982\u679c\u6570\u636e/\u51fd\u6570\u88ab\u5176\u4ed6\u6a21\u5757\u660e\u786e\u5f15\u7528\u4f4f\uff0c\u9700\u8981\u989d\u5916\u5bf9\u8fd9\u4e9b\u6a21\u5757\u7684\u5f15\u7528 Hotfix</li>\n<li>\u5982\u679c\u6709\u5927\u91cf\u7684\u6570\u636e/\u51fd\u6570\u9700\u8981 Hotfix\uff0c\u90a3\u4e48 Hotfix \u7684\u4ee3\u7801\u4f1a\u53d8\u5f97\u5f88\u5e9e\u5927\uff0c\u7ef4\u62a4\u96be\u5ea6\u4e0a\u5347\uff0c\u4e5f\u66f4\u5bb9\u6613\u51fa\u9519</li>\n</ul>\n<h2>Reload</h2>\n<p>\u672c\u7ae0\u8282\u6e90\u7801\u53ef\u4ece\u8fd9\u91cc\u83b7\u5f97\uff1a<a href=\"https://github.com/disenone/python_reloader\">python_reloader</a></p>\n<p>\u6211\u4eec\u66f4\u60f3\u8981\u7684\u662f\u81ea\u52a8\u70ed\u66f4\u65b0\uff0c\u4e0d\u9700\u8981\u989d\u5916\u5199 Hotfix\uff0c\u53ea\u9700\u8981\u66f4\u65b0\u4ee3\u7801\u6587\u4ef6\uff0c\u8ba9\u7a0b\u5e8f\u6267\u884c\u4e00\u4e2a Reload \u51fd\u6570\u5219\u4f1a\u81ea\u52a8\u66ff\u6362\u65b0\u7684\u51fd\u6570\u548c\u65b0\u7684\u6570\u636e\u3002\u6211\u4eec\u628a\u8fd9\u4e2a\u81ea\u52a8\u70ed\u66f4\u65b0\u7684\u529f\u80fd\u53eb\u505a Reload\u3002</p>\n<p>Python3.12 \u63d0\u4f9b\u4e86 importlib.reload \u51fd\u6570\uff0c\u53ef\u4ee5\u91cd\u65b0\u52a0\u8f7d\u6a21\u5757\uff0c\u4f46\u662f\u5374\u662f\u5168\u91cf\u52a0\u8f7d\uff0c\u5e76\u4e14\u8fd4\u56de\u65b0\u7684\u6a21\u5757\u5bf9\u8c61\uff0c\u5bf9\u4e8e\u5176\u4ed6\u6a21\u5757\u4e2d\u7684\u5f15\u7528\uff0c\u5e76\u4e0d\u80fd\u81ea\u52a8\u4fee\u6539\uff0c\u4e5f\u5c31\u662f\u5176\u4ed6\u6a21\u5757\u5982\u679c import \u4e86 reload \u7684\u6a21\u5757\uff0c\u90a3\u4e48\u8bbf\u95ee\u7684\u4f9d\u7136\u662f\u65e7\u7684\u6a21\u5757\u5bf9\u8c61\u3002\u8fd9\u4e2a\u529f\u80fd\u6bd4\u6211\u4eec\u7684 Hotfix \u597d\u4e0d\u4e86\u591a\u5c11\uff0c\u66f4\u4f55\u51b5\u662f\u5168\u91cf reload \u6a21\u5757\uff0c\u4e0d\u80fd\u7531\u6211\u4eec\u63a7\u5236\u54ea\u4e9b\u6570\u636e\u5e94\u8be5\u4fdd\u7559\u3002\u6211\u4eec\u60f3\u8981\u81ea\u5df1\u5b9e\u73b0\u4e00\u4e2a Reload \u529f\u80fd\uff0c\u6ee1\u8db3\u8fd9\u4e9b\u8981\u6c42\uff1a</p>\n<ul>\n<li>\u81ea\u52a8\u66ff\u6362\u51fd\u6570\uff0c\u540c\u65f6\u65e7\u51fd\u6570\u7684\u5f15\u7528\u4f9d\u7136\u6709\u6548\uff0c\u5e76\u4f1a\u6267\u884c\u65b0\u51fd\u6570\u7684\u5185\u5bb9</li>\n<li>\u81ea\u52a8\u66ff\u6362\u6570\u636e\uff0c\u540c\u65f6\u53ef\u63a7\u5236\u90e8\u5206\u66ff\u6362</li>\n<li>\u4fdd\u7559\u65e7\u6a21\u5757\u7684\u5f15\u7528\uff0c\u901a\u8fc7\u65e7\u6a21\u5757\u5c31\u80fd\u8bbf\u95ee\u5230\u65b0\u7684\u5185\u5bb9</li>\n<li>\u9700\u8981 Reload \u7684\u6a21\u5757\u53ef\u63a7</li>\n</ul>\n<p>\u8981\u5b8c\u6210\u8fd9\u4e9b\u8981\u6c42\uff0c\u6211\u4eec\u9700\u8981\u501f\u52a9 Python \u91cc\u9762 meta_path \u7684\u673a\u5236\uff0c\u8be6\u7ec6\u7684\u4ecb\u7ecd\u53ef\u4ee5\u770b\u5b98\u65b9\u6587\u6863 <a href=\"https://docs.python.org/zh-cn/3/reference/import.html?highlight=meta_path#the-meta-path\">the-meta-path</a>\u3002</p>\n<p>sys.meta_path \u91cc\u9762\u53ef\u4ee5\u5b9a\u4e49\u6211\u4eec\u7684\u5143\u8def\u5f84\u67e5\u627e\u5668\u5bf9\u8c61\uff0c\u8b6c\u5982\u6211\u4eec\u628a\u7528\u4e8e Reload \u7684\u67e5\u627e\u5668\u53eb\u505a reload_finder\uff0creload_finder \u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u51fd\u6570 find_spec \u5e76\u8fd4\u56de spec \u5bf9\u8c61\u3002Python \u62ff\u5230 spec \u5bf9\u8c61\u540e\uff0c\u4f1a\u4f9d\u6b21\u6267\u884c spec.loader.create_module \u548c spec.loader.exec_module \u5b8c\u6210\u6a21\u5757\u7684\u5bfc\u5165\u3002</p>\n<p>\u5982\u679c\u6211\u4eec\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6267\u884c\u65b0\u7684\u6a21\u5757\u4ee3\u7801\uff0c\u5e76\u628a\u65b0\u7684\u6a21\u5757\u91cc\u9762\u7684\u51fd\u6570\u548c\u9700\u8981\u7684\u6570\u636e\u590d\u5236\u5230\u65e7\u6a21\u5757\u4e2d\uff0c\u5219\u53ef\u4ee5\u8fbe\u5230 Reload \u7684\u76ee\u7684\uff1a</p>\n<p>```python linenums=\"1\"\nclass MetaFinder:\n    def <strong>init</strong>(self, reloader):\n        self._reloader = reloader</p>\n<pre><code>def find_spec(self, fullname, path, target=None):\n    # find source file\n    finder = importlib.machinery.PathFinder()\n    spec = finder.find_spec(fullname, path)\n    if not spec:\n        return\n\n    old_module = self._reloader.GetOldModule(fullname)\n    if old_module:\n        # run new code in old module dict\n        code = spec.loader.get_code(fullname)\n        exec(code, old_module.__dict__)\n        module = old_module\n    else:\n        # if old module not exists, just create a new one\n        module = import_util.module_from_spec(spec)\n        spec.loader.exec_module(module)\n\n    try:\n        self._reloader.ReloadModule(module)\n    except:\n        sys.excepthook(*sys.exc_info())\n\n    return import_util.spec_from_loader(fullname, MetaLoader(module))\n</code></pre>\n<p>class MetaLoader:\n    def <strong>init</strong>(self, module):\n        self._module = module</p>\n<pre><code>def create_module(self, spec):\n    return self._module\n\ndef exec_module(self, module):\n    # restore __spec__\n    module.__spec__ = module.__dict__.pop('__backup_spec__')\n    module.__loader__ = module.__dict__.pop('__backup_loader__')\n</code></pre>\n<p>```</p>\n<p>\u5982\u4e0a\uff0c<code>find_spec</code> \u52a0\u8f7d\u6700\u65b0\u7684\u6a21\u5757\u6e90\u7801\uff0c\u5e76\u5728\u65e7\u6a21\u5757\u7684 <code>__dict__</code> \u91cc\u9762\u6267\u884c\u65b0\u6a21\u5757\u7684\u4ee3\u7801\uff0c\u4e4b\u540e\u6211\u4eec\u8c03\u7528 <code>ReloadModule</code> \u6765\u5904\u7406\u7c7b / \u51fd\u6570 / \u6570\u636e\u7684\u5f15\u7528\u548c\u66ff\u6362\u3002<code>MetaLoader</code> \u7684\u76ee\u7684\u662f\u9002\u914d meta_path \u673a\u5236\uff0c\u7ed9 Python \u865a\u62df\u673a\u8fd4\u56de\u6211\u4eec\u5904\u7406\u8fc7\u7684\u6a21\u5757\u5bf9\u8c61\u3002</p>\n<p>\u5904\u7406\u5b8c\u52a0\u8f7d\u7684\u6d41\u7a0b\uff0c\u518d\u6765\u770b <code>ReloadModule</code> \u7684\u5927\u81f4\u5b9e\u73b0</p>\n<p>```python linenums=\"1\"</p>\n<h1>...</h1>\n<p>def ReloadModule(self, module):\n    old_module_info = self._old_module_infos.get(module.<strong>name</strong>)\n    if not old_module_info:\n        return</p>\n<pre><code>self.ReloadDict(module, old_module_info, module.__dict__)\n</code></pre>\n<p>def ReloadDict(self, module, old_dict, new_dict, _reload_all_data=False, _del_func=False):\n    dels = []</p>\n<pre><code>for attr_name, old_attr in old_dict.items():\n\n    if attr_name in self.IGNORE_ATTRS:\n        continue\n\n    if attr_name not in new_dict:\n        if _del_func and (inspect.isfunction(old_attr) or inspect.ismethod(old_attr)):\n            dels.append(attr_name)\n        continue\n\n    new_attr = new_dict[attr_name]\n\n    if inspect.isclass(old_attr):\n        new_dict[attr_name] = self.ReloadClass(module, old_attr, new_attr)\n\n    elif inspect.isfunction(old_attr):\n        new_dict[attr_name] = self.ReloadFunction(module, old_attr, new_attr)\n\n    elif inspect.ismethod(old_attr) or isinstance(old_attr, classmethod) or isinstance(old_attr, staticmethod):\n        self.ReloadFunction(module, old_attr.__func__, new_attr.__func__)\n        new_dict[attr_name] = old_attr\n\n    elif inspect.isbuiltin(old_attr) \\\n            or inspect.ismodule(old_attr) \\\n            or inspect.ismethoddescriptor(old_attr) \\\n            or isinstance(old_attr, property):\n        # keep new\n        pass\n\n    elif not _reload_all_data and not self.NeedUpdateData(module, new_dict, attr_name):\n        # keep old data\n        new_dict[attr_name] = old_attr\n\nif dels:\n    for name in dels:\n        old_dict.pop(name)\n</code></pre>\n<h1>...</h1>\n<p>```</p>\n<p><code>ReloadDict</code> \u91cc\u9762\u4f1a\u533a\u5206\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u7684\u5bf9\u8c61</p>\n<ul>\n<li>\u5982\u679c\u662f class\uff0c\u5219\u8c03\u7528 <code>ReloadClass</code>\uff0c\u4f1a\u8fd4\u56de\u65e7\u6a21\u5757\u7684\u5f15\u7528\uff0c\u5e76\u66f4\u65b0 class \u7684\u6210\u5458</li>\n<li>\u5982\u679c\u662f function / method \uff0c\u5219\u8c03\u7528 <code>ReloadFunction</code>\uff0c\u4f1a\u8fd4\u56de\u65e7\u6a21\u5757\u7684\u5f15\u7528\uff0c\u5e76\u66f4\u65b0\u51fd\u6570\u7684\u5185\u90e8\u6570\u636e</li>\n<li>\u5982\u679c\u662f\u6570\u636e\uff0c\u5e76\u4e14\u9700\u8981\u4fdd\u7559\uff0c\u5219\u4f1a\u56de\u6eda <code>new_dict[attr_name] = old_attr</code></li>\n<li>\u5176\u4f59\u7684\u90fd\u4fdd\u6301\u65b0\u7684\u5f15\u7528</li>\n<li>\u5220\u9664\u65b0\u6a21\u5757\u4e0d\u5b58\u5728\u7684\u51fd\u6570</li>\n</ul>\n<p><code>ReloadClass</code>\uff0c<code>ReloadFunction</code> \u7684\u5177\u4f53\u4ee3\u7801\u8fd9\u91cc\u4e0d\u518d\u5c55\u5f00\u5206\u6790\uff0c\u6709\u5174\u8da3\u53ef\u4ee5\u76f4\u63a5\u770b<a href=\"https://github.com/disenone/python_reloader\">\u6e90\u7801</a>\u3002</p>\n<p>\u6574\u4e2a Reload \u7684\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u6982\u62ec\u4e3a\uff1a\u65e7\u74f6\u88c5\u65b0\u9152\u3002\u4e3a\u4e86\u4fdd\u6301\u6a21\u5757/\u6a21\u5757\u7684\u51fd\u6570/\u6a21\u5757\u7684\u7c7b/\u6a21\u5757\u7684\u6570\u636e\u6709\u6548\uff0c\u6211\u4eec\u9700\u8981\u4fdd\u7559\u539f\u6765\u7684\u8fd9\u4e9b\u5bf9\u8c61\u7684\u5f15\u7528\uff08\u8eaf\u58f3\uff09\uff0c\u8f6c\u800c\u53bb\u66f4\u65b0\u5b83\u4eec\u5185\u90e8\u7684\u5177\u4f53\u6570\u636e\uff0c\u8b6c\u5982\u5bf9\u4e8e\u51fd\u6570\uff0c\u66f4\u65b0 <code>__code__</code>\uff0c<code>__dict__</code> \u7b49\u6570\u636e\uff0c\u51fd\u6570\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u8f6c\u800c\u6267\u884c\u65b0\u7684\u4ee3\u7801\u3002</p>\n<h2>\u603b\u7ed3</h2>\n<p>\u672c\u6587\u8be6\u7ec6\u4ecb\u7ecd\u4e86 Python3 \u7684\u4e24\u79cd\u70ed\u66f4\u65b0\u65b9\u5f0f\uff0c\u6bcf\u79cd\u90fd\u6709\u76f8\u5e94\u7684\u5e94\u7528\u573a\u666f\uff0c\u5e0c\u671b\u80fd\u5bf9\u4f60\u6709\u5e2e\u52a9\u3002\u6709\u4efb\u4f55\u7591\u95ee\u6b22\u8fce\u968f\u65f6\u4ea4\u6d41\u3002</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2024-01-12T06:37:04+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/ue-%E8%AE%BE%E7%BD%AE%E6%9C%AC%E5%9C%B0%E5%8C%96%E5%A4%9A%E8%AF%AD%E8%A8%80/",
            "url": "https://wiki.disenone.site/ue-%E8%AE%BE%E7%BD%AE%E6%9C%AC%E5%9C%B0%E5%8C%96%E5%A4%9A%E8%AF%AD%E8%A8%80/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "UE \u8bbe\u7f6e\u672c\u5730\u5316\u591a\u8bed\u8a00",
            "content_html": "<p><meta property=\"og:title\" content=\"UE \u8bbe\u7f6e\u672c\u5730\u5316\u591a\u8bed\u8a00\" /></p>\n<h1>UE \u8bbe\u7f6e\u672c\u5730\u5316\u591a\u8bed\u8a00</h1>\n<blockquote>\n<p>\u8bb0\u5f55\u5982\u4f55\u5728 UE \u4e2d\u5b9e\u73b0\u672c\u5730\u5316\u591a\u8bed\u8a00</p>\n</blockquote>\n<p>\u5982\u679c\u4e0d\u719f\u6089 UE \u6269\u5c55\u83dc\u5355\uff0c\u5efa\u8bae\u5148\u7b80\u5355\u770b\u4e0b\uff1a<a href=\"ue-\u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355.md\">UE \u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355</a>\uff0c<a href=\"ue-\u4f7f\u7528\u8def\u5f84\u5f62\u5f0f\u6269\u5c55\u83dc\u5355.md\">ue-\u4f7f\u7528\u8def\u5f84\u5f62\u5f0f\u6269\u5c55\u83dc\u5355</a></p>\n<p>\u672c\u6587\u4ee3\u7801\u57fa\u4e8e\u63d2\u4ef6\uff1a<a href=\"https://github.com/disenone/UE.EditorPlus\">UE.EditorPlus</a></p>\n<h2>\u529f\u80fd\u4ecb\u7ecd</h2>\n<p>UE \u81ea\u5e26\u5de5\u5177\u53ef\u4ee5\u5b9e\u73b0\u672c\u5730\u5316\u591a\u8bed\u8a00\uff0c\u8b6c\u5982\u6211\u4eec\u53ef\u4ee5\u4e3a\u7f16\u8f91\u5668\u83dc\u5355\u5b9e\u73b0\u672c\u5730\u5316\uff1a</p>\n<p>\u4e2d\u6587\u83dc\u5355\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/chinese.png\"></p>\n<p>\u82f1\u6587\u83dc\u5355\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/english.png\"></p>\n<h2>\u4ee3\u7801\u58f0\u660e</h2>\n<p>\u4e3a\u4e86\u5b9e\u73b0\u83dc\u5355\u672c\u5730\u5316\uff0c\u6211\u4eec\u9700\u8981\u5728\u4ee3\u7801\u4e2d\u660e\u786e\u58f0\u660e\u9700\u8981 UE \u5904\u7406\u7684\u5b57\u7b26\u4e32\uff0c\u4f7f\u7528 UE \u5b9a\u4e49\u597d\u7684\u5b8f <code>LOCTEXT</code> \u548c <code>NSLOCTEXT</code>\uff1a</p>\n<ul>\n<li>\u6587\u4ef6\u5168\u5c40\u5b9a\u4e49\u65b9\u5f0f\uff0c\u5148\u5f00\u59cb\u5b9a\u4e49\u4e00\u4e2a\u53eb\u505a <code>LOCTEXT_NAMESPACE</code> \u7684\u5b8f\uff0c\u5185\u5bb9\u662f\u5f53\u524d\u591a\u8bed\u8a00\u6587\u672c\u6240\u5728\u7684\u540d\u5b57\u7a7a\u95f4\uff0c\u4e4b\u540e\u6587\u4ef6\u4e2d\u7684\u6587\u672c\u5c31\u53ef\u4ee5\u7528 <code>LOCTEXT</code> \u6765\u5b9a\u4e49\uff0c\u6587\u4ef6\u6700\u540e\u53d6\u6d88\u5b8f <code>LOCTEXT_NAMESPACE</code>\uff1a</li>\n</ul>\n<p>```cpp\n// #define LOCTEXT(InKey, InTextLiteral)</p>\n<h1>define LOCTEXT_NAMESPACE \"EditorPlusTools\"</h1>\n<p>LOCTEXT(\"Key\", \"Content\");</p>\n<h1>undef LOCTEXT_NAMESPACE</h1>\n<p>```</p>\n<ul>\n<li>\u5c40\u90e8\u5b9a\u4e49\u65b9\u5f0f\uff0c\u4f7f\u7528 <code>NSLOCTEXT</code>\uff0c\u5b9a\u4e49\u6587\u672c\u7684\u65f6\u5019\u5e26\u4e0a\u540d\u5b57\u7a7a\u95f4\u53c2\u6570\uff1a</li>\n</ul>\n<p>```cpp\n// #define NSLOCTEXT(InNamespace, InKey, InTextLiteral)</p>\n<p>NSLOCTEXT(\"EditorPlusTools\", \"Key\", \"Content\");\n```</p>\n<p>UE \u5de5\u5177\u901a\u8fc7\u67e5\u627e\u5b8f <code>LOCTEXT</code> \u548c <code>NSLOCTEXT</code> \u7684\u51fa\u73b0\u6765\u6536\u96c6\u51fa\u6240\u6709\u9700\u8981\u7ffb\u8bd1\u7684\u6587\u672c\u3002</p>\n<h2>\u4f7f\u7528\u5de5\u5177\u7ffb\u8bd1\u6587\u672c</h2>\n<p>\u5047\u8bbe\u6211\u4eec\u6709\u5982\u4e0b\u4ee3\u7801\u5b9a\u4e49\u6587\u672c\uff1a</p>\n<p>```cpp</p>\n<h1>define LOCTEXT_NAMESPACE \"EditorPlusTools\"</h1>\n<p>// register path node loctext\nFEditorPlusPath::GetNodeByPath(\"/MenuTest\")-&gt;SetFriendlyName(LOCTEXT(\"MenuTest\", \"MenuTest\"))-&gt;SetFriendlyTips(LOCTEXT(\"MenuTestTips\", \"MenuTestTips\"));\nFEditorPlusPath::GetNodeByPath(\"/MenuTest/<SubMenu>SubMenu1\")-&gt;SetFriendlyName(LOCTEXT(\"SubMenu1\", \"SubMenu1\"))-&gt;SetFriendlyTips(LOCTEXT(\"SubMenu1Tips\", \"SubMenu1Tips\"));\nFEditorPlusPath::GetNodeByPath(\"/MenuTest/<SubMenu>SubMenu1/<SubMenu>SubMenu1\")-&gt;SetFriendlyName(LOCTEXT(\"SubMenu1\", \"SubMenu1\"))-&gt;SetFriendlyTips(LOCTEXT(\"SubMenu1Tips\", \"SubMenu1Tips\"));\nFEditorPlusPath::GetNodeByPath(\"/<Hook>Help/<MenuBar>MenuTest/<SubMenu>SubMenu1/<Section>Section1\")-&gt;SetFriendlyName(LOCTEXT(\"Section1\", \"Section1\"))-&gt;SetFriendlyTips(LOCTEXT(\"Section1Tips\", \"Section1Tips\"));</p>\n<h1>undef LOCTEXT_NAMESPACE</h1>\n<p>```</p>\n<p>\u9996\u5148\u5f00\u542f\u7ffb\u8bd1\u5de5\u5177\uff0c\u6253\u5f00\u7f16\u8f91\u5668\u8bbe\u7f6e <code>\u7f16\u8f91 - \u7f16\u8f91\u5668\u504f\u597d\u8bbe\u7f6e</code>\uff0c\u52fe\u9009 <code>\u901a\u7528 - \u8bd5\u9a8c\u6027\u529f\u80fd - Tools - \u7ffb\u8bd1\u9009\u53d6\u5668</code>\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/editor_enable_tool.png\"></p>\n<p>\u7136\u540e\u6253\u5f00\u7ffb\u8bd1\u5de5\u5177 <code>\u5de5\u5177 - \u672c\u5730\u5316\u63a7\u5236\u677f</code>\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/editor_open_tool.png\"></p>\n<p>\u65b0\u5efa\u4e00\u4e2a\u76ee\u6807\uff08\u5728\u9ed8\u8ba4\u7684 Game \u4e0b\u9762\u4e5f\u884c\uff0c\u65b0\u5efa\u4e00\u4e2a\u662f\u4e3a\u4e86\u65b9\u4fbf\u7ba1\u7406\u548c\u79fb\u52a8\u8fd9\u4e9b\u7ffb\u8bd1\u6587\u672c\uff09</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_new_target.png\"></p>\n<p>\u914d\u7f6e\u76ee\u6807\u7684\u53c2\u6570\uff0c\u6211\u8fd9\u91cc\u540d\u5b57\u6539\u4e3a <code>EditorPlusTools</code>\uff0c\u52a0\u8f7d\u653f\u7b56\u662f <code>\u7f16\u8f91\u5668</code>\uff0c\u4ece\u6587\u672c\u6536\u96c6\uff0c\u5e76\u52a0\u4e0a\u63d2\u4ef6\u76ee\u5f55\uff0c\u76ee\u6807\u4f9d\u8d56\u6027\u662f <code>Engine, Editor</code>\uff0c\u5176\u4ed6\u914d\u7f6e\u4fdd\u6301\u4e0d\u53d8\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_target_config.png\"></p>\n<p>\u6dfb\u52a0\u8bed\u7cfb\uff0c\u4fdd\u8bc1\u6709\u4e2d\u6587\uff08\u7b80\u4f53\uff09\u548c\u82f1\u6587\u4e24\u4e2a\u8bed\u7cfb\uff0c\u786e\u8ba4\u9f20\u6807\u653e\u5728\u8bed\u8a00\u540d\u5b57\u4e0a\u5206\u522b\u663e\u793a <code>zh-Hans</code> \u548c <code>en</code>\uff0c\u5e76\u9009\u4e2d\u82f1\u8bed\uff08\u56e0\u4e3a\u6211\u4eec\u4ee3\u7801\u91cc\u9762\u662f\u7528\u82f1\u6587\u5b9a\u4e49\u7684\u6587\u672c\uff0c\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u6536\u96c6\u8fd9\u4e9b\u82f1\u8bed\u6587\u672c\uff09\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_target_lang.png\"></p>\n<p>\u70b9\u51fb\u6536\u96c6\u6587\u672c\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_target_collect.png\"></p>\n<p>\u4f1a\u5f39\u51fa\u6536\u96c6\u8fdb\u5ea6\u6846\uff0c\u7b49\u5f85\u6536\u96c6\u6210\u529f\uff0c\u4f1a\u663e\u793a\u7eff\u8272\u5bf9\u94a9\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_target_collected.png\"></p>\n<p>\u5173\u6389\u6536\u96c6\u8fdb\u5ea6\u6846\uff0c\u56de\u5230\u7ffb\u8bd1\u5de5\u5177\u53ef\u4ee5\u770b\u5230\u82f1\u6587\u4e00\u884c\u6709\u663e\u793a\u6536\u96c6\u5230\u7684\u6570\u91cf\uff0c\u672c\u8eab\u82f1\u6587\u7684\u6211\u4eec\u4e0d\u9700\u8981\u7ffb\u8bd1\uff0c\u70b9\u5f00\u4e2d\u6587\u4e00\u884c\u7684\u7ffb\u8bd1\u6309\u94ae\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_go_trans.png\"></p>\n<p>\u6253\u5f00\u540e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u672a\u7ffb\u8bd1\u4e00\u680f\u6709\u5185\u5bb9\uff0c\u5728\u82f1\u6587\u6587\u672c\u7684\u53f3\u8fb9\u4e00\u680f\u8f93\u5165\u7ffb\u8bd1\u540e\u7684\u5185\u5bb9\uff0c\u7ffb\u8bd1\u5185\u5bb9\u90fd\u5b8c\u6210\u4e4b\u540e\uff0c\u4fdd\u5b58\u9000\u51fa\u7a97\u53e3\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_trans.png\"></p>\n<p>\u70b9\u51fb\u7edf\u8ba1\u5b57\u6570\uff0c\u7ed3\u675f\u540e\u80fd\u770b\u5230\u4e2d\u6587\u4e00\u680f\u663e\u793a\u4e86\u7ffb\u8bd1\u7684\u6570\u91cf\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_count.png\"></p>\n<p>\u6700\u540e\u7f16\u8bd1\u6587\u672c\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_build.png\"></p>\n<p>\u7ffb\u8bd1\u7684\u6570\u636e\u4f1a\u653e\u5728 <code>Content\\Localization\\EditorPlusTools</code> \u91cc\u9762\uff0c\u6bcf\u79cd\u8bed\u8a00\u4e00\u4e2a\u6587\u4ef6\u5939\uff0c\u5728 zh-Hans \u91cc\u9762\u80fd\u770b\u5230\u4e24\u4e2a\u6587\u4ef6\uff0c<code>.archive</code> \u662f\u6536\u96c6\u548c\u7ffb\u8bd1\u7684\u6587\u672c\uff0c<code>.locres</code> \u5219\u662f\u7f16\u8bd1\u4e4b\u540e\u7684\u6570\u636e\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_ret.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_ret2.png\"></p>\n<h2>\u7ffb\u8bd1\u597d\u7684\u6587\u672c\u653e\u5165\u63d2\u4ef6\u76ee\u5f55\u4e2d</h2>\n<p>\u6211\u4eec\u4e0a\u9762\u7ed9\u63d2\u4ef6\u751f\u6210\u7684\u7ffb\u8bd1\u6587\u672c\u653e\u5728\u4e86\u9879\u76ee\u76ee\u5f55\u4e0b\u9762\uff0c\u6211\u4eec\u9700\u8981\u628a\u8fd9\u4e9b\u6587\u672c\u79fb\u52a8\u5230\u63d2\u4ef6\u91cc\u9762\uff0c\u65b9\u4fbf\u968f\u7740\u63d2\u4ef6\u4e00\u8d77\u53d1\u5e03\u3002</p>\n<p>\u628a <code>Content\\Localization\\EditorPlusTools</code> \u76ee\u5f55\u79fb\u52a8\u5230\u63d2\u4ef6\u76ee\u5f55 Content \u4e0b\u9762\uff0c\u6211\u8fd9\u91cc\u662f <code>Plugins\\UE.EditorPlus\\Content\\Localization\\EditorPlusTools</code>\u3002</p>\n<p>\u4fee\u6539\u9879\u76ee\u7684\u914d\u7f6e\u6587\u4ef6 <code>DefaultEditor.ini</code>\uff0c\u52a0\u4e0a\u65b0\u8def\u5f84\uff1a</p>\n<p><code>ini\n[Internationalization]\n+LocalizationPaths=%GAMEDIR%Plugins/UE.EditorPlus/Content/Localization/EditorPlusTools</code></p>\n<p>\u8fd9\u6837\uff0c\u5176\u4ed6\u9879\u76ee\u62ff\u5230\u63d2\u4ef6\u540e\uff0c\u53ea\u8981\u4fee\u6539 <code>DefaultEditor.ini</code> \u5219\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u7ffb\u8bd1\u6587\u672c\uff0c\u4e0d\u9700\u8981\u91cd\u65b0\u914d\u7f6e\u7ffb\u8bd1\u3002</p>\n<h2>\u6ce8\u610f\u4e8b\u9879</h2>\n<p>\u5728\u751f\u6210\u7ffb\u8bd1\u6570\u636e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9047\u5230\u8fc7\u4e00\u4e9b\u95ee\u9898\uff0c\u4ee5\u4e0b\u603b\u7ed3\u51fa\u6765\u6ce8\u610f\u7684\u4e8b\u9879\uff1a</p>\n<ul>\n<li>\u4ee3\u7801\u91cc\u9762\u5b9a\u4e49\u6587\u672c\u5fc5\u987b\u8981\u7528\u5b8f <code>LOCTEXT</code> \u548c <code>NSLOCTEXT</code>\uff0c\u6587\u672c\u9700\u8981\u662f\u5b57\u7b26\u4e32\u5e38\u91cf\uff0c\u8fd9\u6837 UE \u624d\u662f\u6536\u96c6\u51fa\u6765\u3002</li>\n<li>\u7ffb\u8bd1\u76ee\u6807\u540d\u5b57\u4e0d\u80fd\u5e26\u6709\u7b26\u53f7 <code>.</code>\uff0c<code>Content\\Localiztion\\</code> \u4e0b\u7684\u76ee\u5f55\u540d\u5b57\u4e0d\u80fd\u5e26\u6709 <code>.</code>\uff0cUE \u53ea\u4f1a\u622a\u53d6 <code>.</code> \u524d\u9762\u7684\u540d\u5b57\u3002\u4f1a\u5bfc\u81f4 UE \u5728\u8bfb\u53d6\u7ffb\u8bd1\u6587\u672c\u7684\u65f6\u5019\uff0c\u7531\u4e8e\u540d\u5b57\u9519\u8bef\uff0c\u8bfb\u53d6\u5931\u8d25\u3002</li>\n<li>\n<p>\u5bf9\u4e8e\u7f16\u8f91\u5668\u63d2\u4ef6\uff0c\u9700\u8981\u5224\u65ad\u5982\u679c\u662f\u547d\u4ee4\u884c\u6a21\u5f0f <code>IsRunningCommandlet()</code> \u5219\u4e0d\u751f\u6210\u83dc\u5355\u548c SlateUI \uff0c\u56e0\u4e3a\u547d\u4ee4\u884c\u6a21\u5f0f\u4e0b\u6ca1\u6709 Slate \u6a21\u5757\uff0c\u4f1a\u5bfc\u81f4\u6536\u96c6\u6587\u672c\u7684\u65f6\u5019\u62a5\u9519 <code>Assertion failed: CurrentApplication.IsValid()</code>\u3002\u5982\u679c\u4f60\u4e5f\u9047\u5230\u7c7b\u4f3c\u7684\u62a5\u9519\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u52a0\u4e0a\u8fd9\u4e2a\u5224\u65ad\u3002\u5177\u4f53\u62a5\u9519\u4fe1\u606f\uff1a</p>\n<blockquote>\n<p>Assertion failed: CurrentApplication.IsValid() [File:E:\\UE\\ue5.3_git\\Engine\\Source\\Runtime\\Slate\\Public\\Framework\\Application\\SlateApplication.h] [Line: 255] </p>\n</blockquote>\n<p><img alt=\"\" src=\"assets/img/2023-ue-localization/tool_error.png\"></p>\n</li>\n</ul>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-12-28T18:06:38+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/ue-%E4%BD%BF%E7%94%A8%E8%B7%AF%E5%BE%84%E5%BD%A2%E5%BC%8F%E6%89%A9%E5%B1%95%E8%8F%9C%E5%8D%95/",
            "url": "https://wiki.disenone.site/ue-%E4%BD%BF%E7%94%A8%E8%B7%AF%E5%BE%84%E5%BD%A2%E5%BC%8F%E6%89%A9%E5%B1%95%E8%8F%9C%E5%8D%95/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "UE \u4f7f\u7528\u8def\u5f84\u5f62\u5f0f\u6269\u5c55\u83dc\u5355",
            "content_html": "<p><meta property=\"og:title\" content=\"UE \u4f7f\u7528\u8def\u5f84\u5f62\u5f0f\u6269\u5c55\u83dc\u5355\" /></p>\n<blockquote>\n<p>\u8bb0\u5f55\u5982\u4f55\u5728 UE \u4e2d\u5b9e\u73b0\u8def\u5f84\u5f62\u5f0f\u6269\u5c55\u83dc\u5355</p>\n</blockquote>\n<p>\u5982\u679c\u4e0d\u719f\u6089 UE \u6269\u5c55\u83dc\u5355\uff0c\u5efa\u8bae\u5148\u7b80\u5355\u770b\u4e0b\uff1a<a href=\"ue-\u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355.md\">UE \u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355</a></p>\n<p>\u672c\u6587\u4ee3\u7801\u57fa\u4e8e\u63d2\u4ef6\uff1a<a href=\"https://github.com/disenone/UE.EditorPlus\">UE.EditorPlus</a></p>\n<h2>\u8282\u70b9\u7ba1\u7406</h2>\n<p>\u628a\u83dc\u5355\u6309\u7167\u6811\u7684\u7ed3\u6784\u6765\u7ba1\u7406\uff0c\u7236\u8282\u70b9\u53ef\u4ee5\u5305\u542b\u5b69\u5b50\uff1a</p>\n<p><code>cpp\nclass EDITORPLUS_API FEditorPlusMenuBase: public TSharedFromThis&lt;FEditorPlusMenuBase&gt;\n{\nprotected:\n    // sub menus\n    TArray&lt;TSharedRef&lt;FEditorPlusMenuBase&gt;&gt; Children;\n}</code></p>\n<p>\u5728\u521b\u5efa\u7236\u8282\u70b9\u7684\u540c\u65f6\u521b\u5efa\u5b50\u8282\u70b9\uff1a</p>\n<p><code>cpp\nvoid FEditorPlusMenuBase::Register(FMenuBuilder&amp; MenuBuilder)\n{\n    for (const auto Menu: Children)\n    {\n        Menu-&gt;Register(MenuBuilder);\n    }\n}</code></p>\n<p>\u5f53\u7136\u6bcf\u4e2a\u8282\u70b9\u7684\u5177\u4f53\u521b\u5efa\u884c\u4e3a\u4f1a\u6709\u70b9\u4e0d\u540c\uff0c\u8986\u5199\u865a\u51fd\u6570\u6765\u5b9e\u73b0\uff1a</p>\n<p>```cpp\n// Menubar\nvoid FEditorPlusMenuBar::Register(FMenuBarBuilder&amp; MenuBarBuilder)\n{\n    MenuBarBuilder.AddPullDownMenu(\n        GetFriendlyName(),\n        GetFriendlyTips(),\n        // Delegate to call Register\n        FEditorPlusMenuManager::GetDelegate<FNewMenuDelegate>(GetUniqueId()),     <br>\n        Hook);\n}</p>\n<p>// Section\nvoid FEditorPlusSection::Register(FMenuBuilder&amp; MenuBuilder)\n{\n    MenuBuilder.BeginSection(Hook, GetFriendlyName());\n    FEditorPlusMenuBase::Register(MenuBuilder);\n    MenuBuilder.EndSection();\n}</p>\n<p>// Separator\nvoid FEditorPlusSeparator::Register(FMenuBuilder&amp; MenuBuilder)\n{\n    MenuBuilder.AddMenuSeparator(Hook);\n    FEditorPlusMenuBase::Register(MenuBuilder);\n}</p>\n<p>// SubMenu\nvoid FEditorPlusSubMenu::Register(FMenuBuilder&amp; MenuBuilder)\n{\n    MenuBuilder.AddSubMenu(\n        GetFriendlyName(),\n        GetFriendlyTips(),\n        FNewMenuDelegate::CreateSP(this, &amp;FEditorPlusSubMenu::MakeSubMenu),\n        false,\n        FSlateIcon(),\n        true,\n        Hook\n    );\n}</p>\n<p>// Command\nvoid FEditorPlusCommand::Register(FMenuBuilder&amp; MenuBuilder)\n{\n    MenuBuilder.AddMenuEntry(\n        CommandInfo-&gt;Label, CommandInfo-&gt;Tips, CommandInfo-&gt;Icon,\n        CommandInfo-&gt;ExecuteAction, CommandInfo-&gt;Hook, CommandInfo-&gt;Type);\n}</p>\n<p>// ......\n```</p>\n<h2>\u901a\u8fc7\u8def\u5f84\u751f\u6210\u8282\u70b9</h2>\n<p>\u6309\u7167\u6811\u5f62\u7ed3\u6784\u7ec4\u7ec7\u597d\u83dc\u5355\uff0c\u8def\u5f84\u683c\u5f0f\u5c31\u53ef\u4ee5\u5b9a\u4e49\u4e00\u6761\u83dc\u5355\u7684\u6811\u5f62\u7ed3\u6784\uff1a</p>\n<p><code>cpp\n\"/&lt;Hook&gt;Help/&lt;MenuBar&gt;BarTest/&lt;SubMenu&gt;SubTest/&lt;Command&gt;Action\"</code></p>\n<p>\u4ee5\u4e0a\u8def\u5f84\u5373\u53ef\u4ee5\u5b9a\u4e49\u4e00\u7cfb\u5217\u83dc\u5355\u7684\u521b\u5efa\uff1a</p>\n<ul>\n<li><code>&lt;Hook&gt;Help</code>\uff1a\u4f4d\u7f6e\u5728 Hook \u540d\u5b57\u4e3a Help \u7684\u83dc\u5355\u540e</li>\n<li><code>&lt;MenuBar&gt;BarTest</code>\uff1a\u521b\u5efa\u7c7b\u578b MenuBar \u7684\u83dc\u5355\uff0c\u540d\u5b57\u4e3a BarTest</li>\n<li><code>&lt;SubMenu&gt;SubTest</code>\uff1a\u521b\u5efa\u5b50\u8282\u70b9\uff0c\u7c7b\u578b SubMenu, \u540d\u5b57 SubTest</li>\n<li><code>&lt;Command&gt;Action</code>\uff1a\u6700\u540e\u521b\u5efa\u4e00\u4e2a\u547d\u4ee4</li>\n</ul>\n<p>\u63a5\u53e3\u8c03\u7528\u5f62\u5f0f\u53ef\u4ee5\u5f88\u7b80\u6d01\uff1a</p>\n<p><code>cpp\nconst FString Path = \"/&lt;Hook&gt;Help/&lt;MenuBar&gt;BarTest/&lt;SubMenu&gt;SubTest/&lt;Command&gt;Action\";\nFEditorPlusPath::RegisterPathAction(\n    Path, \n    FExecuteAction::CreateLambda([]\n    {\n        // do action\n    })\n);</code></p>\n<h2>\u81ea\u5b9a\u4e49\u5f62\u5f0f\u751f\u6210\u8282\u70b9</h2>\n<p>\u6211\u4eec\u4f9d\u7136\u4fdd\u7559\u4e86\u7b28\u91cd\u7684\u65b9\u5f0f\u6765\u521b\u5efa\u83dc\u5355\uff0c\u7b28\u91cd\u7684\u65b9\u5f0f\u53ef\u4ee5\u5141\u8bb8\u6709\u66f4\u8be6\u7ec6\u7684\u8bbe\u7f6e\uff0c\u4ee3\u7801\u7684\u7ec4\u7ec7\u5f62\u5f0f\u8ddf UE \u7684 SlateUI \u5199\u6cd5\u6709\u4e9b\u50cf\uff1a</p>\n<p><code>cpp\nEP_NEW_MENU(FEditorPlusMenuBar)(\"BarTest\")\n-&gt;RegisterPath()\n-&gt;Content({\n    EP_NEW_MENU(FEditorPlusSubMenu)(\"SubTest\")\n    -&gt;Content({\n        EP_NEW_MENU(FEditorPlusCommand)(\"Action\")\n        -&gt;BindAction(FExecuteAction::CreateLambda([]\n            {\n                // do action\n            })),\n    })\n});</code></p>\n<h2>\u6df7\u5408\u5f62\u5f0f</h2>\n<p>\u5f53\u7136\uff0c\u672c\u8eab\u8def\u5f84\u5f62\u5f0f\u548c\u81ea\u5b9a\u4e49\u751f\u6210\u7684\u83dc\u5355\uff0c\u90fd\u662f\u76f8\u540c\u7684\uff0c\u5b83\u4eec\u4e4b\u95f4\u53ef\u4ee5\u6df7\u7528\uff0c\u6709\u5f88\u5927\u7684\u7075\u6d3b\u6027\uff1a</p>\n<p>```cpp\nFEditorPlusPath::RegisterPath(\n    \"/<MenuBar>BarTest/<SubMenu>SubMenu/<Command>Action1\", \n    EP_NEW_MENU(FEditorPlusCommand)(\"Action1\")\n    -&gt;BindAction(FExecuteAction::CreateLambda([]\n        {\n            // do action\n        })),\n);</p>\n<p>FEditorPlusPath::RegisterPath(\n    \"/<MenuBar>BarTest/<SubMenu>SubMenu/<Command>Action2\", \n    EP_NEW_MENU(FEditorPlusCommand)(\"Action2\")\n    -&gt;BindAction(FExecuteAction::CreateLambda([]\n        {\n            // do action\n        })),\n);\n```</p>\n<p>\u591a\u4e2a\u5730\u65b9\u5b9a\u4e49\u7684\u83dc\u5355\uff0c\u4f1a\u5408\u5e76\u5230\u540c\u4e00\u4e2a\u6811\u5f62\u7ed3\u6784\u4e2d\uff0c\u540d\u5b57\u76f8\u540c\u7684\u8282\u70b9\u4f1a\u8ba4\u4e3a\u662f\u540c\u4e00\u4e2a\u8282\u70b9\u3002\u6362\u8a00\u4e4b\uff0c\u8def\u5f84\u662f\u552f\u4e00\u7684\uff0c\u540c\u4e00\u4e2a\u8def\u5f84\u53ef\u4ee5\u552f\u4e00\u786e\u5b9a\u4e00\u4e2a\u83dc\u5355\u8282\u70b9\u3002\n\u4e8e\u662f\u6211\u4eec\u4e5f\u53ef\u4ee5\u628a\u8282\u70b9\u627e\u51fa\u6765\uff0c\u91cd\u65b0\u505a\u4e00\u4e9b\u8bbe\u7f6e\u548c\u4fee\u6539\uff1a</p>\n<p><code>cpp\n// set Name and Tips\nFEditorPlusPath::GetNodeByPath(\"/&lt;MenuBar&gt;BarTest\")-&gt;SetFriendlyName(LOCTEXT(\"MenuTest\", \"MenuTest\"))-&gt;SetFriendlyTips(LOCTEXT(\"MenuTestTips\", \"MenuTestTips\"));</code></p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-12-28T09:35:18+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/ue-%E6%89%A9%E5%B1%95%E7%BC%96%E8%BE%91%E5%99%A8%E8%8F%9C%E5%8D%95/",
            "url": "https://wiki.disenone.site/ue-%E6%89%A9%E5%B1%95%E7%BC%96%E8%BE%91%E5%99%A8%E8%8F%9C%E5%8D%95/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "UE \u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355",
            "content_html": "<p><meta property=\"og:title\" content=\"UE \u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355\" /></p>\n<h1>UE \u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355</h1>\n<blockquote>\n<p>\u8bb0\u5f55 UE \u5982\u4f55\u6269\u5c55\u7f16\u8f91\u5668\u83dc\u5355</p>\n</blockquote>\n<h2>Hook</h2>\n<p>Hook \u53ef\u4ee5\u7406\u89e3\u4e3a\u6269\u5c55\u83dc\u5355\u7684\u951a\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6e\u65b0\u52a0\u7684\u83dc\u5355\u547d\u4ee4\u5728 Hook \u7684\u524d\u9762\u6216\u8005\u540e\u9762\uff0cUE \u81ea\u5e26\u7684\u7f16\u8f91\u5668\u83dc\u5355\u547d\u4ee4\u57fa\u672c\u90fd\u5e26\u6709 Hook\uff0cUE5 \u4e0b\u6253\u5f00 <code>\u7f16\u8f91 - \u7f16\u8f91\u5668\u504f\u597d\u8bbe\u7f6e - \u901a\u7528 - \u5176\u4ed6 - \u663e\u793a UI \u6269\u5c55\u70b9</code> \u6765\u663e\u793a\u6240\u6709\u83dc\u5355\u7684 Hook\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-extend_menu/show_hook.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-extend_menu/show_hook2.png\"></p>\n<h2>\u6a21\u5757\u4f9d\u8d56</h2>\n<p>\u9700\u8981\u5728\u9879\u76ee .Build.cs \u6587\u4ef6\u91cc\u9762\u52a0\u4e0a\u4f9d\u8d56\u7684\u6a21\u5757 LevelEditor, Slate, SlateCore, EditorStyle, EditorWidgets, UnrealEd, ToolMenus\uff1a</p>\n<p><code>c#\nPrivateDependencyModuleNames.AddRange(\n    new string[]\n    {\n        \"Core\",\n        \"Engine\",\n        \"CoreUObject\",\n        \"LevelEditor\",\n        \"Slate\",\n        \"SlateCore\",\n        \"EditorStyle\",\n        \"EditorWidgets\",\n        \"UnrealEd\",\n        \"ToolMenus\",\n    }\n    );</code></p>\n<h2>\u6dfb\u52a0\u83dc\u5355\u680f</h2>\n<p>\u76f4\u63a5\u4e0a\u4ee3\u7801</p>\n<p>```cpp\nauto MenuExtender = MakeShared<FExtender>();</p>\n<p>MenuExtender-&gt;AddMenuBarExtension(\n    \"Help\", EExtensionHook::After,      // Create After Help\n    nullptr,\n    FMenuBarExtensionDelegate::CreateLambda(<a href=\"FMenuBarBuilder&amp; MenuBarBuilder\"></a>\n    {\n        MenuBarBuilder.AddPullDownMenu(\n            TEXT(\"MenuTest\"),       // Name\n            TEXT(\"MenuTest\"),       // Tips\n            FNewMenuDelegate::CreateLambda(<a href=\"FMenuBuilder&amp; MenuBuilder\"></a>\n            {\n                // create sub menus\n            }),\n            TEXT(\"MenuText\"));      // New Hook\n    })\n);\nFModuleManager::LoadModuleChecked<FLevelEditorModule>(\"LevelEditor\").GetMenuExtensibilityManager()-&gt;AddExtender(MenuExtender);\n```</p>\n<p>\u6267\u884c\u4ee5\u4e0a\u4ee3\u7801\u53ef\u4ee5\u770b\u5230\u5728 \u5e2e\u52a9 \u540e\u9762\u52a0\u4e0a\u4e86\u4e00\u4e2a\u83dc\u5355\u680f MenuTest:</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-extend_menu/bar.png\"></p>\n<h2>\u6dfb\u52a0\u547d\u4ee4</h2>\n<p>\u4f7f\u7528\u63a5\u53e3 <code>MenuBuilder.AddMenuEntry</code>\uff1a</p>\n<p><code>cpp\n// Inside MenuTest Lambda\nMenuBuilder.AddMenuEntry(\n    FText::FromName(\"MenuTestAction\"), FText::FromName(\"MenuTestAction\"),\n    FSlateIcon(), FUIAction(FExecuteAction::CreateLambda([]()\n    {\n        // do action\n    })));</code></p>\n<p>\u628a\u4ee5\u4e0a\u4ee3\u7801\u653e\u5230 CreateLambda \u91cc\u9762\uff0c\u5373\u53ef\u751f\u6210\u83dc\u5355\u547d\u4ee4\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-extend_menu/action.png\"></p>\n<h2>\u83dc\u5355\u5206\u8282</h2>\n<p>\u4f7f\u7528 <code>MenuBuilder.BeginSection</code> \u548c <code>MenuBuilder.EndSection</code>\uff1a</p>\n<p><code>cpp\nMenuBuilder.BeginSection(NAME_None, FText::FromName(\"MenuTestSection\"));\n// code to create action\nMenuBuilder.EndSection();</code></p>\n<h2>\u5206\u9694\u7b26</h2>\n<p><code>cpp\nMenuBuilder.AddMenuSeparator();</code></p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-extend_menu/section&amp;sperator.png\"></p>\n<h2>\u5b50\u83dc\u5355</h2>\n<p>\u5b50\u83dc\u5355\u7c7b\u4f3c\u83dc\u5355\u680f\uff0c\u9700\u8981\u5728 Lambda \u91cc\u9762\u5b9a\u4e49\uff1a</p>\n<p><code>cpp\nMenuBuilder.AddSubMenu(\n    FText::FromName(\"MenuTestSub\"), \n    FText::FromName(\"MenuTestSub\"), \n    FNewMenuDelegate::CreateLambda([](FMenuBuilder&amp; MenuBuilder)\n    {\n        MenuBuilder.AddMenuEntry(\n            FText::FromName(\"MenuTestSubAction\"), FText::FromName(\"MenuTestSubAction\"),\n            FSlateIcon(), FUIAction(FExecuteAction::CreateLambda([]()\n            {\n                // do action\n            })));\n    }));</code></p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-extend_menu/submenu.png\"></p>\n<h1>SlateUI \u63a7\u4ef6</h1>\n<p>\u8fd8\u53ef\u4ee5\u6dfb\u52a0 UI \u63a7\u4ef6\uff1a</p>\n<p>```cpp\nMenuBuilder.AddWidget(\n    SNew(SHorizontalBox)\n        + SHorizontalBox::Slot()\n        .AutoWidth()\n        [\n            SNew(SEditableTextBox)\n            .MinDesiredWidth(50)\n            .Text(FText::FromName(\"MenuTestWidget\"))\n        ]</p>\n<pre><code>    + SHorizontalBox::Slot()\n    .AutoWidth()\n    .Padding(5, 0, 0, 0)\n    [\n    SNew(SButton)\n    .Text(FText::FromName(\"ExtendWidget\"))\n    .OnClicked(FOnClicked::CreateLambda([]()\n    {\n        // do action\n        return FReply::Handled();\n    }))\n    ],\nFText::GetEmpty()\n</code></pre>\n<p>);\n```</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-extend_menu/widget.png\"></p>\n<p>Slate UI \u76f8\u5173\u7684\u5185\u5bb9\u8fd9\u91cc\u4e0d\u8be6\u7ec6\u5c55\u5f00\uff0c\u6709\u5174\u8da3\u53ef\u4ee5\u53bb\u53e6\u5916\u627e\u6587\u7ae0\u770b\u3002</p>\n<h1>Hook \u589e\u52a0\u83dc\u5355</h1>\n<p>\u8b6c\u5982\u5728 <code>\u5de5\u5177 - \u7f16\u7a0b</code> \u91cc\u9762\u589e\u52a0\u4e00\u4e2a\u547d\u4ee4\uff1a</p>\n<p><code>cpp\nMenuExtender-&gt;AddMenuExtension(\n    \"Programming\", EExtensionHook::After,\n    nullptr,\n    FMenuExtensionDelegate::CreateLambda([](FMenuBuilder&amp; MenuBuilder)\n    {\n        MenuBuilder.AddMenuEntry(\n        FText::FromName(\"MenuTestAction\"), FText::FromName(\"MenuTestAction\"),\n        FSlateIcon(), FUIAction(FExecuteAction::CreateLambda([]()\n        {\n            // do action\n        })));\n    })\n);</code></p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-extend_menu/other_hook.png\"></p>\n<p>\u540c\u7406\u53ef\u4ee5\u6dfb\u52a0\u5176\u4ed6\u83dc\u5355\u7c7b\u578b\u3002</p>\n<h1>\u5b8c\u6574\u4ee3\u7801</h1>\n<p>```cpp\nvoid BuildTestMenu()\n{\n    auto MenuExtender = MakeShared<FExtender>();</p>\n<pre><code>MenuExtender-&gt;AddMenuBarExtension(\n    \"Help\", EExtensionHook::After,\n    nullptr,\n    FMenuBarExtensionDelegate::CreateLambda([](FMenuBarBuilder&amp; MenuBarBuilder)\n    {\n        MenuBarBuilder.AddPullDownMenu(\n            FText::FromName(\"MenuTest\"),\n            FText::FromName(\"MenuTest\"),\n            FNewMenuDelegate::CreateLambda([](FMenuBuilder&amp; MenuBuilder)\n            {\n                MenuBuilder.BeginSection(NAME_None, FText::FromName(\"MenuTestSection\"));\n                MenuBuilder.AddMenuSeparator();\n                MenuBuilder.AddMenuEntry(\n                    FText::FromName(\"MenuTestAction\"), FText::FromName(\"MenuTestAction\"),\n                    FSlateIcon(), FUIAction(FExecuteAction::CreateLambda([]()\n                    {\n                        // do action\n                    })));\n\n                MenuBuilder.AddSubMenu(\n                    FText::FromName(\"MenuTestSubb\"),\n                    FText::FromName(\"MenuTestSubb\"),\n                    FNewMenuDelegate::CreateLambda([](FMenuBuilder&amp; MenuBuilder)\n                    {\n                        MenuBuilder.AddMenuEntry(\n                            FText::FromName(\"MenuTestSubAction\"), FText::FromName(\"MenuTestSubAction\"),\n                            FSlateIcon(), FUIAction(FExecuteAction::CreateLambda([]()\n                            {\n                                // do action\n                            })));\n                    }));\n                MenuBuilder.EndSection();\n\n                MenuBuilder.AddWidget(\n                SNew(SHorizontalBox)\n                     + SHorizontalBox::Slot()\n                     .AutoWidth()\n                     [\n                         SNew(SEditableTextBox)\n                         .MinDesiredWidth(50)\n                         .Text(FText::FromName(\"MenuTestWidget\"))\n                     ]\n                     + SHorizontalBox::Slot()\n                     .AutoWidth()\n                     .Padding(5, 0, 0, 0)\n                     [\n                        SNew(SButton)\n                        .Text(FText::FromName(\"ExtendWidget\"))\n                        .OnClicked(FOnClicked::CreateLambda([]()\n                        {\n                            // do action\n                            return FReply::Handled();\n                        }))\n                     ],\n                 FText::GetEmpty()\n                );\n            }),\n            \"MenuTest\");\n    })\n);\n\nMenuExtender-&gt;AddMenuExtension(\n    \"Programming\", EExtensionHook::After,\n    nullptr,\n    FMenuExtensionDelegate::CreateLambda([](FMenuBuilder&amp; MenuBuilder)\n    {\n        MenuBuilder.AddMenuEntry(\n        FText::FromName(\"MenuTestAction\"), FText::FromName(\"MenuTestAction\"),\n        FSlateIcon(), FUIAction(FExecuteAction::CreateLambda([]()\n        {\n            // do action\n        })));\n    })\n);\n\nFModuleManager::LoadModuleChecked&lt;FLevelEditorModule&gt;(\"LevelEditor\").GetMenuExtensibilityManager()-&gt;AddExtender(MenuExtender);\n</code></pre>\n<p>}\n```</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-extend_menu/overall.png\"></p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-12-25T17:20:26+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/contact-and-subscribe/",
            "url": "https://wiki.disenone.site/contact-and-subscribe/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Contact and Subscribe",
            "content_html": "<h1>Contact and Subscribe</h1>\n<!-- no translate -->\n\n<p><a href=\"https://github.com/disenone\"><img alt=\"badge\" src=\"https://img.shields.io/badge/GitHub-282c34?&amp;style=for-the-badge\"></a>\n<a href=\"mailto:disenonec@gmail.com\"><img alt=\"badge\" src=\"https://img.shields.io/badge/Email-f48222?&amp;style=for-the-badge\"></a></p>\n<p><a href=\"https://wiki.disenone.site/sitemap.xml\"><img alt=\"badge\" src=\"https://img.shields.io/badge/Sitemap-green?&amp;style=flat-square\">{ loading=lazy }</a>\n<a href=\"https://wiki.disenone.site/feed_rss_created.xml\"><img alt=\"badge\" src=\"https://img.shields.io/badge/RSS-post%20created-pcf?&amp;style=flat-square\">{ loading=lazy }</a>\n<a href=\"https://wiki.disenone.site/feed_rss_updated.xml\"><img alt=\"badge\" src=\"https://img.shields.io/badge/RSS-post%20updated-yellowgreen?&amp;style=flat-square\">{ loading=lazy }</a></p>",
            "image": null,
            "date_published": "2023-12-02T05:09:54+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/ue-%E4%BD%BF%E7%94%A8FASTBuild%E7%BC%96%E8%AF%91UE4%E5%92%8CUE5/",
            "url": "https://wiki.disenone.site/ue-%E4%BD%BF%E7%94%A8FASTBuild%E7%BC%96%E8%AF%91UE4%E5%92%8CUE5/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "\u4f7f\u7528 FASTBuild \u7f16\u8bd1 UE4 \u548c UE5",
            "content_html": "<p><meta property=\"og:title\" content=\"\u4f7f\u7528 FASTBuild \u7f16\u8bd1 UE4 \u548c UE5\" /></p>\n<!-- no translate -->\n\n<blockquote>\n<p>\u672c\u6587\u65b9\u6cd5\u7ecf\u6d4b\u8bd5\u652f\u6301 UE4.27 - UE5.3\uff0c\u5176\u4ed6\u7248\u672c\u672a\u6d4b\u8bd5\u8fc7\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u3002</p>\n</blockquote>\n<h2>\u524d\u8a00</h2>\n<p><a href=\"https://www.fastbuild.org/docs/home.html\">FASTBuild</a> \u662f\u4e00\u4e2a\u514d\u8d39\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u7f16\u8bd1\u5de5\u5177\uff0cUE \u672c\u8eab\u7f16\u8bd1\u6bd4\u8f83\u8017\u65f6\uff0c\u5982\u679c\u53ef\u4ee5\u7528\u4e0a FASTBuild\uff0c\u80fd\u591f\u5927\u5927\u51cf\u5c11\u8017\u65f6\u3002</p>\n<p>UE \u4ece 4.x \u5f00\u59cb\u80fd\u591f\u652f\u6301 FASTBuild\uff0c\u5b98\u65b9\u6e90\u7801\u81ea\u5e26\u4e86\u9b54\u6539\u8fc7\u7684 FASTBuild \u5de5\u5177\uff0c\u57fa\u4e8e FASTBuild 0.99 \u7248\u672c\uff0c\u4f4d\u7f6e\u5728 <code>Engine\\Extras\\ThirdPartyNotUE\\FASTBuild</code>\uff0cUE5.3 \u540c\u6837\u4f7f\u7528\u7684\u662f\u8fd9\u4e2a\u7248\u672c\u3002\u8fd9\u4e2a\u5df2\u7ecf\u662f\u6bd4\u8f83\u4e45\u4ee5\u524d\u7684\u7248\u672c\u4e86\uff0c\u622a\u6b62\u672c\u6587\u521b\u5efa\u65f6\u95f4\uff0cFASTBuild \u5b98\u65b9\u6700\u65b0\u7248\u672c\u662f 1.11\uff0c\u6709\u4e86\u66f4\u591a\u65b0\u7684\u529f\u80fd\u652f\u6301\u548c bug \u4fee\u590d\u3002\u672c\u6587\u7740\u91cd\u8bb0\u5f55\u5982\u4f55\u4f7f\u7528 1.11 \u7248\u672c\u540c\u65f6\u652f\u6301 UE4 \u548c UE5\u3002</p>\n<h2>\u7b80\u6613\u914d\u7f6e</h2>\n<p>\u8981\u8fbe\u5230\u76ee\u7684\uff0c\u6211\u4eec\u9700\u8981\u5bf9 FASTBuild 1.11 \u548c UE \u6e90\u7801\u505a\u4e00\u4e9b\u4fee\u6539\u3002\u5728\u8fd9\u91cc\uff0c\u5176\u5b9e\u6211\u5df2\u7ecf\u90fd\u4fee\u6539\u5b8c\u4e86\uff0c\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u7528\u6211\u4fee\u6539\u5b8c\u7684\u7248\u672c\u6765\u4f7f\u7528\u3002</p>\n<p>FASTBuild \u4e0b\u8f7d\u6211\u63d0\u4ea4\u7684 <a href=\"https://github.com/disenone/fastbuild/releases\">\u6700\u65b0\u7248\u672c</a> \u91cc\u9762\u7684\u6267\u884c\u6587\u4ef6 FBuild.exe, FBuildCoordinator.exe, FBuildWorker.exe\u3002\u4e3a\u4e86\u6e05\u6670\u8868\u8fbe\uff0c\u4e0b\u9762\u628a\u4f7f\u7528 FBuild.exe \u6765\u8fdb\u884c\u7f16\u7a0b\u7684\u673a\u5668\u53eb\u505a<code>\u672c\u673a</code>\uff0c\u5176\u4ed6\u63d0\u4f9b CPU \u53c2\u4e0e\u7f16\u8f91\u7684\u8fdc\u7a0b\u673a\u5668\u53eb\u505a<code>\u8fdc\u7a0b\u673a</code>\u3002</p>\n<h3>\u672c\u673a\u914d\u7f6e</h3>\n<p>\u628a FBuild.exe \u6240\u5728\u76ee\u5f55\u52a0\u5165\u7cfb\u7edf\u73af\u5883\u53d8\u91cf Path \u4e2d\uff0c\u4fdd\u8bc1 cmd \u91cc\u9762\u80fd\u76f4\u63a5\u6267\u884c FBuild.exe\u3002</p>\n<p>\u914d\u7f6e Cache \u5171\u4eab\u76ee\u5f55\uff08\u5982\u679c\u4e0d\u9700\u8981\u751f\u6210 Cache \u7684\u8bdd\uff0c\u53ef\u4ee5\u4e0d\u914d\u7f6e\uff09\uff1a\u628a\u4e00\u4e2a\u7a7a\u76ee\u5f55\u8bbe\u7f6e\u6210\u5171\u4eab\u8def\u5f84\uff0c\u5e76\u786e\u8ba4\u8fdc\u7a0b\u673a\u53ef\u4ee5\u8bbf\u95ee\u3002</p>\n<p>\u6253\u5f00\u672c\u673a UE4 / UE5 \u7684\u6e90\u7801\u9879\u76ee\uff0c\u4fee\u6539\u7f16\u8bd1\u914d\u7f6e\u6587\u4ef6 Engine\\Saved\\UnrealBuildTool\\BuildConfiguration.xml \u5982\u4e0b\uff1a</p>\n<p>```xml</p>\n<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<p><Configuration xmlns=\"https://www.unrealengine.com/BuildConfiguration\">\n    <BuildConfiguration>\n        <bAllowFASTBuild>true</bAllowFASTBuild>\n    </BuildConfiguration>\n    <FASTBuild>\n        <bEnableDistribution>true</bEnableDistribution>\n        <bEnableCaching>true</bEnableCaching>\n        <FBuildCachePath>\\127.0.0.1\\Cache\\</FBuildCachePath>\n        <FBuildCoordinator>127.0.0.1</FBuildCoordinator>\n    </FASTBuild>\n</Configuration>\n```</p>\n<p>\u672c\u673a\u8fd0\u884c\u4e4b\u524d\u4e0b\u8f7d\u7684 FBuildCoordinator.exe\u3002</p>\n<h3>\u8fdc\u7a0b\u673a\u914d\u7f6e</h3>\n<p>\u540c\u6837\u914d\u7f6e Cache\uff0c\u53ea\u662f ip \u9700\u8981\u6307\u5b9a\u5230\u672c\u673a ip\uff0c\u8fd9\u91cc\u5047\u5b9a\u4e3a 192.168.1.100</p>\n<ul>\n<li>FASTBUILD_CACHE_PATH: \\192.168.1.100\\Cache</li>\n<li>FASTBUILD_CACHE_MODE: rw</li>\n</ul>\n<p>\u540c\u6837\u914d\u7f6e Coordinator ip</p>\n<ul>\n<li>FASTBUILD_COORDINATOR: 192.168.1.100</li>\n</ul>\n<p>\u914d\u7f6e\u5b8c\u5982\u4e0b\u56fe</p>\n<p><img alt=\"\" src=\"assets/img/2023-ue-fastbuild/remote_vars.png\"></p>\n<p>\u8fdc\u7a0b\u673a\u4e0a\u8fd0\u884c FBuildWorker.exe\uff0c\u5982\u679c\u914d\u7f6e\u6210\u529f\uff0c\u53ef\u4ee5\u770b\u5230\u672c\u673a\u7684 FBuildCoordinator.exe \u4e0a\u4f1a\u6253\u5370\u65e5\u5fd7\uff08\u8fd9\u91cc 192.168.1.101 \u662f\u8fdc\u7a0b\u673a\u7684 ip\uff09\uff1a</p>\n<p><code>FBuildCoordinator - v1.11-UE\n[2023-12-01-20:06:38] Listening on port 31392\n[2023-12-01-20:06:38] current [0] workers: []\n[2023-12-01-20:06:42] New worker available: 192.168.1.101\n[2023-12-01-20:06:42] current [1] workers: [192.168.1.101]</code></p>\n<h3>\u6d4b\u8bd5 UE \u7f16\u8bd1</h3>\n<p>\u7528 VisualStudio \u6253\u5f00 UE \u6e90\u7801\u5de5\u7a0b sln\uff0c\u9009\u4e00\u4e2a C++ \u7684\u9879\u76ee\uff0c\u70b9\u51fb Rebuild\u3002\u5982\u679c\u914d\u7f6e\u6b63\u5e38\uff0c\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u5982\u4e0b\u7684\u65e5\u5fd7</p>\n<p><code>11&gt;FBuild Command Line Arguments: '-monitor -summary -dist -cache -ide -j12 -clean -config \"E:\\UE\\ue5.3_git\\Engine\\Intermediate\\Build\\fbuild.bff\" -nostoponerror\n11&gt;FBuild Executable: 'd:\\libs\\FASTBuild\\bin\\FBuild.exe\n11&gt;FBuild Coordinator: '127.0.0.1\n11&gt;FBuild BrokeragePath: '\\\\127.0.0.1\\Brokerage\\\n11&gt;FBuild CachePath: '\\\\127.0.0.1\\Cache\\\n11&gt;BFF file 'E:\\UE\\ue5.3_git\\Engine\\Intermediate\\Build\\fbuild.bff' has changed (reparsing will occur).\n11&gt;Using Coordinator: 127.0.0.1\n11&gt;Requesting worker list from Corrdinator\n11&gt;Get Worker List from Coordinator.\n11&gt;2 workers in payload: [192.168.1.101]\n11&gt;Worker list received: 1 workers\n11&gt;Distributed Compilation : 1 Workers in pool '127.0.0.1'</code></p>\n<p>FASTBuild \u80fd\u627e\u5230\u8fdc\u7a0b\u673a\u7684 ip\uff0c\u5e76\u5f00\u59cb\u7ed9\u8fdc\u7a0b\u673a\u53d1\u9001\u7f16\u8bd1\u3002\u5728\u8fdc\u7a0b\u673a\u7684 FBuildWorker \u4e0a\u4e5f\u80fd\u770b\u5230\u5f53\u524d\u6709\u7f16\u8bd1\u4efb\u52a1\u5728\u6267\u884c\u3002</p>\n<h2>\u8fdb\u9636\u914d\u7f6e</h2>\n<h3>\u652f\u6301\u66f4\u4e45\u7248\u672c\u7684 UE</h3>\n<p>\u5982\u679c\u4f60\u53d1\u73b0\u81ea\u5df1\u7684 UE \u6ca1\u6709 FASTBuild \u5de5\u5177\uff08Engine\\Extras\\ThirdPartyNotUE\\FASTBuild\uff09\uff0c\u5e76\u4e14\u9879\u76ee UnrealBuildTool \u91cc\u9762\u6ca1\u6709 FASTBuild.cs \u6587\u4ef6\uff0c\u90a3\u4e48\u5f88\u5927\u6982\u7387\u662f\u4f60\u7684 UE \u7248\u672c\u8fd8\u4e0d\u652f\u6301 FASTBuild\u3002</p>\n<p>\u90a3\u4e48\u4f60\u9700\u8981\u53c2\u8003 UE4.27 \u7684\u6e90\u7801\uff0c\u4e5f\u521b\u5efa\u4e00\u4e2a\u7c7b\u4f3c\u7684 FASTBuild.cs\uff0c\u5e76\u8865\u4e0a\u5176\u4ed6\u76f8\u5173\u4ee3\u7801\u7684\u4fee\u6539\uff0c\u8fd9\u91cc\u4e0d\u8be6\u8ff0\u3002</p>\n<h3>\u7f16\u8bd1\u81ea\u5df1\u7684 FASTBuild</h3>\n<p>\u5982\u679c\u4f60\u5bf9 FASTBuild \u672c\u8eab\u4e5f\u611f\u5174\u8da3\uff0c\u6216\u8005\u60f3\u8981\u505a\u4e00\u4e9b\u4fee\u6539\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u7528 FASTBuild \u6765\u7f16\u8bd1 FASTBuild\u3002</p>\n<ul>\n<li>\u4e0b\u8f7d\u6211\u7684 <a href=\"https://github.com/disenone/fastbuild/releases\">\u6700\u65b0\u6e90\u7801</a>\uff0c\u5e76\u89e3\u538b</li>\n<li>\n<p>\u4fee\u6539 External\\SDK\\VisualStudio\\VS2019.bff\uff0c\u628a .VS2019_BasePath \u548c .VS2019_Version \u4fee\u6539\u6210\u4f60\u672c\u673a\u5bf9\u5e94\u7684\u5185\u5bb9\uff0cVersion \u53ef\u4ee5\u5728 .VS2019_BasePath\\Tools\\MSVC \u76ee\u5f55\u4e0b\u9762\u770b\uff0c\u4f8b\u5982\n    <code>.VS2019_BasePath        = 'C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\VC'    // &lt;-- Set path here\n    .VS2019_Version         = '14.29.30133' // &lt;-- Set version here\n    .VS2019_MSC_VER         = '1929' // &lt;-- Set MSC_VER here</code></p>\n</li>\n<li>\n<p>\u4fee\u6539 External\\SDK\\Windows\\Windows10SDK.bff \u7684 .Windows10_SDKBasePath \u548c .Windows10_SDKVersion\uff0c\u7248\u672c\u53ef\u4ee5\u5728 .Windows10_SDKBasePath/bin \u91cc\u9762\u770b\uff1a\n    <code>.Windows10_SDKBasePath        = 'C:\\Program Files (x86)\\Windows Kits/10'    // &lt;-- Set path here\n    .Windows10_SDKVersion         = '10.0.19041.0' // &lt;-- Set version here</code></p>\n</li>\n<li>\n<p>\u4fee\u6539 External\\SDK\\Clang\\Windows\\Clang11.bff \u7684 .Clang11_BasePath \u548c .Clang11_Version\uff0c\u8def\u5f84\u5728 .VS2019_BasePath\\Tools\\Tools/LLVM/x64\n    <code>.Clang11_BasePath = 'C:/Program Files (x86)/Microsoft Visual Studio/2019/Professional/VC/Tools/LLVM/x64'    // &lt;-- Set path here\n    .Clang11_Version  = '12.x.x'</code></p>\n</li>\n<li>\n<p>\u8fdb\u5165 Code \u76ee\u5f55\uff0c\u5728 cmd \u6267\u884c <code>FBuild.exe All-x64-Release</code>\uff0c\u5982\u679c\u914d\u7f6e\u6b63\u5e38\uff0c\u53ef\u4ee5\u770b\u5230\u7f16\u8bd1\u6210\u529f\uff0c\u5728 tmp\\x64-Release\\Tools\\FBuild\\FBuild \u80fd\u770b\u5230 FBuild.exe\u3002</p>\n</li>\n<li>\n<p><code>FBuild.exe All-x64-Release -dist -coordinator=127.0.0.1</code> \u53ef\u4ee5\u5f00\u542f\u5206\u5e03\u5f0f\u7f16\u8bd1\u3002</p>\n</li>\n</ul>\n<h3>FBuild \u66f4\u591a\u9009\u9879</h3>\n<p>\u6211\u63d0\u4f9b\u7684 FBuild \u672c\u8eab\u652f\u6301\u4ee5\u4e0b\u5e38\u7528\u7684\u9009\u9879\uff1a</p>\n<ul>\n<li>coordinator: \u6307\u5b9a Coordinator ip \u5730\u5740\uff08\u53ef\u4ee5\u8986\u76d6\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u7684\u503c\uff09</li>\n<li>brokerage: \u6307\u5b9a Brokerage \u5730\u5740\uff08\u53ef\u4ee5\u8986\u76d6\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u7684\u503c\uff09</li>\n<li>nocache\uff1a\u5f3a\u5236\u4e0d\u4f7f\u7528 cache</li>\n<li>dist\uff1a\u5f00\u542f\u5206\u5e03\u5f0f\u7f16\u8bd1</li>\n<li>forceremote\uff1a\u5f3a\u5236\u5728\u8fdc\u7a0b\u673a\u7f16\u8bd1</li>\n<li>summary: \u7f16\u8f91\u7ed3\u675f\u540e\u8f93\u51fa\u7edf\u8ba1\u62a5\u544a</li>\n</ul>\n<p>\u7b49\u7b49\uff0c\u66f4\u591a\u9009\u9879\u53ef\u4ee5\u8fd0\u884c <code>FBuild.exe -help</code> \u6765\u770b\u3002</p>\n<p>FBuildWorker \u5e38\u7528\u7684\u9009\u9879\u6709\uff1a</p>\n<ul>\n<li>coordinator: \u6307\u5b9a Coordinator ip \u5730\u5740\uff08\u53ef\u4ee5\u8986\u76d6\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u7684\u503c\uff09</li>\n<li>brokerage: \u6307\u5b9a Brokerage \u5730\u5740\uff08\u53ef\u4ee5\u8986\u76d6\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u7684\u503c\uff09</li>\n<li>nocache\uff1a\u5f3a\u5236\u4e0d\u4f7f\u7528 cache</li>\n<li>cpus: \u6307\u5b9a\u5206\u914d\u591a\u5c11\u4e2a\u6838\u53c2\u4e0e\u7f16\u8bd1</li>\n</ul>\n<p>\u66f4\u591a\u9009\u9879\u53ef\u4ee5\u8fd0\u884c <code>FBuildWorder.exe -help</code> \u6765\u770b\u3002</p>\n<h3>\u4fee\u6539 UE \u81ea\u5e26\u7684 FASTBuild.cs</h3>\n<p>UE \u81ea\u5e26\u7684 FASTBuild.cs \u5e76\u6ca1\u6709\u5f88\u597d\u7684\u5904\u7406\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\uff0c\u8ddf BuildConfiguration.xml \u6307\u5b9a\u7684\u53c2\u6570\u7684\u5173\u7cfb\uff0c\u5f88\u591a\u53c2\u6570\u662f\u4f18\u5148\u8bfb\u53d6\u4e86\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\uff0c\u8fd9\u663e\u7136\u8ddf BuildConfiguration.xml \u7684\u4f7f\u7528\u903b\u8f91\u662f\u76f8\u53cd\u7684\u3002</p>\n<p>\u4e3a\u6b64\uff0c\u53ef\u4ee5\u628a\u76f8\u5173\u7684\u4ee3\u7801\u6539\u6210\u8fd9\u6837\uff0c\u8fd9\u91cc\u4ee5 UE5.3 \u4e3a\u4f8b\uff1a</p>\n<p>```csharp\nprivate bool ExecuteBffFile(string BffFilePath, ILogger Logger)\n{\n    string CacheArgument = \"\";</p>\n<pre><code>if (bEnableCaching)\n{\n    switch (CacheMode)\n    {\n        case FASTBuildCacheMode.ReadOnly:\n            CacheArgument = \"-cacheread\";\n            break;\n        case FASTBuildCacheMode.WriteOnly:\n            CacheArgument = \"-cachewrite\";\n            break;\n        case FASTBuildCacheMode.ReadWrite:\n            CacheArgument = \"-cache\";\n            break;\n    }\n}\nelse\n{\n    CacheArgument = \"-nocache\";\n}\n\nstring DistArgument = bEnableDistribution ? \"-dist\" : \"\";\nstring ForceRemoteArgument = bForceRemote ? \"-forceremote\" : \"\";\nstring NoStopOnErrorArgument = bStopOnError ? \"\" : \"-nostoponerror\";\nstring IDEArgument = IsApple() ? \"\" : \"-ide\";\nstring MaxProcesses = \"-j\" + ((ParallelExecutor)LocalExecutor).NumParallelProcesses;\n\n// Interesting flags for FASTBuild:\n// -nostoponerror, -verbose, -monitor (if FASTBuild Monitor Visual Studio Extension is installed!)\n// Yassine: The -clean is to bypass the FASTBuild internal\n// dependencies checks (cached in the fdb) as it could create some conflicts with UBT.\n// Basically we want FB to stupidly compile what UBT tells it to.\nstring FBCommandLine = $\"-monitor -summary {DistArgument} {CacheArgument} {IDEArgument} {MaxProcesses} -clean -config \\\"{BffFilePath}\\\" {NoStopOnErrorArgument} {ForceRemoteArgument}\";\n\nLogger.LogInformation(\"FBuild Command Line Arguments: '{FBCommandLine}\", FBCommandLine);\n\nstring FBExecutable = GetExecutablePath()!;\nLogger.LogInformation(\"FBuild Executable: '{FBExecutable}\", FBExecutable);\n\nstring WorkingDirectory = Path.GetFullPath(Path.Combine(Unreal.EngineDirectory.MakeRelativeTo(DirectoryReference.GetCurrentDirectory()), \"Source\"));\n\nProcessStartInfo FBStartInfo = new ProcessStartInfo(FBExecutable, FBCommandLine);\nFBStartInfo.UseShellExecute = false;\nFBStartInfo.WorkingDirectory = WorkingDirectory;\nFBStartInfo.RedirectStandardError = true;\nFBStartInfo.RedirectStandardOutput = true;\n\nstring? Coordinator = GetCoordinator();\nif (!String.IsNullOrEmpty(Coordinator))\n{\n    Logger.LogInformation(\"FBuild Coordinator: '{Coordinator}\", Coordinator);\n    FBStartInfo.EnvironmentVariables[\"FASTBUILD_COORDINATOR\"] = Coordinator;\n}\n\nstring? BrokeragePath = GetBrokeragePath();\nif (!String.IsNullOrEmpty(BrokeragePath))\n{\n    Logger.LogInformation(\"FBuild BrokeragePath: '{BrokeragePath}\", BrokeragePath);\n    FBStartInfo.EnvironmentVariables[\"FASTBUILD_BROKERAGE_PATH\"] = BrokeragePath;\n}\n\nstring? CachePath = GetCachePath();\nif (!String.IsNullOrEmpty(CachePath))\n{\n    Logger.LogInformation(\"FBuild CachePath: '{CachePath}\", CachePath);\n    FBStartInfo.EnvironmentVariables[\"FASTBUILD_CACHE_PATH\"] = CachePath;\n}\n</code></pre>\n<p>...\n```</p>\n<h3>BuildConfiguration.xml \u8fdb\u9636\u914d\u7f6e</h3>\n<p>```xml</p>\n<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<p><Configuration xmlns=\"https://www.unrealengine.com/BuildConfiguration\">\n    <ProjectFileGenerator>\n        <!-- \u6307\u5b9avs\u7248\u672c -->\n        <Format>VisualStudio2022</Format> <br>\n    </ProjectFileGenerator>\n    <BuildConfiguration>\n        <!-- \u5f00\u542f FASTBuild -->\n        <bAllowFASTBuild>true</bAllowFASTBuild>\n        <!-- \u6307\u5b9a\u672c\u673a\u53c2\u4e0e\u7f16\u8bd1\u7684 cpu \u6838\u6570 -->\n        <MaxParallelActions>12</MaxParallelActions>\n        <!-- \u5173\u95ed Incredibuild -->\n        <bAllowXGE>false</bAllowXGE>\n    </BuildConfiguration>\n    <FASTBuild>\n        <!-- \u6307\u5b9a FBuild \u8def\u5f84 -->\n        <FBuildExecutablePath>d:\\libs\\FASTBuild\\bin\\FBuild.exe</FBuildExecutablePath>\n        <!-- \u5f00\u542f\u5206\u5e03\u5f0f\u7f16\u8bd1 -->\n        <bEnableDistribution>true</bEnableDistribution>\n        <!-- \u6307\u5b9a brokerage \u8def\u5f84 -->\n        <FBuildBrokeragePath>\\127.0.0.1\\Brokerage\\</FBuildBrokeragePath>\n        <!-- \u6307\u5b9a cache \u8def\u5f84 -->\n        <FBuildCachePath>\\127.0.0.1\\Cache\\</FBuildCachePath>\n        <!-- \u5f00\u542f cache -->\n        <bEnableCaching>true</bEnableCaching>\n        <!-- cache \u7684\u8bfb\u5199\u6743\u9650 Read/Write/ReadWrite -->\n        <CacheMode>ReadWrite</CacheMode>\n        <!-- \u6307\u5b9a coordinator ip -->\n        <FBuildCoordinator>127.0.0.1</FBuildCoordinator>\n        <!-- \u5f3a\u5236\u8fdc\u7a0b\u7f16\u8bd1 -->\n        <!-- <bForceRemote>true</bForceRemote> -->\n    </FASTBuild>\n</Configuration>\n```</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-12-01T00:00:00+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/ue-%E9%80%9A%E8%BF%87%E6%8F%92%E4%BB%B6%E6%BA%90%E7%A0%81%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6/",
            "url": "https://wiki.disenone.site/ue-%E9%80%9A%E8%BF%87%E6%8F%92%E4%BB%B6%E6%BA%90%E7%A0%81%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "UE \u901a\u8fc7\u63d2\u4ef6\u6e90\u7801\u6dfb\u52a0\u63d2\u4ef6",
            "content_html": "<p><meta property=\"og:title\" content=\"UE \u901a\u8fc7\u63d2\u4ef6\u6e90\u7801\u6dfb\u52a0\u63d2\u4ef6\" /></p>\n<h1>UE \u901a\u8fc7\u63d2\u4ef6\u6e90\u7801\u6dfb\u52a0\u63d2\u4ef6</h1>\n<h1>\u6dfb\u52a0\u63d2\u4ef6</h1>\n<blockquote>\n<p>\u7b80\u5355\u8bb0\u5f55\u4e00\u4e0b\u5982\u4f55\u5728\u62e5\u6709\u63d2\u4ef6\u6e90\u7801\u7684\u60c5\u51b5\u4e0b\u6dfb\u52a0\u63d2\u4ef6.</p>\n</blockquote>\n<p>\u4ee5\u63d2\u4ef6 <a href=\"https://github.com/disenone/UE.EditorPlus\">UE.EditorPlus</a> \u4e3a\u4f8b</p>\n<ul>\n<li>\u628a\u6e90\u7801\u653e\u5230 Plugins \u76ee\u5f55\u4e0b</li>\n<li>\uff08\u8fd9\u4e00\u6b65\u53ef\u4ee5\u4e0d\u6267\u884c\uff09\u4fee\u6539\u9879\u76ee .uproject \u6587\u4ef6\uff0cPlugins \u5b57\u6bb5\u4e0b\u589e\u52a0\uff1a\n    <code>json\n        \"Plugins\": [\n        {\n            \"Name\": \"EditorPlus\",\n            \"Enabled\": true,\n            \"TargetAllowList\": [\n                \"Editor\"\n            ]\n        }</code></li>\n<li>\u53f3\u952e uproject \u6587\u4ef6\uff0c\u6267\u884c \"Generate Visual Studio Project Files\"\uff0c\u66f4\u65b0 sln \u9879\u76ee\u6587\u4ef6</li>\n<li>\u6253\u5f00 sln \u6587\u4ef6\uff0c\u7f16\u8bd1\u9879\u76ee</li>\n</ul>\n<h1>\u8bbe\u7f6e\u591a\u8bed\u8a00</h1>\n<p>\u4fee\u6539\u9879\u76ee\u7684\u914d\u7f6e\u6587\u4ef6 <code>DefaultEditor.ini</code>\uff0c\u52a0\u4e0a\u65b0\u8def\u5f84\uff1a</p>\n<p><code>ini\n[Internationalization]\n+LocalizationPaths=%GAMEDIR%Plugins/UE.EditorPlus/Content/Localization/EditorPlusTools</code></p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-12-01T00:00:00+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/",
            "url": "https://wiki.disenone.site/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Home",
            "content_html": "<!-- no translate -->\n\n<h1>Disenone's Wiki</h1>\n<p><a href=\"https://github.com/disenone/wiki/actions\"><img alt=\"badge\" src=\"https://github.com/disenone/wiki/actions/workflows/Build.yml/badge.svg?label=Build&amp;style=flat-square\">{ loading=lazy }</a>\n<a href=\"https://github.com/disenone/wiki/commits/main\"><img alt=\"badge\" src=\"https://img.shields.io/github/last-commit/disenone/wiki?color=FCD734&amp;label=Last%20commit&amp;style=flat-square\">{ loading=lazy }</a>\n<a href=\"contact-and-subscribe\"><img alt=\"badge\" src=\"https://img.shields.io/badge/Contact%20%26%20Subscribe-me-34ABE0?&amp;style=flat-square\">{ loading=lazy }</a></p>\n<blockquote>\n<p>\u65e0\u6b62\u5883</p>\n</blockquote>\n<p>Hi there~ \u6b22\u8fce\u6765\u5230\u6211\u7684\u77e5\u8bc6\u5e93\u3002</p>\n<p>\u4e3a\u4e86\u907f\u514d\u9057\u5fd8\u3001\u4fbf\u4e8e\u5206\u4eab\uff0c\u6211\u5728\u8fd9\u91cc\u6536\u5f55\u77e5\u8bc6\u3002\n\u8bf7\u968f\u610f\u6d4f\u89c8\uff5e</p>\n<p><a href=\"cpp-C\u548cCpp\u7684\u547d\u4ee4\u884c\u53c2\u6570\u5904\u7406\u603b\u7ed3\">\u7f16\u7a0b\u6280\u672f</a>{ .md-button }\n<a href=\"game-\u6e38\u620fAOI\u7b97\u6cd5\u89e3\u6790\u548c\u6027\u80fd\u5b9e\u6d4b\">\u6e38\u620f\u5f00\u53d1</a>{ .md-button }</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/cpp-C%E5%92%8CCpp%E5%AE%8F%E7%BC%96%E7%A8%8B%E8%A7%A3%E6%9E%90/",
            "url": "https://wiki.disenone.site/cpp-C%E5%92%8CCpp%E5%AE%8F%E7%BC%96%E7%A8%8B%E8%A7%A3%E6%9E%90/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "C/C++ \u5b8f\u7f16\u7a0b\u89e3\u6790",
            "content_html": "<p><meta property=\"og:title\" content=\"C/C++ \u5b8f\u7f16\u7a0b\u89e3\u6790\" /></p>\n<p>\u672c\u6587\u7684\u76ee\u7684\u662f\u8981\u8bb2\u6e05\u695a C/C++ \u7684\u5b8f\u7f16\u7a0b\u7684\u89c4\u5219\u548c\u5b9e\u73b0\u65b9\u6cd5\uff0c\u8ba9\u4f60\u4e0d\u518d\u60e7\u6015\u770b\u5230\u4ee3\u7801\u91cc\u9762\u7684\u5b8f\u3002\u6211\u4f1a\u9996\u5148\u8bf4\u8bf4 C++ \u6807\u51c6 14 \u91cc\u9762\u63d0\u5230\u7684\u5173\u4e8e\u5b8f\u5c55\u5f00\u7684\u89c4\u5219\uff0c\u7136\u540e\u901a\u8fc7\u4fee\u6539 Clang \u7684\u6e90\u7801\u6765\u89c2\u5bdf\u5b8f\u5c55\u5f00\uff0c\u6700\u540e\u57fa\u4e8e\u8fd9\u4e9b\u77e5\u8bc6\u6765\u804a\u804a\u5b8f\u7f16\u7a0b\u7684\u5b9e\u73b0\u3002</p>\n<p>\u672c\u6587\u7684\u4ee3\u7801\u5168\u90e8\u90fd\u5728\u8fd9\u91cc\uff1a<a href=\"assets/img/2021-3-31-cpp-preprocess/macros.cpp\">\u4e0b\u8f7d</a>\uff0c<a href=\"https://godbolt.org/z/coWvc5Pse\">\u5728\u7ebf\u6f14\u793a</a>\u3002</p>\n<h2>\u5f15\u5b50</h2>\n<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6267\u884c\u547d\u4ee4 <code>gcc -P -E a.cpp -o a.cpp.i</code> \u6765\u8ba9\u7f16\u8bd1\u5668\u5bf9\u6587\u4ef6 <code>a.cpp</code> \u53ea\u6267\u884c\u9884\u5904\u7406\u5e76\u4fdd\u5b58\u7ed3\u679c\u5230 <code>a.cpp.i</code> \u4e2d\u3002</p>\n<p>\u9996\u5148\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e9b\u4f8b\u5b50:</p>\n<h4>\u9012\u5f52\u91cd\u5165\uff08Reentrancy\uff09</h4>\n<p>``` cpp</p>\n<h1>define ITER(arg0, arg1) ITER(arg1, arg0)</h1>\n<p>ITER(1, 2)          // -&gt; ITER(2, 1)\n```</p>\n<p>\u5b8f <code>ITER</code> \u4ea4\u6362\u4e86 <code>arg0</code>, <code>arg1</code> \u7684\u4f4d\u7f6e\u3002\u5b8f\u5c55\u5f00\u4e4b\u540e\uff0c\u5f97\u5230\u7684\u662f <code>ITER(2, 1)</code>\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c<code>arg0</code> <code>arg1</code> \u7684\u4f4d\u7f6e\u6210\u529f\u4ea4\u6362\uff0c\u5728\u8fd9\u91cc\u5b8f\u6210\u529f\u5c55\u5f00\u4e86\u4e00\u6b21\uff0c\u4f46\u4e5f\u53ea\u5c55\u5f00\u4e86\u4e00\u6b21\uff0c\u4e0d\u518d\u9012\u5f52\u91cd\u5165\u3002\u6362\u8a00\u4e4b\uff0c\u5b8f\u7684\u5c55\u5f00\u8fc7\u7a0b\u4e2d\uff0c\u662f\u4e0d\u53ef\u81ea\u8eab\u9012\u5f52\u91cd\u5165\u7684\uff0c\u5982\u679c\u5728\u9012\u5f52\u7684\u8fc7\u7a0b\u4e2d\u53d1\u73b0\u76f8\u540c\u7684\u5b8f\u5728\u4e4b\u524d\u7684\u9012\u5f52\u4e2d\u5df2\u7ecf\u5c55\u5f00\u8fc7\uff0c\u5219\u4e0d\u518d\u5c55\u5f00\uff0c\u8fd9\u662f\u5b8f\u5c55\u5f00\u7684\u5176\u4e2d\u4e00\u6761\u91cd\u8981\u7684\u89c4\u5219\u3002\u7981\u6b62\u9012\u5f52\u91cd\u5165\u7684\u539f\u56e0\u4e5f\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u4e3a\u4e86\u907f\u514d\u65e0\u9650\u9012\u5f52\u3002</p>\n<h4>\u5b57\u7b26\u4e32\u62fc\u63a5</h4>\n<p>``` cpp</p>\n<h1>define CONCAT(arg0, arg1) arg0 ## arg1</h1>\n<p>CONCAT(Hello, World)                // -&gt; HelloWorld\nCONCAT(Hello, CONCAT(World, !))     // -&gt;\u3000HelloCONCAT(World, !)\n```</p>\n<p>\u5b8f <code>CONCAT</code> \u76ee\u7684\u662f\u62fc\u63a5 <code>arg0</code> <code>arg1</code>\u3002\u5b8f\u5c55\u5f00\u4e4b\u540e\uff0c<code>CONCAT(Hello, World)</code> \u80fd\u591f\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c <code>HelloWorld</code>\u3002\u4f46\u662f <code>CONCAT(Hello, CONCAT(World, !))</code> \u5374\u53ea\u5c55\u5f00\u4e86\u5916\u5c42\u7684\u5b8f\uff0c\u5185\u5c42\u7684 <code>CONCAT(World, !)</code> \u5e76\u6ca1\u6709\u5c55\u5f00\u800c\u662f\u76f4\u63a5\u8ddf <code>Hello</code> \u62fc\u63a5\u5728\u4e00\u8d77\u4e86\uff0c\u8fd9\u8ddf\u6211\u4eec\u9884\u60f3\u7684\u4e0d\u4e00\u6837\uff0c\u6211\u4eec\u771f\u6b63\u60f3\u8981\u7684\u7ed3\u679c\u662f <code>HelloWorld!</code>\u3002\u8fd9\u5c31\u662f\u5b8f\u5c55\u5f00\u7684\u53e6\u5916\u4e00\u6761\u91cd\u8981\u7684\u89c4\u5219\uff1a\u8ddf\u5728 <code>##</code> \u64cd\u4f5c\u7b26\u540e\u9762\u7684\u5b8f\u53c2\u6570\uff0c\u4e0d\u4f1a\u6267\u884c\u5c55\u5f00\uff0c\u800c\u662f\u4f1a\u76f4\u63a5\u8ddf\u524d\u9762\u7684\u5185\u5bb9\u5148\u62fc\u63a5\u5728\u4e00\u8d77\u3002</p>\n<p>\u901a\u8fc7\u4e0a\u9762\u4e24\u4e2a\u4f8b\u5b50\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u5b8f\u5c55\u5f00\u7684\u89c4\u5219\u6709\u4e00\u4e9b\u662f\u53cd\u76f4\u89c9\u7684\uff0c\u5982\u679c\u4e0d\u6e05\u695a\u5177\u4f53\u7684\u89c4\u5219\uff0c\u6709\u53ef\u80fd\u5199\u51fa\u6765\u7684\u5b8f\u8ddf\u6211\u4eec\u60f3\u8981\u7684\u6548\u679c\u4e0d\u4e00\u81f4\u3002</p>\n<h2>\u5b8f\u5c55\u5f00\u89c4\u5219</h2>\n<p>\u901a\u8fc7\u5f15\u5b50\u7684\u4e24\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u4e86\u89e3\u5230\u4e86\u5b8f\u5c55\u5f00\u662f\u6709\u4e00\u5957\u6807\u51c6\u7684\u89c4\u5219\u7684\uff0c\u8fd9\u5957\u89c4\u5219\u5b9a\u4e49\u5728 C/C++ \u6807\u51c6\u91cc\u9762\uff0c\u5185\u5bb9\u4e0d\u591a\uff0c\u5efa\u8bae\u5148\u4ed4\u7ec6\u8bfb\u51e0\u904d\uff0c\u6211\u8fd9\u91cc\u987a\u5e26\u7ed9\u4e0b\u6807\u51c6 n4296 \u7248\u672c\u7684\u94fe\u63a5\uff0c\u5b8f\u5c55\u5f00\u5728 16.3 \u8282\uff1a<a href=\"http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4296.pdf\">\u4f20\u9001\u95e8</a>\u3002\u4e0b\u9762\u6211\u6311\u51fa n4296 \u7248\u672c\u4e2d\u51e0\u6761\u91cd\u8981\u7684\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u4f1a\u51b3\u5b9a\u5982\u4f55\u6b63\u786e\u7f16\u5199\u5b8f\uff08\u8fd8\u662f\u5efa\u8bae\u62bd\u65f6\u95f4\u628a\u6807\u51c6\u91cc\u9762\u7684\u5b8f\u5c55\u5f00\u7ec6\u8bfb\u4e0b\uff09\u3002</p>\n<h4>\u53c2\u6570\u5206\u9694</h4>\n<p>\u5b8f\u7684\u53c2\u6570\u8981\u6c42\u662f\u7528\u9017\u53f7\u5206\u9694\uff0c\u800c\u4e14\u53c2\u6570\u7684\u4e2a\u6570\u9700\u8981\u8ddf\u5b8f\u5b9a\u4e49\u7684\u4e2a\u6570\u4e00\u81f4\uff0c\u4f20\u9012\u7ed9\u5b8f\u7684\u53c2\u6570\u4e2d\uff0c\u989d\u5916\u7528\u62ec\u53f7\u5305\u4f4f\u7684\u5185\u5bb9\u89c6\u4e3a\u4e00\u4e2a\u53c2\u6570\uff0c\u53c2\u6570\u5141\u8bb8\u4e3a\u7a7a\uff1a</p>\n<p>``` cpp</p>\n<h1>define ADD_COMMA(arg1, arg2) arg1, arg2</h1>\n<p>ADD_COMMA(a, b)             // -&gt; a, b\nADD_COMMA(a)                // \u62a5\u9519 \"macro \"MACRO\" requires 2 arguments, but only 1 given\"\nADD_COMMA((a, b), c)        // -&gt; (a, b), c\nADD_COMMA(, b)              // -&gt; , b\n```</p>\n<p><code>ADD_COMMA((a, b), c)</code> \u4e2d <code>(a, b)</code> \u89c6\u4e3a\u7b2c\u4e00\u4e2a\u53c2\u6570\u3002<code>ADD_COMMA(, b)</code> \u4e2d\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a\u7a7a\uff0c\u4e8e\u662f\u5c55\u5f00\u4e3a <code>, b</code>\u3002</p>\n<h4>\u5b8f\u53c2\u6570\u5c55\u5f00</h4>\n<p>\u5728\u5bf9\u5b8f\u8fdb\u884c\u5c55\u5f00\u7684\u65f6\u5019\uff0c\u5982\u679c\u5b8f\u7684\u53c2\u6570\u4e5f\u662f\u53ef\u4ee5\u5c55\u5f00\u7684\u5b8f\uff0c\u4f1a\u5148\u628a\u53c2\u6570\u5b8c\u5168\u5c55\u5f00\uff0c\u518d\u5c55\u5f00\u5b8f\uff0c\u4f8b\u5982</p>\n<p><code>cpp\nADD_COMMA(ADD_COMMA(1, 2), ADD_COMMA(3, 4))     // -&gt; 1, 2, 3, 4</code></p>\n<p>\u4e00\u822c\u60c5\u51b5\u4e0b\u7684\u5b8f\u5c55\u5f00\uff0c\u90fd\u53ef\u4ee5\u8ba4\u4e3a\u662f\u5148\u5bf9\u53c2\u6570\u6c42\u503c\uff0c\u518d\u5bf9\u5b8f\u6c42\u503c\uff0c\u9664\u975e\u9047\u5230\u4e86 <code>#</code> \u548c <code>##</code> \u64cd\u4f5c\u7b26\u3002</p>\n<h4><code>#</code> \u64cd\u4f5c\u7b26</h4>\n<p><code>#</code> \u64cd\u4f5c\u7b26\u540e\u9762\u8ddf\u7684\u5b8f\u53c2\u6570\uff0c\u4e0d\u4f1a\u8fdb\u884c\u5c55\u5f00\uff0c\u4f1a\u76f4\u63a5\u5b57\u7b26\u4e32\u5316\uff0c\u4f8b\u5982\uff1a</p>\n<p>``` cpp</p>\n<h1>define STRINGIZE(arg0) # arg0</h1>\n<p>STRINGIZE(a)                // -&gt; \"a\"\nSTRINGIZE(STRINGIZE(a))     // -&gt; \"STRINGIZE(a)\"\n```</p>\n<p>\u6839\u636e\u8fd9\u6761\u89c4\u5219 <code>STRINGIZE(STRINGIZE(a))</code> \u53ea\u80fd\u5c55\u5f00\u4e3a <code>\"STRINGIZE(a)\"</code>\u3002</p>\n<h4><code>##</code> \u64cd\u4f5c\u7b26</h4>\n<p><code>##</code> \u64cd\u4f5c\u7b26\u524d\u540e\u7684\u5b8f\u53c2\u6570\uff0c\u90fd\u4e0d\u4f1a\u8fdb\u884c\u5c55\u5f00\uff0c\u4f1a\u5148\u76f4\u63a5\u62fc\u63a5\u8d77\u6765\uff0c\u4f8b\u5982\uff1a</p>\n<p>``` cpp</p>\n<h1>define CONCAT(arg0, arg1) arg0 ## arg1</h1>\n<p>CONCAT(Hello, World)                        // -&gt; HelloWorld\nCONCAT(Hello, CONCAT(World, !))             // -&gt; HelloCONCAT(World, !)\nCONCAT(CONCAT(Hello, World) C, ONCAT(!))    // -&gt; CONCAT(Hello, World) CONCAT(!)\n```</p>\n<p><code>CONCAT(CONCAT(Hello, World) C, ONCAT(!))</code> \u53ea\u80fd\u662f\u5148\u62fc\u63a5\u5728\u4e00\u8d77\uff0c\u5f97\u5230 <code>CONCAT(Hello, World) CONCAT(!)</code>\u3002</p>\n<h4>\u91cd\u590d\u626b\u63cf</h4>\n<p>\u9884\u5904\u7406\u5668\u6267\u884c\u5b8c\u4e00\u6b21\u5b8f\u5c55\u5f00\u4e4b\u540e\uff0c\u4f1a\u91cd\u65b0\u626b\u63cf\u5f97\u5230\u7684\u5185\u5bb9\uff0c\u7ee7\u7eed\u5c55\u5f00\uff0c\u76f4\u5230\u6ca1\u6709\u53ef\u4ee5\u5c55\u5f00\u7684\u5185\u5bb9\u4e3a\u6b62\u3002</p>\n<p>\u4e00\u6b21\u5b8f\u5c55\u5f00\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u5148\u628a\u53c2\u6570\u5b8c\u5168\u5c55\u5f00\uff08\u9664\u975e\u9047\u5230 <code>#</code> \u548c <code>##</code>\uff09\uff0c\u518d\u6839\u636e\u5b8f\u7684\u5b9a\u4e49\uff0c\u628a\u5b8f\u548c\u5b8c\u5168\u5c55\u5f00\u540e\u7684\u53c2\u6570\u6309\u7167\u5b9a\u4e49\u8fdb\u884c\u66ff\u6362\uff0c\u518d\u5904\u7406\u5b9a\u4e49\u4e2d\u7684\u6240\u6709 <code>#</code> \u548c <code>##</code> \u64cd\u4f5c\u7b26\u3002</p>\n<p>``` cpp</p>\n<h1>define CONCAT(arg0, arg1) arg0 ## arg1</h1>\n<h1>define STRINGIZE(arg0) # arg0</h1>\n<p>CONCAT(STRING, IZE(Hello))        // -&gt; STRINGIZE(Hello) -&gt; \"Hello\"\n```</p>\n<p><code>CONCAT(STRING, IZE(Hello))</code> \u7b2c\u4e00\u6b21\u626b\u63cf\u5c55\u5f00\u5f97\u5230 <code>STRINGIZE(Hello)</code>\uff0c\u7136\u540e\u6267\u884c\u7b2c\u4e8c\u6b21\u626b\u63cf\uff0c\u53d1\u73b0 <code>STRINGIZE</code> \u53ef\u4ee5\u7ee7\u7eed\u5c55\u5f00\uff0c\u6700\u540e\u5f97\u5230 <code>\"Hello\"</code>\u3002</p>\n<h4>\u7981\u6b62\u9012\u5f52\u91cd\u5165</h4>\n<p>\u5728\u91cd\u590d\u626b\u63cf\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7981\u6b62\u9012\u5f52\u5c55\u5f00\u76f8\u540c\u7684\u5b8f\u3002\u53ef\u4ee5\u628a\u5b8f\u5c55\u5f00\u7406\u89e3\u4e3a\u6811\u5f62\u7684\u7ed3\u6784\uff0c\u6839\u8282\u70b9\u5c31\u662f\u4e00\u5f00\u59cb\u8981\u5c55\u5f00\u7684\u5b8f\uff0c\u6bcf\u4e2a\u5b8f\u5c55\u5f00\u4e4b\u540e\u7684\u5185\u5bb9\u4f5c\u4e3a\u8be5\u5b8f\u7684\u5b50\u8282\u70b9\u8fde\u63a5\u5230\u6811\u4e0a\uff0c\u90a3\u4e48\u7981\u6b62\u9012\u5f52\u5c31\u662f\u5728\u5c55\u5f00\u5b50\u8282\u70b9\u7684\u5b8f\u65f6\uff0c\u5982\u679c\u8be5\u5b8f\u8ddf\u4efb\u610f\u7956\u5148\u8282\u70b9\u7684\u5b8f\u76f8\u540c\uff0c\u5219\u7981\u6b62\u5c55\u5f00\u3002\u6765\u770b\u4e00\u4e9b\u4f8b\u5b50\uff1a</p>\n<p>``` cpp</p>\n<h1>define CONCAT(arg0, arg1) arg0 ## arg1</h1>\n<h1>define CONCAT_SPACE(arg0, arg1) arg0 arg1</h1>\n<h1>define IDENTITY(arg0) IDENTITY_IMPL(arg0)</h1>\n<h1>define IDENTITY_IMPL(arg0) arg0</h1>\n<p>CONCAT(CON, CAT(a, b))                  // -&gt; CONCAT(a, b)\nIDENTITY_IMPL(CONCAT(CON, CAT(a, b)))   // -&gt; CONCAT(a, b)\nIDENTITY(CONCAT(CON, CAT(a, b)))        // -&gt; IDENTITY_IMPL(CONCAT(a, b)) -&gt; CONCAT(a, b)\n```</p>\n<p><code>CONCAT(CON, CAT(a, b))</code>\uff1a\u7531\u4e8e <code>CONCAT</code> \u662f\u7528 <code>##</code> \u62fc\u63a5\u4e24\u4e2a\u53c2\u6570\uff0c\u6839\u636e <code>##</code> \u7684\u89c4\u5219\uff0c\u4e0d\u4f1a\u5c55\u5f00\u53c2\u6570\uff0c\u76f4\u63a5\u62fc\u63a5\u3002\u6240\u4ee5\u7b2c\u4e00\u6b21\u5c55\u5f00\u5f97\u5230\u4e86 <code>CONCAT(a, b)</code>\uff0c\u7531\u4e8e <code>CONCAT</code> \u5df2\u7ecf\u5c55\u5f00\u8fc7\u4e86\u4e0d\u4f1a\u518d\u9012\u5f52\u5c55\u5f00\uff0c\u6240\u4ee5\u505c\u6b62\u3002</p>\n<p><code>IDENTITY_IMPL(CONCAT(CON, CAT(a, b)))</code>\uff1a<code>IDENTITY_IMPL</code> \u53ef\u4ee5\u7406\u89e3\u4e3a\u5bf9\u53c2\u6570 <code>arg0</code> \u6c42\u503c\uff0c\u8fd9\u91cc\u7684\u53c2\u6570 <code>arg0</code> \u6c42\u503c\u5f97\u5230\u4e86 <code>CONCAT(a, b)</code>\uff0c\u5e76\u7531\u4e8e\u9012\u5f52\u88ab\u6807\u8bb0\u4e3a\u4e86\u7981\u6b62\u91cd\u5165\uff0c\u4e4b\u540e <code>IDENTITY_IMPL</code> \u5c55\u5f00\u5b8c\u6210\uff0c\u8fdb\u884c\u7b2c\u4e8c\u6b21\u626b\u63cf\u7684\u65f6\u5019\uff0c\u53d1\u73b0\u662f\u7981\u6b62\u91cd\u5165\u7684 <code>CONCAT(a, b)</code>\uff0c\u4e8e\u662f\u505c\u6b62\u5c55\u5f00\u3002\u5728\u8fd9\u91cc <code>CONCAT(a, b)</code> \u662f\u7531\u53c2\u6570 <code>arg0</code> \u5c55\u5f00\u800c\u5f97\u5230\u7684\uff0c\u4f46\u5728\u540e\u7eed\u5c55\u5f00\u7684\u65f6\u5019\uff0c\u4e5f\u4f1a\u4fdd\u6301\u7981\u6b62\u91cd\u5165\u7684\u6807\u8bb0\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u7236\u8282\u70b9\u662f\u53c2\u6570 <code>arg0</code>\uff0c\u4e00\u76f4\u4fdd\u6301\u7740\u7981\u6b62\u91cd\u5165\u7684\u6807\u8bb0\u3002</p>\n<p><code>IDENTITY(CONCAT(CON, CAT(a, b)))</code>\uff1a\u8fd9\u4e2a\u4f8b\u5b50\u4e3b\u8981\u662f\u4e3a\u4e86\u52a0\u5f3a\u5bf9\u7236\u5b50\u8282\u70b9\u7684\u7406\u89e3\uff0c\u53c2\u6570\u81ea\u5df1\u5c55\u5f00\u7684\u65f6\u5019\uff0c\u662f\u81ea\u8eab\u4f5c\u4e3a\u7236\u8282\u70b9\uff0c\u5c55\u5f00\u7684\u5185\u5bb9\u4f5c\u4e3a\u5b50\u8282\u70b9\u53bb\u5224\u65ad\u9012\u5f52\uff0c\u5c55\u5f00\u540e\u7684\u53c2\u6570\u4f20\u5230\u5b8f\u5b9a\u4e49\u4e4b\u540e\uff0c\u7981\u6b62\u91cd\u5165\u7684\u6807\u8bb0\u4f1a\u7ee7\u7eed\u4fdd\u7559\uff08\u5982\u679c\u4f20\u5230\u5b8f\u5b9a\u4e49\u4e4b\u540e\u6ca1\u6709\u6539\u53d8\u53c2\u6570\u5c55\u5f00\u540e\u7684\u5b8f\uff09\u3002\u53ef\u4ee5\u628a\u53c2\u6570\u7684\u5c55\u5f00\u8fc7\u7a0b\u770b\u6210\u662f\u53e6\u5916\u4e00\u68f5\u6811\uff0c\u53c2\u6570\u7684\u5c55\u5f00\u7ed3\u679c\u5c31\u662f\u6811\u7684\u6700\u5e95\u5c42\u5b50\u8282\u70b9\uff0c\u8fd9\u4e2a\u5b50\u8282\u70b9\u4f20\u7ed9\u5b8f\u6765\u6267\u884c\u5c55\u5f00\u7684\u540c\u65f6\uff0c\u4f9d\u7136\u662f\u4fdd\u7559\u7740\u7981\u6b62\u91cd\u5165\u7684\u7279\u6027\u3002</p>\n<p>\u4f8b\u5982\u8fd9\u91cc\uff0c\u5728\u7b2c\u4e00\u6b21\u5b8c\u5168\u5c55\u5f00\u4e4b\u540e\u5f97\u5230 <code>IDENTITY_IMPL(CONCAT(a, b))</code>\uff0c<code>CONCAT(a, b)</code> \u88ab\u6807\u8bb0\u4e3a\u7981\u6b62\u91cd\u5165\uff0c \u5373\u4f7f <code>IDENTITY_IMPL</code> \u662f\u5bf9\u53c2\u6570\u6c42\u503c\u7684\uff0c\u4f46\u53c2\u6570\u5df2\u7ecf\u7981\u6b62\u5c55\u5f00\uff0c\u6240\u4ee5\u53c2\u6570\u5c31\u539f\u5c01\u4e0d\u52a8\u7684\u4f20\u5230\u5b9a\u4e49\u91cc\uff0c\u6700\u540e\u6211\u4eec\u8fd8\u662f\u5f97\u5230 <code>CONCAT(a, b)</code>\u3002</p>\n<p>\u4ee5\u4e0a\u6211\u53ea\u662f\u5217\u51fa\u4e86\u4e00\u4e9b\u6211\u8ba4\u4e3a\u6bd4\u8f83\u91cd\u8981\u7684\uff0c\u6216\u8005\u89c9\u5f97\u4e0d\u592a\u597d\u7406\u89e3\u7684\u89c4\u5219\uff0c\u8be6\u7ec6\u7684\u5b8f\u5c55\u5f00\u89c4\u5219\uff0c\u8fd8\u662f\u5efa\u8bae\u82b1\u70b9\u65f6\u95f4\u76f4\u63a5\u53bb\u770b\u6807\u51c6\u6587\u6863\u3002</p>\n<h2>\u901a\u8fc7 Clang \u89c2\u5bdf\u5c55\u5f00\u8fc7\u7a0b</h2>\n<p>\u6211\u4eec\u53ef\u4ee5\u7ed9 Clang \u6e90\u7801\u52a0\u4e0a\u4e00\u4e9b\u6253\u5370\u4fe1\u606f\u6765\u89c2\u5bdf\u5b8f\u5c55\u5f00\u7684\u8fc7\u7a0b\uff0c\u6211\u65e0\u610f\u6df1\u5165\u89e3\u91ca Clang \u7684\u6e90\u7801\uff0c\u5728\u8fd9\u91cc\u7ed9\u4e00\u4efd\u4fee\u6539\u8fc7\u7684\u6587\u4ef6 diff\uff0c\u6709\u5174\u8da3\u7684\u53ef\u4ee5\u81ea\u5df1\u7f16\u8bd1 Clang \u6765\u7814\u7a76\u3002\u8fd9\u91cc\u6211\u662f\u7528\u7684 llvm \u7248\u672c 11.1.0 \uff08<a href=\"https://github.com/llvm/llvm-project/archive/refs/tags/llvmorg-11.1.0.tar.gz\">\u4f20\u9001\u95e8</a>\uff09\uff0c\u4fee\u6539\u8fc7\u7684\u6587\u4ef6\uff08<a href=\"assets/img/2021-3-31-cpp-preprocess/clang-modify.zip\">\u4f20\u9001\u95e8</a>\uff09\u3002\u4e0b\u9762\u7b80\u5355\u901a\u8fc7\u4f8b\u5b50\u6765\u9a8c\u8bc1\u6211\u4eec\u4e4b\u524d\u4ecb\u7ecd\u7684\u5b8f\u5c55\u5f00\u89c4\u5219\uff1a</p>\n<h4>\u4f8b\u5b501</h4>\n<p>``` cpp</p>\n<h1>define CONCAT(arg0, arg1) arg0 ## arg1</h1>\n<p>CONCAT(C, ONCAT(a, b))      // CONCAT(a, b)\n```</p>\n<p>\u4f7f\u7528\u4fee\u6539\u8fc7\u7684 Clang \u6765\u9884\u5904\u7406\u4ee5\u4e0a\u4ee3\u7801\uff1a <code>clang -P -E a.cpp -o a.cpp.i</code>\uff0c\u5f97\u5230\u4e0b\u9762\u7684\u6253\u5370\u4fe1\u606f\uff1a</p>\n<p>``` text linenums=\"1\"\nHandleIdentifier:\nMacroInfo 0x559e57496900\n    #define <macro><a href=\"arg0, arg1\">2813:CONCAT</a> arg0 ## arg1\nMacro is ok to expand</p>\n<p>EnterMacro: 0</p>\n<p>Enter ExpandFunctionArguments:\nMacroInfo 0x559e57496900 used\n    #define <macro><a href=\"arg0, arg1\">2813:CONCAT</a> arg0 ## arg1\nToken: 0\nidentifier: arg0\nArgs: [identifier: C]\nToken: 1\nhashhash:\nToken: 2\nidentifier: arg1\nArgs: [identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\nLeave ExpandFunctionArguments: [identifier: C][hashhash: ][identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]</p>\n<p>LeaveMacro: 0</p>\n<p>HandleIdentifier:\nMacroInfo 0x559e57496900 disabled used\n    #define <macro><a href=\"arg0, arg1\">2813:CONCAT</a> arg0 ## arg1\nMacro is not ok to expand\n```</p>\n<p>\u7b2c <a href=\"#__codelineno-9-1\">1</a> \u884c <code>HandleIdentifier</code> \u9047\u5230\u5b8f\u7684\u65f6\u5019\u4f1a\u6253\u5370\uff0c\u63a5\u7740\u6253\u5370\u5b8f\u7684\u4fe1\u606f\uff08\u7b2c <a href=\"#__codelineno-9-2\">2-4</a> \u884c\uff09\uff0c\u5b8f\u6ca1\u6709\u7981\u7528\uff0c\u6240\u4ee5\u53ef\u4ee5\u6309\u7167\u5b9a\u4e49\u6765\u5c55\u5f00 <code>Macro is ok to expand</code>\uff0c\u4e4b\u540e\u8fdb\u5165\u5b8f <code>EnterMacro</code>\u3002</p>\n<p>\u771f\u6b63\u6267\u884c\u5b8f\u5c55\u5f00\u7684\u51fd\u6570\u662f <code>ExpandFunctionArguments</code>\uff0c\u4e4b\u540e\u518d\u6b21\u6253\u5370\u5f85\u5c55\u5f00\u7684\u5b8f\u4fe1\u606f\uff0c\u6ce8\u610f\u5230\u6b64\u65f6\u5b8f\u5df2\u7ecf\u88ab\u6807\u8bb0\u4e3a <code>used</code> \uff08\u7b2c <a href=\"#__codelineno-9-9\">9</a> \u884c\uff09\u3002\u4e4b\u540e\u6839\u636e\u5b8f\u7684\u5b9a\u4e49\uff0c\u8fdb\u884c\u9010\u4e2a <code>Token</code> \u7684\u5c55\u5f00 \uff08<code>Token</code> \u662f <code>Clang</code> \u9884\u5904\u7406\u91cc\u9762\u7684\u6982\u5ff5\uff0c\u8fd9\u91cc\u4e0d\u6df1\u5165\u8bf4\u660e\uff09\u3002</p>\n<p>\u7b2c 0 \u4e2a <code>Token</code> \u662f\u5f62\u53c2 <code>arg0</code>, \u5bf9\u5e94\u7684\u5b9e\u53c2\u662f <code>C</code>\uff0c\u5224\u65ad\u4e0d\u9700\u8981\u5c55\u5f00\uff0c\u4e8e\u662f\u76f4\u63a5\u590d\u5236\u5230\u7ed3\u679c\u4e0a\uff08\u7b2c <a href=\"#__codelineno-9-11\">11-13</a> \u884c\uff09\u3002</p>\n<p>\u7b2c 1 \u4e2a <code>Token</code> \u662f <code>hashhash</code>\uff0c\u4e5f\u5c31\u662f <code>##</code> \u64cd\u4f5c\u7b26\uff0c\u7ee7\u7eed\u590d\u5236\u5230\u7ed3\u679c\u4e0a\uff08\u7b2c <a href=\"#__codelineno-9-14\">14-15</a> \u884c\uff09\u3002</p>\n<p>\u7b2c 2 \u4e2a <code>Token</code> \u662f\u5f62\u53c2 <code>arg1</code>\uff0c\u5bf9\u5e94\u7684\u5b9e\u53c2\u662f <code>ONCAT(a, b)</code>\uff0c\u9884\u5904\u7406\u5668\u4e5f\u4f1a\u628a\u5b9e\u53c2\u5904\u7406\u6210\u4e00\u4e2a\u4e2a\u7684 <code>Token</code>\uff0c\u6240\u4ee5\u53ef\u4ee5\u770b\u5230\u6253\u5370\u7684\u7ed3\u679c\u7528\u4e2d\u62ec\u53f7\u5305\u4f4f\u4e86\u5b9e\u53c2\u7684\u6bcf\u4e2a <code>Token</code>\uff08\u7b2c 18 \u884c\uff09\uff0c\u7531\u4e8e <code>##</code> \u7684\u539f\u56e0\u8fd9\u4e2a\u5b9e\u53c2\u4f9d\u7136\u4e0d\u9700\u8981\u5c55\u5f00\uff0c\u6240\u4ee5\u8fd8\u662f\u76f4\u63a5\u590d\u5236\u5230\u7ed3\u679c\u4e0a\uff08\u7b2c <a href=\"#__codelineno-9-16\">16-18</a> \u884c\uff09\u3002</p>\n<p>\u6700\u540e <code>Leave ExpandFunctionArguments</code> \u6253\u5370\u672c\u6b21\u626b\u63cf\u5c55\u5f00\u5f97\u5230\u7684\u7ed3\u679c\uff08\u7b2c <a href=\"#__codelineno-9-19\">19</a> \u884c\uff09\uff0c\u628a\u7ed3\u679c\u7684 <code>Token</code> \u90fd\u7ffb\u8bd1\u8fc7\u6765\u5c31\u662f <code>C ## ONCAT(a, b)</code>\uff0c\u4e4b\u540e\u9884\u5904\u7406\u5668\u5c31\u6267\u884c <code>##</code> \u64cd\u4f5c\u7b26\u6765\u751f\u6210\u65b0\u7684\u5185\u5bb9\u3002</p>\n<p><code>##</code> \u6267\u884c\u4e4b\u540e\u5f97\u5230 <code>CONCAT(a, b)</code>\uff0c\u9047\u5230\u5b8f <code>CONCAT</code>\uff0c\u9884\u5904\u7406\u8fd8\u662f\u5148\u8fdb\u5165 <code>HandleIdentifier</code>\uff0c\u6253\u5370\u5b8f\u7684\u4fe1\u606f\uff0c\u53d1\u73b0\u8be5\u5b8f\u72b6\u6001\u662f <code>disable used</code>\uff0c\u662f\u5df2\u7ecf\u5c55\u5f00\u8fc7\u7684\uff0c\u7981\u6b62\u518d\u91cd\u5165\u4e86\uff0c\u663e\u793a <code>Macro is not ok to expand</code>\uff0c\u9884\u5904\u7406\u5668\u4e0d\u518d\u5c55\u5f00\uff0c\u6700\u7ec8\u5f97\u5230\u7684\u7ed3\u679c\u5c31\u662f <code>CONCAT(a, b)</code>\u3002</p>\n<h4>\u4f8b\u5b502</h4>\n<p>``` cpp</p>\n<h1>define CONCAT(arg0, arg1) arg0 ## arg1</h1>\n<h1>define IDENTITY(arg0) arg0</h1>\n<p>IDENTITY(CONCAT(C, ONCAT(a, b)))\n```</p>\n<details>\n<summary> <font> Clang \u6253\u5370\u4fe1\u606f\uff08\u70b9\u51fb\u5c55\u5f00\uff09\uff1a</font> </summary>\n``` test linenums=\"1\"\nHandleIdentifier:\nMacroInfo 0x562a148f5a60\n    #define <macro>[2853:IDENTITY](arg0) arg0\nMacro is ok to expand\n\nHandleIdentifier:\nMacroInfo 0x562a148f5930\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\n\nEnterMacro: 0\n\nEnter ExpandFunctionArguments:\nMacroInfo 0x562a148f5a60 used\n    #define <macro>[2853:IDENTITY](arg0) arg0\nToken: 0\nidentifier: arg0\nArgs: [identifier: CONCAT][l_paren: ][identifier: C][comma: ][identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ][r_paren: ]\ngetPreExpArgument: [identifier: CONCAT][l_paren: ][identifier: C][comma: ][identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ][r_paren: ][eof: ]\n\nHandleIdentifier:\nMacroInfo 0x562a148f5930\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\nMacro is ok to expand\n\nEnterMacro: 1\n\nEnter ExpandFunctionArguments:\nMacroInfo 0x562a148f5930 used\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\nToken: 0\nidentifier: arg0\nArgs: [identifier: C]\nToken: 1\nhashhash:\nToken: 2\nidentifier: arg1\nArgs: [identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\nLeave ExpandFunctionArguments: [identifier: C][hashhash: ][identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\n\nLeaveMacro: 1\n\nHandleIdentifier:\nMacroInfo 0x562a148f5930 disabled used\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\nMacro is not ok to expand\nResultArgToks: [identifier: CONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\nLeave ExpandFunctionArguments: [identifier: CONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\n\nLeaveMacro: 0\n\nHandleIdentifier:\nMacroInfo 0x562a148f5930 used\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\nMacro is not ok to expand\n```\n\n</details>\n\n<p>\u7b2c <a href=\"#__codelineno-11-12\">12</a> \u884c\u5f00\u59cb\u5c55\u5f00 <code>IDENTITY</code>\uff0c\u53d1\u73b0\u53c2\u6570 <code>Token 0</code> \u662f <code>CONCAT(...)</code>\uff0c\u4e5f\u662f\u4e00\u4e2a\u5b8f\uff0c\u4e8e\u662f\u5148\u5bf9\u8be5\u53c2\u6570\u8fdb\u884c\u6c42\u503c\u3002</p>\n<p>\u7b2c <a href=\"#__codelineno-11-27\">27</a> \u884c\u5f00\u59cb\u5c55\u5f00\u53c2\u6570\u5b8f <code>CONCAT(...)</code>\uff0c\u8ddf\u4f8b\u5b50 1 \u4e00\u6837\uff0c\u591a\u6b21\u626b\u63cf\u5c55\u5f00\u5b8c\u6210\u540e\u5f97\u5230 <code>CONCAT(a, b)</code> \uff08\u7b2c <a href=\"#__codelineno-11-46\">46</a> \u884c\uff09\u3002</p>\n<p>\u7b2c <a href=\"#__codelineno-11-47\">47</a> \u7ed3\u675f\u5bf9 <code>IDENTITY</code> \u7684\u5c55\u5f00\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u662f <code>CONCAT(a, b)</code>\u3002</p>\n<p>\u7b2c <a href=\"#__codelineno-11-51\">51</a> \u884c\u91cd\u65b0\u626b\u63cf <code>CONCAT(a, b)</code>\uff0c\u53d1\u73b0\u867d\u7136\u662f\u5b8f\uff0c\u4f46\u5728\u4e4b\u524d\u7684\u53c2\u6570\u5c55\u5f00\u8fc7\u7a0b\u4e2d\u5df2\u7ecf\u88ab\u8bbe\u7f6e\u6210\u4e86 <code>used</code>\uff0c\u4e0d\u518d\u9012\u5f52\u5c55\u5f00\uff0c\u76f4\u63a5\u4f5c\u4e3a\u6700\u7ec8\u7ed3\u679c\u3002</p>\n<h4>\u4f8b\u5b50 3</h4>\n<p>``` cpp</p>\n<h1>define CONCAT(arg0, arg1) arg0 ## arg1</h1>\n<h1>define IDENTITY_IMPL(arg0) arg0</h1>\n<h1>define IDENTITY(arg0) IDENTITY_IMPL(arg0)</h1>\n<p>IDENTITY(CONCAT(C, ONCAT(a, b)))\n```</p>\n<details>\n<summary> <font>Clang \u6253\u5370\u4fe1\u606f\uff08\u70b9\u51fb\u5c55\u5f00\uff09\uff1a</font> </summary>\n``` test linenums=\"1\"\nHandleIdentifier:\nMacroInfo 0x55e824457a80\n    #define <macro>[2853:IDENTITY_IMPL](arg0) arg0\n\nHandleIdentifier:\nMacroInfo 0x55e824457ba0\n    #define <macro>[2886:IDENTITY](arg0) IDENTITY_IMPL(arg0)\nMacro is ok to expand\n\nHandleIdentifier:\nMacroInfo 0x55e824457950\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\n\nEnterMacro: 0\n\nEnter ExpandFunctionArguments:\nMacroInfo 0x55e824457ba0 used\n    #define <macro>[2886:IDENTITY](arg0) IDENTITY_IMPL(arg0)\nToken: 0\nidentifier: IDENTITY_IMPL\nToken: 1\nl_paren:\nToken: 2\nidentifier: arg0\nArgs: [identifier: CONCAT][l_paren: ][identifier: C][comma: ][identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ][r_paren: ]\ngetPreExpArgument: [identifier: CONCAT][l_paren: ][identifier: C][comma: ][identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ][r_paren: ][eof: ]\n\nHandleIdentifier:\nMacroInfo 0x55e824457950\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\nMacro is ok to expand\n\nEnterMacro: 1\n\nEnter ExpandFunctionArguments:\nMacroInfo 0x55e824457950 used\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\nToken: 0\nidentifier: arg0\nArgs: [identifier: C]\nToken: 1\nhashhash:\nToken: 2\nidentifier: arg1\nArgs: [identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\nLeave ExpandFunctionArguments: [identifier: C][hashhash: ][identifier: ONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\n\nLeaveMacro: 1\n\nHandleIdentifier:\nMacroInfo 0x55e824457950 disabled used\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\nMacro is not ok to expand\nResultArgToks: [identifier: CONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\nToken: 3\nr_paren:\nLeave ExpandFunctionArguments: [identifier: IDENTITY_IMPL][l_paren: ][identifier: CONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ][r_paren: ]\n\nLeaveMacro: 0\n\nHandleIdentifier:\nMacroInfo 0x55e824457a80\n    #define <macro>[2853:IDENTITY_IMPL](arg0) arg0\nMacro is ok to expand\n\nHandleIdentifier:\nMacroInfo 0x55e824457950 used\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\n\nEnterMacro: 2\n\nEnter ExpandFunctionArguments:\nMacroInfo 0x55e824457a80 used\n    #define <macro>[2853:IDENTITY_IMPL](arg0) arg0\nToken: 0\nidentifier: arg0\nArgs: [identifier: CONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\ngetPreExpArgument: [identifier: CONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ][eof: ]\n\nHandleIdentifier:\nMacroInfo 0x55e824457950 used\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\nMacro is not ok to expand\nResultArgToks: [identifier: CONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\nLeave ExpandFunctionArguments: [identifier: CONCAT][l_paren: ][identifier: a][comma: ][identifier: b][r_paren: ]\n\nLeaveMacro: 2\n\nHandleIdentifier:\nMacroInfo 0x55e824457950 used\n    #define <macro>[2813:CONCAT](arg0, arg1) arg0 ## arg1\nMacro is not ok to expand\n```\n\n</details>\n\n<ul>\n<li>\n<p>\u7b2c <a href=\"#__codelineno-13-16\">16</a> \u884c\u5f00\u59cb\u5c55\u5f00 <code>IDENTITY</code>\uff0c\u540c\u7406\u9884\u5904\u7406\u5668\u770b\u5230 <code>Token 2</code> \uff08\u4e5f\u5373\u662f <code>arg0</code>\uff09\u662f\u5b8f\uff0c\u4e8e\u662f\u5148\u5c55\u5f00 <code>CONCAT(C, ONCAT(a, b))</code>\u3002</p>\n</li>\n<li>\n<p>\u5c55\u5f00 <code>arg0</code> \u540e\u5f97\u5230 <code>CONCAT(a, b)</code> \uff08\u7b2c <a href=\"#__codelineno-13-23\">23-54</a> \u884c\uff09</p>\n</li>\n<li>\n<p><code>IDENTITY</code> \u6700\u7ec8\u5c55\u5f00\u4e3a <code>IDENTITY_IMPL(CONCAT(a, b))</code>\uff08\u7b2c <a href=\"#__codelineno-13-57\">57</a> \u884c\uff09</p>\n</li>\n<li>\n<p>\u91cd\u65b0\u626b\u63cf\uff0c\u7ee7\u7eed\u5c55\u5f00 <code>IDENTITY_IMPL</code>\uff08\u7b2c <a href=\"#__codelineno-13-61\">61-72</a> \u884c\uff09\uff0c\u53d1\u73b0\u6b64\u65f6\u7684 <code>Token 0</code> \u662f\u5b8f <code>CONCAT(a, b)</code>\uff0c\u4f46\u5904\u4e8e <code>used</code> \u72b6\u6001\uff0c\u4e2d\u6b62\u5c55\u5f00\u5e76\u8fd4\u56de\uff08\u7b2c 75-84\u884c\uff09\uff0c\u6700\u7ec8\u5f97\u5230\u7684\u7ed3\u679c\u8fd8\u662f <code>CONCAT(a, b)</code>\uff08\u7b2c <a href=\"#__codelineno-13-85\">85</a> \u884c\uff09\u3002</p>\n</li>\n<li>\n<p>\u91cd\u65b0\u626b\u63cf\u7ed3\u679c\uff0c\u53d1\u73b0\u5b8f <code>CONCAT(a, b)</code> \u7684\u72b6\u6001\u662f <code>used</code>\uff0c\u505c\u6b62\u5c55\u5f00\u5e76\u5f97\u5230\u6700\u7ec8\u7684\u7ed3\u679c\u3002</p>\n</li>\n</ul>\n<p>\u901a\u8fc7\u4ee5\u4e0a\u4e09\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u6211\u4eec\u53ef\u4ee5\u5927\u81f4\u7684\u7406\u89e3\u9884\u5904\u7406\u5668\u5c55\u5f00\u5b8f\u7684\u8fc7\u7a0b\uff0c\u8fd9\u91cc\u4e0d\u518d\u5bf9\u9884\u5904\u7406\u5668\u8fdb\u884c\u66f4\u6df1\u5165\u7684\u63a2\u8ba8\uff0c\u6709\u5174\u8da3\u53ef\u4ee5\u5bf9\u7167\u6211\u63d0\u4f9b\u7684\u4fee\u6539\u6587\u4ef6\u6765\u7814\u7a76\u3002</p>\n<h2>\u5b8f\u7f16\u7a0b\u5b9e\u73b0</h2>\n<p>\u4e0b\u9762\u6211\u4eec\u5f00\u59cb\u8fdb\u5165\u5230\u4e86\u4e3b\u9898\uff08\u524d\u9762\u90a3\u4e00\u5927\u6bb5\u76ee\u7684\u662f\u4e3a\u4e86\u66f4\u597d\u7684\u7406\u89e3\u5b8f\u5c55\u5f00\u89c4\u5219\uff09\uff0c\u5b8f\u7f16\u7a0b\u5b9e\u73b0\u3002</p>\n<h4>\u57fa\u672c\u7b26\u53f7</h4>\n<p>\u9996\u5148\u53ef\u4ee5\u5148\u5b9a\u4e49\u5b8f\u7684\u7279\u6b8a\u7b26\u53f7\uff0c\u505a\u6c42\u503c\u548c\u62fc\u63a5\u7684\u65f6\u5019\u4f1a\u7528\u5230</p>\n<p>``` cpp</p>\n<h1>define PP_LPAREN() (</h1>\n<h1>define PP_RPAREN() )</h1>\n<h1>define PP_COMMA() ,</h1>\n<h1>define PP_EMPTY()</h1>\n<h1>define PP_HASHHASH # ## #      // \u8868\u793a ## \u5b57\u7b26\u4e32\uff0c\u4f46\u53ea\u662f\u4f5c\u4e3a\u5b57\u7b26\u4e32\uff0c\u4e0d\u4f1a\u5f53\u4f5c ## \u64cd\u4f5c\u7b26\u6765\u5904\u7406</h1>\n<p>```</p>\n<h4>\u6c42\u503c</h4>\n<p>\u5229\u7528\u53c2\u6570\u4f18\u5148\u5c55\u5f00\u7684\u89c4\u5219\uff0c\u53ef\u4ee5\u5199\u51fa\u4e00\u4e2a\u6c42\u503c\u5b8f\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_IDENTITY(arg0) arg0</h1>\n<p>PP_COMMA PP_LPAREN() PP_RPAREN()                // -&gt; PP_COMMA ( )\nPP_IDENTITY(PP_COMMA PP_LPAREN() PP_RPAREN())   // -&gt; PP_COMMA() -&gt; ,\n```</p>\n<p>\u5982\u679c\u53ea\u662f\u5199 <code>PP_COMMA PP_LPAREN() PP_RPAREN()</code>\uff0c\u9884\u5904\u7406\u5668\u53ea\u4f1a\u5206\u522b\u5904\u7406\u6bcf\u4e2a\u5b8f\uff0c\u5bf9\u5c55\u5f00\u7684\u7ed3\u679c\u4e0d\u4f1a\u518d\u5408\u5e76\u5904\u7406\u3002\u52a0\u4e0a <code>PP_IDENTITY</code> \u4e4b\u540e\uff0c\u9884\u5904\u7406\u5668\u53ef\u4ee5\u5bf9\u5c55\u5f00\u5f97\u5230\u7684 <code>PP_COMMA()</code> \u518d\u8fdb\u884c\u6c42\u503c\uff0c\u5f97\u5230 <code>,</code>\u3002</p>\n<h4>\u62fc\u63a5</h4>\n<p>\u7531\u4e8e <code>##</code> \u62fc\u63a5\u7684\u65f6\u5019\uff0c\u662f\u4e0d\u4f1a\u5c55\u5f00\u5de6\u53f3\u4e24\u8fb9\u7684\u53c2\u6570\uff0c\u4e3a\u4e86\u8ba9\u53c2\u6570\u53ef\u4ee5\u5148\u6c42\u503c\u518d\u62fc\u63a5\uff0c\u53ef\u4ee5\u8fd9\u6837\u5199\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_CONCAT(arg0, arg1) PP_CONCAT_IMPL(arg0, arg1)</h1>\n<h1>define PP_CONCAT_IMPL(arg0, arg1) arg0 ## arg1</h1>\n<p>PP_CONCAT(PP_IDENTITY(1), PP_IDENTITY(2))         // -&gt; 12\nPP_CONCAT_IMPL(PP_IDENTITY(1), PP_IDENTITY(2))    // -&gt; PP_IDENTITY(1)PP_IDENTITY(2) -&gt; \u62a5\u9519\n```</p>\n<p>\u8fd9\u91cc <code>PP_CONCAT</code> \u7528\u5230\u7684\u65b9\u6cd5\u53eb\u505a\u5ef6\u8fdf\u62fc\u63a5\uff0c\u5728\u5c55\u5f00\u4e3a <code>PP_CONCAT_IMPL</code> \u7684\u65f6\u5019\uff0c<code>arg0</code> \u548c <code>arg1</code> \u90fd\u4f1a\u5148\u5c55\u5f00\u6c42\u503c\uff0c\u4e4b\u540e\u518d\u7531 <code>PP_CONCAT_IMPL</code> \u6267\u884c\u771f\u6b63\u7684\u62fc\u63a5\u64cd\u4f5c\u3002</p>\n<h4>\u903b\u8f91\u8fd0\u7b97</h4>\n<p>\u501f\u52a9 <code>PP_CONCAT</code> \u53ef\u4ee5\u5b9e\u73b0\u903b\u8f91\u8fd0\u7b97\u3002\u9996\u5148\u5b9a\u4e49 <code>BOOL</code> \u503c\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_BOOL(arg0) PP_CONCAT(PP_BOOL_, arg0)</h1>\n<h1>define PP_BOOL_0 0</h1>\n<h1>define PP_BOOL_1 1</h1>\n<h1>define PP_BOOL_2 1</h1>\n<h1>define PP_BOOL_3 1</h1>\n<p>// ...</p>\n<h1>define PP_BOOL_256 1</h1>\n<p>PP_BOOL(3)              // -&gt; PP_BOOL_3 -&gt; 1\n```</p>\n<p>\u7528<code>PP_CONCAT</code> \u5148\u628a <code>PP_BOOL_</code> \u548c <code>arg0</code> \u62fc\u63a5\u5728\u4e00\u8d77\uff0c\u518d\u5bf9\u62fc\u63a5\u7ed3\u679c\u8fdb\u884c\u6c42\u503c\u3002\u8fd9\u91cc\u7684 <code>arg0</code> \u8981\u6c42\u662f\u6c42\u503c\u4e4b\u540e\u5f97\u5230 <code>[0, 256]</code> \u8303\u56f4\u7684\u6570\u5b57\uff0c\u62fc\u63a5\u5728 <code>PP_BOOL_</code> \u540e\u9762\u6c42\u503c\uff0c\u5c31\u80fd\u5f97\u5230\u5e03\u5c14\u503c\u3002\u4e0e\u6216\u975e\u8fd0\u7b97\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_NOT(arg0) PP_CONCAT(PP_NOT_, PP_BOOL(arg0))</h1>\n<h1>define PP_NOT_0 1</h1>\n<h1>define PP_NOT_1 0</h1>\n<h1>define PP_AND(arg0, arg1) PP_CONCAT(PP_AND_, PP_CONCAT(PP_BOOL(arg0), PP_BOOL(arg1)))</h1>\n<h1>define PP_AND_00 0</h1>\n<h1>define PP_AND_01 0</h1>\n<h1>define PP_AND_10 0</h1>\n<h1>define PP_AND_11 1</h1>\n<h1>define PP_OR(arg0, arg1) PP_CONCAT(PP_OR_, PP_CONCAT(PP_BOOL(arg0), PP_BOOL(arg1)))</h1>\n<h1>define PP_OR_00 0</h1>\n<h1>define PP_OR_01 1</h1>\n<h1>define PP_OR_10 1</h1>\n<h1>define PP_OR_11 1</h1>\n<p>PP_NOT(PP_BOOL(2))      // -&gt; PP_CONCAT(PP_NOT_, 1) -&gt; PP_NOT_1 -&gt; 0\nPP_AND(2, 3)            // -&gt; PP_CONCAT(PP_AND_, 11) -&gt; PP_AND_11 -&gt; 1\nPP_AND(2, 0)            // -&gt; PP_CONCAT(PP_AND_, 10) -&gt; PP_AND_10 -&gt; 0\nPP_OR(2, 0)             // -&gt; PP_CONCAT(PP_OR_, 10) -&gt; PP_OR_10, -&gt; 1\n```</p>\n<p>\u5148\u7528 <code>PP_BOOL</code> \u5bf9\u53c2\u6570\u6c42\u503c\uff0c\u4e4b\u540e\u518d\u6839\u636e <code>0 1</code> \u7684\u7ec4\u5408\u6765\u62fc\u63a5\u903b\u8f91\u8fd0\u7b97\u7684\u7ed3\u679c\u3002\u5982\u679c\u4e0d\u7528 <code>PP_BOOL</code> \u6765\u6c42\u503c\uff0c\u90a3\u4e48\u53c2\u6570\u5c31\u53ea\u80fd\u652f\u6301 <code>0 1</code> \u4e24\u79cd\u6570\u503c\uff0c\u9002\u7528\u6027\u5927\u5927\u964d\u4f4e\u3002\u540c\u7406\u4e5f\u53ef\u4ee5\u5199\u51fa\u5f02\u6216\uff0c\u6216\u975e\u7b49\u64cd\u4f5c\uff0c\u6709\u5174\u8da3\u53ef\u4ee5\u81ea\u5df1\u5c1d\u8bd5\u3002</p>\n<h4>\u6761\u4ef6\u9009\u62e9</h4>\n<p>\u5229\u7528 <code>PP_BOOL</code> \u548c <code>PP_CONCAT</code>\uff0c\u8fd8\u53ef\u4ee5\u5199\u51fa\u6761\u4ef6\u9009\u62e9\u8bed\u53e5\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_IF(if, then, else) PP_CONCAT(PP_IF_, PP_BOOL(if))(then, else)</h1>\n<h1>define PP_IF_1(then, else) then</h1>\n<h1>define PP_IF_0(then, else) else</h1>\n<p>PP_IF(1, 2, 3)      // -&gt; PP_IF_1(2, 3) -&gt; 2\nPP_IF(0, 2, 3)      // -&gt; PP_IF_0(2, 3) -&gt; 3\n```</p>\n<p><code>if</code> \u6c42\u503c\u5982\u679c\u662f <code>1</code>\uff0c\u7528 <code>PP_CONCAT</code> \u62fc\u63a5\u6210 <code>PP_IF_1</code>\uff0c\u6700\u540e\u5c55\u5f00\u4e3a <code>then</code> \u7684\u503c\uff1b\u540c\u7406\u82e5 <code>if</code> \u6c42\u503c\u4e3a <code>0</code>\uff0c\u5f97\u5230 <code>PP_IF_0</code>\u3002</p>\n<h4>\u9012\u589e\u9012\u51cf</h4>\n<p>\u6574\u6570\u9012\u589e\u9012\u51cf\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_INC(arg0) PP_CONCAT(PP_INC_, arg0)</h1>\n<h1>define PP_INC_0 1</h1>\n<h1>define PP_INC_1 2</h1>\n<h1>define PP_INC_2 3</h1>\n<h1>define PP_INC_3 4</h1>\n<p>// ...</p>\n<h1>define PP_INC_255 256</h1>\n<h1>define PP_INC_256 256</h1>\n<h1>define PP_DEC(arg0) PP_CONCAT(PP_DEC_, arg0)</h1>\n<h1>define PP_DEC_0 0</h1>\n<h1>define PP_DEC_1 0</h1>\n<h1>define PP_DEC_2 1</h1>\n<h1>define PP_DEC_3 2</h1>\n<p>// ...</p>\n<h1>define PP_DEC_255 254</h1>\n<h1>define PP_DEC_256 255</h1>\n<p>PP_INC(2)                   // -&gt; PP_INC_2 -&gt; 3\nPP_DEC(3)                   // -&gt; PP_DEC_3 -&gt; 2\n```</p>\n<p>\u8ddf <code>PP_BOOL</code> \u7c7b\u4f3c\uff0c\u6574\u6570\u7684\u9012\u589e\u9012\u51cf\u4e5f\u662f\u6709\u8303\u56f4\u9650\u5236\u7684\uff0c\u8fd9\u91cc\u8303\u56f4\u8bbe\u7f6e\u4e3a <code>[0, 256]</code>\uff0c\u9012\u589e\u5230 <code>256</code> \u4e4b\u540e\uff0c\u5b89\u5168\u8d77\u89c1\uff0c<code>PP_INC_256</code> \u4f1a\u8fd4\u56de\u81ea\u8eab <code>256</code> \u4f5c\u4e3a\u8fb9\u754c\uff0c\u540c\u7406 <code>PP_DEC_0</code> \u4e5f\u662f\u8fd4\u56de <code>0</code>\u3002</p>\n<h4>\u53d8\u957f\u53c2\u6570</h4>\n<p>\u5b8f\u53ef\u4ee5\u63a5\u53d7\u53d8\u957f\u53c2\u6570\uff0c\u683c\u5f0f\u662f\uff1a</p>\n<p>```cpp</p>\n<h1>define LOG(format, ...) printf(\"log: \" format, <strong>VA_ARGS</strong>)</h1>\n<p>LOG(\"Hello %s\\n\", \"World\")      // -&gt; printf(\"log: \" \"Hello %s\\n\", \"World\");\nLOG(\"Hello World\")              // -&gt; printf(\"log: \" \"Hello World\", ); \u591a\u4e86\u4e2a\u9017\u53f7\uff0c\u7f16\u8bd1\u62a5\u9519\n```</p>\n<p>\u7531\u4e8e\u53d8\u957f\u53c2\u6570\u6709\u53ef\u80fd\u4e3a\u7a7a\uff0c\u7a7a\u7684\u60c5\u51b5\u4e0b\u4f1a\u5bfc\u81f4\u7f16\u8bd1\u5931\u8d25\uff0c\u56e0\u6b64 C++ 20 \u5f15\u5165\u4e86 <code>__VA_OPT__</code>\uff0c\u5982\u679c\u53d8\u957f\u53c2\u6570\u662f\u7a7a\uff0c\u5219\u8fd4\u56de\u7a7a\uff0c\u5426\u5219\u8fd4\u56de\u539f\u53c2\u6570\uff1a</p>\n<p>```cpp</p>\n<h1>define LOG2(format, ...) printf(\"log: \" format <strong>VA_OPT</strong>(,) <strong>VA_ARGS</strong>)</h1>\n<p>LOG2(\"Hello %s\\n\", \"World\")      // -&gt; printf(\"log: \" \"Hello %s\\n\", \"World\");\nLOG2(\"Hello World\")              // -&gt; printf(\"log: \" \"Hello World\" ); \u6ca1\u6709\u9017\u53f7\uff0c\u6b63\u5e38\u7f16\u8bd1\n```</p>\n<p>\u4f46\u53ef\u60dc\u53ea\u6709 C++ 20 \u4ee5\u4e0a\u6807\u51c6\u624d\u6709\u8fd9\u4e2a\u5b8f\uff0c\u4e0b\u6587\u4e2d\u6211\u4eec\u5c06\u4f1a\u7ed9\u51fa <code>__VA_OPT__</code> \u7684\u5b9e\u73b0\u65b9\u6cd5\u3002</p>\n<h4>\u60f0\u6027\u6c42\u503c</h4>\n<p>\u8003\u8651\u8fd9\u79cd\u60c5\u51b5\uff1a</p>\n<p><code>cpp\nPP_IF(1, PP_COMMA(), PP_LPAREN())     // -&gt; PP_IF_1(,,)) -&gt; \u62a5\u9519 unterminated argument list invoking macro \"PP_IF_1\"</code></p>\n<p>\u6211\u4eec\u77e5\u9053\uff0c\u5b8f\u5c55\u5f00\u7684\u65f6\u5019\u4f1a\u5bf9\u5148\u53c2\u6570\u8fdb\u884c\u6c42\u503c\u3002<code>PP_COMMA()</code> \u548c <code>PP_LPAREN()</code> \u6c42\u503c\u4e4b\u540e\u518d\u4f20\u7ed9 <code>PP_IF_1</code>\uff0c\u5f97\u5230 <code>PP_IF_1(,,))</code>\uff0c\u5bfc\u81f4\u9884\u5904\u7406\u51fa\u9519\u3002\u6b64\u65f6\uff0c\u53ef\u4ee5\u91c7\u7528\u4e00\u79cd\u53eb\u505a\u60f0\u6027\u6c42\u503c\u65b9\u6cd5\uff1a</p>\n<p><code>cpp\nPP_IF(1, PP_COMMA, PP_LPAREN)()       // -&gt; PP_IF_1(PP_COMMA, PP_LPAREN)() -&gt; PP_COMMA() -&gt; ,</code></p>\n<p>\u6539\u6210\u8fd9\u79cd\u5199\u6cd5\uff0c\u53ea\u4f20\u5b8f\u7684\u540d\u5b57\uff0c\u8ba9 <code>PP_IF</code> \u9009\u51fa\u9700\u8981\u7684\u5b8f\u540d\u5b57\u4e4b\u540e\uff0c\u518d\u8ddf\u62ec\u53f7 <code>()</code> \u62fc\u63a5\u5728\u4e00\u8d77\u7ec4\u6210\u5b8c\u6210\u7684\u5b8f\uff0c\u6700\u540e\u518d\u5c55\u5f00\u3002\u60f0\u6027\u6c42\u503c\u5728\u5b8f\u7f16\u7a0b\u91cc\u9762\u4e5f\u662f\u5f88\u5e38\u89c1\u7684\u3002</p>\n<h4>\u4ee5\u62ec\u53f7\u5f00\u59cb</h4>\n<p>\u5224\u65ad\u53d8\u957f\u53c2\u6570\u662f\u5426\u4ee5\u62ec\u53f7\u5f00\u59cb\uff1a</p>\n<p>``` cpp\n#define PP_IS_BEGIN_PARENS(...) \\\n    PP_IS_BEGIN_PARENS_PROCESS( \\\n        PP_IS_BEGIN_PARENS_CONCAT( \\\n            PP_IS_BEGIN_PARENS_PRE_, PP_IS_BEGIN_PARENS_EAT <strong>VA_ARGS</strong> \\\n        ) \\\n    )</p>\n<h1>define PP_IS_BEGIN_PARENS_PROCESS(...) PP_IS_BEGIN_PARENS_PROCESS_0(<strong>VA_ARGS</strong>)</h1>\n<h1>define PP_IS_BEGIN_PARENS_PROCESS_0(arg0, ...) arg0</h1>\n<h1>define PP_IS_BEGIN_PARENS_CONCAT(arg0, ...) PP_IS_BEGIN_PARENS_CONCAT_IMPL(arg0, <strong>VA_ARGS</strong>)</h1>\n<h1>define PP_IS_BEGIN_PARENS_CONCAT_IMPL(arg0, ...) arg0 ## <strong>VA_ARGS</strong></h1>\n<h1>define PP_IS_BEGIN_PARENS_PRE_1 1,</h1>\n<h1>define PP_IS_BEGIN_PARENS_PRE_PP_IS_BEGIN_PARENS_EAT 0,</h1>\n<h1>define PP_IS_BEGIN_PARENS_EAT(...) 1</h1>\n<p>PP_IS_BEGIN_PARENS(())              // -&gt; 1\nPP_IS_BEGIN_PARENS((()))            // -&gt; 1\nPP_IS_BEGIN_PARENS(a, b, c)         // -&gt; 0\nPP_IS_BEGIN_PARENS(a, ())           // -&gt; 0\nPP_IS_BEGIN_PARENS(a())             // -&gt; 0\nPP_IS_BEGIN_PARENS(()aa(bb()cc))    // -&gt; 1\nPP_IS_BEGIN_PARENS(aa(bb()cc))      // -&gt; 0\n```</p>\n<p><code>PP_IS_BEGIN_PARENS</code> \u53ef\u4ee5\u7528\u6765\u5224\u65ad\u4f20\u5165\u7684\u53c2\u6570\u662f\u5426\u4ee5\u62ec\u53f7\u5f00\u59cb\uff0c\u5728\u9700\u8981\u5904\u7406\u62ec\u53f7\u53c2\u6570\u7684\u65f6\u5019\u4f1a\u9700\u8981\u7528\u5230\uff08\u8b6c\u5982\u540e\u9762\u8bf4\u5230\u7684 <code>__VA_OPT__</code> \u5b9e\u73b0\uff09\u3002\u770b\u4e0a\u53bb\u6709\u70b9\u590d\u6742\uff0c\u6838\u5fc3\u601d\u60f3\u5c31\u662f\u6784\u5efa\u51fa\u4e00\u4e2a\u5b8f\uff0c\u82e5\u53d8\u957f\u53c2\u6570\u4ee5\u62ec\u53f7\u5f00\u59cb\uff0c\u5219\u53ef\u4ee5\u8ddf\u62ec\u53f7\u8fde\u5728\u4e00\u8d77\u6c42\u503c\u5f97\u5230\u4e00\u79cd\u7ed3\u679c\uff0c\u5426\u5219\u5c31\u53e6\u5916\u6c42\u503c\u5f97\u5230\u53e6\u4e00\u79cd\u7ed3\u679c\u3002\u6211\u4eec\u6765\u6162\u6162\u770b\uff1a</p>\n<p><code>PP_IS_BEGIN_PARENS_PROCESS</code> \u548c <code>PP_IS_BEGIN_PARENS_PROCESS_0</code> \u7ec4\u6210\u7684\u5b8f\u529f\u80fd\u662f\u5148\u5bf9\u4f20\u5165\u7684\u4e0d\u5b9a\u53c2\u6570\u6c42\u503c\uff0c\u7136\u540e\u53d6\u7b2c 0 \u4e2a\u53c2\u6570\u3002</p>\n<p><code>PP_IS_BEGIN_PARENS_CONCAT(PP_IS_BEGIN_PARENS_PRE_, PP_IS_BEGIN_PARENS_EAT __VA_ARGS__)</code> \u662f\u5148\u5bf9 <code>PP_IS_BEGIN_PARENS_EAT __VA_ARGS__</code> \u6c42\u503c\uff0c\u5728\u628a\u6c42\u503c\u7ed3\u679c\u8ddf <code>PP_IS_BEGIN_PARENS_PRE_</code> \u62fc\u63a5\u5728\u4e00\u8d77\u3002</p>\n<p><code>PP_IS_BEGIN_PARENS_EAT(...)</code> \u5b8f\u4f1a\u541e\u6389\u6240\u6709\u53c2\u6570\uff0c\u8fd4\u56de1\uff0c\u5982\u679c\u4e0a\u4e00\u6b65 <code>PP_IS_BEGIN_PARENS_EAT __VA_ARGS__</code> \u4e2d\uff0c<code>__VA_ARGS__</code> \u662f\u4ee5\u62ec\u53f7\u5f00\u59cb\u7684\uff0c\u90a3\u4e48\u5c31\u4f1a\u5339\u914d\u5230\u5bf9 <code>PP_IS_BEGIN_PARENS_EAT(...)</code> \u7684\u6c42\u503c\uff0c\u7136\u540e\u8fd4\u56de <code>1</code>\uff1b\u76f8\u53cd\uff0c\u5982\u679c\u4e0d\u662f\u4ee5\u62ec\u53f7\u5f00\u59cb\uff0c\u5219\u6ca1\u6709\u5339\u914d\u4e0a\uff0c<code>PP_IS_BEGIN_PARENS_EAT __VA_ARGS__</code> \u4f1a\u4fdd\u7559\u4e0d\u53d8\u3002</p>\n<p>\u82e5 <code>PP_IS_BEGIN_PARENS_EAT __VA_ARGS__</code> \u6c42\u503c\u5f97\u5230 <code>1</code>\uff0c<code>PP_IS_BEGIN_PARENS_CONCAT(PP_IS_BEGIN_PARENS_PRE_, 1) -&gt; PP_IS_BEGIN_PARENS_PRE_1 -&gt; 1,</code>\uff0c\u6ce8\u610f <code>1</code> \u540e\u9762\u662f\u6709\u4e2a\u9017\u53f7\u7684\uff0c\u628a <code>1,</code> \u4f20\u7ed9 <code>PP_IS_BEGIN_PARENS_PROCESS_0</code>\uff0c\u53d6\u7b2c 0 \u4e2a\u53c2\u6570\uff0c\u6700\u540e\u5f97\u5230 <code>1</code>\uff0c\u8868\u793a\u53c2\u6570\u662f\u4ee5\u62ec\u53f7\u5f00\u59cb\u3002</p>\n<p>\u82e5 <code>PP_IS_BEGIN_PARENS_EAT __VA_ARGS__</code> \u6c42\u503c\u5f97\u5230\u4e0d\u662f <code>1</code>\uff0c\u800c\u662f\u4fdd\u6301\u4e0d\u53d8\uff0c\u5219 <code>PP_IS_BEGIN_PARENS_CONCAT(PP_IS_BEGIN_PARENS_PRE_, PP_IS_BEGIN_PARENS_EAT __VA_ARGS__) -&gt; PP_IS_BEGIN_PARENS_PRE_PP_IS_BEGIN_PARENS_EAT __VA_ARGS__ -&gt; 0, __VA_ARGS__</code>\uff0c\u4f20\u7ed9 <code>PP_IS_BEGIN_PARENS_PROCESS_0</code> \u5f97\u5230\u7684\u662f <code>0</code>\uff0c\u8868\u793a\u53c2\u6570\u4e0d\u662f\u4ee5\u62ec\u53f7\u5f00\u59cb\u3002</p>\n<h4>\u53d8\u957f\u53c2\u6570\u7a7a</h4>\n<p>\u5224\u65ad\u53d8\u957f\u53c2\u6570\u662f\u5426\u4e3a\u7a7a\u4e5f\u662f\u4e00\u4e2a\u5e38\u7528\u7684\u5b8f\uff0c\u5728\u5b9e\u73b0 <code>__VA_OPT__</code> \u7684\u65f6\u5019\u9700\u8981\u7528\u5230\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u5229\u7528 <code>PP_IS_BEGIN_PARENS</code>\uff0c\u53ef\u4ee5\u5148\u5199\u51fa\u4e0d\u5b8c\u6574\u7684\u7248\u672c\uff1a</p>\n<p>``` cpp\n#define PP_IS_EMPTY_PROCESS(...) \\\n    PP_IS_BEGIN_PARENS(PP_IS_EMPTY_PROCESS_EAT <strong>VA_ARGS</strong> ())</p>\n<h1>define PP_IS_EMPTY_PROCESS_EAT(...) ()</h1>\n<p>PP_IS_EMPTY_PROCESS()       // -&gt; 1\nPP_IS_EMPTY_PROCESS(1)      // -&gt; 0\nPP_IS_EMPTY_PROCESS(1, 2)   // -&gt; 0\nPP_IS_EMPTY_PROCESS(())     // -&gt; 1\n```</p>\n<p><code>PP_IS_EMPTY_PROCESS</code> \u7684\u4f5c\u7528\u662f\u5224\u65ad <code>PP_IS_EMPTY_PROCESS_EAT __VA_ARGS__ ()</code> \u662f\u5426\u4ee5\u62ec\u53f7\u5f00\u59cb\u3002</p>\n<p>\u5982\u679c <code>__VA_ARGS__</code> \u662f\u7a7a\uff0c<code>PP_IS_EMPTY_PROCESS_EAT __VA_ARGS__ () -&gt; PP_IS_EMPTY_PROCESS_EAT() -&gt; ()</code>\uff0c\u5f97\u5230\u7684\u662f\u4e00\u5bf9\u62ec\u53f7 <code>()</code>\uff0c\u518d\u4f20\u7ed9 <code>PP_IS_BEGIN_PARENS</code> \u8fd4\u56de <code>1</code>\uff0c\u8868\u793a\u53c2\u6570\u662f\u7a7a\u3002</p>\n<p>\u5426\u5219\uff0c<code>PP_IS_EMPTY_PROCESS_EAT __VA_ARGS__ ()</code> \u4fdd\u6301\u4e0d\u53d8\u5730\u4f20\u7ed9 <code>PP_IS_BEGIN_PARENS</code>\uff0c\u8fd4\u56de 0\uff0c\u8868\u793a\u975e\u7a7a\u3002</p>\n<p>\u7559\u610f\u7b2c 4 \u4e2a\u4f8b\u5b50 <code>PP_IS_EMPTY_PROCESS(()) -&gt; 1</code>\uff0c<code>PP_IS_EMPTY_PROCESS</code> \u4e0d\u80fd\u6b63\u786e\u5904\u7406\u4ee5\u62ec\u53f7\u5f00\u59cb\u7684\u53d8\u957f\u53c2\u6570\uff0c\u56e0\u4e3a\u8fd9\u65f6\u53d8\u957f\u53c2\u6570\u5e26\u6765\u7684\u62ec\u53f7\u4f1a\u5339\u914d <code>PP_IS_EMPTY_PROCESS_EAT</code> \u5bfc\u81f4\u6c42\u503c\u5f97\u5230 <code>()</code>\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u9700\u8981\u533a\u522b\u5bf9\u5f85\u53c2\u6570\u662f\u5426\u4ee5\u62ec\u53f7\u5f00\u59cb\u7684\u60c5\u51b5\uff1a</p>\n<p>``` cpp\n#define PP_IS_EMPTY(...) \\\n    PP_IS_EMPTY_IF(PP_IS_BEGIN_PARENS(<strong>VA_ARGS</strong>)) \\\n        (PP_IS_EMPTY_ZERO, PP_IS_EMPTY_PROCESS)(<strong>VA_ARGS</strong>)</p>\n<h1>define PP_IS_EMPTY_IF(if) PP_CONCAT(PP_IS_EMPTY_IF_, if)</h1>\n<h1>define PP_IS_EMPTY_IF_1(then, else) then</h1>\n<h1>define PP_IS_EMPTY_IF_0(then, else) else</h1>\n<h1>define PP_IS_EMPTY_ZERO(...) 0</h1>\n<p>PP_IS_EMPTY()       // -&gt; 1\nPP_IS_EMPTY(1)      // -&gt; 0\nPP_IS_EMPTY(1, 2)   // -&gt; 0\nPP_IS_EMPTY(())     // -&gt; 0\n```</p>\n<p><code>PP_IS_EMPTY_IF</code> \u6839\u636e <code>if</code> \u6761\u4ef6\u6765\u8fd4\u56de\u7b2c 0 \u6216\u8005 \u7b2c 1 \u4e2a\u53c2\u6570\u3002</p>\n<p>\u5982\u679c\u4f20\u5165\u7684\u53d8\u957f\u53c2\u6570\u4ee5\u62ec\u53f7\u5f00\u59cb\uff0c<code>PP_IS_EMPTY_IF</code> \u8fd4\u56de <code>PP_IS_EMPTY_ZERO</code>\uff0c\u6700\u540e\u8fd4\u56de <code>0</code>\uff0c\u8868\u793a\u53d8\u957f\u53c2\u6570\u975e\u7a7a\u3002</p>\n<p>\u53cd\u4e4b <code>PP_IS_EMPTY_IF</code> \u8fd4\u56de <code>PP_IS_EMPTY_PROCESS</code>\uff0c\u6700\u540e\u7531 <code>PP_IS_EMPTY_PROCESS</code> \u6765\u5224\u65ad\u53d8\u957f\u53c2\u6570\u662f\u5426\u975e\u7a7a\u3002</p>\n<h4>\u4e0b\u6807\u8bbf\u95ee</h4>\n<p>\u83b7\u53d6\u53d8\u957f\u53c2\u6570\u6307\u5b9a\u4f4d\u7f6e\u7684\u5143\u7d20\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_ARGS_ELEM(I, ...) PP_CONCAT(PP_ARGS_ELEM_, I)(<strong>VA_ARGS</strong>)</h1>\n<h1>define PP_ARGS_ELEM_0(a0, ...) a0</h1>\n<h1>define PP_ARGS_ELEM_1(a0, a1, ...) a1</h1>\n<h1>define PP_ARGS_ELEM_2(a0, a1, a2, ...) a2</h1>\n<h1>define PP_ARGS_ELEM_3(a0, a1, a2, a3, ...) a3</h1>\n<p>// ...</p>\n<h1>define PP_ARGS_ELEM_7(a0, a1, a2, a3, a4, a5, a6, a7, ...) a7</h1>\n<h1>define PP_ARGS_ELEM_8(a0, a1, a2, a3, a4, a5, a6, a7, a8, ...) a8</h1>\n<p>PP_ARGS_ELEM(0, \"Hello\", \"World\")   // -&gt; PP_ARGS_ELEM_0(\"Hello\", \"World\") -&gt; \"Hello\"\nPP_ARGS_ELEM(1, \"Hello\", \"World\")   // -&gt; PP_ARGS_ELEM_1(\"Hello\", \"World\") -&gt; \"World\"\n```</p>\n<p><code>PP_ARGS_ELEM</code> \u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u5143\u7d20\u4e0b\u6807 <code>I</code>\uff0c\u540e\u9762\u662f\u53d8\u957f\u53c2\u6570\u3002\u5229\u7528 <code>PP_CONCAT</code> \u62fc\u63a5 <code>PP_ARGS_ELEM_</code> \u548c <code>I</code>\uff0c\u5373\u53ef\u4ee5\u5f97\u5230\u8fd4\u56de\u76f8\u5e94\u4f4d\u7f6e\u5143\u7d20\u7684\u5b8f <code>PP_ARGS_ELEM_0..8</code>\uff0c\u518d\u628a\u53d8\u957f\u53c2\u6570\u4f20\u7ed9\u8be5\u5b8f\uff0c\u5c55\u5f00\u8fd4\u56de\u4e0b\u6807\u5bf9\u5e94\u4f4d\u7f6e\u7684\u5143\u7d20\u3002</p>\n<h4>PP_IS_EMPTY2</h4>\n<p>\u5229\u7528 <code>PP_ARGS_ELEM</code> \u4e5f\u53ef\u4ee5\u5b9e\u73b0\u53e6\u4e00\u7248\u672c\u7684 <code>PP_IS_EMPTY</code>\uff1a</p>\n<p>``` cpp\n#define PP_IS_EMPTY2(...) \\\n    PP_AND( \\\n        PP_AND( \\\n            PP_NOT(PP_HAS_COMMA(<strong>VA_ARGS</strong>)), \\\n            PP_NOT(PP_HAS_COMMA(<strong>VA_ARGS</strong>())) \\\n        ), \\\n        PP_AND( \\\n            PP_NOT(PP_HAS_COMMA(PP_COMMA_ARGS <strong>VA_ARGS</strong>)), \\\n            PP_HAS_COMMA(PP_COMMA_ARGS <strong>VA_ARGS</strong> ()) \\\n        ) \\\n    )</p>\n<h1>define PP_HAS_COMMA(...) PP_ARGS_ELEM(8, <strong>VA_ARGS</strong>, 1, 1, 1, 1, 1, 1, 1, 0)</h1>\n<h1>define PP_COMMA_ARGS(...) ,</h1>\n<p>PP_IS_EMPTY2()              // -&gt; 1\nPP_IS_EMPTY2(a)             // -&gt; 0\nPP_IS_EMPTY2(a, b)          // -&gt; 0\nPP_IS_EMPTY2(())            // -&gt; 0\nPP_IS_EMPTY2(PP_COMMA)      // -&gt; 0\n```</p>\n<p>\u501f\u7528 <code>PP_ARGS_ELEM</code> \u5b9e\u73b0\u5224\u65ad\u53c2\u6570\u662f\u5426\u542b\u6709\u9017\u53f7 <code>PP_HAS_COMMA</code>\u3002<code>PP_COMMA_ARGS</code> \u4f1a\u541e\u6389\u4f20\u5165\u7684\u4efb\u610f\u53c2\u6570\uff0c\u8fd4\u56de\u4e00\u4e2a\u9017\u53f7\u3002</p>\n<p>\u5224\u65ad\u53d8\u957f\u53c2\u6570\u662f\u5426\u4e3a\u7a7a\u7684\u57fa\u7840\u903b\u8f91\u662f <code>PP_COMMA_ARGS __VA_ARGS__ ()</code> \u8fd4\u56de\u4e00\u4e2a\u9017\u53f7\uff0c\u4e5f\u5c31\u662f <code>__VA_ARGS__</code> \u4e3a\u7a7a\uff0c<code>PP_COMMA_ARGS</code> \u548c <code>()</code> \u62fc\u63a5\u5728\u4e00\u8d77\u6c42\u503c\uff0c\u5177\u4f53\u7684\u5199\u6cd5\u5c31\u662f <code>PP_HAS_COMMA(PP_COMMA_ARGS __VA_ARGS__ ())</code>\u3002</p>\n<p>\u4f46\u662f\u4f1a\u6709\u4f8b\u5916\u7684\u60c5\u51b5\uff1a</p>\n<ul>\n<li><code>__VA_ARGS__</code> \u672c\u8eab\u6709\u53ef\u80fd\u4f1a\u5e26\u6765\u9017\u53f7\uff1b</li>\n<li><code>__VA_ARGS__ ()</code> \u62fc\u63a5\u5728\u4e00\u8d77\u53d1\u751f\u6c42\u503c\u5e26\u6765\u9017\u53f7\uff1b</li>\n<li><code>PP_COMMA_ARGS __VA_ARGS__</code> \u62fc\u63a5\u5728\u4e00\u8d77\u53d1\u751f\u6c42\u503c\u5e26\u6765\u9017\u53f7\uff1b</li>\n</ul>\n<p>\u9488\u5bf9\u4e0a\u9762\u8bf4\u5230\u7684\u4e09\u79cd\u4f8b\u5916\u60c5\u51b5\uff0c\u9700\u8981\u505a\u6392\u9664\uff0c\u6240\u4ee5\u6700\u540e\u7684\u5199\u6cd5\u7b49\u4ef7\u4e8e\u5bf9\u4ee5\u4e0b 4 \u4e2a\u6761\u4ef6\u6267\u884c\u4e0e\u903b\u8f91\uff1a</p>\n<ul>\n<li><code>PP_NOT(PP_HAS_COMMA(__VA_ARGS__))</code> &amp;&amp;</li>\n<li><code>PP_NOT(PP_HAS_COMMA(__VA_ARGS__()))</code> &amp;&amp;</li>\n<li><code>PP_NOT(PP_HAS_COMMA(PP_COMMA_ARGS __VA_ARGS__))</code> &amp;&amp;</li>\n<li><code>PP_HAS_COMMA(PP_COMMA_ARGS __VA_ARGS__ ())</code></li>\n</ul>\n<h4><code>__VA_OPT__</code></h4>\n<p>\u5229\u7528 <code>PP_IS_EMPTY</code> \u7ec8\u4e8e\u53ef\u4ee5\u6765\u5b9e\u73b0\u7c7b\u4f3c <code>__VA_OPT__</code> \u7684\u5b8f\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_REMOVE_PARENS(tuple) PP_REMOVE_PARENS_IMPL tuple</h1>\n<h1>define PP_REMOVE_PARENS_IMPL(...) <strong>VA_ARGS</strong></h1>\n<p>#define PP_ARGS_OPT(data_tuple, empty_tuple, ...) \\\n    PP_ARGS_OPT_IMPL(PP_IF(PP_IS_EMPTY(<strong>VA_ARGS</strong>), empty_tuple, data_tuple))</p>\n<h1>define PP_ARGS_OPT_IMPL(tuple) PP_REMOVE_PARENS(tuple)</h1>\n<p>PP_ARGS_OPT((data), (empty))        // -&gt; empty\nPP_ARGS_OPT((data), (empty), 1)     // -&gt; data\nPP_ARGS_OPT((,), (), 1)             // -&gt; ,\n```</p>\n<p><code>PP_ARGS_OPT</code> \u63a5\u53d7\u4e24\u4e2a\u56fa\u5b9a\u53c2\u6570\u548c\u53d8\u957f\u53c2\u6570\uff0c\u53d8\u957f\u53c2\u6570\u975e\u7a7a\u65f6\u8fd4\u56de <code>data</code>\uff0c\u5426\u5219\u8fd4\u56de <code>empty</code>\u3002\u4e3a\u4e86\u8ba9 <code>data</code> \u548c <code>empty</code> \u652f\u6301\u9017\u53f7\uff0c\u8981\u6c42\u4e24\u8005\u90fd\u8981\u7528\u62ec\u53f7\u5305\u4f4f\u5b9e\u9645\u7684\u53c2\u6570\uff0c\u6700\u540e\u7528 <code>PP_REMOVE_PARENS</code> \u6765\u79fb\u9664\u5916\u5c42\u7684\u62ec\u53f7\u3002</p>\n<p>\u6709\u4e86 <code>PP_ARGS_OPT</code> \u53ef\u4ee5\u5b9e\u73b0 <code>LOG3</code> \u6765\u6a21\u62df <code>LOG2</code> \u5b9e\u73b0\u7684\u529f\u80fd\uff1a</p>\n<p>``` cpp\n#define LOG3(format, ...) \\\n    printf(\"log: \" format PP_ARGS_OPT((,), (), <strong>VA_ARGS</strong>) <strong>VA_ARGS</strong>)</p>\n<p>LOG3(\"Hello\");                  // -&gt; printf(\"log: \" \"Hello\" );\nLOG3(\"Hello %s\", \"World\");      // -&gt; printf(\"log: \" \"Hello %s\" , \"World\");\n```</p>\n<p><code>data_tuple</code> \u662f <code>(,)</code>\uff0c\u5982\u679c\u53d8\u957f\u53c2\u6570\u975e\u7a7a\uff0c\u5219\u4f1a\u8fd4\u56de <code>data_tuple</code> \u91cc\u9762\u7684\u6240\u6709\u5143\u7d20\uff0c\u5728\u8fd9\u91cc\u5c31\u662f\u9017\u53f7 <code>,</code>\u3002</p>\n<h4>\u6c42\u53c2\u6570\u4e2a\u6570</h4>\n<p>\u83b7\u53d6\u53d8\u957f\u53c2\u6570\u7684\u4e2a\u6570\uff1a</p>\n<p>``` cpp\n#define PP_ARGS_SIZE_IMCOMPLETE(...) \\\n    PP_ARGS_ELEM(8, <strong>VA_ARGS</strong>, 8, 7, 6, 5, 4, 3, 2, 1, 0)</p>\n<p>PP_ARGS_SIZE_IMCOMPLETE(a)             // -&gt; 1\nPP_ARGS_SIZE_IMCOMPLETE(a, b)          // -&gt; 2\nPP_ARGS_SIZE_IMCOMPLETE(PP_COMMA())    // -&gt; 2\nPP_ARGS_SIZE_IMCOMPLETE()              // -&gt; 1\n```</p>\n<p>\u8ba1\u7b97\u53d8\u957f\u53c2\u6570\u7684\u4e2a\u6570\uff0c\u662f\u901a\u8fc7\u6570\u53c2\u6570\u7684\u4f4d\u7f6e\u6765\u83b7\u5f97\u7684\u3002<code>__VA_ARGS__</code> \u4f1a\u5bfc\u81f4\u540e\u7eed\u7684\u53c2\u6570\u5168\u4f53\u5f80\u53f3\u79fb\u52a8\uff0c\u7528\u5b8f <code>PP_ARGS_ELEM</code> \u6765\u83b7\u53d6\u7b2c 8 \u4e2a\u4f4d\u7f6e\u7684\u53c2\u6570\uff0c\u5982\u679c <code>__VA_ARGS__</code> \u53ea\u6709\u4e00\u4e2a\u53c2\u6570\uff0c\u5219\u7b2c 8 \u4e2a\u53c2\u6570\u7b49\u4e8e <code>1</code>\uff1b\u540c\u7406\u5982\u679c <code>__VA_ARGS__</code> \u6709\u4e24\u4e2a\u53c2\u6570\uff0c\u5219\u7b2c 8 \u4e2a\u53c2\u6570\u5c31\u53d8\u4e3a <code>2</code>\uff0c\u521a\u597d\u7b49\u4e8e\u53d8\u957f\u53c2\u6570\u7684\u4e2a\u6570\u3002</p>\n<p>\u8fd9\u91cc\u7ed9\u7684\u4f8b\u5b50\u53ea\u6700\u9ad8\u652f\u6301\u4e2a\u6570 8 \u7684\u53d8\u957f\u53c2\u6570\uff0c\u8fd9\u662f\u4f9d\u8d56\u4e8e <code>PP_ARGS_ELEM</code> \u6240\u80fd\u652f\u6301\u7684\u6700\u5927\u957f\u5ea6\u3002</p>\n<p>\u4f46\u662f\u8fd9\u4e2a\u5b8f\u8fd8\u4e0d\u5b8c\u6574\uff0c\u5728\u53d8\u957f\u53c2\u6570\u4e3a\u7a7a\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e2a\u5b8f\u4f1a\u9519\u8bef\u8fd4\u56de <code>1</code>\u3002\u5982\u679c\u9700\u8981\u5904\u7406\u7a7a\u7684\u53d8\u957f\u53c2\u6570\uff0c\u5219\u9700\u8981\u7528\u5230\u6211\u4eec\u524d\u9762\u8bf4\u5230\u7684 <code>PP_ARGS_OPT</code> \u5b8f\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_COMMA_IF_ARGS(...) PP_ARGS_OPT((,), (), <strong>VA_ARGS</strong>)</h1>\n<h1>define PP_ARGS_SIZE(...) PP_ARGS_ELEM(8, <strong>VA_ARGS</strong> PP_COMMA_IF_ARGS(<strong>VA_ARGS</strong>) 8, 7, 6, 5, 4, 3, 2, 1, 0, 0, 0)</h1>\n<p>PP_ARGS_SIZE(a)             // -&gt; 1\nPP_ARGS_SIZE(a, b)          // -&gt; 2\nPP_ARGS_SIZE(PP_COMMA())    // -&gt; 2\nPP_ARGS_SIZE()              // -&gt; 0\nPP_ARGS_SIZE(,,,)           // -&gt; 4\n```</p>\n<p>\u95ee\u9898\u7684\u5173\u952e\u5c31\u662f\u9017\u53f7 <code>,</code>\uff0c\u5728 <code>__VA_ARGS__</code> \u4e3a\u7a7a\u7684\u65f6\u5019\uff0c\u628a\u9017\u53f7\u9690\u53bb\u5c31\u80fd\u6b63\u786e\u8fd4\u56de <code>0</code>\u3002</p>\n<h4>\u904d\u5386\u8bbf\u95ee</h4>\n<p>\u7c7b\u4f3c C++ \u7684 <code>for_each</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9e\u73b0\u5b8f\u7684 <code>PP_FOR_EACH</code>\uff1a</p>\n<p>``` cpp\n#define PP_FOR_EACH(macro, contex, ...) \\\n    PP_CONCAT(PP_FOR_EACH_, PP_ARGS_SIZE(<strong>VA_ARGS</strong>))(0, macro, contex, <strong>VA_ARGS</strong>)</p>\n<h1>define PP_FOR_EACH_0(index, macro, contex, ...)</h1>\n<h1>define PP_FOR_EACH_1(index, macro, contex, arg, ...) macro(index, contex, arg)</h1>\n<p>#define PP_FOR_EACH_2(index, macro, contex, arg, ...) \\\n    macro(index, contex, arg) \\\n    PP_FOR_EACH_1(PP_INC(index), macro, contex, <strong>VA_ARGS</strong>)</p>\n<p>#define PP_FOR_EACH_3(index, macro, contex, arg, ...) \\\n    macro(index, contex, arg) \\\n    PP_FOR_EACH_2(PP_INC(index), macro, contex, <strong>VA_ARGS</strong>)\n// ...\n#define PP_FOR_EACH_8(index, macro, contex, arg, ...) \\\n    macro(index, contex, arg) \\\n    PP_FOR_EACH_7(PP_INC(index), macro, contex, <strong>VA_ARGS</strong>)</p>\n<h1>define DECLARE_EACH(index, contex, arg)    PP_IF(index, PP_COMMA, PP_EMPTY)() contex arg</h1>\n<p>PP_FOR_EACH(DECLARE_EACH, int, x, y, z);    // -&gt; int x, y, z;\nPP_FOR_EACH(DECLARE_EACH, bool, a, b);      // -&gt; bool a, b;\n```</p>\n<p><code>PP_FOR_EACH</code> \u63a5\u6536\u4e24\u4e2a\u56fa\u5b9a\u53c2\u6570\uff1a <code>macro</code> \u53ef\u4ee5\u7406\u89e3\u4e3a\u904d\u5386\u7684\u65f6\u5019\u8c03\u7528\u7684\u5b8f\uff0c<code>contex</code> \u53ef\u4ee5\u4f5c\u4e3a\u56fa\u5b9a\u503c\u53c2\u6570\u4f20\u7ed9 <code>macro</code>\u3002<code>PP_FOR_EACH</code> \u5148\u901a\u8fc7 <code>PP_ARGS_SIZE</code> \u83b7\u53d6\u53d8\u957f\u53c2\u6570\u7684\u957f\u5ea6 <code>N</code>\uff0c\u518d\u7528 <code>PP_CONCAT</code> \u62fc\u63a5\u5f97\u5230 <code>PP_FOR_EACH_N</code>\uff0c\u4e4b\u540e <code>PP_FOR_EACH_N</code> \u4f1a\u8fed\u4ee3\u8c03\u7528 <code>PP_FOR_EACH_N-1</code> \u6765\u5b9e\u73b0\u8ddf\u53d8\u957f\u53c2\u6570\u4e2a\u6570\u76f8\u540c\u7684\u904d\u5386\u6b21\u6570\u3002</p>\n<p>\u4f8b\u5b50\u91cc\u6211\u4eec\u58f0\u660e\u4e86 <code>DECLARE_EACH</code> \u4f5c\u4e3a\u53c2\u6570 <code>macro</code>\uff0c<code>DECLARE_EACH</code> \u7684\u4f5c\u7528\u5c31\u662f\u8fd4\u56de <code>contex arg</code>\uff0c\u5982\u679c <code>contex</code> \u662f\u7c7b\u578b\u540d\u5b57\uff0c<code>arg</code> \u662f\u53d8\u91cf\u540d\u5b57\uff0c<code>DECLARE_EACH</code> \u5c31\u53ef\u4ee5\u7528\u6765\u58f0\u660e\u53d8\u91cf\u3002</p>\n<h4>\u6761\u4ef6\u5faa\u73af</h4>\n<p>\u6709\u4e86 <code>FOR_EACH</code> \u4e4b\u540e\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u7528\u7c7b\u4f3c\u7684\u5199\u6cd5\u5199\u51fa <code>PP_WHILE</code>\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_WHILE PP_WHILE_1</h1>\n<h1>define PP_WHILE_1(pred, op, val) PP_WHILE_1_IMPL(PP_BOOL(pred(val)), pred, op, val)</h1>\n<p>#define PP_WHILE_1_IMPL(cond, pred, op, val) \\\n    PP_IF(cond, PP_WHILE_2, val PP_EMPTY_EAT)(pred, op, PP_IF(cond, op, PP_EMPTY_EAT)(val))</p>\n<h1>define PP_WHILE_2(pred, op, val) PP_WHILE_2_IMPL(PP_BOOL(pred(val)), pred, op, val)</h1>\n<p>#define PP_WHILE_2_IMPL(cond, pred, op, val) \\\n    PP_IF(cond, PP_WHILE_3, val PP_EMPTY_EAT)(pred, op, PP_IF(cond, op, PP_EMPTY_EAT)(val))</p>\n<h1>define PP_WHILE_3(pred, op, val) PP_WHILE_3_IMPL(PP_BOOL(pred(val)), pred, op, val)</h1>\n<p>#define PP_WHILE_3_IMPL(cond, pred, op, val) \\\n    PP_IF(cond, PP_WHILE_4, val PP_EMPTY_EAT)(pred, op, PP_IF(cond, op, PP_EMPTY_EAT)(val))</p>\n<h1>define PP_WHILE_4(pred, op, val) PP_WHILE_4_IMPL(PP_BOOL(pred(val)), pred, op, val)</h1>\n<p>#define PP_WHILE_4_IMPL(cond, pred, op, val) \\\n    PP_IF(cond, PP_WHILE_5, val PP_EMPTY_EAT)(pred, op, PP_IF(cond, op, PP_EMPTY_EAT)(val))\n// ...</p>\n<h1>define PP_WHILE_8(pred, op, val) PP_WHILE_8_IMPL(PP_BOOL(pred(val)), pred, op, val)</h1>\n<p>#define PP_WHILE_8_IMPL(cond, pred, op, val) \\\n    PP_IF(cond, PP_WHILE_8, val PP_EMPTY_EAT)(pred, op, PP_IF(cond, op, PP_EMPTY_EAT)(val))</p>\n<h1>define PP_EMPTY_EAT(...)</h1>\n<h1>define SUM_OP(xy_tuple) SUM_OP_OP_IMPL xy_tuple</h1>\n<h1>define SUM_OP_OP_IMPL(x, y) (PP_DEC(x), y + x)</h1>\n<h1>define SUM_PRED(xy_tuple) SUM_PRED_IMPL xy_tuple</h1>\n<h1>define SUM_PRED_IMPL(x, y) x</h1>\n<p>#define SUM(max_num, origin_num) \\\n    PP_IDENTITY(SUM_IMPL PP_WHILE(SUM_PRED, SUM_OP, (max_num, origin_num)))</p>\n<h1>define SUM_IMPL(ignore, ret) ret</h1>\n<p>PP_WHILE(SUM_PRED, SUM_OP, (2, a))      // -&gt; (0, a + 2 + 1)\nSUM(2, a)                               // -&gt; a + 2 + 1\n```</p>\n<p><code>PP_WHILE</code> \u63a5\u53d7\u4e09\u4e2a\u53c2\u6570\uff1a <code>pred</code> \u6761\u4ef6\u5224\u65ad\u51fd\u6570\uff0c<code>op</code> \u64cd\u4f5c\u51fd\u6570\uff0c<code>val</code> \u521d\u59cb\u503c\uff1b\u5faa\u73af\u7684\u8fc7\u7a0b\u4e2d\u4e0d\u65ad\u7528 <code>pred(val)</code> \u6765\u505a\u5faa\u73af\u7ec8\u6b62\u5224\u65ad\uff0c\u628a <code>op(val)</code> \u5f97\u5230\u7684\u503c\u4f20\u7ed9\u540e\u7eed\u7684\u5b8f\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u6267\u884c\u4ee5\u4e0b\u4ee3\u7801\uff1a</p>\n<p><code>cpp\nwhile (pred(val)) {\n    val = op(val);\n}</code></p>\n<p><code>PP_WHILE_N</code> \u9996\u5148\u7528 <code>pred(val)</code> \u5f97\u5230\u6761\u4ef6\u5224\u65ad\u7ed3\u679c\uff0c\u628a\u6761\u4ef6\u7ed3\u679c <code>cond</code> \u548c\u5176\u4f59\u53c2\u6570\u518d\u4f20\u7ed9 <code>PP_WHILE_N_IMPL</code>\u3002\n<code>PP_WHILE_N_IMPL</code> \u53ef\u4ee5\u5206\u4e24\u90e8\u5206\u770b\uff1a\u540e\u534a\u90e8\u5206 <code>(pred, op, PP_IF(cond, op, PP_EMPTY_EAT)(val))</code> \u662f\u4f5c\u4e3a\u524d\u534a\u90e8\u5206\u7684\u53c2\u6570\uff0c<code>PP_IF(cond, op, PP_EMPTY_EAT)(val)</code> \u662f\u5982\u679c <code>cond</code> \u4e3a\u771f\uff0c\u5219\u6c42\u503c <code>op(val)</code>\uff0c \u5426\u5219\u6c42\u503c <code>PP_EMPTY_EAT(val)</code> \u5f97\u5230\u7a7a\u3002\u524d\u534a\u90e8\u5206 <code>PP_IF(cond, PP_WHILE_N+1, val PP_EMPTY_EAT)</code>\uff0c\u5982\u679c <code>cond</code> \u4e3a\u771f\uff0c\u5219\u8fd4\u56de <code>PP_WHILE_N+1</code>\uff0c\u7ed3\u5408\u540e\u534a\u90e8\u5206\u7684\u53c2\u6570\u7ee7\u7eed\u6267\u884c\u5faa\u73af\uff1b\u5426\u5219\u8fd4\u56de <code>val PP_EMPTY_EAT</code>\uff0c\u6b64\u65f6 <code>val</code> \u5c31\u662f\u6700\u7ec8\u7684\u8ba1\u7b97\u7ed3\u679c\uff0c\u800c <code>PP_EMPTY_EAT</code> \u4f1a\u541e\u6389\u540e\u534a\u90e8\u5206\u7684\u7ed3\u679c\u3002</p>\n<p><code>SUM</code> \u5b9e\u73b0 <code>N + N-1 + ... + 1</code>\u3002\u521d\u59cb\u503c <code>(max_num, origin_num)</code>\uff1b<code>SUM_PRED</code> \u53d6\u503c\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20 <code>x</code>\uff0c\u5224\u65ad\u662f\u5426\u5927\u4e8e 0\uff1b<code>SUM_OP</code> \u5bf9 <code>x</code> \u6267\u884c\u9012\u51cf\u64cd\u4f5c <code>x = x - 1</code>\uff0c\u5bf9 <code>y</code> \u6267\u884c <code>+ x</code> \u64cd\u4f5c <code>y = y + x</code>\u3002\u76f4\u63a5\u7528 <code>SUM_PRED</code> \u548c <code>SUM_OP</code> \u4f20\u7ed9 <code>PP_WHILE</code>\uff0c\u8fd4\u56de\u7684\u7ed3\u679c\u662f\u4e00\u4e2a\u5143\u7ec4\uff0c\u6211\u4eec\u771f\u6b63\u60f3\u8981\u7684\u7ed3\u679c\u662f\u5143\u7ec4\u7684\u7b2c 2 \u4e2a\u5143\u7d20\uff0c\u4e8e\u662f\u518d\u7528 <code>SUM</code> \u53d6\u7b2c 2 \u4e2a\u5143\u7d20\u7684\u503c\u3002</p>\n<h4>\u9012\u5f52\u91cd\u5165</h4>\n<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u7684\u904d\u5386\u8bbf\u95ee\u548c\u6761\u4ef6\u5faa\u73af\u90fd\u8fd0\u4f5c\u7684\u5f88\u597d\uff0c\u7ed3\u679c\u7b26\u5408\u9884\u671f\u3002\u8fd8\u8bb0\u5f97\u6211\u4eec\u5728\u8bb2\u5b8f\u5c55\u5f00\u89c4\u5219\u7684\u65f6\u5019\u63d0\u5230\u7684\u7981\u6b62\u9012\u5f52\u91cd\u5165\u4e48\uff0c\u5f53\u6211\u4eec\u60f3\u8981\u6267\u884c\u4e24\u91cd\u5faa\u73af\u7684\u65f6\u5019\u5c31\u4e0d\u5e78\u9047\u5230\u5230\u4e86\u7981\u6b62\u9012\u5f52\u91cd\u5165\uff1a</p>\n<p>``` cpp</p>\n<h1>define SUM_OP2(xy_tuple) SUM_OP_OP_IMPL2 xy_tuple</h1>\n<h1>define SUM_OP_OP_IMPL2(x, y) (PP_DEC(x), y + SUM(x, 0))</h1>\n<p>#define SUM2(max_num, origin_num) \\\n    PP_IDENTITY(SUM_IMPL PP_WHILE(SUM_PRED, SUM_OP2, (max_num, origin_num)))</p>\n<p>SUM2(1, a)      // -&gt; a + SUM_IMPL PP_WHILE_1(SUM_PRED, SUM_OP, (1, a))\n```</p>\n<p><code>SUM2</code> \u628a\u53c2\u6570 <code>op</code> \u6539\u7528 <code>SUM_OP2</code>\uff0c<code>SUM_OP2</code> \u91cc\u9762\u4f1a\u8c03\u7528\u5230 <code>SUM</code>\uff0c\u800c <code>SUM</code> \u5c55\u5f00\u8fd8\u4f1a\u662f <code>PP_WHILE_1</code>\uff0c\u76f8\u5f53\u4e8e <code>PP_WHILE_1</code> \u9012\u5f52\u8c03\u7528\u5230\u4e86\u81ea\u8eab\uff0c\u9884\u5904\u7406\u5668\u505c\u6b62\u5c55\u5f00\u3002</p>\n<p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e00\u79cd\u81ea\u52a8\u63a8\u5bfc\u9012\u5f52\u7684\u65b9\u6cd5\uff08Automatic Recursion\uff09\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_AUTO_WHILE PP_CONCAT(PP_WHILE_, PP_AUTO_REC(PP_WHILE_PRED))</h1>\n<h1>define PP_AUTO_REC(check) PP_IF(check(2), PP_AUTO_REC_12, PP_AUTO_REC_34)(check)</h1>\n<h1>define PP_AUTO_REC_12(check) PP_IF(check(1), 1, 2)</h1>\n<h1>define PP_AUTO_REC_34(check) PP_IF(check(3), 3, 4)</h1>\n<p>#define PP_WHILE_PRED(n) \\\n    PP_CONCAT(PP_WHILE_CHECK_, PP_WHILE_ ## n(PP_WHILE_FALSE, PP_WHILE_FALSE, PP_WHILE_FALSE))</p>\n<h1>define PP_WHILE_FALSE(...) 0</h1>\n<h1>define PP_WHILE_CHECK_PP_WHILE_FALSE 1</h1>\n<h1>define PP_WHILE_CHECK_PP_WHILE_1(...) 0</h1>\n<h1>define PP_WHILE_CHECK_PP_WHILE_2(...) 0</h1>\n<h1>define PP_WHILE_CHECK_PP_WHILE_3(...) 0</h1>\n<h1>define PP_WHILE_CHECK_PP_WHILE_4(...) 0</h1>\n<p>// ...</p>\n<h1>define PP_WHILE_CHECK_PP_WHILE_8(...) 0</h1>\n<p>PP_AUTO_WHILE       // -&gt; PP_WHILE_1</p>\n<p>#define SUM3(max_num, origin_num) \\\n    PP_IDENTITY(SUM_IMPL PP_AUTO_WHILE(SUM_PRED, SUM_OP, (max_num, origin_num)))</p>\n<h1>define SUM_OP4(xy_tuple) SUM_OP_OP_IMPL4 xy_tuple</h1>\n<h1>define SUM_OP_OP_IMPL4(x, y) (PP_DEC(x), y + SUM3(x, 0))</h1>\n<p>#define SUM4(max_num, origin_num) \\\n    PP_IDENTITY(SUM_IMPL PP_AUTO_WHILE(SUM_PRED, SUM_OP4, (max_num, origin_num)))</p>\n<p>SUM4(2, a)          // -&gt; a + 0 + 2 + 1 + 0 + 1\n```</p>\n<p><code>PP_AUTO_WHILE</code> \u5c31\u662f <code>PP_WHILE</code> \u7684\u81ea\u52a8\u63a8\u5bfc\u9012\u5f52\u7248\u672c\uff0c\u6838\u5fc3\u7684\u5b8f\u662f <code>PP_AUTO_REC(PP_WHILE_PRED)</code>\uff0c\u8fd9\u4e2a\u5b8f\u53ef\u4ee5\u627e\u51fa\u5f53\u524d\u53ef\u7528\u7684 <code>PP_WHILE_N</code> \u7248\u672c\u7684\u6570\u5b57 <code>N</code>\u3002</p>\n<p>\u63a8\u5bfc\u7684\u539f\u7406\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u641c\u7d22\u6240\u6709\u7248\u672c\uff0c\u627e\u51fa\u80fd\u591f\u6b63\u786e\u5c55\u5f00\u7684\u7248\u672c\uff0c\u8fd4\u56de\u8be5\u7248\u672c\u7684\u6570\u5b57\uff0c\u4e3a\u4e86\u63d0\u5347\u641c\u7d22\u7684\u901f\u5ea6\uff0c\u4e00\u822c\u7684\u505a\u6cd5\u662f\u4f7f\u7528\u4e8c\u5206\u67e5\u627e\uff0c\u8fd9\u5c31\u662f <code>PP_AUTO_REC</code> \u5728\u505a\u7684\u4e8b\u60c5\u3002<code>PP_AUTO_REC</code> \u63a5\u53d7\u4e00\u4e2a\u53c2\u6570 <code>check</code>\uff0c<code>check</code> \u8d1f\u8d23\u68c0\u67e5\u7248\u672c\u53ef\u7528\u6027\uff0c\u8fd9\u91cc\u7ed9\u51fa\u7684\u662f\u652f\u6301\u641c\u7d22\u7248\u672c\u8303\u56f4 <code>[1, 4]</code>\u3002<code>PP_AUTO_REC</code> \u4f1a\u9996\u5148\u68c0\u67e5 <code>check(2)</code>\uff0c\u5982\u679c <code>check(2)</code> \u4e3a\u771f\uff0c\u5219\u8c03\u7528 <code>PP_AUTO_REC_12</code> \u641c\u7d22\u8303\u56f4 <code>[1, 2]</code>\uff0c\u5426\u5219\u7528 <code>PP_AUTO_REC_34</code> \u641c\u7d22 <code>[3, 4]</code>\u3002<code>PP_AUTO_REC_12</code> \u68c0\u67e5 <code>check(1)</code> \u5982\u679c\u4e3a\u771f\uff0c\u8bf4\u660e\u7248\u672c <code>1</code> \u53ef\u7528\uff0c\u5426\u5219\u7528\u7248\u672c <code>2</code>\uff0c<code>PP_AUTO_REC_34</code> \u540c\u7406\u3002</p>\n<p><code>check</code> \u5b8f\u8981\u600e\u4e48\u5199\u624d\u80fd\u77e5\u9053\u7248\u672c\u662f\u5426\u53ef\u7528\u5462\uff1f\u5728\u8fd9\u91cc\uff0c<code>PP_WHILE_PRED</code> \u4f1a\u5c55\u5f00\u6210\u4e24\u90e8\u5206\u7684\u62fc\u63a5\uff0c\u6211\u4eec\u6765\u770b\u540e\u90e8\u5206 <code>PP_WHILE_ ## n(PP_WHILE_FALSE, PP_WHILE_FALSE, PP_WHILE_FALSE)</code>\uff1a\u5982\u679c <code>PP_WHILE_ ## n</code> \u53ef\u7528\uff0c\u7531\u4e8e <code>PP_WHILE_FALSE</code> \u56fa\u5b9a\u8fd4\u56de <code>0</code>\uff0c\u8fd9\u90e8\u5206\u4f1a\u5c55\u5f00\u5f97\u5230 <code>val</code> \u53c2\u6570\u7684\u503c\uff0c\u4e5f\u5c31\u662f <code>PP_WHILE_FALSE</code>\uff1b\u5426\u5219\u8fd9\u90e8\u5206\u5b8f\u4f1a\u4fdd\u6301\u4e0d\u53d8\uff0c\u4f9d\u7136\u662f <code>PP_WHILE_n(PP_WHILE_FALSE, PP_WHILE_FALSE, PP_WHILE_FALSE)</code>\u3002</p>\n<p>\u628a\u540e\u90e8\u5206\u7684\u7ed3\u679c\u8ddf\u524d\u90e8\u5206 <code>PP_WHILE_CHECK_</code> \u62fc\u63a5\u8d77\u6765\uff0c\u5f97\u5230\u4e24\u79cd\u7ed3\u679c\uff1a<code>PP_WHILE_CHECK_PP_WHILE_FALSE</code> \u6216\u8005 <code>PP_WHILE_CHECK_PP_WHILE_n(PP_WHILE_FALSE, PP_WHILE_FALSE, PP_WHILE_FALSE)</code>\uff0c\u4e8e\u662f\u6211\u4eec\u8ba9 <code>PP_WHILE_CHECK_PP_WHILE_FALSE</code> \u8fd4\u56de <code>1</code> \u8868\u660e\u53ef\u7528\uff0c<code>PP_WHILE_CHECK_PP_WHILE_n</code> \u8fd4\u56de <code>0</code> \u8868\u793a\u4e0d\u53ef\u7528\u3002\u81f3\u6b64\uff0c\u6211\u4eec\u5b8c\u6210\u4e86\u81ea\u52a8\u63a8\u5bfc\u9012\u5f52\u7684\u529f\u80fd\u3002</p>\n<h4>\u7b97\u672f\u6bd4\u8f83</h4>\n<p>\u4e0d\u76f8\u7b49\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_NOT_EQUAL(x, y) PP_NOT_EQUAL_IMPL(x, y)</h1>\n<p>#define PP_NOT_EQUAL_IMPL(x, y) \\\n    PP_CONCAT(PP_NOT_EQUAL_CHECK_, PP_NOT_EQUAL_ ## x(0, PP_NOT_EQUAL_ ## y))</p>\n<h1>define PP_NOT_EQUAL_CHECK_PP_EQUAL_NIL 1</h1>\n<h1>define PP_NOT_EQUAL_CHECK_PP_NOT_EQUAL_0(...) 0</h1>\n<h1>define PP_NOT_EQUAL_CHECK_PP_NOT_EQUAL_1(...) 0</h1>\n<h1>define PP_NOT_EQUAL_CHECK_PP_NOT_EQUAL_2(...) 0</h1>\n<h1>define PP_NOT_EQUAL_CHECK_PP_NOT_EQUAL_3(...) 0</h1>\n<h1>define PP_NOT_EQUAL_CHECK_PP_NOT_EQUAL_4(...) 0</h1>\n<p>// ...</p>\n<h1>define PP_NOT_EQUAL_CHECK_PP_NOT_EQUAL_8(...) 0</h1>\n<h1>define PP_NOT_EQUAL_0(cond, y) PP_IF(cond, PP_EQUAL_NIL, y(1, PP_EQUAL_NIL))</h1>\n<h1>define PP_NOT_EQUAL_1(cond, y) PP_IF(cond, PP_EQUAL_NIL, y(1, PP_EQUAL_NIL))</h1>\n<h1>define PP_NOT_EQUAL_2(cond, y) PP_IF(cond, PP_EQUAL_NIL, y(1, PP_EQUAL_NIL))</h1>\n<h1>define PP_NOT_EQUAL_3(cond, y) PP_IF(cond, PP_EQUAL_NIL, y(1, PP_EQUAL_NIL))</h1>\n<h1>define PP_NOT_EQUAL_4(cond, y) PP_IF(cond, PP_EQUAL_NIL, y(1, PP_EQUAL_NIL))</h1>\n<p>// ...</p>\n<h1>define PP_NOT_EQUAL_8(cond, y) PP_IF(cond, PP_EQUAL_NIL, y(1, PP_EQUAL_NIL))</h1>\n<p>PP_NOT_EQUAL(1, 1)          // -&gt; 0\nPP_NOT_EQUAL(3, 1)          // -&gt; 1\n```</p>\n<p>\u5224\u65ad\u6570\u503c\u662f\u5426\u76f8\u7b49\uff0c\u7528\u5230\u4e86\u7981\u6b62\u9012\u5f52\u91cd\u5165\u7684\u7279\u6027\uff0c\u628a <code>x</code> \u548c <code>y</code> \u9012\u5f52\u62fc\u63a5\u6210 <code>PP_NOT_EQUAL_x PP_NOT_EQUAL_y</code> \u5b8f\uff0c\u5982\u679c <code>x == y</code>\uff0c\u5219\u4e0d\u4f1a\u5c55\u5f00 <code>PP_NOT_EQUAL_y</code> \u5b8f\uff0c\u8ddf <code>PP_NOT_EQUAL_CHECK_</code> \u62fc\u63a5\u6210 <code>PP_NOT_EQUAL_CHECK_PP_NOT_EQUAL_y</code> \u8fd4\u56de <code>0</code>\uff1b\u53cd\u4e4b\uff0c\u4e24\u6b21\u90fd\u6210\u529f\u5c55\u5f00\u6700\u540e\u5f97\u5230 <code>PP_EQUAL_NIL</code>\uff0c\u62fc\u63a5\u5f97\u5230 <code>PP_NOT_EQUAL_CHECK_PP_EQUAL_NIL</code> \u8fd4\u56de <code>1</code>\u3002</p>\n<p>\u76f8\u7b49\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_EQUAL(x, y) PP_NOT(PP_NOT_EQUAL(x, y))</h1>\n<p>PP_EQUAL(1, 1)              // -&gt; 1\nPP_EQUAL(1, 3)              // -&gt; 0</p>\n<p>```</p>\n<p>\u5c0f\u4e8e\u7b49\u4e8e\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_LESS_EQUAL(x, y) PP_NOT(PP_SUB(x, y))</h1>\n<p>PP_LESS_EQUAL(2, 1)         // -&gt; 0\nPP_LESS_EQUAL(1, 1)         // -&gt; 1\nPP_LESS_EQUAL(1, 2)         // -&gt; 1\n```</p>\n<p>\u5c0f\u4e8e\uff1a</p>\n<p>``` cpp</p>\n<h1>define PP_LESS(x, y) PP_AND(PP_LESS_EQUAL(x, y), PP_NOT_EQUAL(x, y))</h1>\n<p>PP_LESS(2, 1)               // -&gt; 0\nPP_LESS(1, 2)               // -&gt; 1\nPP_LESS(2, 2)               // -&gt; 0\n```</p>\n<p>\u53e6\u5916\u8fd8\u6709\u5927\u4e8e\uff0c\u5927\u4e8e\u7b49\u4e8e\u7b49\u7b49\u7b97\u672f\u6bd4\u8f83\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002</p>\n<h4>\u7b97\u672f\u8fd0\u7b97</h4>\n<p>\u5229\u7528 <code>PP_AUTO_WHILE</code> \u6211\u4eec\u53ef\u4ee5\u5b9e\u73b0\u57fa\u7840\u7684\u7b97\u672f\u8fd0\u7b97\u4e86\uff0c\u800c\u4e14\u652f\u6301\u5d4c\u5957\u8fd0\u7b97\u3002</p>\n<p>\u52a0\u6cd5\uff1a</p>\n<p>``` cpp\n#define PP_ADD(x, y) \\\n    PP_IDENTITY(PP_ADD_IMPL PP_AUTO_WHILE(PP_ADD_PRED, PP_ADD_OP, (x, y)))</p>\n<h1>define PP_ADD_IMPL(x, y) x</h1>\n<h1>define PP_ADD_PRED(xy_tuple) PP_ADD_PRED_IMPL xy_tuple</h1>\n<h1>define PP_ADD_PRED_IMPL(x, y) y</h1>\n<h1>define PP_ADD_OP(xy_tuple) PP_ADD_OP_IMPL xy_tuple</h1>\n<h1>define PP_ADD_OP_IMPL(x, y) (PP_INC(x), PP_DEC(y))</h1>\n<p>PP_ADD(1, 2)                  // -&gt; 3\nPP_ADD(1, PP_ADD(1, 2))       // -&gt; 4\n```</p>\n<p>\u51cf\u6cd5\uff1a</p>\n<p>``` cpp\n#define PP_SUB(x, y) \\\n    PP_IDENTITY(PP_SUB_IMPL PP_AUTO_WHILE(PP_SUB_PRED, PP_SUB_OP, (x, y)))</p>\n<h1>define PP_SUB_IMPL(x, y) x</h1>\n<h1>define PP_SUB_PRED(xy_tuple) PP_SUB_PRED_IMPL xy_tuple</h1>\n<h1>define PP_SUB_PRED_IMPL(x, y) y</h1>\n<h1>define PP_SUB_OP(xy_tuple) PP_SUB_OP_IMPL xy_tuple</h1>\n<h1>define PP_SUB_OP_IMPL(x, y) (PP_DEC(x), PP_DEC(y))</h1>\n<p>PP_SUB(2, 1)                // -&gt; 1\nPP_SUB(3, PP_ADD(2, 1))     // -&gt; 0\n```</p>\n<p>\u4e58\u6cd5\uff1a</p>\n<p>``` cpp\n#define PP_MUL(x, y) \\\n    IDENTITY(PP_MUL_IMPL PP_AUTO_WHILE(PP_MUL_PRED, PP_MUL_OP, (0, x, y)))</p>\n<h1>define PP_MUL_IMPL(ret, x, y) ret</h1>\n<h1>define PP_MUL_PRED(rxy_tuple) PP_MUL_PRED_IMPL rxy_tuple</h1>\n<h1>define PP_MUL_PRED_IMPL(ret, x, y) y</h1>\n<h1>define PP_MUL_OP(rxy_tuple) PP_MUL_OP_IMPL rxy_tuple</h1>\n<h1>define PP_MUL_OP_IMPL(ret, x, y) (PP_ADD(ret, x), x, PP_DEC(y))</h1>\n<p>PP_MUL(1, 1)                // -&gt; 1\nPP_MUL(2, PP_ADD(0, 1))     // -&gt; 2\n```</p>\n<p>\u4e58\u6cd5\u5b9e\u73b0\u8fd9\u91cc\u589e\u52a0\u4e86\u4e00\u4e2a\u53c2\u6570 <code>ret</code>\uff0c\u521d\u59cb\u503c\u4e3a <code>0</code>\uff0c\u6bcf\u6b21\u8fed\u4ee3\u4f1a\u6267\u884c <code>ret = ret + x</code>\u3002</p>\n<p>\u9664\u6cd5\uff1a</p>\n<p>``` cpp\n#define PP_DIV(x, y) \\\n    IDENTITY(PP_DIV_IMPL PP_AUTO_WHILE(PP_DIV_PRED, PP_DIV_OP, (0, x, y)))</p>\n<h1>define PP_DIV_IMPL(ret, x, y) ret</h1>\n<h1>define PP_DIV_PRED(rxy_tuple) PP_DIV_PRED_IMPL rxy_tuple</h1>\n<h1>define PP_DIV_PRED_IMPL(ret, x, y) PP_LESS_EQUAL(y, x)</h1>\n<h1>define PP_DIV_OP(rxy_tuple) PP_DIV_OP_IMPL rxy_tuple</h1>\n<h1>define PP_DIV_OP_IMPL(ret, x, y) (PP_INC(ret), PP_SUB(x, y), y)</h1>\n<p>PP_DIV(1, 2)                // -&gt; 0\nPP_DIV(2, 1)                // -&gt; 2\nPP_DIV(2, PP_ADD(1, 1))     // -&gt; 1\n```</p>\n<p>\u9664\u6cd5\u5229\u7528\u4e86 <code>PP_LESS_EQUAL</code>\uff0c\u53ea\u6709 <code>y &lt;= x</code> \u7684\u60c5\u51b5\u4e0b\u624d\u7ee7\u7eed\u5faa\u73af\u3002</p>\n<h4>\u6570\u636e\u7ed3\u6784</h4>\n<p>\u5b8f\u4e5f\u53ef\u4ee5\u6709\u6570\u636e\u7ed3\u6784\uff0c\u5176\u5b9e\u6211\u4eec\u5728\u524d\u9762\u7684\u4e5f\u7a0d\u5fae\u7528\u5230\u4e86\u4e00\u79cd\u6570\u636e\u7ed3\u6784 <code>tuple</code>\uff0c<code>PP_REMOVE_PARENS</code> \u5c31\u662f\u53ef\u4ee5\u53bb\u6389 <code>tuple</code> \u7684\u5916\u5c42\u62ec\u53f7\uff0c\u8fd4\u56de\u91cc\u9762\u7684\u5143\u7d20\u3002\u6211\u4eec\u8fd9\u91cc\u5c31\u4ee5 <code>tuple</code> \u4e3a\u4f8b\u5b50\u8ba8\u8bba\u76f8\u5173\u7684\u5b9e\u73b0\uff0c\u5176\u4ed6\u7684\u6570\u636e\u7ed3\u6784 <code>list, array</code> \u7b49\u6709\u5174\u8da3\u53ef\u4ee5\u53bb\u770b <code>Boost</code> \u7684\u5b9e\u73b0\u3002</p>\n<p><code>tuple</code> \u5b9a\u4e49\u4e3a\u7528\u62ec\u53f7\u5305\u4f4f\u7684\u9017\u53f7\u5206\u5f00\u7684\u5143\u7d20\u96c6\u5408\uff1a<code>(a, b, c)</code>\u3002</p>\n<p>``` cpp</p>\n<h1>define PP_TUPLE_REMOVE_PARENS(tuple) PP_REMOVE_PARENS(tuple)</h1>\n<p>// \u83b7\u53d6\u6307\u5b9a\u4e0b\u6807\u7684\u5143\u7d20</p>\n<h1>define PP_TUPLE_ELEM(i, tuple) PP_ARGS_ELEM(i, PP_TUPLE_REMOVE_PARENS(tuple))</h1>\n<p>// \u541e\u6389\u6574\u4e2a tuple \u8fd4\u56de\u7a7a</p>\n<h1>define PP_TUPLE_EAT() PP_EMPTY_EAT</h1>\n<p>// \u83b7\u53d6\u5927\u5c0f</p>\n<h1>define PP_TUPLE_SIZE(tuple) PP_ARGS_SIZE(PP_TUPLE_REMOVE_PARENS(tuple))</h1>\n<p>// \u6dfb\u52a0\u5143\u7d20\n#define PP_TUPLE_PUSH_BACK(elem, tuple) \\\n    PP_TUPLE_PUSH_BACK_IMPL(PP_TUPLE_SIZE(tuple), elem, tuple)\n#define PP_TUPLE_PUSH_BACK_IMPL(size, elem, tuple) \\\n    (PP_TUPLE_REMOVE_PARENS(tuple) PP_IF(size, PP_COMMA, PP_EMPTY)() elem)</p>\n<p>// \u63d2\u5165\u5143\u7d20\n#define PP_TUPLE_INSERT(i, elem, tuple) \\\n    PP_TUPLE_ELEM( \\\n        3, \\\n        PP_AUTO_WHILE( \\\n            PP_TUPLE_INSERT_PRED, \\\n            PP_TUPLE_INSERT_OP, \\\n            (0, i, elem, (), tuple) \\\n        ) \\\n    )</p>\n<h1>define PP_TUPLE_INSERT_PRED(args) PP_TUPLE_INSERT_PERD_IMPL args</h1>\n<p>#define PP_TUPLE_INSERT_PERD_IMPL(curi, i, elem, ret, tuple) \\\n    PP_NOT_EQUAL(PP_TUPLE_SIZE(ret), PP_INC(PP_TUPLE_SIZE(tuple)))</p>\n<h1>define PP_TUPLE_INSERT_OP(args) PP_TUPLE_INSERT_OP_IMPL args</h1>\n<p>#define PP_TUPLE_INSERT_OP_IMPL(curi, i, elem, ret, tuple) \\\n    ( \\\n    PP_IF(PP_NOT_EQUAL(PP_TUPLE_SIZE(ret), i), PP_INC(curi), curi), \\\n    i, elem, \\\n    PP_TUPLE_PUSH_BACK(\\\n        PP_IF( \\\n            PP_NOT_EQUAL(PP_TUPLE_SIZE(ret), i), \\\n            PP_TUPLE_ELEM(curi, tuple), elem \\\n        ), \\\n        ret \\\n    ), \\\n    tuple \\\n    )</p>\n<p>// \u5220\u9664\u672b\u5c3e\u5143\u7d20\n#define PP_TUPLE_POP_BACK(tuple) \\\n    PP_TUPLE_ELEM( \\\n        1, \\\n        PP_AUTO_WHILE( \\\n            PP_TUPLE_POP_BACK_PRED, \\\n            PP_TUPLE_POP_BACK_OP, \\\n            (0, (), tuple) \\\n        ) \\\n    )</p>\n<h1>define PP_TUPLE_POP_BACK_PRED(args) PP_TUPLE_POP_BACK_PRED_IMPL args</h1>\n<p>#define PP_TUPLE_POP_BACK_PRED_IMPL(curi, ret, tuple) \\\n    PP_IF( \\\n        PP_TUPLE_SIZE(tuple), \\\n        PP_NOT_EQUAL(PP_TUPLE_SIZE(ret), PP_DEC(PP_TUPLE_SIZE(tuple))), \\\n        0 \\\n    )</p>\n<h1>define PP_TUPLE_POP_BACK_OP(args) PP_TUPLE_POP_BACK_OP_IMPL args</h1>\n<p>#define PP_TUPLE_POP_BACK_OP_IMPL(curi, ret, tuple) \\\n    (PP_INC(curi), PP_TUPLE_PUSH_BACK(PP_TUPLE_ELEM(curi, tuple), ret), tuple)</p>\n<p>// \u5220\u9664\u5143\u7d20\n#define PP_TUPLE_REMOVE(i, tuple) \\\n    PP_TUPLE_ELEM( \\\n        2, \\\n        PP_AUTO_WHILE( \\\n            PP_TUPLE_REMOVE_PRED, \\\n            PP_TUPLE_REMOVE_OP, \\\n            (0, i, (), tuple) \\\n        ) \\\n    )</p>\n<h1>define PP_TUPLE_REMOVE_PRED(args) PP_TUPLE_REMOVE_PRED_IMPL args</h1>\n<p>#define PP_TUPLE_REMOVE_PRED_IMPL(curi, i, ret, tuple) \\\n    PP_IF( \\\n        PP_TUPLE_SIZE(tuple), \\\n        PP_NOT_EQUAL(PP_TUPLE_SIZE(ret), PP_DEC(PP_TUPLE_SIZE(tuple))), \\\n        0 \\\n    )</p>\n<h1>define PP_TUPLE_REMOVE_OP(args) PP_TUPLE_REMOVE_OP_IMPL args</h1>\n<p>#define PP_TUPLE_REMOVE_OP_IMPL(curi, i, ret, tuple) \\\n    ( \\\n    PP_INC(curi), \\\n    i, \\\n    PP_IF( \\\n        PP_NOT_EQUAL(curi, i), \\\n        PP_TUPLE_PUSH_BACK(PP_TUPLE_ELEM(curi, tuple), ret), \\\n        ret \\\n    ), \\\n    tuple \\\n    )</p>\n<p>PP_TUPLE_SIZE(())               // -&gt; 0</p>\n<p>PP_TUPLE_PUSH_BACK(2, (1))      // -&gt; (1, 2)\nPP_TUPLE_PUSH_BACK(2, ())       // -&gt; (2)</p>\n<p>PP_TUPLE_INSERT(1, 2, (1, 3))   // -&gt; (1, 2, 3)</p>\n<p>PP_TUPLE_POP_BACK(())           // -&gt; ()\nPP_TUPLE_POP_BACK((1))          // -&gt; ()\nPP_TUPLE_POP_BACK((1, 2, 3))    // -&gt; (1, 2)</p>\n<p>PP_TUPLE_REMOVE(1, (1, 2, 3))   // -&gt; (1, 3)\nPP_TUPLE_REMOVE(0, (1, 2, 3))   // -&gt; (2, 3)\n```</p>\n<p>\u8fd9\u91cc\u7a0d\u5fae\u89e3\u91ca\u4e00\u4e0b\u63d2\u5165\u5143\u7d20\u7684\u5b9e\u73b0\uff0c\u5176\u4ed6\u5220\u9664\u5143\u7d20\u7b49\u64cd\u4f5c\u4e5f\u662f\u901a\u8fc7\u7c7b\u4f3c\u7684\u539f\u7406\u6765\u5b9e\u73b0\u7684\u3002<code>PP_TUPLE_INSERT(i, elem, tuple)</code> \u53ef\u4ee5\u5728 <code>tuple</code> \u7684\u4f4d\u7f6e <code>i</code> \u63d2\u5165\u5143\u7d20 <code>elem</code>\uff0c\u4e3a\u4e86\u5b8c\u6210\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u5148\u628a\u4f4d\u7f6e\u5c0f\u4e8e <code>i</code> \u7684\u5143\u7d20\u90fd\u5148\u7528 <code>PP_TUPLE_PUSH_BACK</code> \u653e\u5230\u4e00\u4e2a\u65b0\u7684 <code>tuple</code> \u4e0a\uff08<code>ret</code>\uff09\uff0c\u7136\u540e\u5728\u4f4d\u7f6e <code>i</code> \u653e\u5165\u5143\u7d20 <code>elem</code>\uff0c\u4e4b\u540e\u518d\u628a\u539f <code>tuple</code> \u4f4d\u7f6e\u5927\u4e8e\u7b49\u4e8e <code>i</code> \u7684\u5143\u7d20\u653e\u5230 <code>ret</code> \u540e\u9762\uff0c\u6700\u540e <code>ret</code> \u5c31\u5f97\u5230\u6211\u4eec\u60f3\u8981\u7684\u7ed3\u679c\u3002</p>\n<h2>\u5c0f\u7ed3</h2>\n<p>\u672c\u6587\u7684\u76ee\u7684\u662f\u60f3\u8981\u9610\u8ff0\u6e05\u695a C/C++ \u5b8f\u7f16\u7a0b\u7684\u539f\u7406\u548c\u57fa\u672c\u5b9e\u73b0\uff0c\u5728\u8bb0\u5f55\u6211\u672c\u4eba\u7684\u4e00\u4e9b\u7406\u89e3\u548c\u8ba4\u8bc6\u7684\u540c\u65f6\uff0c\u5e0c\u671b\u80fd\u591f\u5bf9\u5176\u4ed6\u4eba\u80fd\u5e26\u6765\u4e00\u4e9b\u89e3\u60d1\u548c\u542f\u53d1\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5c3d\u7ba1\u672c\u6587\u7bc7\u5e45\u6709\u70b9\u957f\uff0c\u4f46\u8fd8\u662f\u6709\u4e00\u4e9b\u5173\u4e8e\u5b8f\u7f16\u7a0b\u7684\u6280\u5de7\u548c\u7528\u6cd5\u662f\u6ca1\u6709\u6d89\u53ca\u5230\u7684\uff0c\u8b6c\u5982 CHAOS_PP \u63d0\u51fa\u7684<a href=\"https://github.com/pfultz2/Cloak/wiki/C-Preprocessor-tricks,-tips,-and-idioms#deferred-expression\">\u57fa\u4e8e\u5ef6\u8fdf\u5c55\u5f00\u7684\u9012\u5f52\u8c03\u7528\u65b9\u6cd5</a>\uff0cBOOST_PP \u91cc\u9762\u7684 <code>REPEAT</code> \u76f8\u5173\u5b8f\u7b49\u7b49\uff0c\u6709\u5174\u8da3\u7684\u53ef\u4ee5\u81ea\u884c\u67e5\u9605\u8d44\u6599\u3002</p>\n<p>\u5b8f\u7f16\u7a0b\u7684\u8c03\u8bd5\u662f\u4e00\u4e2a\u75db\u82e6\u7684\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\uff1a</p>\n<ul>\n<li>\u7528 <code>-P -E</code> \u9009\u9879\u8f93\u51fa\u9884\u5904\u7406\u7ed3\u679c\uff1b</li>\n<li>\u7528\u524d\u9762\u63d0\u5230\u7684\u6211\u81ea\u5df1\u4fee\u6539\u7684 <code>clang</code> \u7248\u672c\u4ed4\u7ec6\u7814\u7a76\u5c55\u5f00\u8fc7\u7a0b\uff1b</li>\n<li>\u628a\u590d\u6742\u7684\u5b8f\u62c6\u89e3\uff0c\u67e5\u770b\u4e2d\u95f4\u5b8f\u7684\u5c55\u5f00\u7ed3\u679c\uff1b</li>\n<li>\u5c4f\u853d\u65e0\u5173\u7684\u5934\u6587\u4ef6\u548c\u5b8f\uff1b</li>\n<li>\u6700\u540e\u5c31\u662f\u8981\u8111\u8865\u5b8f\u5c55\u5f00\u7684\u8fc7\u7a0b\u4e86\uff0c\u719f\u6089\u5b8f\u5c55\u5f00\u4e4b\u540e\u8c03\u8bd5\u7684\u6548\u7387\u4e5f\u4f1a\u63d0\u5347\u3002</li>\n</ul>\n<p>\u672c\u6587\u4e2d\u7684\u5b8f\u662f\u6211\u81ea\u5df1\u5728\u7406\u89e3\u4e86\u539f\u7406\u4e4b\u540e\u91cd\u65b0\u5b9e\u73b0\u51fa\u6765\u7684\uff0c\u6709\u90e8\u5206\u5b8f\u501f\u9274\u4e86 <code>Boost</code> \u7684\u5b9e\u73b0\u548c\u5f15\u7528\u91cc\u9762\u7684\u6587\u7ae0\uff0c\u6709\u4efb\u4f55\u9519\u8bef\u4e4b\u5904\uff0c\u6b22\u8fce\u968f\u65f6\u6307\u6b63\uff0c\u4e5f\u6b22\u8fce\u627e\u6211\u6765\u8ba8\u8bba\u76f8\u5173\u7684\u95ee\u9898\u3002</p>\n<p>\u672c\u6587\u7684\u4ee3\u7801\u5168\u90e8\u90fd\u5728\u8fd9\u91cc\uff1a<a href=\"assets/img/2021-3-31-cpp-preprocess/macros.cpp\">\u4e0b\u8f7d</a>\uff0c<a href=\"https://godbolt.org/z/coWvc5Pse\">\u5728\u7ebf\u6f14\u793a</a>\u3002</p>\n<h2>\u5f15\u7528</h2>\n<ul>\n<li><a href=\"https://www.boost.org/doc/libs/1_75_0/libs/preprocessor/doc/\">Boost.Preprocessor</a></li>\n<li><a href=\"https://bot-man-jl.github.io/articles/?post=2020/Macro-Programming-Art\">C/C++ \u5b8f\u7f16\u7a0b\u7684\u827a\u672f</a></li>\n</ul>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/cpp-C%E5%92%8CCpp%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/",
            "url": "https://wiki.disenone.site/cpp-C%E5%92%8CCpp%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86%E6%80%BB%E7%BB%93/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "C/C++ \u7684\u547d\u4ee4\u884c\u53c2\u6570\u5904\u7406\u603b\u7ed3",
            "content_html": "<p><meta property=\"og:title\" content=\"C/C++ \u7684\u547d\u4ee4\u884c\u53c2\u6570\u5904\u7406\u603b\u7ed3\" /></p>\n<p><img alt=\"\" src=\"https://img.shields.io/badge/vs-2015-68217A.svg\">{:style=\"display: inline-block\"}\n<img alt=\"\" src=\"https://img.shields.io/badge/gcc-4.9-blue.svg\">{:style=\"display: inline-block\"}\n<img alt=\"\" src=\"https://img.shields.io/badge/clang-3.7-birghtgreen.svg\">{:style=\"display: inline-block\"}</p>\n<p><img alt=\"\" src=\"assets/img/2016-11-19-aparsing/aparsing.png\"></p>\n<p>\u524d\u4e00\u9635\u5b50\u7ffb Linux \u5185\u6838\u4ee3\u7801\u7684\u65f6\u5019\u770b\u5230\u4e86\u5185\u6838\u5bf9\u6a21\u5757\u53c2\u6570 (moduleparam) \u7684\u5904\u7406\uff0c\u89c9\u5f97\u633a\u7cbe\u5999\uff0c\u8ba9\u6211\u4e0d\u7981\u60f3\u7814\u7a76\u4e0b C \u4e0b\u7684\u547d\u4ee4\u884c\u53c2\u6570\u8981\u600e\u6837\u66f4\u597d\u5730\u5904\u7406\u3002\u672c\u6587\u6240\u7528\u4ee3\u7801\u90fd\u5728\u8fd9\u91cc <a href=\"https://github.com/disenone/aparsing\">aparsing</a> \u3002\u4ee3\u7801\u652f\u6301\u5728 Windows \u3001 Linux \u3001 Mac OS X \u4e0b\u7f16\u8bd1\u8fd0\u884c\uff0c\u8be6\u7ec6\u7684\u7f16\u8bd1\u6307\u5357\u5728 README.md \u91cc\u9762\u3002 </p>\n<h2>getenv</h2>\n<p>\u6807\u51c6\u5e93\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u51fd\u6570 <code>getenv</code> \uff0c\u6309\u7167\u5b57\u9762\u610f\u601d\uff0c\u8fd9\u4e2a\u51fd\u6570\u662f\u7528\u6765\u83b7\u53d6\u73af\u5883\u53d8\u91cf\u7684\uff0c\u90a3\u4e48\u53ea\u8981\u6211\u4eec\u9884\u5148\u8bbe\u7f6e\u597d\u9700\u8981\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5728\u7a0b\u5e8f\u91cc\u9762\u62ff\u51fa\u6765\uff0c\u5c31\u95f4\u63a5\u5730\u628a\u53c2\u6570\u4f20\u5230\u7a0b\u5e8f\u91cc\u9762\u5566\u3002\u6211\u4eec\u6765\u770b\u4e0b\u9762\u8fd9\u6bb5<a href=\"https://github.com/disenone/aparsing/blob/master/getenv/getenv_test.c\">\u4ee3\u7801</a>\uff1a</p>\n<p>``` cpp linenums=\"1\"</p>\n<h1>include <stdlib.h></h1>\n<h1>include <stdio.h></h1>\n<p>//char <em>getenv( const char </em>name );\n//GETENV_ADD=abc GETENV_NUM=2 ./getenv_test </p>\n<p>int main (int argc, char <em><em>argv)\n{\n    char </em>add, </em>num;\n    if((add = getenv(\"GETENV_ADD\")))\n        printf(\"GETENV_ADD = %s\\n\", add);\n    else\n        printf(\"GETENV_ADD not found\\n\");</p>\n<pre><code>if((num = getenv(\"GETENV_NUM\")))\n{\n    int numi = atoi(num);\n    printf(\"GETENV_NUM = %d\\n\", numi);\n}\nelse\n    printf(\"GETENV_NUM not found\\n\");\n</code></pre>\n<p>}\n```</p>\n<p><code>getenv</code> \u51fd\u6570\u58f0\u660e\u5982\u7b2c <a href=\"#__codelineno-0-5\">4</a> \u884c\uff0c\u4f20\u5165\u60f3\u8981\u83b7\u53d6\u7684\u53d8\u91cf\u540d\u5b57\uff0c\u8fd4\u56de\u8be5\u53d8\u91cf\u7684\u503c\uff0c\u5982\u679c\u627e\u4e0d\u5230\u53d8\u91cf\uff0c\u5219\u8fd4\u56de0\u3002<a href=\"#__codelineno-0-10\">10</a> \u548c <a href=\"#__codelineno-0-15\">15</a> \u884c\u5c31\u662f\u5206\u522b\u83b7\u53d6\u4e24\u4e2a\u73af\u5883\u53d8\u91cf\u7684\u503c\uff0c\u5982\u679c\u53d8\u91cf\u6709\u6548\u5219\u6253\u5370\u53d8\u91cf\u503c\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f <code>getenv</code> \u8fd4\u56de\u7684\u90fd\u662f\u5b57\u7b26\u4e32\uff0c\u9700\u8981\u4f7f\u7528\u8005\u624b\u52a8\u8f6c\u6362\u6570\u503c\u7c7b\u578b\u7684\uff0c\u6240\u4ee5\u4f7f\u7528\u8d77\u6765\u4e0d\u591f\u65b9\u4fbf\u3002\u7f16\u8bd1\u8fd0\u884c:</p>\n<p>Windows \u4e0b\uff1a</p>\n<p><code>bat\nset GETENV_ADD=abc &amp; set GETENV_NUM=1 &amp; .\\getenv_test.exe</code></p>\n<p>Linux \u4e0b\uff1a</p>\n<p><code>shell\nGETENV_ADD=abc GETENV_NUM=2 ./getenv_test</code></p>\n<p>\u8f93\u51fa\uff1a</p>\n<p><code>GETENV_ADD = abc\nGETENV_NUM = 2</code></p>\n<h2>getopt</h2>\n<p>Linux \u7ed9\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u7ec4\u51fd\u6570 <code>getopt, getopt_long, getopt_long_only</code> \u6765\u5904\u7406\u547d\u4ee4\u884c\u4f20\u9012\u8fdb\u6765\u7684\u51fd\u6570\uff0c\u8fd9\u4e09\u4e2a\u51fd\u6570\u7684\u58f0\u660e\u5206\u522b\u662f\uff1a</p>\n<p>```cpp linenums=\"1\"\nextern char *optarg;\nextern int optind, opterr, optopt;</p>\n<p>int getopt(int argc, char * const argv[],\n                  const char *optstring);</p>\n<p>int getopt_long(int argc, char * const argv[],\n            const char <em>optstring,\n            const struct option </em>longopts, int *longindex);</p>\n<p>int getopt_long_only(int argc, char * const argv[],\n            const char <em>optstring,\n            const struct option </em>longopts, int *longindex);\n```</p>\n<p><code>getopt</code> \u53ea\u80fd\u5904\u7406\u77ed\u53c2\u6570\uff08\u5373\u5355\u5b57\u7b26\u53c2\u6570\uff09\uff0c<code>getopt_long, getopt_long_only</code> \u5219\u53ef\u4ee5\u5904\u7406\u957f\u53c2\u6570\u3002\u8be6\u7ec6\u7684\u51fd\u6570\u89e3\u91ca\u53ef\u4ee5\u53bb\u7ffb Linux \u4e0b\u7684\u624b\u518c\uff0c\u4e0b\u9762\u6211\u4eec\u901a\u8fc7\u4f8b\u5b50\u6765\u8bf4\u660e <code>getopt</code> \u548c <code>getopt_long</code> \u7684\u7528\u6cd5\u3002</p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c Windows \u4e0b\u662f\u6ca1\u6709\u63d0\u4f9b\u8fd9\u4e00\u7ec4\u51fd\u6570\u7684\uff0c\u6240\u4ee5\u6211\u627e\u4e86\u4e00\u4efd\u53ef\u4ee5\u5728 Windows \u4e0b\u7f16\u8bd1\u7684\u6e90\u7801\uff0c\u505a\u4e86\u5c0f\u5c0f\u7684\u6539\u52a8\uff0c\u4ee3\u7801\u90fd\u5728<a href=\"https://github.com/disenone/aparsing/tree/master/getopt\">\u8fd9\u91cc</a>\u3002</p>\n<p>```cpp linenums=\"1\"\n// test getopt</p>\n<h1>include <getopt.h></h1>\n<h1>include <stdio.h></h1>\n<h1>include <string.h></h1>\n<p>static struct option long_options[] =\n{\n    {\"add\", required_argument, 0, 'a'},\n    {\"append\", no_argument, 0, 0},\n    {\"delete\", required_argument, 0, 0},\n    {\"verbose\", optional_argument, 0, 0},\n    {\"create\", no_argument, 0, 0},\n    {\"file\", required_argument, 0, 0},\n    {\"help\", no_argument, 0, 0},\n    {0, 0, 0, 0}\n};</p>\n<p>static char simple_options[] = \"a:bc::d:0123456789\";</p>\n<p>int main (int argc, char **argv)\n{</p>\n<pre><code>int c;\nint digit_optind = 0;\n\nwhile (1)\n{\n    int this_option_optind = optind ? optind : 1;\n    int longindex = -1;\n\n    c = getopt_long(argc, argv, simple_options, long_options, &amp;longindex);\n    if (c == -1)\n    break;\n\n    switch (c)\n    {\n        // long option\n        case 0:\n               printf(\"option %s\", long_options[longindex].name);\n               if (optarg)\n                   printf(\" with arg %s\", optarg);\n               printf(\"\\n\");\n               break;\n\n            break;\n\n        case '0':\n        case '1':\n        case '2':\n        case '3':\n        case '4':\n        case '5':\n        case '6':\n        case '7':\n        case '8':\n        case '9':\n            if(digit_optind != 0 &amp;&amp; digit_optind != this_option_optind)\n                printf(\"digits occur in two different argv-elements.\\n\");\n\n            digit_optind = this_option_optind;\n            printf(\"option %c\\n\", c);\n            break;\n\n        case 'a':\n            printf(\"option a with value '%s'\\n\", optarg);\n            break;\n\n        case 'b':\n            printf(\"option b\\n\");\n            break;\n\n        case 'c':\n            if(optarg)\n                printf(\"option c with value '%s'\\n\", optarg);\n            else\n                printf(\"option c\\n\");\n            break;\n\n        case '?':\n            break;\n\n        default:\n            printf(\"?? getopt returned character code 0%o ??\\n\", c);\n    } // switch\n} // while\n\nif (optind &lt; argc)\n{\n    printf(\"non-option ARGV-elements: \");\n    while (optind &lt; argc)\n    printf(\"%s \", argv[optind++]);\n    printf(\"\\n\");\n}\n\nreturn 0;\n</code></pre>\n<p>}</p>\n<p>```</p>\n<p>\u6211\u4eec\u6765\u7740\u91cd\u5206\u6790 <code>getopt_long</code> \u7684\u7528\u6cd5\uff0c<code>getopt_long</code> \u7684\u524d\u4e09\u4e2a\u53c2\u6570\u8ddf <code>getopt</code> \u662f\u4e00\u6837\u7684\uff0c\u5206\u522b\u662f\uff1a\u547d\u4ee4\u884c\u53c2\u6570\u4e2a\u6570 <code>argc</code> \uff0c\u547d\u4ee4\u884c\u53c2\u6570\u6570\u7ec4 <code>argv</code>\uff0c\u77ed\u53c2\u6570\u5177\u4f53\u5f62\u5f0f <code>optstring</code>\u3002<code>otpstring</code> \u7684\u683c\u5f0f\u5c31\u662f\u4e00\u4e2a\u4e2a\u7684\u77ed\u53c2\u6570\u5b57\u7b26\uff0c\u540e\u9762\u52a0\u5192\u53f7 <code>:</code> \u8868\u793a\u5e26\u53c2\u6570\uff0c\u4e24\u4e2a\u5192\u53f7 <code>::</code> \u8868\u793a\u53ef\u9009\u53c2\u6570\uff0c\u8b6c\u5982\u7b2c 19 \u884c\uff0c\u5c31\u662f\u58f0\u660e\u77ed\u53c2\u6570\u7684\u5f62\u5f0f\uff0c<code>b</code> \u53c2\u6570\u4e0d\u5e26\u989d\u5916\u53c2\u6570\uff0c <code>a</code> \u53c2\u6570\u5e26\u989d\u5916\u53c2\u6570\uff0c<code>c</code> \u5e26\u53ef\u9009\u53c2\u6570\u3002</p>\n<p><code>getopt_long</code> \u540e\u4e24\u4e2a\u53c2\u6570\u662f\u7528\u6765\u5904\u7406\u957f\u53c2\u6570\u7684\uff0c\u5176\u4e2d <code>option</code> \u7684\u7ed3\u6784\u662f\uff1a</p>\n<p><code>c\nstruct option {\n    const char *name;       // \u957f\u53c2\u6570\u540d\u5b57\n    int         has_arg;    // \u662f\u5426\u5e26\u989d\u5916\u53c2\u6570\n    int        *flag;       // \u8bbe\u7f6e\u5982\u4f55\u8fd4\u56de\u51fd\u6570\u8c03\u7528\u7ed3\u679c\n    int         val;        // \u8fd4\u56de\u7684\u6570\u503c\n};</code>\n\u867d\u7136\u8bf4\u662f\u957f\u53c2\u6570\uff0c\u4f46 <code>name</code> \u8fd8\u662f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a\u5355\u5b57\u7b26\u957f\u5ea6\u7684\u3002</p>\n<p><code>has_arg</code> \u53ef\u4ee5\u8bbe\u7f6e\u4e3a <code>no_argument, required_argument, optional_argument</code>\uff0c\u5206\u522b\u8868\u793a\u4e0d\u5e26\u53c2\u6570\uff0c\u5e26\u53c2\u6570\uff0c\u5e26\u53ef\u9009\u53c2\u6570\u3002</p>\n<p><code>flag</code> \u548c <code>val</code> \u662f\u914d\u5408\u4f7f\u7528\u7684\uff0c\u5982\u679c <code>flag = NULL</code>\uff0c<code>getopt_long</code> \u4f1a\u76f4\u63a5\u8fd4\u56de <code>val</code> \uff0c\u5426\u5219\u5982\u679c <code>flag</code> \u4e3a\u6709\u6548\u6307\u9488\uff0c<code>getopt_long</code> \u4f1a\u6267\u884c\u7c7b\u4f3c <code>*flag = val</code> \u7684\u64cd\u4f5c\uff0c\u628a <code>flag</code> \u6307\u5411\u7684\u53d8\u91cf\u8bbe\u7f6e\u4e3a <code>val</code> \u7684\u6570\u503c\u3002</p>\n<p>\u5982\u679c <code>getopt_long</code> \u627e\u5230\u5339\u914d\u7684\u77ed\u53c2\u6570\uff0c\u4f1a\u8fd4\u56de\u8be5\u77ed\u53c2\u6570\u7684\u5b57\u7b26\u503c\uff0c\u5982\u679c\u627e\u5230\u5339\u914d\u7684\u957f\u53c2\u6570\uff0c\u4f1a\u8fd4\u56de <code>val</code>\uff08 <code>flag = NULL</code> \uff09\u6216\u8005\u8fd4\u56de <code>0</code> \uff08 <code>flag != NULL; *flag = val;</code> \uff09\uff1b\u5982\u679c\u9047\u5230\u975e\u53c2\u6570\u7684\u5b57\u7b26\uff0c\u4f1a\u8fd4\u56de <code>?</code>\uff1b\u5982\u679c\u6240\u6709\u53c2\u6570\u90fd\u5904\u7406\u5b8c\u6bd5\uff0c\u5219\u8fd4\u56de <code>-1</code> \u3002</p>\n<p>\u5229\u7528\u8fd4\u56de\u503c\u7684\u7279\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u505a\u51fa\u7528\u957f\u53c2\u8ddf\u77ed\u53c2\u542b\u4e49\u76f8\u540c\u7684\u6548\u679c\uff0c\u8b6c\u5982 <code>long_options</code> \u7684\u7b2c\u4e00\u4e2a\u53c2\u6570 <code>add</code>\uff0c\u5176 <code>val</code> \u503c\u8bbe\u7f6e\u4e3a\u77ed\u53c2\u6570\u7684\u5b57\u7b26 <code>'a'</code>\uff0c\u90a3\u4e48\u5224\u65ad\u8fd4\u56de\u65f6\uff0c<code>--add</code> \u548c <code>-a</code> \u4f1a\u8fdb\u5165\u76f8\u540c\u7684\u5904\u7406\u5206\u652f\uff0c\u88ab\u5f53\u4f5c\u76f8\u540c\u7684\u542b\u4e49\u6765\u5904\u7406\u4e86\u3002</p>\n<p>\u62fc\u56fe\u7684\u6700\u540e\u4e00\u5757\u5c31\u662f <code>optind</code> \u548c <code>optarg</code> \u7684\u7528\u6cd5\uff0c<code>optind</code> \u662f\u4e0b\u4e00\u4e2a\u5f85\u5904\u7406\u53c2\u6570\u5728 <code>argv</code> \u4e2d\u7684\u4f4d\u7f6e\uff0c <code>optarg</code> \u5219\u6307\u5411\u989d\u5916\u53c2\u6570\u5b57\u7b26\u4e32\u3002</p>\n<p>\u7f16\u8bd1\u8fd0\u884c\u4ee3\u7801\uff1a</p>\n<p><code>``\n$ .\\getopt_test -a 1 -b -c4 --add 2 --verbose --verbose=3 -123 -e --e\noption a with value '1'\noption b\noption c with value '4'\noption a with value '2'\noption verbose\noption verbose with arg 3\noption 1\noption 2\noption 3\n.\\getopt_test: invalid option -- e\n.\\getopt_test: unrecognized option</code>--e'</p>\n<p>```</p>\n<p><code>-a</code> \u548c <code>--add</code> \u7684\u542b\u4e49\u76f8\u540c\uff0c\u77ed\u53c2\u6570\u7684\u53ef\u9009\u53c2\u6570\u76f4\u63a5\u8ddf\u5728\u540e\u9762\uff0c\u8b6c\u5982 <code>-c4</code>\uff0c\u800c\u957f\u53c2\u6570\u7684\u53ef\u9009\u53c2\u6570\u9700\u8981\u6709\u7b49\u53f7\uff0c\u8b6c\u5982 <code>--verbose=3</code>\u3002</p>\n<h2>mobuleparam</h2>\n<p>ok\uff0c\u7ec8\u4e8e\u6765\u5230\u6700\u521d\u5f15\u53d1\u8fd9\u7bc7\u6587\u7ae0\u7684\u65b9\u6cd5\uff0cLinux \u5185\u6838\u7528\u4e86\u4e00\u79cd\u5f88\u53d6\u5de7\u7684\u65b9\u6cd5\u6765\u7ed9\u5185\u6838\u6a21\u5757\u4f20\u9012\u53c2\u6570\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u5c31\u662f <code>moduleparam</code> \u3002\u6211\u5728\u8fd9\u91cc\u5148\u7b80\u5355\u89e3\u91ca Linux \u5185\u6838\u7684 <code>moduleparam</code> \u7684\u505a\u6cd5\uff0c\u66f4\u8be6\u7ec6\u7684\u89e3\u91ca\u53ef\u4ee5\u53bb\u770b\u4ee3\u7801\u3002\u867d\u7136\u6211\u501f\u9274\u4e86\u4e00\u4e9b <code>moduleparam</code> \u7684\u5904\u7406\u65b9\u6cd5\uff0c\u4f46\u548c Linux \u5185\u6838\u7684 <code>moduleparam</code> \u6709\u4e00\u4e9b\u4e0d\u540c\uff0c\u4e3a\u4e86\u533a\u5206\uff0c\u6211\u4f1a\u628a\u6211\u7684\u65b9\u6cd5\u53eb\u505a <code>small moduleparam</code> \uff0c Linux \u5185\u6838\u7684\u4f9d\u7136\u53eb\u505a <code>moduleparam</code> \u3002</p>\n<p>\u5148\u6765\u770b\u770b <code>moduleparam</code> \u7684\u7528\u6cd5\uff0c\u5728\u6a21\u5757\u91cc\u9762\u58f0\u660e\uff1a</p>\n<p><code>c\nint enable_debug = 0;\nmodule_param(enable_debug, int, 0);</code></p>\n<p>\u7136\u540e\u52a0\u8f7d\u6a21\u5757\u65f6\u8f93\u5165\u53c2\u6570\uff1a</p>\n<p><code>shell\n$ insmod mod enable_debug=1</code></p>\n<p>\u53d8\u91cf <code>enable_debug</code> \u5c31\u88ab\u6b63\u786e\u5730\u8bbe\u7f6e\u4e3a <code>1</code>\uff0c\u4f7f\u7528\u8d77\u6765\u5f88\u65b9\u4fbf\uff0c\u9700\u8981\u589e\u52a0\u7684\u4ee3\u7801\u4e5f\u5f88\u5c11\uff0c\u4ee3\u7801\u53ef\u4ee5\u5199\u5f97\u5f88\u7b80\u77ed\u4f18\u96c5\uff0c\u4e0d\u7528\u50cf <code>getenv</code> \u548c <code>getopt</code> \u90a3\u6837\u5199\u5f88\u591a\u5faa\u73af\u5224\u65ad\uff0c\u800c\u4e14\u8fd8\u81ea\u5e26\u7c7b\u578b\u8f6c\u6362\uff0c\u6240\u4ee5\u6211\u770b\u5230\u5c31\u60f3\uff0c\u8981\u662f\u80fd\u628a\u8fd9\u4e2a\u65b9\u6cd5\u62ff\u6765\u5904\u7406\u547d\u4ee4\u884c\u53c2\u6570\uff0c\u90a3\u5c31\u66f4\u597d\u4e86\u3002</p>\n<p>\u63a5\u7740\u6765\u770b\u770b <code>moduleparam</code> \u7684\u6838\u5fc3\u5b9e\u73b0\uff1a</p>\n<p>```cpp linenums=\"1\"\nstruct kernel_param {\n    const char <em>name;           // \u53d8\u91cf\u540d\u5b57\n    u16 perm;                   // \u53d8\u91cf\u8bbf\u95ee\u6743\u9650\n    u16 flags;                  // \u53d8\u91cf\u662f\u5426 bool \u7c7b\u578b\n    param_set_fn set;           // str -&gt; \u53d8\u91cf\u503c\n    param_get_fn get;           // \u53d8\u91cf\u503c -&gt; str\n    union {\n        void </em>arg;              // \u53d8\u91cf\u6307\u9488\n        const struct kparam_string <em>str;\n        const struct kparam_array </em>arr;\n    };\n};</p>\n<p>#define <strong>module_param_call(prefix, name, set, get, arg, isbool, perm)  \\\n    /<em> Default value instead of permissions? </em>/         \\\n    static int __param_perm_check_##name __attribute</strong>((unused)) =  \\\n    BUILD_BUG_ON_ZERO((perm) &lt; 0 || (perm) &gt; 0777 || ((perm) &amp; 2))  \\\n    + BUILD_BUG_ON_ZERO(sizeof(\"\"prefix) &gt; MAX_PARAM_PREFIX_LEN);   \\\n    static const char <strong>param_str_##name[] = prefix #name;      \\\n    static struct kernel_param __moduleparam_const __param_##name   \\\n    __used                              \\\n        __attribute</strong> ((unused,<strong>section</strong> (\"__param\"),aligned(sizeof(void *)))) \\\n    = { __param_str_##name, perm, isbool ? KPARAM_ISBOOL : 0,   \\\n        set, get, { arg } }</p>\n<p>#define module_param_call(name, set, get, arg, perm)                  \\\n    __module_param_call(MODULE_PARAM_PREFIX,                  \\\n                name, set, get, arg,                  \\\n                __same_type(*(arg), bool), perm)</p>\n<p>#define module_param_named(name, value, type, perm)            \\\n    param_check_##type(name, &amp;(value));                \\\n    module_param_call(name, param_set_##type, param_get_##type, &amp;value, perm); \\\n    __MODULE_PARM_TYPE(name, #type)</p>\n<p>#define module_param(name, type, perm)              \\\n    module_param_named(name, name, type, perm)</p>\n<p>```</p>\n<p><code>module_param</code> \u662f\u4e00\u4e2a\u5b8f\uff0c\u5b83\u5b9e\u9645\u505a\u7684\u4e8b\u60c5\u662f\u5efa\u7acb\u4e86\u4e00\u4e2a\u53ef\u4ee5\u53cd\u5c04\u5230\u4f20\u5165\u53d8\u91cf\u7684\u7ed3\u6784 <code>kernel_param</code> \uff0c\u8be5\u7ed3\u6784\u4fdd\u5b58\u4e86\u8db3\u591f\u8bbf\u95ee\u548c\u8bbe\u7f6e\u53d8\u91cf\u7684\u4fe1\u606f\uff0c\u5373\u7b2c 20-24 \u884c\uff0c\u5e76\u4e14\u628a\u7ed3\u6784\u653e\u5728\u53eb\u505a <code>__param</code> \u7684 <code>section</code> \u4e2d\uff08 <code>__section__ (\"__param\")</code> \uff09\u3002\u7ed3\u6784\u4fdd\u5b58\u597d\u4e4b\u540e\uff0c\u5185\u6838\u4f1a\u5728\u52a0\u8f7d\u6a21\u5757\u65f6\uff0c\u627e\u51fa elf \u6587\u4ef6\u7684 <code>section __param</code> \u7684\u4f4d\u7f6e\u548c\u7ed3\u6784\u6570\u91cf\uff0c\u5728\u6839\u636e\u540d\u5b57\u548c <code>param_set_fn</code> \u5206\u522b\u8bbe\u7f6e\u6bcf\u4e2a\u53c2\u6570\u7684\u6570\u503c\u3002\u627e\u51fa\u7279\u5b9a\u540d\u5b57 <code>section</code> \u7684\u65b9\u6cd5\u662f\u5e73\u53f0\u76f8\u5173\u7684\uff0cLinux \u5185\u6838\u5b9e\u73b0\u7684\u662f\u5bf9 elf \u6587\u4ef6\u7684\u5904\u7406\uff0cLinux \u63d0\u4f9b\u4e86\u6307\u4ee4 <code>readelf</code> \u6765\u67e5\u770b elf \u6587\u4ef6\u7684\u4fe1\u606f\uff0c\u6709\u5174\u8da3\u7684\u53ef\u4ee5\u67e5\u770b <code>readelf</code> \u7684\u5e2e\u52a9\u4fe1\u606f\u3002</p>\n<p>\u4e0a\u9762\u8bf4\u9053 Linux \u5185\u6838\u7684\u505a\u6cd5\u662f\u5e73\u53f0\u76f8\u5173\u7684\uff0c\u800c\u6211\u60f3\u8981\u7684\u5e73\u53f0\u65e0\u5173\u7684\u5904\u7406\u53c2\u6570\u7684\u65b9\u6cd5\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u8981\u6539\u4e00\u6539\u539f\u59cb\u7684 <code>moduleparam</code> \u7684\u505a\u6cd5\uff0c\u628a <code>__section__ (\"__param\")</code> \u58f0\u660e\u53bb\u6389\uff0c\u6bd5\u7adf\u6211\u4eec\u5e76\u4e0d\u50cf\u53bb\u5f88\u9ebb\u70e6\u5730\u8bfb\u53d6 elf \u6587\u4ef6\u7684 <code>section</code> \u3002\u5148\u6765\u770b\u770b\u4fee\u6539\u540e\u7684\u7528\u6cd5\uff1a</p>\n<p>```cpp linenums=\"1\"</p>\n<h1>include \"moduleparam.h\"</h1>\n<h1>include <stdio.h></h1>\n<p>static int test = 0;\nstatic bool btest = 0;\nstatic unsigned int latest_num = 0;\nstatic long latest[10] = {0};\nstatic char strtest[20] = \"\\0\";</p>\n<p>void usage()\n{\n    char *msg = \"usage: moduleparam_test [test=int] [btest[=bool]] [latest=int array] [strtest=string]\\n\";\n    printf(msg);\n}</p>\n<p>int unknown_handler(char <em>param, char </em>val)\n{\n    printf(\"find unknown param: %s\\n\", param);\n    return 0;\n}</p>\n<p>int main (int argc, char **argv)\n{\n    init_module_param(4);\n    module_param(test, int);\n    module_param_bool(btest);\n    module_param_array(latest, long, &amp;latest_num);\n    module_param_string(strtest, strtest, sizeof(strtest));</p>\n<pre><code>int ret = parse_params(argc, argv, unknown_handler);\n\nif(ret != 0)\n{\n    usage();\n    return 0;\n}\n\nchar buf[1024];\nfor(int i=0; i &lt; MODULE_INIT_VARIABLE_NUM; ++i)\n{\n    MODULE_INIT_VARIABLE[i].get(buf, &amp;MODULE_INIT_VARIABLE[i]);\n    printf(\"%s = %s\\n\", MODULE_INIT_VARIABLE[i].name, buf);\n}\nreturn 0;\n</code></pre>\n<p>}</p>\n<p>```</p>\n<p>\u90a3\u4e48\u4e3a\u4e86\u4fdd\u5b58\u6bcf\u4e00\u4e2a\u53cd\u5c04\u7684\u7ed3\u6784\uff0c\u6211\u5c31\u589e\u52a0\u4e86\u4e00\u4e2a\u5b8f <code>init_module_param(num)</code> \uff0c\u6765\u58f0\u660e\u4fdd\u5b58\u7ed3\u6784\u7684\u7a7a\u95f4\uff0c <code>num</code> \u662f\u53c2\u6570\u7684\u4e2a\u6570\uff0c\u5982\u679c\u5b9e\u9645\u58f0\u660e\u7684\u53c2\u6570\u4e2a\u6570\u8d85\u51fa <code>num</code> \uff0c\u7a0b\u5e8f\u4f1a\u89e6\u53d1\u65ad\u8a00\u9519\u8bef\u3002<code>module_param</code> \u7684\u58f0\u660e\u8ddf\u539f\u59cb\u7684\u7a0d\u6709\u4e0d\u540c\uff0c\u53bb\u6389\u4e86\u6700\u540e\u4e00\u4e2a\u8868\u793a\u8bbf\u95ee\u6743\u9650\u7684\u53c2\u6570\uff0c\u4e0d\u505a\u6743\u9650\u7684\u63a7\u5236\u3002\u53e6\u5916\u65b0\u589e\u4e86\u5b8f <code>module_param_bool</code> \u6765\u5904\u7406\u8868\u793a <code>bool</code> \u7684\u53d8\u91cf\uff0c\u8fd9\u5728 Linux \u7684\u7248\u672c\u662f\u4e0d\u9700\u8981\u7684\uff0c\u56e0\u4e3a\u5b83\u7528\u5230\u4e86 gcc \u5185\u5efa\u51fd\u6570 <code>__builtin_types_compatible_p</code> \u6765\u5224\u65ad\u53d8\u91cf\u7684\u7c7b\u578b\uff0c\u5f88\u9057\u61be\uff0cMSVC \u662f\u6ca1\u6709\u8fd9\u4e2a\u51fd\u6570\u7684\uff0c\u6240\u4ee5\u6211\u53ea\u80fd\u628a\u8fd9\u4e2a\u529f\u80fd\u53bb\u6389\uff0c\u589e\u52a0\u4e00\u4e2a\u5b8f\u3002 <code>module_param_array</code> \u548c <code>module_param_string</code> \u5c31\u662f\u5bf9\u6570\u7ec4\u548c\u5b57\u7b26\u4e32\u7684\u5904\u7406\uff0c\u8fd9\u4e24\u4e2a\u529f\u80fd\u5728\u539f\u59cb\u7684\u7248\u672c\u4e5f\u662f\u6709\u7684\u3002</p>\n<p>\u58f0\u660e\u53c2\u6570\u5b8c\u6bd5\uff0c\u5c31\u662f\u5904\u7406\u4f20\u5165\u7684\u53c2\u6570\u4e86\uff0c\u4f7f\u7528\u5b8f <code>parse_params</code> \uff0c\u4f20\u5165 <code>argc, argv</code>\uff0c\u7b2c 3 \u4e2a\u53c2\u6570\u662f\u5bf9\u672a\u77e5\u53c2\u6570\u7684\u5904\u7406\u56de\u8c03\u51fd\u6570\u6307\u9488\uff0c\u53ef\u4ee5\u4f20 <code>NULL</code> \uff0c\u5219\u5165\u5230\u4f4d\u7f6e\u53c2\u6570\u4f1a\u4e2d\u65ad\u5904\u7406\u53c2\u6570\uff0c\u8fd4\u56de\u9519\u8bef\u7801\u3002</p>\n<p>\u7f16\u8bd1\u8fd0\u884c\u4ee3\u7801\uff1a</p>\n<p><code>.\\moduleparam_test.exe error=0 test=101 btest=1 latest=1,2,3 strtest=\\\"Hello World!\\\"\nParsing ARGS: error=0 test=101 btest=1 latest=1,2,3 strtest=\"Hello World!\"\nfind unknown param: error\ntest = 101\nbtest = Y\nlatest = 1,2,3\nstrtest = Hello World!</code></p>\n<p>\u53ef\u4ee5\u770b\u5230\u6570\u503c\uff0c\u6570\u7ec4\u548c\u5b57\u7b26\u4e32\u90fd\u80fd\u6b63\u786e\u8bfb\u5165\u5e76\u8f6c\u6362\u683c\u5f0f\uff0c\u5982\u679c\u9047\u5230\u4e0d\u80fd\u8f6c\u6362\u683c\u5f0f\u7684\u53c2\u6570\uff0c\u4f1a\u8fd4\u56de\u9519\u8bef\u7801\u5e76\u6253\u5370\u76f8\u5173\u4fe1\u606f\u3002\u6211\u4eec\u53ef\u4ee5\u5f88\u7b80\u5355\u5730\u6dfb\u52a0\u51e0\u884c\u4ee3\u7801\uff0c\u5c31\u5b8c\u6210\u53c2\u6570\u7684\u8bfb\u5165\u548c\u8f6c\u6362\u5904\u7406\uff0c\u7528\u8d77\u6765\u5f88\u4f18\u96c5\u3002\u66f4\u8be6\u7ec6\u5b9e\u73b0\u53ef\u4ee5\u76f4\u63a5\u770b\u4ee3\u7801\uff0c<a href=\"https://github.com/disenone/aparsing\">\u5728\u8fd9\u91cc</a>\u3002</p>\n<h2>\u603b\u7ed3</h2>\n<p>\u8fd9\u6b21\u6211\u4eec\u603b\u7ed3\u4e86\u4e00\u4e0b C/C++ \u4e0b\u4e09\u79cd\u5904\u7406\u547d\u4ee4\u884c\u53c2\u6570\u7684\u65b9\u6cd5\uff0c\u5206\u522b\u662f <code>getenv</code> \uff0c<code>getopt</code> \u548c <code>moduleparam</code>\u3002\u4e09\u79cd\u65b9\u6cd5\u6709\u5404\u81ea\u7684\u7279\u70b9\uff0c\u4ee5\u540e\u6709\u9700\u8981\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u7684\u9700\u6c42\u6765\u9009\u62e9\u5408\u9002\u7684\u65b9\u6cd5\uff1a</p>\n<ul>\n<li><code>getenv</code> \u662f\u539f\u751f\u591a\u5e73\u53f0\u5c31\u652f\u6301\u7684\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff0c\u4f46\u4e5f\u8fc7\u4e8e\u539f\u59cb\uff0c\u5e76\u4f7f\u7528\u7684\u662f\u73af\u5883\u53d8\u91cf\uff0c\u5bf9\u73af\u5883\u6709\u4e00\u5b9a\u7684\u6c61\u67d3\uff0c\u6bcf\u6b21\u4f7f\u7528\u524d\u6700\u597d\u6e05\u9664\u4e0d\u5fc5\u8981\u7684\u73af\u5883\u53d8\u91cf\u9632\u6b62\u4e0a\u6b21\u7684\u8bbe\u7f6e\u5b58\u7559\u6c61\u67d3</li>\n<li><code>getopt</code> \u662f Linux \u5e73\u53f0\u539f\u751f\u652f\u6301\u7684\uff0cWindows \u4e0d\u652f\u6301\uff0c\u6240\u4ee5\u9700\u8981\u5305\u542b\u5b9e\u73b0\u7684\u4ee3\u7801\u624d\u80fd\u8de8\u5e73\u53f0\u4f7f\u7528\u3002\u53c2\u6570\u7684\u4f20\u9012\u7b26\u5408 Linux \u7684\u547d\u4ee4\u4f20\u53c2\u6807\u51c6\uff0c\u652f\u6301\u53ef\u9009\u53c2\u6570\uff0c\u4f46\u4f7f\u7528\u8d77\u6765\u7565\u5fae\u9ebb\u70e6\uff0c\u901a\u5e38\u9700\u8981\u5faa\u73af\u548c\u6761\u4ef6\u5224\u65ad\u6765\u5904\u7406\u4e0d\u540c\u7684\u53c2\u6570\uff0c\u5e76\u5bf9\u6570\u503c\u7c7b\u578b\u7684\u53c2\u6570\u4e0d\u53cb\u597d\u3002</li>\n<li><code>moduleparam</code> \u662f\u53c2\u8003 Linux \u5185\u6838\u7684 <code>moduleparam</code> \u5b9e\u73b0\u7684\u547d\u4ee4\u884c\u53c2\u6570\u5904\u7406\u5de5\u5177\uff0c\u652f\u6301\u8de8\u5e73\u53f0\u4f7f\u7528\uff0c\u4f7f\u7528\u7b80\u5355\uff0c\u80fd\u5bf9\u4e0d\u540c\u7c7b\u578b\u7684\u53c2\u6570\u8fdb\u884c\u7c7b\u578b\u8f6c\u6362\uff0c\u7f3a\u70b9\u5c31\u662f\u6bcf\u4e2a\u53c2\u6570\u90fd\u9700\u8981\u4e00\u4e2a\u76f8\u5e94\u7684\u53d8\u91cf\u5b58\u50a8\u3002</li>\n</ul>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/",
            "url": "https://wiki.disenone.site/cpp-KCP%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "KCP \u6e90\u7801\u5256\u6790",
            "content_html": "<p><meta property=\"og:title\" content=\"KCP \u6e90\u7801\u5256\u6790\" /></p>\n<p>\u9605\u8bfb\u672c\u6587\u4e4b\u524d\uff0c\u5982\u679c\u6ca1\u542c\u8bf4\u8fc7 KCP \uff0c\u6216\u8005\u4e00\u70b9\u90fd\u4e0d\u4e86\u89e3 KCP\uff0c\u9ebb\u70e6\u62bd\u4e00\u70b9\u65f6\u95f4\u5148\u770b\u770b KCP \u9879\u76ee\u7684\u8bf4\u660e\u6587\u6863\uff1a<a href=\"https://github.com/skywind3000/kcp\">\u4f20\u9001\u95e8</a>\u3002\u672c\u6587\u7684\u76ee\u7684\u662f\u6df1\u5165 KCP \u7684\u5b9e\u73b0\u7ec6\u8282\u53bb\u7406\u89e3 KCP \u3002</p>\n<h2>\u4ec0\u4e48\u662f KCP</h2>\n<p>KCP \u662f\u4e00\u4e2a\u5feb\u901f\u53ef\u9760\u534f\u8bae\uff0c\u80fd\u591f\u4ee5\u6bd4 TCP \u66f4\u4f4e\u7684\u5ef6\u8fdf\u6765\u4f20\u9001\u6570\u636e\uff0c\u6570\u636e\u91cd\u4f20\u66f4\u5feb\uff0c\u7b49\u5f85\u65f6\u95f4\u66f4\u77ed\u3002</p>\n<blockquote>\n<p>TCP\u662f\u4e3a\u6d41\u91cf\u8bbe\u8ba1\u7684\uff08\u6bcf\u79d2\u5185\u53ef\u4ee5\u4f20\u8f93\u591a\u5c11KB\u7684\u6570\u636e\uff09\uff0c\u8bb2\u7a76\u7684\u662f\u5145\u5206\u5229\u7528\u5e26\u5bbd\u3002\u800c KCP\u662f\u4e3a\u6d41\u901f\u8bbe\u8ba1\u7684\uff08\u5355\u4e2a\u6570\u636e\u5305\u4ece\u4e00\u7aef\u53d1\u9001\u5230\u4e00\u7aef\u9700\u8981\u591a\u5c11\u65f6\u95f4\uff09\uff0c\u4ee510%-20%\u5e26\u5bbd\u6d6a\u8d39\u7684\u4ee3\u4ef7\u6362\u53d6\u4e86\u6bd4 TCP\u5feb30%-40%\u7684\u4f20\u8f93\u901f\u5ea6\u3002TCP\u4fe1\u9053\u662f\u4e00\u6761\u6d41\u901f\u5f88\u6162\uff0c\u4f46\u6bcf\u79d2\u6d41\u91cf\u5f88\u5927\u7684\u5927\u8fd0\u6cb3\uff0c\u800cKCP\u662f\u6c34\u6d41\u6e4d\u6025\u7684\u5c0f\u6fc0\u6d41</p>\n</blockquote>\n<p>\u4ee5\u4e0a\u662f KCP \u6587\u6863\u4e0a\u9762\u5199\u7684\uff0c\u5173\u952e\u8bcd\u662f<strong>\u5e26\u5bbd</strong>\u548c<strong>\u6d41\u901f</strong>\uff0cKCP \u4f1a\u635f\u8017\u5e26\u5bbd\uff0c\u5e26\u6765\u7684\u597d\u5904\u662f\u66f4\u5927\u66f4\u5747\u8861\u7684\u4f20\u8f93\u901f\u7387\u3002\u66f4\u591a\u7684\u8bf4\u660e\u53c2\u8003 KCP \u81ea\u8eab\u7684\u6587\u6863\u3002</p>\n<h2>KCP \u6570\u636e\u7ed3\u6784</h2>\n<p>KCP \u6e90\u7801\u5728 <code>ikcp.h</code> \u548c <code>ikcp.c</code> \u91cc\u9762\uff0c<code>ikcp.h</code> \u6838\u5fc3\u7684\u662f\u6570\u636e\u7ed3\u6784\u7684\u58f0\u660e\uff0c\u9996\u5148\u662f <code>SEGMENT</code> \u6570\u636e\u5305\uff0c\u662f KCP \u534f\u8bae\u5904\u7406\u6570\u636e\u7684\u6700\u5c0f\u5355\u4f4d\uff1a</p>\n<details>\n<summary> SEGMENT \u7ed3\u6784\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\n//=====================================================================\n// SEGMENT \u4e00\u4e2a SETMENT \u5c31\u662f\u4e00\u4e2a\u6570\u636e\u5305\n//=====================================================================\nstruct IKCPSEG\n{\n    // \u94fe\u8868\u8282\u70b9\uff0c\u53d1\u9001\u548c\u63a5\u53d7\u961f\u5217\u90fd\u662f\u8fd9\u91cc\u7684\u94fe\u8868\u7684\u7ed3\u6784\n    struct IQUEUEHEAD node;\n\n    // \u4f1a\u8bdd\u7f16\u53f7\uff0c\u540c\u4e00\u4e2a\u4f1a\u8bdd\u7f16\u53f7\u76f8\u540c\n    IUINT32 conv;\n\n    // \u6570\u636e\u5305\u7c7b\u578b\uff0c\u8b6c\u5982 DATA \u6216\u8005 ACK\n    IUINT32 cmd;\n\n    // \u7531\u4e8e MTU \u7684\u9650\u5236\uff0c\u5927\u6570\u636e\u5305\u4f1a\u62c6\u5206\u6210\u591a\u4e2a\u5c0f\u6570\u636e\u5305\uff0c\u8fd9\u4e2a\u662f\u5c0f\u6570\u636e\u5305\u7684\u7f16\u53f7\n    IUINT32 frg\n\n    // \u6bcf\u4e2a\u6570\u636e\u5305\uff0c\u90fd\u4f1a\u9644\u5e26\u4e0a\u53d1\u9001\u65b9\u7684\u63a5\u53d7\u7a97\u53e3\u5927\u5c0f\n    IUINT32 wnd;\n\n    // \u53d1\u9001\u65f6\u95f4\uff0c\u5982\u679c\u662f ACK \u5305\uff0c\u4f1a\u8bbe\u7f6e\u4e3a\u6e90\u6570\u636e\u5305\u7684 ts\n    IUINT32 ts;\n\n    // \u552f\u4e00\u6807\u8bc6\u6570\u636e\u5305\u7684\u7f16\u53f7\n    IUINT32 sn;\n\n    // \u4ee3\u8868\u5c0f\u4e8e una \u7684\u6570\u636e\u5305\u90fd\u63a5\u6536\u6210\u529f\uff0c\u8ddf TCP \u542b\u4e49\u4e00\u81f4\uff1aoldest unacknowledged sequence number SND\n    IUINT32 una;\n\n    // \u6570\u636e\u957f\u5ea6\n    IUINT32 len;\n\n    // \u8d85\u65f6\u91cd\u4f20\u65f6\u95f4\n    IUINT32 resendts;\n\n    // \u4e0b\u6b21\u8d85\u65f6\u7b49\u5f85\u65f6\u95f4\n    IUINT32 rto;\n\n    // \u5feb\u901f\u91cd\u4f20\uff0c\u6536\u5230\u672c\u6570\u636e\u5305\u4e4b\u540e\u7684\u6570\u636e\u5305\u7684\u6570\u91cf\uff0c\u5927\u4e8e\u4e00\u5b9a\u6570\u91cf\u5c31\u89e6\u53d1\u5feb\u901f\u91cd\u4f20\n    IUINT32 fastack;\n\n    // \u53d1\u9001\u6b21\u6570\n    IUINT32 xmit;\n\n    // \u6570\u636e\n    char data[1];\n};\n```\n</details>\n\n<p>\u770b\u5b8c <code>SEGMENT</code> \u7684\u6ce8\u91ca\uff0c\u5927\u81f4\u80fd\u770b\u51fa KCP \u7684\u6838\u5fc3\u4e5f\u662f\u4e00\u4e2a ARQ \u534f\u8bae\uff0c\u901a\u8fc7\u81ea\u52a8\u8d85\u65f6\u91cd\u4f20\u6765\u4fdd\u8bc1\u6570\u636e\u7684\u9001\u8fbe\u3002\u63a5\u7740\u518d\u6765\u770b\u770b KCP \u7ed3\u6784 <code>KCPCB</code> \u7684\u5b9a\u4e49\uff1a</p>\n<details>\n<summary> KCP \u7ed3\u6784\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\n//---------------------------------------------------------------------\n// IKCPCB\n//---------------------------------------------------------------------\nstruct IKCPCB\n{\n    // conv: \u4f1a\u8bdd\u7f16\u53f7\n    // mtu, mss: \u6700\u5927\u4f20\u8f93\u5355\u5143\uff0c\u6700\u5927\u62a5\u6587\u6bb5\u5927\u5c0f\n    // state: \u4f1a\u8bdd\u72b6\u6001\uff0c0 \u6709\u6548\uff0c-1 \u65ad\u5f00\n    IUINT32 conv, mtu, mss, state;\n\n    // snd_una: \u7b49\u5f85 ACK \u7684\u5305\u7f16\u53f7\n    // snd_nxt: \u4e0b\u4e00\u4e2a\u7b49\u5f85\u53d1\u9001\u7684\u6570\u636e\u5305\u7f16\u53f7\n    // rcv_nxt: \u4e0b\u4e00\u4e2a\u7b49\u5f85\u63a5\u6536\u7684\u6570\u636e\u5305\u7f16\u53f7\n    IUINT32 snd_una, snd_nxt, rcv_nxt;\n\n    // ts_recent, ts_lastack: \u672a\u7528\u5230\n    // ssthresh: \u62e5\u585e\u63a7\u5236\u6162\u542f\u52a8\u9608\u503c\n    IUINT32 ts_recent, ts_lastack, ssthresh;\n\n    // rx_rto: rto (retransmission timeout)\uff0c\u8d85\u65f6\u91cd\u4f20\u65f6\u95f4\n    // rx_rttval, rx_srtt, rx_minrto: \u8ba1\u7b97 rto \u7684\u4e2d\u95f4\u53d8\u91cf\n    IINT32 rx_rttval, rx_srtt, rx_rto, rx_minrto;\n\n    // snd_wnd, rcv_wnd: \u6700\u5927\u53d1\u9001\u548c\u63a5\u6536\u7a97\u53e3\u5927\u5c0f\n    // rmt_wnd: remote wnd \uff0c\u5bf9\u7aef\u5269\u4f59\u63a5\u53d7\u7a97\u53e3\u5927\u5c0f\n    // cwnd: \u53ef\u53d1\u9001\u7a97\u53e3\u5927\u5c0f\n    // probe: \u662f\u5426\u8981\u53d1\u9001\u63a7\u5236\u62a5\u6587\u7684\u6807\u5fd7\n    IUINT32 snd_wnd, rcv_wnd, rmt_wnd, cwnd, probe;\n\n    // current: \u5f53\u524d\u65f6\u95f4\n    // interval: \u66f4\u65b0\u95f4\u9694\n    // ts_flush: \u4e0b\u6b21\u9700\u8981\u66f4\u65b0\u7684\u65f6\u95f4\n    // xmit: \u53d1\u9001\u5931\u8d25\u6b21\u6570\n    IUINT32 current, interval, ts_flush, xmit;\n\n    // \u5bf9\u5e94\u94fe\u8868\u7684\u957f\u5ea6\n    IUINT32 nrcv_buf, nsnd_buf;\n    IUINT32 nrcv_que, nsnd_que;\n\n    // nodelay: \u63a7\u5236\u8d85\u65f6\u91cd\u4f20\u7684 rto \u589e\u957f\u901f\u5ea6\n    // updated: \u662f\u5426\u8c03\u7528\u8fc7 ikcp_update\n    IUINT32 nodelay, updated;\n\n    // ts_probe, probe_wait: \u5bf9\u7aef\u63a5\u6536\u7a97\u53e3\u957f\u65f6\u95f4\u4e3a 0 \u65f6\u4e3b\u52a8\u5b9a\u671f\u53d1\u8d77\u8be2\u95ee\n    IUINT32 ts_probe, probe_wait;\n\n    // deal_link: \u5bf9\u7aef\u957f\u65f6\u95f4\u65e0\u5e94\u7b54\n    // incr: \u53c2\u4e0e\u8ba1\u7b97\u53d1\u9001\u7a97\u53e3\u5927\u5c0f\n    IUINT32 dead_link, incr;\n\n    // queue: \u8ddf\u7528\u6237\u5c42\u63a5\u89e6\u7684\u6570\u636e\u5305\n    // buf: \u534f\u8bae\u7f13\u5b58\u7684\u6570\u636e\u5305\n    struct IQUEUEHEAD snd_queue;\n    struct IQUEUEHEAD rcv_queue;\n    struct IQUEUEHEAD snd_buf;\n    struct IQUEUEHEAD rcv_buf;\n\n    // \u9700\u8981\u53d1\u9001 ack \u7684\u6570\u636e\u5305\u4fe1\u606f\n    IUINT32 *acklist;\n\n    // \u9700\u8981 ack \u7684\u5305\u6570\u91cf\n    IUINT32 ackcount;\n\n    // acklist \u5185\u5b58\u5927\u5c0f\n    IUINT32 ackblock;\n\n    // \u7528\u6237\u5c42\u4f20\u8fdb\u6765\u7684\u6570\u636e\n    void *user;\n\n    // \u5b58\u653e\u4e00\u4e2a kcp \u5305\u7684\u7a7a\u95f4\n    char *buffer;\n\n    // \u89e6\u53d1\u5feb\u901f\u91cd\u4f20\u7684 fastack \u6b21\u6570\n    int fastresend;\n\n    // \u5feb\u901f\u91cd\u4f20\u6700\u5927\u6b21\u6570\n    int fastlimit;\n\n    // nocwnd: \u4e0d\u8003\u8651\u6162\u542f\u52a8\u7684\u53d1\u9001\u7a97\u53e3\u5927\u5c0f\n    // stream: \u6d41\u6a21\u5f0f\n    int nocwnd, stream;\n\n    // debug log\n    int logmask;\n\n    // \u53d1\u9001\u6570\u636e\u63a5\u53e3\n    int (*output)(const char *buf, int len, struct IKCPCB *kcp, void *user);\n\n    void (*writelog)(const char *log, struct IKCPCB *kcp, void *user);\n};\n```\n</details>\n\n<p>\u9010\u4e00\u628a KCP \u7ed3\u6784\u91cc\u9762\u7684\u5b57\u6bb5\u6ce8\u91ca\u4e0a\uff0c\u53ef\u4ee5\u521d\u6b65\u611f\u89c9\u5230\uff0c\u6574\u5957 KCP \u7684\u534f\u8bae\u4e0d\u592a\u590d\u6742\uff0c\u7ec6\u7ec6\u53bb\u5206\u6790\u4ee3\u7801\uff0c\u4f60\u6211\u90fd\u80fd\u8bfb\u61c2\u5e76\u7406\u89e3 KCP \u534f\u8bae :smile:</p>\n<h2>KCP \u7684 ARQ \u5b9e\u73b0</h2>\n<p>KCP \u672c\u8d28\u4e0a\u662f\u4e00\u4e2a ARQ (Auto Repeat-reQuest\uff0c\u81ea\u52a8\u91cd\u4f20) \u534f\u8bae\uff0c\u6700\u57fa\u672c\u7684\u662f\u8981\u4fdd\u8bc1\u53ef\u9760\u7684\u4f20\u8f93\u3002\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5148\u6765\u5173\u6ce8 KCP \u7684\u57fa\u672c ARQ \u90e8\u5206\uff0cKCP \u662f\u600e\u4e48\u5b9e\u73b0\u53ef\u9760\u4f20\u8f93\u7684\u3002</p>\n<p>ARQ \u987e\u540d\u601d\u4e49\uff0c\u5f53\u6211\u4eec\u8ba4\u4e3a\u5bf9\u7aef\u63a5\u6536\u6570\u636e\u5305\u5931\u8d25\u65f6\uff0c\u81ea\u52a8\u91cd\u65b0\u53d1\u9001\u5bf9\u5e94\u7684\u6570\u636e\u5305\uff0c\u5b83\u662f\u901a\u8fc7\u786e\u8ba4\u63a5\u6536\u548c\u8d85\u65f6\u91cd\u4f20\u4e24\u4e2a\u673a\u5236\uff0c\u6765\u5b9e\u73b0\u53ef\u9760\u4f20\u8f93\u3002\u5177\u4f53\u7684\u4ee3\u7801\u5b9e\u73b0\u4e0a\uff0c KCP \u7ed9\u6bcf\u4e2a\u6570\u636e\u5305\uff08\u5c31\u662f\u4e0a\u4e00\u8282\u63d0\u5230\u7684 <code>SEGMENT</code> \uff09 \u5206\u914d\u552f\u4e00\u7684 <code>sn</code> \u6807\u8bc6\u7b26\uff0c\u4e00\u65e6\u5bf9\u7aef\u63a5\u6536\u5230\u6570\u636e\u5305\uff0c\u4f1a\u56de\u590d\u4e00\u4e2a ACK \u5305\uff08\u540c\u6837\u662f <code>SEGMENT</code>\uff09\uff0cACK \u5305\u7684 <code>sn</code> \u8ddf\u63a5\u6536\u5230\u7684\u6570\u636e\u5305 <code>sn</code> \u76f8\u540c\uff0c\u901a\u77e5\u63a5\u6536\u5230\u6b64\u6570\u636e\u5305\u5df2\u7ecf\u63a5\u6536\u6210\u529f\u3002<code>SEGMENT</code> \u4e0a\u8fd8\u6709\u4e00\u4e2a <code>una</code> \u5b57\u6bb5\uff0c\u8868\u793a\u4e0b\u4e00\u4e2a\u671f\u5f85\u63a5\u6536\u7684\u6570\u636e\u5305\u7684\u7f16\u53f7\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u5373\u662f\u6240\u6709\u5728\u8be5\u7f16\u53f7\u4e4b\u524d\u7684\u6570\u636e\u5305\u90fd\u5df2\u7ecf\u63a5\u6536\u5b8c\uff0c\u76f8\u5f53\u4e8e\u4e00\u4e2a\u5168\u91cf\u7684 ACK \u5305\uff0c\u53d1\u9001\u7aef\u53ef\u4ee5\u66f4\u5feb\u7684\u66f4\u65b0\u53d1\u9001\u7f13\u51b2\u548c\u53d1\u9001\u7a97\u53e3\u3002</p>\n<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8ddf\u8e2a KCP \u5305\u7684\u53d1\u9001\u548c\u63a5\u53d7\u4ee3\u7801\uff0c\u6765\u7406\u89e3\u6700\u57fa\u672c\u7684 ARQ \u5b9e\u73b0\uff1a</p>\n<h3>\u53d1\u9001</h3>\n<p>\u53d1\u9001\u7684\u8fc7\u7a0b\u662f <code>ikcp_send</code> -&gt; <code>ikcp_update</code> -&gt; <code>ikcp_output</code>\uff0c\u4e0a\u5c42\u8c03\u7528 <code>ikcp_send</code> \u628a\u6570\u636e\u4f20\u7ed9 KCP\uff0cKCP \u5728 <code>ikcp_update</code> \u4e2d\u5904\u7406\u6570\u636e\u7684\u53d1\u9001\u3002</p>\n<details>\n<summary> ikcp_send\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\n//---------------------------------------------------------------------\n// \u53d1\u9001\u6570\u636e\u63a5\u53e3\uff0c\u7528\u6237\u8c03\u7528 ikcp_send \u6765\u8ba9 kcp \u53d1\u9001\u6570\u636e\n// user/upper level send, returns below zero for error\n//---------------------------------------------------------------------\nint ikcp_send(ikcpcb *kcp, const char *buffer, int len)\n{\n    IKCPSEG *seg;\n    int count, i;\n\n    // mss \u4e0d\u80fd\u5c0f\u4e8e1\n    assert(kcp->mss > 0);\n    if (len < 0) return -1;\n\n    // append to previous segment in streaming mode (if possible)\n    if (kcp->stream != 0) {\n        // \u5904\u7406\u6d41\u6a21\u5f0f\n        // ......\n    }\n\n    // \u8ba1\u7b97\u5206\u5305\uff0c\u5982\u679c\u6570\u636e\u957f\u5ea6 len \u5927\u4e8e mss\uff0c\u9700\u8981\u5206\u6210\u591a\u4e2a\u5305\u53d1\u9001\uff0c\u5bf9\u7aef\u63a5\u53d7\u5230\u4e4b\u540e\u518d\u62fc\u8d77\u6765\n    if (len <= (int)kcp->mss) count = 1;\n    else count = (len + kcp->mss - 1) / kcp->mss;\n\n    if (count >= (int)IKCP_WND_RCV) return -2;\n\n    if (count == 0) count = 1;\n\n    // \u5206\u5305\n    for (i = 0; i < count; i++) {\n        // \u8ba1\u7b97\u5305\u7684\u6570\u636e\u957f\u5ea6\uff0c\u5e76\u5206\u914d\u5bf9\u5e94\u7684 seg \u7ed3\u6784\n        int size = len > (int)kcp->mss ? (int)kcp->mss : len;\n        seg = ikcp_segment_new(kcp, size);\n        assert(seg);\n        if (seg == NULL) {\n            return -2;\n        }\n\n        // \u8bbe\u7f6e seg \u7684 \u6570\u636e\u4fe1\u606f\uff0cfrg \u8868\u793a\u5206\u5305\u7f16\u53f7\n        if (buffer && len > 0) {\n            memcpy(seg->data, buffer, size);\n        }\n        seg->len = size;\n        seg->frg = (kcp->stream == 0)? (count - i - 1) : 0;\n\n        // \u52a0\u5230 snd_queue \u7684\u672b\u5c3e\uff0cnsnd_qua \u52a0\u4e00\n        iqueue_init(&seg->node);\n        iqueue_add_tail(&seg->node, &kcp->snd_queue);\n        kcp->nsnd_que++;\n        if (buffer) {\n            buffer += size;\n        }\n        len -= size;\n    }\n\n    return 0;\n}\n```\n</details>\n\n<p><code>ikcp_send</code> \u662f\u7531 KCP \u7684\u4e0a\u5c42\u6765\u8c03\u7528\u7684\u53d1\u9001\u6570\u636e\u63a5\u53e3\uff0c\u6240\u6709\u8ba9 KCP \u53d1\u9001\u7684\u6570\u636e\uff0c\u90fd\u5e94\u8be5\u901a\u8fc7\u8fd9\u4e2a\u63a5\u53e3\u3002 <code>ikcp_send</code> \u505a\u7684\u4e8b\u60c5\u5f88\u7b80\u5355\uff0c\u4e3b\u8981\u5c31\u662f\u628a\u6570\u636e\uff0c\u6839\u636e <code>kcp-&gt;mss</code> \uff08\u4e00\u4e2a\u5305\u6700\u5927\u6570\u636e\u957f\u5ea6\uff09\u6765\u5206\u6210\u591a\u4e2a\u5305\uff0c\u5e76\u8bbe\u7f6e\u5206\u5305\u7f16\u53f7\uff0c\u6700\u540e\u653e\u5230\u53d1\u9001\u94fe\u8868 <code>snd_queue</code> \u7684\u672b\u5c3e\u3002\u6d41\u6a21\u5f0f\u5c31\u662f\u628a\u591a\u6b21\u8c03\u7528 <code>ikcp_send</code> \u7684\u6570\u636e\u90fd\u770b\u6210\u4e00\u4e2a\u6d41\uff0c\u4f1a\u5148\u81ea\u52a8\u586b\u5145\u672a\u6ee1\u7684 <code>SEGMENT</code> \u518d\u5206\u914d\u65b0\u7684\uff0c\u8be6\u7ec6\u5b9e\u73b0\u672c\u6587\u4e0d\u8ba8\u8bba\uff0c\u611f\u5174\u8da3\u7684\uff0c\u76f8\u4fe1\u770b\u5b8c\u672c\u6587\uff0c\u518d\u5bf9\u5e94\u770b\u770b\u4ee3\u7801\u5c31\u80fd\u7406\u89e3\u3002</p>\n<p><code>ikcp_send</code> \u8c03\u7528\u5b8c\u6210\u4e4b\u540e\uff0c\u6570\u636e\u653e\u5728\u7684 KCP \u7684 <code>snd_queue</code> \u4e2d\uff0c\u90a3\u4e48\u540e\u9762 KCP \u9700\u8981\u627e\u4e2a\u65f6\u673a\uff0c\u628a\u5f85\u53d1\u9001\u7684\u6570\u636e\u53d1\u9001\u51fa\u53bb\uff0c\u8fd9\u5757\u4ee3\u7801\u90fd\u653e\u5728 <code>ikcp_update</code> \u548c <code>ikcp_flush</code> \u91cc\u9762\uff1a</p>\n<details>\n<summary> ikcp_update\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\n//---------------------------------------------------------------------\n// ikcp_update \u662f\u7ed9\u4e0a\u5c42\u5b9a\u671f\u8c03\u7528\u7684\u63a5\u53e3\uff0c\u7528\u6765\u66f4\u65b0 kcp \u7684\u72b6\u6001\uff0c\u53d1\u9001\u6570\u636e\n// update state (call it repeatedly, every 10ms-100ms), or you can ask \n// ikcp_check when to call it again (without ikcp_input/_send calling).\n// 'current' - current timestamp in millisec. \n//---------------------------------------------------------------------\nvoid ikcp_update(ikcpcb *kcp, IUINT32 current)\n{\n    IINT32 slap;\n\n    kcp->current = current;\n\n    // ikcp_flush \u4f1a\u68c0\u67e5\u8fd9\u4e2a\uff0c\u4e0a\u5c42\u5fc5\u987b\u8c03\u7528\u8fc7 ikcp_update \u624d\u80fd\u8c03\u7528 ikcp_flush\uff0c\u5efa\u8bae\u53ea\u4f7f\u7528 ikcp_update\n    if (kcp->updated == 0) {\n        kcp->updated = 1;\n        kcp->ts_flush = kcp->current;\n    }\n\n    slap = _itimediff(kcp->current, kcp->ts_flush);\n\n    if (slap >= 10000 || slap < -10000) {\n        kcp->ts_flush = kcp->current;\n        slap = 0;\n    }\n\n    if (slap >= 0) {\n        // \u4e0b\u6b21 flush \u7684\u65f6\u95f4\n        kcp->ts_flush += kcp->interval;\n        if (_itimediff(kcp->current, kcp->ts_flush) >= 0) {\n            kcp->ts_flush = kcp->current + kcp->interval;\n        }\n        ikcp_flush(kcp);\n    }\n}\n```\n</details>\n\n<p><code>ikcp_update</code> \u505a\u7684\u4e8b\u60c5\u5f88\u7b80\u5355\uff0c\u5224\u65ad\u4e00\u4e0b <code>ts_flush</code> \u7684\u65f6\u95f4\uff0c\u7b26\u5408\u6761\u4ef6\u5219\u8c03\u7528 <code>ikcp_flush</code>\uff0c\u4e3b\u8981\u7684\u5904\u7406\u903b\u8f91\u90fd\u5728 <code>ikcp_flush</code> \u91cc\u9762\u4e86\uff0c\u56e0\u4e3a <code>ikcp_flush</code> \u5185\u5bb9\u590d\u6742\u4e00\u70b9\uff0c\u6211\u4eec\u76ee\u524d\u53ea\u5173\u6ce8\u8ddf ARQ \u53d1\u9001\u76f8\u5173\u7684\u90e8\u5206\uff1a</p>\n<details>\n<summary> \u53d1\u9001\u6570\u636e\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\n//---------------------------------------------------------------------\n// ikcp_flush\n//---------------------------------------------------------------------\nvoid ikcp_flush(ikcpcb *kcp)\n{\n    IUINT32 current = kcp->current;\n\n    // buffer \u662f\u8981\u4f20\u7ed9 ikcp_output \u7684\u6570\u636e\uff0c\u521d\u59cb\u5316\u4e3a 3 \u500d\u6570\u636e\u5305\u5927\u5c0f\n    char *buffer = kcp->buffer;\n    char *ptr = buffer;\n    int count, size, i;\n    IUINT32 resent, cwnd;\n    IUINT32 rtomin;\n    struct IQUEUEHEAD *p;\n    int change = 0;\n    int lost = 0;\n    IKCPSEG seg;\n\n    // 'ikcp_update' haven't been called.\n    if (kcp->updated == 0) return;\n\n    seg.conv = kcp->conv;\n    seg.cmd = IKCP_CMD_ACK;\n    seg.frg = 0;\n\n    // seg.wnd \u662f\u8868\u793a\u5f53\u524d\u53ef\u63a5\u6536\u7a97\u53e3\u5927\u5c0f\n    seg.wnd = ikcp_wnd_unused(kcp);\n    seg.una = kcp->rcv_nxt;\n    seg.len = 0;\n    seg.sn = 0;\n    seg.ts = 0;\n\n    // \u53d1\u9001 ack\n    // \u8ba1\u7b97 \u53d1\u9001\u7a97\u53e3\n    //...\n\n    // \u628a\u6570\u636e\u5305\u4ece snd_queue \u79fb\u52a8\u5230 snd_buf\n    // \u79fb\u52a8\u662f\u9700\u8981\u6ee1\u8db3 \u53d1\u9001\u7a97\u53e3 \u5927\u5c0f\uff0c\u53d1\u9001\u7a97\u53e3\u6ee1\u4e86\uff0c\u5c31\u505c\u6b62\u79fb\u52a8\n    // \u653e\u5728 snd_buf \u7684\u91cc\u9762\u7684\u6570\u636e\uff0c\u5c31\u662f\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528 ikcp_output \u7ed9\u5bf9\u7aef\u53d1\u9001\u7684\u6570\u636e\n    while (_itimediff(kcp->snd_nxt, kcp->snd_una + cwnd) < 0) {\n        IKCPSEG *newseg;\n        if (iqueue_is_empty(&kcp->snd_queue)) break;\n\n        newseg = iqueue_entry(kcp->snd_queue.next, IKCPSEG, node);\n\n        iqueue_del(&newseg->node);\n        iqueue_add_tail(&newseg->node, &kcp->snd_buf);\n        kcp->nsnd_que--;\n        kcp->nsnd_buf++;\n\n        newseg->conv = kcp->conv;\n        newseg->cmd = IKCP_CMD_PUSH;\n        newseg->wnd = seg.wnd;\n        newseg->ts = current;\n\n        // seg \u552f\u4e00\u5e8f\u53f7\uff0c\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u9012\u589e\u7684 kcp->snd_nxt\n        newseg->sn = kcp->snd_nxt++;\n\n        // una \u5728\u8fd9\u91cc\u8bbe\u7f6e\uff0c\u901a\u77e5\u5bf9\u7aef\u4e0b\u4e00\u4e2a\u7b49\u5f85\u63a5\u6536\u7684\u5305\u5e8f\u53f7\n        newseg->una = kcp->rcv_nxt;\n        newseg->resendts = current;\n        newseg->rto = kcp->rx_rto;\n        newseg->fastack = 0;\n        newseg->xmit = 0;\n    }\n\n    // \u8ba1\u7b97\u5feb\u901f\u91cd\u4f20\u6807\u5fd7\uff0c\u8d85\u65f6\u7b49\u5f85\u65f6\u95f4\n    // ...\n\n    // \u53d1\u9001 snd_buf\n    for (p = kcp->snd_buf.next; p != &kcp->snd_buf; p = p->next) {\n        IKCPSEG *segment = iqueue_entry(p, IKCPSEG, node);\n        int needsend = 0;\n        if (segment->xmit == 0) {\n            // \u9996\u6b21\u53d1\u9001\n            // set->xmit \u8868\u793a\u53d1\u9001\u6b21\u6570\n            // resendts \u8d85\u65f6\u91cd\u4f20\u7684\u7b49\u5f85\u65f6\u95f4\n            needsend = 1;\n            segment->xmit++;\n            segment->rto = kcp->rx_rto;\n            segment->resendts = current + segment->rto + rtomin;\n        }\n        else if (_itimediff(current, segment->resendts) >= 0) {\n            // \u8d85\u65f6\u91cd\u4f20\n            // ...\n        }\n        else if (segment->fastack >= resent) {\n            // \u5feb\u901f\u91cd\u4f20\n            // ...\n        }\n\n        if (needsend) {\n            int need;\n            segment->ts = current;\n            segment->wnd = seg.wnd;\n            segment->una = kcp->rcv_nxt;\n\n            size = (int)(ptr - buffer);\n            need = IKCP_OVERHEAD + segment->len;\n\n            // \u6bcf\u5f53 buffer \u4e2d\u7684\u6570\u636e\u8d85\u8fc7 mtu \uff0c\u90a3\u5c31\u5148\u53d1\u51fa\u53bb\uff0c\u5c3d\u91cf\u907f\u514d\u5e95\u5c42\u518d\u5206\u5305\n            if (size + need > (int)kcp->mtu) {\n                ikcp_output(kcp, buffer, size);\n                ptr = buffer;\n            }\n\n            // \u628a seg \u63a7\u5236\u6570\u636e\u590d\u5236\u5230 buffer \u4e0a\uff0ckcp \u81ea\u5df1\u6765\u5904\u7406\u5927\u5c0f\u7aef\u95ee\u9898\n            ptr = ikcp_encode_seg(ptr, segment);\n\n            // \u518d\u590d\u5236\u6570\u636e\n            if (segment->len > 0) {\n                memcpy(ptr, segment->data, segment->len);\n                ptr += segment->len;\n            }\n\n\n            if (segment->xmit >= kcp->dead_link) {\n                kcp->state = (IUINT32)-1;\n            }\n        }\n    }\n\n    // flash remain segments\n    size = (int)(ptr - buffer);\n    if (size > 0) {\n        ikcp_output(kcp, buffer, size);\n    }\n\n    // \u8ba1\u7b97 ssthresh\uff0c\u66f4\u65b0\u6162\u542f\u52a8\u7a97\u53e3\n    // ...\n}\n```\n</details>\n\n<p>\u6211\u4eec\u76ee\u524d\u53ea\u5173\u6ce8 <code>ikcp_flush</code> \u91cc\u9762\u6709\u5173\u53d1\u9001\u6570\u636e\u7684\u903b\u8f91\uff1a</p>\n<ul>\n<li>\n<p>\u9996\u5148 KCP \u4f1a\u6839\u636e\u5bf9\u7aef\u7684\u63a5\u6536\u7a97\u53e3\u5927\u5c0f\uff0c\u628a <code>snd_queue</code> \u4e0a\u7684\u6570\u636e\u79fb\u52a8\u5230 <code>snd_buf</code> \u4e0a\u9762\uff0c\u8ba1\u7b97\u79fb\u52a8\u6570\u91cf\u7684\u516c\u5f0f\u662f <code>num = snd_nxt - (snd_una + cwnd)</code>\uff0c\u4e5f\u5c31\u662f\uff1a\u5df2\u53d1\u9001\u6210\u529f\u7684\u6700\u5927\u5305\u5e8f\u53f7 <code>snd_una</code> \u52a0\u4e0a \u6ed1\u52a8\u7a97\u53e3\u5927\u5c0f <code>cwnd</code> \u5927\u4e8e \u4e0b\u4e2a\u5f85\u53d1\u9001\u7684\u5305\u5e8f\u53f7<code>snd_nxt</code>\uff0c\u5219\u53ef\u4ee5\u7ee7\u7eed\u518d\u53d1\u9001\u65b0\u7684\u6570\u636e\u5305\u3002\u79fb\u52a8 <code>SEG</code> \u7684\u540c\u65f6\uff0c\u8bbe\u7f6e\u63a7\u5236\u5b57\u6bb5\u3002</p>\n</li>\n<li>\n<p>\u904d\u5386 <code>snd_buf</code>\uff0c\u5982\u679c\u9700\u8981\u53d1\u9001\u6570\u636e\u5305\uff0c\u5219\u628a\u6570\u636e\u590d\u5236\u5230 <code>buffer</code> \u4e0a\uff0c\u590d\u5236\u7684\u540c\u65f6\u7528 <code>ikcp_encode_seg</code> \u5904\u7406\u63a7\u5236\u5b57\u6bb5\u6570\u636e\u7684\u5927\u5c0f\u7aef\u95ee\u9898\u3002</p>\n</li>\n<li>\n<p>\u6700\u540e\u8c03\u7528 <code>ikcp_output</code> \u628a <code>buffer</code> \u4e0a\u7684\u6570\u636e\u53d1\u9001\u51fa\u53bb</p>\n</li>\n</ul>\n<p>\u81f3\u6b64\uff0c KCP \u5b8c\u6210\u6570\u636e\u7684\u53d1\u9001\u3002</p>\n<h3>\u63a5\u6536</h3>\n<p>\u63a5\u6536\u7684\u8fc7\u7a0b\u662f\u8ddf\u53d1\u9001\u76f8\u53cd\u7684\uff1a<code>ikcp_input</code> -&gt; <code>ikcp_update</code> -&gt; <code>ikcp_recv</code>\uff0c\u7528\u6237\u63a5\u6536\u5230\u7f51\u7edc\u4e0a\u7684\u6570\u636e\u4e4b\u540e\uff0c\u9700\u8981\u8c03\u7528 <code>ikcp_input</code> \u4f20\u7ed9 KCP \u89e3\u6790\uff0c\u8c03\u7528 <code>ikcp_update</code> \u7684\u65f6\u5019\u4f1a\u7ed9\u53d1\u9001\u7aef\u56de\u590d ACK \u5305\uff0c\u4e0a\u5c42\u901a\u8fc7\u8c03\u7528 <code>ikcp_recv</code> \u6765\u63a5\u6536 KCP \u89e3\u6790\u4e4b\u540e\u7684\u6570\u636e\u3002</p>\n<details>\n<summary> \u63a5\u6536\u6570\u636e\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\n//---------------------------------------------------------------------\n// input data\n//---------------------------------------------------------------------\nint ikcp_input(ikcpcb *kcp, const char *data, long size)\n{\n    IUINT32 prev_una = kcp->snd_una;\n    IUINT32 maxack = 0, latest_ts = 0;\n    int flag = 0;\n\n    // \u5408\u6cd5\u6027\u68c0\u67e5\n    if (data == NULL || (int)size < (int)IKCP_OVERHEAD) return -1;\n\n    // data \u53ef\u80fd\u662f\u591a\u4e2a KCP \u5305\uff0c\u5faa\u73af\u5904\u7406\n    while (1) {\n        IUINT32 ts, sn, len, una, conv;\n        IUINT16 wnd;\n        IUINT8 cmd, frg;\n        IKCPSEG *seg;\n\n        // \u4e0d\u591f\u4e00\u4e2a KCP \u5305\uff0c\u9000\u51fa\n        if (size < (int)IKCP_OVERHEAD) break;\n\n        // \u5148\u628a\u63a7\u5236\u5b57\u6bb5\u89e3\u6790\u51fa\u6765\n        data = ikcp_decode32u(data, &conv);\n        if (conv != kcp->conv) return -1;\n\n        data = ikcp_decode8u(data, &cmd);\n        data = ikcp_decode8u(data, &frg);\n        data = ikcp_decode16u(data, &wnd);\n        data = ikcp_decode32u(data, &ts);\n        data = ikcp_decode32u(data, &sn);\n        data = ikcp_decode32u(data, &una);\n        data = ikcp_decode32u(data, &len);\n\n        size -= IKCP_OVERHEAD;\n\n        if ((long)size < (long)len || (int)len < 0) return -2;\n\n        // \u6570\u636e\u5305\u7c7b\u578b\u68c0\u67e5\n        if (cmd != IKCP_CMD_PUSH && cmd != IKCP_CMD_ACK &&\n            cmd != IKCP_CMD_WASK && cmd != IKCP_CMD_WINS) \n            return -3;\n\n        kcp->rmt_wnd = wnd;\n\n        // \u8fd9\u91cc\u7684 una \u662f\u53d1\u9001\u65b9\u7684 kcp->rcv_nxt\uff0c\u6839\u636e\u8fd9\u4e2a\u6570\u636e\uff0c\u53ef\u4ee5\u53bb\u6389\u5df2\u786e\u8ba4\u63a5\u6536\u7684\u6570\u636e\u5305\n        ikcp_parse_una(kcp, una);\n        // \u53bb\u6389\u5df2\u786e\u8ba4\u63a5\u6536\u7684\u5305\u540e\uff0c\u66f4\u65b0 snd_una \u4e0b\u4e00\u4e2a\u8981\u53d1\u9001\u7684\u5e8f\u53f7\n        ikcp_shrink_buf(kcp);\n\n        if (cmd == IKCP_CMD_ACK) {\n            // ack \u5305\n            // ...\n        }\n        else if (cmd == IKCP_CMD_PUSH) {\n            // \u6570\u636e\u5305\n            // \u5982\u679c\u63a5\u6536\u5230\u7684\u6570\u636e\u5305\u5e8f\u53f7 sn\uff0c\u5728\u63a5\u6536\u7a97\u53e3\u5185\uff0c\u5219\u6b63\u5e38\u5904\u7406\uff0c\u5426\u5219\u76f4\u63a5\u4e22\u5f03\uff0c\u7b49\u91cd\u4f20\n            if (_itimediff(sn, kcp->rcv_nxt + kcp->rcv_wnd) < 0) {\n\n                // \u63a5\u6536\u5230\u7684\u6bcf\u4e2a\u6570\u636e\u5305\uff0c\u90fd\u8981\u56de\u4e00\u4e2a ack \u5305\uff0c\u8bb0\u5f55\u4e0b\u6765\n                ikcp_ack_push(kcp, sn, ts);\n\n                // \u63a5\u6536\u7684\u6570\u636e\u8c03\u7528 ikcp_parse_data \u5904\u7406\n                if (_itimediff(sn, kcp->rcv_nxt) >= 0) {\n                    seg = ikcp_segment_new(kcp, len);\n                    seg->conv = conv;\n                    seg->cmd = cmd;\n                    seg->frg = frg;\n                    seg->wnd = wnd;\n                    seg->ts = ts;\n                    seg->sn = sn;\n                    seg->una = una;\n                    seg->len = len;\n\n                    if (len > 0) {\n                        memcpy(seg->data, data, len);\n                    }\n\n                    ikcp_parse_data(kcp, seg);\n                }\n            }\n        }\n        else if (cmd == IKCP_CMD_WASK) {\n            // \u67e5\u8be2\u7a97\u53e3\u5305\n            // ...\n        }\n        else if (cmd == IKCP_CMD_WINS) {\n            // \u67e5\u8be2\u7a97\u53e3\u7684\u56de\u590d\u5305\n            // ...\n        }\n        else {\n            return -3;\n        }\n\n        data += len;\n        size -= len;\n    }\n\n    // \u5904\u7406\u5feb\u901f\u91cd\u4f20\u903b\u8f91\n    // ...\n\n    // \u66f4\u65b0\u53d1\u9001\u7a97\u53e3\n    // ...\n\n    return 0;\n}\n```\n</details>\n\n<p><code>ikcp_input</code> \u5faa\u73af\u5904\u7406\u6bcf\u4e00\u4e2a <code>SEG</code> \u5305\uff0c\u5148\u68c0\u67e5\u6570\u636e\u5305\u7684\u5408\u6cd5\u6027\u548c\u7c7b\u578b\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u6570\u636e\u5305\u90fd\u4f1a\u5e26\u4e0a <code>una</code>\uff0c\u5b58\u653e\u7684\u662f\u53d1\u9001\u7aef\u7b49\u5f85\u63a5\u6536\u7684\u5305\u5e8f\u53f7\uff0c\u9700\u8981\u5c0f\u4e8e <code>una</code> \u7684\u5305\u5bf9\u7aef\u90fd\u5df2\u7ecf\u63a5\u53d7\u6210\u529f\uff0c\u6240\u4ee5\u53ef\u4ee5\u628a <code>snd_buff</code> \u4e2d\u9700\u8981\u5c0f\u4e8e <code>una</code> \u7684\u90fd\u5220\u6389\uff0c\u5e76\u66f4\u65b0 <code>snd_nxt</code>\uff0c\u8fd9\u4e00\u90e8\u5206\u7531 <code>ikcp_parse_una</code> \u548c <code>ikcp_shrink_buf</code> \u6765\u5904\u7406\u3002\u63a5\u6536\u5230\u7684\u6bcf\u4e2a\u6570\u636e\u5305\uff0c\u90fd\u9700\u8981\u56de\u590d ACK \u5305\uff0c\u7531 <code>ikcp_ack_push</code> \u8bb0\u5f55\u4e0b\u6765\uff0c\u6700\u540e\u8c03\u7528 <code>ikcp_parse_data</code> \u5904\u7406\u6570\u636e\u3002</p>\n<details>\n<summary> \u89e3\u6790\u6570\u636e\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\nvoid ikcp_parse_data(ikcpcb *kcp, IKCPSEG *newseg)\n{\n    struct IQUEUEHEAD *p, *prev;\n    IUINT32 sn = newseg->sn;\n    int repeat = 0;\n\n    // \u5e8f\u53f7\u68c0\u67e5\n    if (_itimediff(sn, kcp->rcv_nxt + kcp->rcv_wnd) >= 0 ||\n        _itimediff(sn, kcp->rcv_nxt) < 0) {\n        ikcp_segment_delete(kcp, newseg);\n        return;\n    }\n\n    // \u627e\u51fa newseg \u5e94\u8be5\u653e\u7f6e\u7684\u4f4d\u7f6e\uff0c\u56e0\u4e3a\u63a5\u6536\u5230\u7684 seg \u53ef\u80fd\u662f\u4e71\u5e8f\u7684\n    for (p = kcp->rcv_buf.prev; p != &kcp->rcv_buf; p = prev) {\n        IKCPSEG *seg = iqueue_entry(p, IKCPSEG, node);\n        prev = p->prev;\n        if (seg->sn == sn) {\n            // \u91cd\u590d\u6536\u5230\n            repeat = 1;\n            break;\n        }\n        if (_itimediff(sn, seg->sn) > 0) {\n            break;\n        }\n    }\n\n    // \u628a newseg \u653e\u5230 rcv_buf \u6b63\u786e\u7684\u4f4d\u7f6e\u4e0a\n    if (repeat == 0) {\n        iqueue_init(&newseg->node);\n        iqueue_add(&newseg->node, p);\n        kcp->nrcv_buf++;\n    }    else {\n        ikcp_segment_delete(kcp, newseg);\n    }\n\n    // \u628a\u6570\u636e\u4ece rcv_buf \u79fb\u52a8\u5230 rcv_queue\n    while (! iqueue_is_empty(&kcp->rcv_buf)) {\n        IKCPSEG *seg = iqueue_entry(kcp->rcv_buf.next, IKCPSEG, node);\n        // \u5982\u679c seg \u5e8f\u53f7\u662f\u7b49\u5f85\u63a5\u6536\u7684\u5e8f\u53f7\uff0c\u79fb\u52a8\u5230 rcv_queue\n        if (seg->sn == kcp->rcv_nxt && kcp->nrcv_que < kcp->rcv_wnd) {\n            iqueue_del(&seg->node);\n            kcp->nrcv_buf--;\n            iqueue_add_tail(&seg->node, &kcp->rcv_queue);\n            kcp->nrcv_que++;\n            kcp->rcv_nxt++;\n        }    else {\n            break;\n        }\n    }\n}\n```\n</details>\n\n<p><code>ikcp_parse_data</code> \u4e3b\u8981\u7684\u5de5\u4f5c\u5c31\u662f\u628a <code>newseg</code> \u653e\u7f6e\u5230 <code>kcp-&gt;rcv_buf</code> \u5408\u9002\u7684\u4f4d\u7f6e\u4e0a\uff0c\u5e76\u628a\u6570\u636e\u4ece <code>rcv_buf</code> \u79fb\u52a8\u5230 <code>rcv_queue</code>\u3002<code>rcv_buf</code> \u5408\u9002\u7684\u4f4d\u7f6e\u7684\u610f\u601d\u662f\uff0c<code>rcv_buf</code> \u662f\u6309\u7167 <code>sn</code> \u7684\u9012\u589e\u987a\u5e8f\u6392\u5217\u7684\uff0c<code>newseg</code> \u9700\u8981\u6839\u636e\u81ea\u5df1\u7684 <code>sn</code> \u5927\u5c0f\u67e5\u627e\u5408\u9002\u7684\u4f4d\u7f6e\u3002<code>rcv_buf</code> \u4e0a\u7684\u6570\u636e\u8981\u79fb\u52a8\u5230 <code>rcv_queue</code>\uff0c\u6761\u4ef6\u662f <code>rcv_buf</code> \u4e0a\u7684\u6570\u636e\u5305\u5e8f\u53f7\uff0c\u7b49\u4e8e KCP \u5728\u7b49\u5f85\u63a5\u6536\u7684\u5305\u5e8f\u53f7 <code>kcp-&gt;rcv_nxt</code> \uff0c\u79fb\u52a8\u4e00\u4e2a\u6570\u636e\u5305\u4e4b\u540e\uff0c\u9700\u8981\u66f4\u65b0 <code>kcp-&gt;rvc_nxt</code>\uff0c\u518d\u5904\u7406\u4e0b\u4e00\u4e2a\u6570\u636e\u5305\u3002</p>\n<p><code>ikcp_input</code> \u4e4b\u540e\uff0c\u4e0a\u5c42\u8c03\u7528 <code>ikcp_update</code> \u65f6\u5019\u4f1a\u53d1\u9001 ACK \u5305\uff0c\u8c03\u7528 <code>ikcp_recv</code> \u4f1a\u7ed9\u4e0a\u5c42\u8fd4\u56de\u6709\u6548\u6570\u636e\u3002<code>ikcp_update</code> \u548c <code>ikcp_recv</code> \u4e92\u76f8\u72ec\u7acb\uff0c\u6ca1\u6709\u8c03\u7528\u987a\u5e8f\u8981\u6c42\uff0c\u89c6\u4e0a\u5c42\u7684\u8c03\u7528\u65f6\u673a\u800c\u5b9a\u3002\u6211\u4eec\u5148\u6765\u770b <code>ikcp_update</code> \u91cc\u9762\u6709\u5173 ACK \u53d1\u9001\u7684\u90e8\u5206\uff1a</p>\n<details>\n<summary> \u56de\u590d ACK\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\n// \u524d\u9762\u8bf4\u8fc7\uff0cikcp_update \u6700\u7ec8\u662f\u8c03\u7528 ikcp_flush\nvoid ikcp_flush(ikcpcb *kcp, IUINT32 current)\n{\n    // ...\n\n    // \u56de\u590d ACK \u5305\n    count = kcp->ackcount;\n    for (i = 0; i < count; i++) {\n        size = (int)(ptr - buffer);\n        if (size + (int)IKCP_OVERHEAD > (int)kcp->mtu) {\n            ikcp_output(kcp, buffer, size);\n            ptr = buffer;\n        }\n        ikcp_ack_get(kcp, i, &seg.sn, &seg.ts);\n        ptr = ikcp_encode_seg(ptr, &seg);\n    }\n\n    kcp->ackcount = 0;\n\n    // ...\n}\n```\n</details>\n\n<p>ACK \u5305\u7684\u4e4b\u524d\u5df2\u7ecf\u7531 <code>ikcp_ack_push</code> \u4fdd\u5b58\u8d77\u6765\u4e86\uff0c\u6240\u4ee5\u8fd9\u91cc\u53ea\u9700\u8981 <code>ikcp_ack_get</code> \u83b7\u53d6\u6bcf\u4e2a ACK \u5305\u7684\u4fe1\u606f\uff0c\u53d1\u9001\u7ed9\u5bf9\u65b9\u3002\u4e0a\u5c42\u53ef\u4ee5\u4f7f\u7528 <code>ikcp_recv</code> \u4ece KCP \u83b7\u53d6\u6570\u636e\uff1a</p>\n<details>\n<summary> ikcp_recv\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\n//---------------------------------------------------------------------\n// user/upper level recv: returns size, returns below zero for EAGAIN\n//---------------------------------------------------------------------\nint ikcp_recv(ikcpcb *kcp, char *buffer, int len)\n{\n    struct IQUEUEHEAD *p;\n    int ispeek = (len < 0)? 1 : 0;\n    int peeksize;\n    int recover = 0;\n    IKCPSEG *seg;\n    assert(kcp);\n\n    // \u4e00\u4e9b\u6709\u6548\u6027\u68c0\u67e5\n    if (iqueue_is_empty(&kcp->rcv_queue))\n        return -1;\n    if (len < 0) len = -len;\n\n    // \u8ba1\u7b97\u80fd\u8fd4\u56de\u7684\u6570\u636e\u957f\u5ea6\n    peeksize = ikcp_peeksize(kcp);\n\n    if (peeksize < 0)\n        return -2;\n    if (peeksize > len)\n        return -3;\n\n    // \u5224\u65ad\u4e0b\u63a5\u6536\u7a97\u53e3\n    if (kcp->nrcv_que >= kcp->rcv_wnd)\n        recover = 1;\n\n    // \u904d\u5386 rcv_queue\uff0c\u628a\u6570\u636e\u590d\u5236\u5230 buffer \u4e0a\n    for (len = 0, p = kcp->rcv_queue.next; p != &kcp->rcv_queue; ) {\n        int fragment;\n        seg = iqueue_entry(p, IKCPSEG, node);\n        p = p->next;\n\n        if (buffer) {\n            memcpy(buffer, seg->data, seg->len);\n            buffer += seg->len;\n        }\n\n        len += seg->len;\n\n        // \u5224\u65ad\u5206\u5305\n        fragment = seg->frg;\n\n        // \u79fb\u9664\u6570\u636e\u5305\n        if (ispeek == 0) {\n            iqueue_del(&seg->node);\n            ikcp_segment_delete(kcp, seg);\n            kcp->nrcv_que--;\n        }\n\n        // \u6240\u6709\u5206\u5305\u90fd\u590d\u5236\u5b8c\uff0c\u9000\u51fa\u5faa\u73af\n        if (fragment == 0)\n            break;\n    }\n\n    assert(len == peeksize);\n\n    // rcv_queue \u53c8\u7a7a\u4e86\u4e00\u4e9b\uff0c\u5c1d\u8bd5\u7ee7\u7eed\u4ece rcv_buf \u79fb\u52a8\u5230 rcv_queue\n    while (! iqueue_is_empty(&kcp->rcv_buf)) {\n        seg = iqueue_entry(kcp->rcv_buf.next, IKCPSEG, node);\n        if (seg->sn == kcp->rcv_nxt && kcp->nrcv_que < kcp->rcv_wnd) {\n            iqueue_del(&seg->node);\n            kcp->nrcv_buf--;\n            iqueue_add_tail(&seg->node, &kcp->rcv_queue);\n            kcp->nrcv_que++;\n            kcp->rcv_nxt++;\n        }    else {\n            break;\n        }\n    }\n\n    return len;\n}\n```\n</details>\n\n<p><code>ikcp_recv</code> \u4e00\u6b21\u8c03\u7528\u53ea\u4f1a\u8fd4\u56de\u4e00\u4e2a\u5b8c\u6574\u7684\u6570\u636e\u5305\uff0c\u4e0a\u5c42\u53ef\u4ee5\u5faa\u73af\u8c03\u7528\u76f4\u5230\u6ca1\u6709\u6570\u636e\u8fd4\u56de\u4e3a\u6b62\uff0c\u51fd\u6570\u7684\u903b\u8f91\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u662f\u4ece <code>rcv_queue</code> \u4e2d\u590d\u5236\u6570\u636e\u5230\u4e0a\u5c42\u4f20\u8fdb\u6765\u7684 <code>buffer</code> \u91cc\u9762\uff0c\u81f3\u6b64\u63a5\u6536\u65b9\u5bf9\u4e8e\u63a5\u6536\u5230\u7684\u6570\u636e\u5305\u5df2\u7ecf\u5904\u7406\u5b8c\u6bd5\u3002</p>\n<p>\u63a5\u6536\u65b9\u5904\u7406\u6570\u636e\u5305\u7684\u65f6\u5019\uff0c\u7ed9\u53d1\u9001\u65b9\u53d1\u9001\u4e86 ACK \u5305\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u53d1\u9001\u65b9\u63a5\u53d7 ACK \u5305\u7684\u5904\u7406\uff1a</p>\n<details>\n<summary> \u5904\u7406 ACK \u5305\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\nint ikcp_input(ikcpcb *kcp, const char *data, long size)\n{\n    // ...\n    IUINT32 maxack = 0, latest_ts = 0;\n    // ...\n    while (1) {\n        // ...\n        // ts \u662f\u5bf9\u7aef\u7684 kcp-> current\n        data = ikcp_decode32u(data, &ts);\n        data = ikcp_decode32u(data, &sn);\n\n        if (cmd == IKCP_CMD_ACK) {\n            // \u66f4\u65b0 rot\n            if (_itimediff(kcp->current, ts) >= 0) {\n                ikcp_update_ack(kcp, _itimediff(kcp->current, ts));\n            }\n            // \u66f4\u65b0 snd_buf\n            ikcp_parse_ack(kcp, sn);\n            ikcp_shrink_buf(kcp);\n\n            // maxack = \u8fd9\u6b21 input \u7684\u6240\u6709 ACK \u5305\u4e2d\u6700\u5927\u7684 sn\n            if (flag == 0) {\n                flag = 1;\n                maxack = sn;\n                latest_ts = ts;\n            }    else {\n                if (_itimediff(sn, maxack) > 0) {\n                #ifndef IKCP_FASTACK_CONSERVE\n                    maxack = sn;\n                    latest_ts = ts;\n                #else\n                    if (_itimediff(ts, latest_ts) > 0) {\n                        maxack = sn;\n                        latest_ts = ts;\n                    }\n                #endif\n                }\n            }\n        }\n        // ...\n    }\n\n    // \u5982\u679c\u6709\u6536\u5230 ACK \u5305\uff0c\u8bb0\u5f55\u7528\u6765\u505a\u5feb\u901f\u91cd\u4f20\n    if (flag != 0) {\n        ikcp_parse_fastack(kcp, maxack, latest_ts);\n    }\n}\n```\n</details>\n\n<p>\u53ef\u4ee5\u770b\u5230\u63a5\u6536\u5230 ACK \u5305\u540e\u540c\u6837\u4f1a\u9700\u8981 <code>ikcp_parse_ack</code> \u548c <code>ikcp_shrink_buf</code> \u6765\u66f4\u65b0 <code>snd_buf</code>\uff0c\u53e6\u5916\u8fd8\u9700\u8981\u8c03\u7528 <code>ikcp_update_ack</code> \u6765\u8ba1\u7b97\u66f4\u65b0 rto \uff08retransmission timeout\uff0c\u8d85\u65f6\u91cd\u4f20\u65f6\u95f4\uff09\u3002<code>ikcp_input</code> \u8ba1\u7b97\u6536\u5230\u7684 ACK \u5305\u4e2d\u6700\u5927\u5e8f\u53f7\uff0c\u6765\u8bb0\u5f55\u505a\u5feb\u901f\u91cd\u4f20\u7528\u3002\u5c31\u8fd9\u6837\uff0c\u53d1\u9001\u65b9\u6536\u5230 ACK \u5305\uff0c\u628a\u53d1\u9001\u6570\u636e\u4ece <code>snd_buf</code> \u4e2d\u79fb\u9664\uff0c\u8be5\u6570\u636e\u5305\u53ef\u9760\u5730\u9001\u8fbe\u5230\u4e86\u63a5\u6536\u65b9\uff0c\u4e00\u6b21\u5b8c\u6574\u7684 ARQ \u786e\u8ba4\u63a5\u6536\u8fc7\u7a0b\u7ed3\u675f\u3002</p>\n<h3>\u8d85\u65f6\u91cd\u4f20</h3>\n<p>\u524d\u9762\u4ecb\u7ecd\u7684\u662f KCP \u5b9e\u73b0\u7684 ARQ \u4e2d\u7684 \u786e\u8ba4\u63a5\u6536\u673a\u5236\uff0cARQ \u8fd8\u9700\u8981\u4e00\u4e2a\u8d85\u65f6\u91cd\u4f20\u6765\u4fdd\u8bc1\u53ef\u9760\u6027\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u770b\u770b KCP \u662f\u600e\u4e48\u505a\u8d85\u65f6\u91cd\u4f20\u7684\u3002</p>\n<p>\u8ba9\u6211\u4eec\u56de\u5230 <code>ikcp_flush</code> \u51fd\u6570\uff1a</p>\n<details>\n<summary> \u8d85\u65f6\u91cd\u4f20\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\nvoid ikcp_flush(ikcpcb *kcp)\n{\n    // ...\n    // \u53d1\u9001 snd_buf\n    for (p = kcp->snd_buf.next; p != &kcp->snd_buf; p = p->next) {\n        IKCPSEG *segment = iqueue_entry(p, IKCPSEG, node);\n        int needsend = 0;\n        if (segment->xmit == 0) {\n            // \u9996\u6b21\u53d1\u9001\n            needsend = 1;\n            segment->xmit++;\n            // \u8bbe\u7f6e segment->rto\n            // \u901a\u8fc7 segment->rto \u8ba1\u7b97 segment->resendts \u8d85\u65f6\u91cd\u4f20\u65f6\u95f4\n            segment->rto = kcp->rx_rto;\n            segment->resendts = current + segment->rto + rtomin;\n        }\n        else if (_itimediff(current, segment->resendts) >= 0) {\n            // \u8d85\u65f6\u91cd\u4f20\n            needsend = 1;\n            segment->xmit++;\n            kcp->xmit++;\n            // nodelay \u63a7\u5236\u4e0b\u4e00\u6b21\u8d85\u65f6\u91cd\u4f20\u65f6\u95f4\u7684\u8ba1\u7b97\n            if (kcp->nodelay == 0) {\n                segment->rto += kcp->rx_rto;\n            }    else {\n                segment->rto += kcp->rx_rto / 2;\n            }\n            segment->resendts = current + segment->rto;\n            lost = 1;\n        }\n        else if (segment->fastack >= resent) {\n            // \u5feb\u901f\u91cd\u4f20\n            // ...\n        }\n        if (needsend) {\n            // \u53d1\u9001\u6570\u636e\n            // ...\n        }\n    // ...\n}\n```\n</details>\n\n<p>\u4e00\u65e6\u5f53\u524d\u65f6\u95f4 <code>current</code> \u5927\u4e8e <code>segment-&gt;resendts</code> \u8d85\u65f6\u91cd\u4f20\u65f6\u95f4\uff0c\u8bf4\u660e\u5728\u8fd9\u6bb5\u65f6\u95f4\u5185\uff0c\u90fd\u6ca1\u6709\u6536\u5230\u63a5\u6536\u65b9\u7684 ACK \u5305\uff0c\u89e6\u53d1\u8d85\u65f6\u91cd\u4f20\u673a\u5236\uff0c<code>needsend = 1</code>\uff0c\u91cd\u65b0\u53d1\u9001\u6570\u636e\u3002</p>\n<p>\u6709\u4e86\u786e\u8ba4\u63a5\u6536\u548c\u8d85\u65f6\u91cd\u4f20\u673a\u5236\uff0cKCP \u5c31\u53ef\u4ee5\u4fdd\u8bc1\u57fa\u7840\u7684\u53ef\u9760\u6570\u636e\u4f20\u8f93\u4e86\u3002\u4f46\u662f\u4e3a\u4e86\u80fd\u591f\u4fdd\u6301\u66f4\u7a33\u5b9a\u7684\u6570\u636e\u6d41\u901f\uff0cKCP \u8fd8\u505a\u4e86\u66f4\u591a\u7684\u4e8b\u60c5\uff0c\u4e0b\u9762\u6211\u4eec\u4e00\u8d77\u770b\u770b KCP \u8fd8\u505a\u4e86\u90a3\u4e9b\u4f18\u5316\u3002</p>\n<h2>KCP \u63d0\u5347\u6d41\u901f\u7684\u7b56\u7565</h2>\n<h3>\u5feb\u901f\u91cd\u4f20</h3>\n<p>\u53d1\u9001\u65b9\u53d1\u9001\u4e86\u5e8f\u53f7\u4e3a <code>sn</code> \u548c <code>sn + 1</code> \u4e24\u4e2a\u6570\u636e\u5305\uff0c\u5982\u679c\u53ea\u6536\u5230\u4e86 <code>sn + 1</code> \u7684 ACK \u5305\uff0c\u90a3\u53ef\u80fd\u662f\u56e0\u4e3a <code>sn</code> \u7684 ACK \u5305\u5728\u7f51\u8def\u4e2d\u8fd8\u6ca1\u5230\u8fbe\uff0c\u53c8\u6216\u8005 ACK \u5305\u4e22\u4e86\uff0c\u53c8\u6216\u8005 <code>sn</code> \u6570\u636e\u5305\u4e22\u4e86\uff0c\u5982\u679c\u6b64\u65f6\u8fd8\u6ca1\u5230\u8d85\u65f6\u91cd\u4f20\u7684\u65f6\u95f4\uff0c\u7f51\u7edc\u4e5f\u8fd8\u4e0d\u592a\u62e5\u5835\uff0c\u53ea\u662f\u56e0\u4e3a\u67d0\u79cd\u539f\u56e0\u800c\u7a81\u53d1\u4e22\u5305\uff0c\u90a3\u4e48\u53d1\u9001\u65b9\u4e3b\u52a8\u63d0\u524d\u53d1\u9001 <code>sn</code> \u6570\u636e\u5305\uff0c\u53ef\u4ee5\u5e2e\u52a9\u63a5\u6536\u65b9\u66f4\u5feb\u5730\u63a5\u6536\u6570\u636e\uff0c\u63d0\u9ad8\u6d41\u901f\u3002</p>\n<p>KCP \u91cc\u9762\u4e5f\u76f8\u5e94\u5b9e\u73b0\u4e86\u5feb\u901f\u91cd\u4f20\u673a\u5236\uff0c\u4e5f\u5728 <code>ikcp_flush</code> \u91cc\u9762\uff1a</p>\n<details>\n<summary> \u5feb\u901f\u91cd\u4f20\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\nvoid ikcp_flush(ikcpcb *kcp)\n{\n    // ...\n    resent = (kcp->fastresend > 0)? (IUINT32)kcp->fastresend : 0xffffffff;\n\n    // \u53d1\u9001 snd_buf\n    for (p = kcp->snd_buf.next; p != &kcp->snd_buf; p = p->next) {\n        IKCPSEG *segment = iqueue_entry(p, IKCPSEG, node);\n        int needsend = 0;\n        if (segment->xmit == 0) {\n            // ...\n        }\n        else if (_itimediff(current, segment->resendts) >= 0) {\n            // ...\n        }\n        else if (segment->fastack >= resent) {\n            // \u5feb\u901f\u91cd\u4f20\n            if ((int)segment->xmit <= kcp->fastlimit ||\n                kcp->fastlimit <= 0) {\n                needsend = 1;\n                segment->xmit++;\n                segment->fastack = 0;\n                segment->resendts = current + segment->rto;\n                change++;\n            }\n        }\n        if (needsend) {\n            // \u53d1\u9001\u6570\u636e\n            // ...\n        }\n    // ...\n}\n```\n</details>\n\n<p>\u8981\u51fa\u53d1\u5feb\u901f\u91cd\u4f20\uff0c\u6709\u4e24\u4e2a\u6761\u4ef6\uff1a\n* <code>segment-&gt;fastack &gt;= resent</code>\uff0cresent \u662f\u53ef\u914d\u7f6e\u7684\u53c2\u6570 <code>kcp-&gt;fastresend</code>\uff0c\u914d\u7f6e\u4e3a 0 \u4f1a\u5173\u95ed\u5feb\u901f\u91cd\u4f20\u3002<code>segment-&gt;fastack</code> \u662f\u5728\u51fd\u6570 <code>ikcp_parse_fastack</code> \u91cc\u9762\u8bbe\u7f6e\u7684\uff0c\u8fd9\u4e2a\u51fd\u6570\u662f\u5728 <code>ikcp_input</code> \u91cc\u9762\u8c03\u7528\uff0c\u4f1a\u6839\u636e <code>ikcp_input</code> \u7b97\u51fa\u7684 <code>maxack</code> \u6765\u7ed9\u6240\u6709 <code>sn</code> \u5c0f\u4e8e <code>maxack</code> \u7684 <code>segment-&gt;fastack</code> \u52a0\u4e00\uff0c\u6240\u4ee5 <code>segment-&gt;fastack</code> \u5c31\u662f\u8868\u793a\u6536\u5230\u6bd4 <code>sn</code> \u5927\u7684\u5305\u7684\u6b21\u6570\u3002\n* <code>segment-&gt;xmit &lt;= kcp-&gt;fastlimit || kcp-&gt;fastlimit &lt;= 0</code>\uff0c<code>setgment-&gt;xmit</code> \u662f\u53d1\u9001\u6b21\u6570\uff0c<code>kcp-&gt;fastlimit</code> \u662f\u53ef\u914d\u7f6e\u7684\u6700\u5927\u5feb\u901f\u91cd\u4f20\u6b21\u6570\uff0c\u53d1\u9001\u6b21\u6570\u9700\u8981\u5c0f\u4e8e\u6700\u5927\u5feb\u901f\u91cd\u4f20\u6b21\u6570</p>\n<p>\u4e00\u65e6\u6ee1\u8db3\u5feb\u901f\u91cd\u4f20\u7684\u4ee5\u4e0a\u6761\u4ef6\uff0cKCP \u5c31\u4f1a\u6267\u884c\u5feb\u901f\u91cd\u4f20\uff0c\u8981\u6ce8\u610f\u5feb\u901f\u91cd\u4f20\u5e76\u4e0d\u4f1a\u91cd\u7f6e\u8d85\u65f6\u91cd\u4f20\u65f6\u95f4\uff0c\u539f\u6765\u7684\u8d85\u65f6\u65f6\u95f4\u4f9d\u7136\u4f1a\u751f\u6548\u3002</p>\n<h3>\u7f29\u77ed\u8d85\u65f6\u91cd\u4f20\u65f6\u95f4</h3>\n<p>\u8d85\u65f6\u91cd\u4f20\u662f\u4e2a\u5f88\u597d\u7684\u673a\u5236\uff0c\u4f46\u5c31\u662f\u592a\u82b1\u65f6\u95f4\u4e86\uff0c\u6309\u7167 TCP \u7684\u7b56\u7565\uff0c\u6bcf\u6b21\u8d85\u65f6\u91cd\u4f20\u65f6\u95f4\u7ffb\u500d\uff0c\u7b49\u5f85\u65f6\u95f4\u81a8\u80c0\u5f97\u5f88\u5feb\uff0c\u5728\u7b49\u5f85\u65f6\u95f4\u5185\uff0c\u5f88\u53ef\u80fd\u7531\u4e8e\u63a5\u6536\u7aef\u7684\u63a5\u6536\u7a97\u53e3\u5df2\u8017\u5c3d\uff0c\u65e0\u6cd5\u63a5\u6536\u65b0\u6570\u636e\uff0c\u800c\u7b49\u5f85\u91cd\u4f20\u7684\u5305\u5e8f\u53f7\u662f\u5728\u6700\u524d\u9762\uff0c\u63a5\u6536\u65b9\u8981\u63a5\u6536\u5230\u91cd\u4f20\u7684\u5305\u624d\u80fd\u628a\u6240\u6709\u6570\u636e\u8fd4\u56de\u7ed9\u4e0a\u5c42\uff0c\u8fd9\u79cd\u60c5\u51b5\uff0c\u6574\u4e2a\u7f51\u8def\u7684\u6d41\u901f\u51e0\u4e4e\u4e3a 0\u3002KCP \u589e\u52a0\u4e86\u914d\u7f6e\u53ef\u4ee5\u51cf\u7f13\u7b49\u5f85\u7684\u65f6\u95f4\u589e\u957f\uff0c\u800c\u4e14\u4e5f\u4e0d\u4f1a\u662f\u7ffb\u500d\uff0c\u901a\u8fc7\u914d\u7f6e <code>kcp-&gt;nodelay</code> \u63a7\u5236\u6bcf\u6b21\u7b49\u5f85\u65f6\u95f4\u53ea\u4f1a\u589e\u957f 1 \u500d\u7684 RTO \u6216\u8005 0.5 \u500d\u7684 RTO\uff0c\u6709\u6548\u51cf\u7f13\u7b49\u5f85\u65f6\u95f4\u7684\u589e\u957f\uff0c\u5e2e\u52a9\u7f51\u8def\u5c3d\u5feb\u6062\u590d\u6d41\u901f\u3002</p>\n<h3>\u66f4\u65b0\u53d1\u9001\u7a97\u53e3</h3>\n<p>\u53d1\u9001\u7a97\u53e3\u8868\u793a\u7684\u662f\u540c\u65f6\u4f20\u8f93\u7684\u6570\u636e\u5305\u6570\u91cf\uff0c\u7a97\u53e3\u8d8a\u5927\uff0c\u540c\u65f6\u4f20\u8f93\u7684\u6570\u636e\u8d8a\u591a\uff0c\u6d41\u901f\u8d8a\u5927\uff0c\u4f46\u7a97\u53e3\u8fc7\u5927\uff0c\u4f1a\u5bfc\u81f4\u7f51\u7edc\u62e5\u585e\uff0c\u4e22\u5305\u7387\u4e0a\u5347\uff0c\u6570\u636e\u91cd\u4f20\u589e\u591a\uff0c\u6d41\u901f\u4e0b\u964d\u3002\u6240\u4ee5\u53d1\u9001\u7a97\u53e3\u9700\u8981\u6839\u636e\u7f51\u7edc\u60c5\u51b5\u4e0d\u65ad\u66f4\u65b0\uff0c\u6162\u6162\u8d8b\u8fd1\u6700\u4f18\u3002 KCP \u4e2d\u5173\u4e8e\u53d1\u9001\u7a97\u53e3\u7684\u4ee3\u7801\uff1a</p>\n<details>\n<summary> \u53d1\u9001\u7a97\u53e3\uff08\u70b9\u51fb\u5c55\u5f00\u4ee3\u7801\uff09 </summary>\n```cpp\nikcpcb* ikcp_create(IUINT32 conv, void *user)\n{\n    // ...\n    // snd_wnd\uff0crcv_wnd \u53d1\u9001\u548c\u63a5\u53d7\u7684\u7f13\u51b2\u533a\u5927\u5c0f\n    kcp->snd_wnd = IKCP_WND_SND;    // 32\n    kcp->rcv_wnd = IKCP_WND_RCV;    // 128\n    // \u5bf9\u7aef\u63a5\u6536\u7a97\u53e3\u5927\u5c0f              // 128\n    kcp->rmt_wnd = IKCP_WND_RCV\n    // \u53d1\u9001\u7a97\u53e3 cwnd \u521d\u59cb\u5316 0\n    kcp->cwnd = 0;\n    // \u53d1\u9001\u7a97\u53e3\u5b57\u8282\u6570\u5927\u5c0f\uff0c\u53c2\u4e0e\u8ba1\u7b97 cwnd\n    kcp->incr = 0\n    // \u6162\u542f\u52a8\u9608\u503c\uff0cslow start threshold\n    kcp->ssthresh = IKCP_THRESH_INIT;\n    // nocwnd \u662f\u53ef\u914d\u7f6e\u53c2\u6570\uff0c1 \u4e0d\u8003\u8651 cwnd\n    kcp->nocwnd = 0;\n    // ...\n}\n\nvoid ikcp_flush(ikcpcb *kcp)\n{\n    // ...\n    // \u53d1\u9001\u6570\u636e\u65f6\u5148\u8ba1\u7b97 \u53d1\u9001\u7a97\u53e3\u5927\u5c0f\uff0c\u662f\u53d1\u9001\u7f13\u51b2\u533a\u5927\u5c0f\u548c\u5bf9\u65b9\u63a5\u6536\u7a97\u53e3\u5927\u5c0f\u7684\u5c0f\u503c\n    cwnd = _imin_(kcp->snd_wnd, kcp->rmt_wnd);\n    // \u9ed8\u8ba4\u8fd8\u9700\u8981\u8003\u8651 kcp->cwnd\uff0c\u5373\u662f\u4e0d\u65ad\u66f4\u65b0\u7684\u53d1\u9001\u7a97\u53e3\n    if (kcp->nocwnd == 0) cwnd = _imin_(kcp->cwnd, cwnd);\n\n    // \u6839\u636e cwnd \u5927\u5c0f\uff0csnd_queue \u79fb\u52a8\u5230 snd_buf\n    while (_itimediff(kcp->snd_nxt, kcp->snd_una + cwnd) < 0) {\n    }\n    // \u53d1\u9001\u6570\u636e\n    resent = (kcp->fastresend > 0)? (IUINT32)kcp->fastresend : 0xffffffff;\n    // \u89e6\u53d1\u8d85\u65f6\u91cd\u4f20 lost = 1\n    // \u89e6\u53d1\u5feb\u901f\u91cd\u4f20 change++\n\n    // \u66f4\u65b0\u6162\u542f\u52a8\u9608\u503c\u548c\u53d1\u9001\u7a97\u53e3\n    if (change) {\n        // \u5982\u679c\u6709\u89e6\u53d1\u5feb\u901f\u91cd\u4f20\uff0cssthresh \u8bbe\u7f6e\u4e3a\u7f51\u7edc\u4e0a\u6b63\u5728\u4f20\u8f93\u7684\u6570\u636e\u5305\u6570\u91cf\u7684\u4e00\u534a\n        IUINT32 inflight = kcp->snd_nxt - kcp->snd_una;\n        kcp->ssthresh = inflight / 2;\n        if (kcp->ssthresh < IKCP_THRESH_MIN)\n            kcp->ssthresh = IKCP_THRESH_MIN;\n\n        // \u53d1\u9001\u7a97\u53e3\u4e3a\u9608\u503c\u518d\u52a0\u4e0a\u5feb\u901f\u91cd\u4f20\u76f8\u5173\u7684 resent\n        kcp->cwnd = kcp->ssthresh + resent;\n        kcp->incr = kcp->cwnd * kcp->mss;\n    }\n\n    if (lost) {\n        // \u5982\u679c\u6709\u8d85\u65f6\u91cd\u4f20\uff0c\u89e6\u53d1\u6162\u542f\u52a8, ssthresh \u9608\u503c\u4e3a\u53d1\u9001\u7a97\u53e3\u7684\u4e00\u534a\n        kcp->ssthresh = cwnd / 2;\n        if (kcp->ssthresh < IKCP_THRESH_MIN)\n            kcp->ssthresh = IKCP_THRESH_MIN;\n        // \u53d1\u9001\u7a97\u53e3\u56de\u5230 1\uff0c\u91cd\u65b0\u6162\u542f\u52a8\u589e\u957f\n        kcp->cwnd = 1;\n        kcp->incr = kcp->mss;\n    }\n\n    if (kcp->cwnd < 1) {\n        // \u56e0\u4e3a\u521d\u59cb\u5316\u4e3a 0\uff0c\u6765\u5230\u8fd9\u91cc\u4f1a\u518d\u8bbe\u7f6e\u6210 1\n        kcp->cwnd = 1;\n        kcp->incr = kcp->mss;\n    }\n}\n\nint ikcp_input(ikcpcb *kcp, const char *data, long size)\n{\n    IUINT32 prev_una = kcp->snd_una;\n    // \u5904\u7406\u63a5\u6536\u7684\u6570\u636e\n\n    while (1) {\n        // ...\n        data = ikcp_decode16u(data, &wnd)\n        // rmt_wnd \u662f\u5bf9\u65b9\u7684\u63a5\u6536\u7a97\u53e3\u5927\u5c0f\n        kcp->rmt_wnd = wnd\n        // ...\n        // \u5904\u7406\u6570\u636e\n    }\n\n    // \u6700\u540e\u66f4\u65b0\u53d1\u9001\u7a97\u53e3\n    // kcp->snd_una - prev_una > 0\uff0c\u8868\u793a\u672c\u6b21 input \u6709\u63a5\u53d7\u5230 ACK \u5e76\u4e14\u53d1\u9001\u7f13\u51b2 snd_buf \u6709\u53d8\u5316\n    if (_itimediff(kcp->snd_una, prev_una) > 0) {\n        // \u518d\u5224\u65ad\u5bf9\u65b9\u7684\u63a5\u6536\u7a97\u53e3\n        if (kcp->cwnd < kcp->rmt_wnd) {\n            IUINT32 mss = kcp->mss;\n\n            if (kcp->cwnd < kcp->ssthresh) {\n                // \u5c0f\u4e8e\u6162\u542f\u52a8\u9608\u503c\uff0c\u53cc\u500d\u589e\u957f\n                kcp->cwnd++;\n                kcp->incr += mss;\n\n            }    else {\n                // \u5927\u4e8e\u6162\u542f\u52a8\u9608\u503c\u4e4b\u540e\uff0c\u901a\u8fc7\u516c\u5f0f\u66f4\u65b0 incr \uff0c\u8fdb\u800c\u8ba1\u7b97 cwnd\n                if (kcp->incr < mss) kcp->incr = mss;\n                kcp->incr += (mss * mss) / kcp->incr + (mss / 16);\n                if ((kcp->cwnd + 1) * mss <= kcp->incr) {\n                    kcp->cwnd++;\n                }\n            }\n            // \u66f4\u65b0\u51fa\u6765\u7684\u503c\u8fd8\u8981\u518d\u6bd4\u8f83\u4e0b rmt_wnd\n            if (kcp->cwnd > kcp->rmt_wnd) {\n                kcp->cwnd = kcp->rmt_wnd;\n                kcp->incr = kcp->rmt_wnd * mss;\n            }\n        }\n    }\n}\n```\n</details>\n\n<p>\u8ba1\u7b97\u53d1\u9001\u7a97\u53e3 <code>kcp-&gt;cwnd</code> \u7684\u5927\u5c0f\u6d89\u53ca\u7684\u4ee3\u7801\u7247\u6bb5\u4f1a\u7a0d\u5fae\u591a\u4e00\u4e9b\uff0c\u56e0\u4e3a\u5728\u53d1\u9001\u548c\u63a5\u6536\u6570\u636e\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u9700\u8981\u66f4\u65b0\u3002<code>kcp-&gt;cwnd</code> \u521d\u59cb\u5316\u4e3a 0\uff0c\n\u4e4b\u540e\u4f1a\u5728\u7b2c\u4e00\u6b21\u8c03\u7528 <code>ikcp_flush</code> \u7684\u65f6\u5019\uff0c\u5224\u65ad\u5c0f\u4e8e 1 \uff0c\u4fbf\u4fee\u6539\u6210 1\u3002\u4e4b\u540e\u53d1\u9001\u65b9\u6839\u636e\u53d1\u9001\u7a97\u53e3\u5927\u5c0f\uff0c\u53d1\u9001\u51fa\u76f8\u5e94\u6570\u91cf\u7684\u6570\u636e\u5305\uff0c\u7b49\u5f85 ACK\n\u56de\u590d\u5305\u3002ACK \u5305\u5728 <code>kcp-&gt;input</code> \u4e2d\u8fdb\u884c\u5904\u7406\uff0c<code>kcp-&gt;input</code> \u4e2d\u5982\u679c\u5224\u65ad\u6709 ACK \u5305\uff0c\u5e76\u6709\u6e05\u9664\u53d1\u9001\u7f13\u51b2\u4e2d\u7684\u53d1\u9001\u6570\u636e\u5305\uff0c\u8bf4\u660e\u6709\u6570\u636e\u5305\u5df2\u7ecf\u5b8c\u6210\u9001\u8fbe\uff0c<code>kcp-&gt;cwnd++</code>\u3002\u5b9e\u9645\u4e0a\u5f88\u53ef\u80fd\u662f\u4e00\u6b21 <code>kcp-&gt;input</code> \u53ea\u5904\u7406\u5230\u4e00\u4e2a ACK \u5305\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\uff0c\u6bcf\u6536\u5230\u4e00\u4e2a ACK \u5305\u90fd\u4f1a\u6709 <code>kcp-&gt;cwnd++</code>\uff0c\u8fd9\u53e5\u81ea\u589e\u5b9e\u73b0\u7684\u662f\u7ffb\u500d\u7684\u6548\u679c\uff0c\u8b6c\u5982\u5f53\u524d <code>kcp-&gt;cwnd = 2</code>\uff0c\u53d1\u9001\u4e24\u4e2a\u6570\u636e\u5305\uff0c\u6536\u5230\u4e24\u4e2a ACK \u5305\uff0c\u89e6\u53d1\u4e86\u4e24\u6b21\u81ea\u589e\uff0c\u6700\u540e\u5c31\u662f <code>kcp-&gt;cwnd = 4</code> \u7ffb\u500d\u3002</p>\n<p><code>cwnd</code> \u53ef\u4ee5\u4e00\u76f4\u6307\u6570\u589e\u957f\uff0c\u76f4\u5230\u8d85\u8fc7\u6162\u542f\u52a8\u9608\u503c\uff0c\u6216\u8005\u53d1\u751f\u62e5\u5835\u8d85\u65f6\u91cd\u4f20\uff0c\u5feb\u901f\u91cd\u4f20\u7684\u60c5\u51b5\u3002\u53d1\u751f\u4e86\u8d85\u65f6\u91cd\u4f20\u4e4b\u540e\uff0c\u4f1a\u89e6\u53d1\u6162\u542f\u52a8\uff0c\u6162\u542f\u52a8\u9608\u503c <code>ssthresh = kcp-&gt;cwnd / 2</code>\uff0c\u53d1\u9001\u7a97\u53e3 <code>kcp-&gt;cwnd = 1</code>\uff0c\u56de\u5230\u6700\u521d\u91cd\u65b0\u6307\u6570\u589e\u957f\u3002\u5982\u679c\u53d1\u751f\u4e86\u5feb\u901f\u91cd\u4f20\uff0cKCP \u5148\u63d0\u524d\u51cf\u5c11 <code>ssthresh</code>\uff0c\u4e5f\u5373\u662f\u51cf\u5c11\u4e86 <code>cwnd</code> \u6307\u6570\u589e\u957f\u7684\u7a7a\u95f4\uff0c\u964d\u4f4e\u589e\u957f\u901f\u5ea6\uff0c\u63d0\u524d\u51cf\u7f13\u62e5\u5835\u7684\u60c5\u51b5\u3002</p>\n<p>KCP \u8fd8\u589e\u52a0\u4e86\u4e00\u4e2a\u914d\u7f6e <code>nocwnd</code>\uff0c\u5f53 <code>nocwnd = 1</code>\uff0c\u53d1\u9001\u6570\u636e\u662f\u4e0d\u518d\u8003\u8651\u53d1\u9001\u7a97\u53e3\u5927\u5c0f\uff0c\u76f4\u63a5\u8ba9\u6700\u5927\u80fd\u53d1\u9001\u7684\u6570\u91cf\u53d1\u9001\u6570\u636e\u5305\uff0c\u6ee1\u8db3\u9ad8\u901f\u6a21\u5f0f\u4e0b\u7684\u8981\u6c42\u3002</p>\n<h2>\u5c0f\u7ed3</h2>\n<p>\u672c\u6587\u7b80\u5355\u5730\u5206\u6790\u4e86 KCP \u7684\u6e90\u7801\uff0c\u5e76\u8ba8\u8bba\u4e86 KCP \u4e0a ARQ \u7684\u5b9e\u73b0\uff0c\u548c\u4e00\u4e9b KCP \u63d0\u5347\u6d41\u901f\u7684\u7b56\u7565\u3002\u8fd8\u6709\u5f88\u591a\u7ec6\u8282\u6ca1\u6709\u63d0\u5230\uff0c\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u81ea\u5df1\u7ffb KCP \u7684\u6e90\u7801\u5bf9\u7167\u7740\u770b\uff0c\u76f8\u4fe1\u4e5f\u80fd\u6709\u4e0d\u5c11\u7684\u6536\u83b7\u3002</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/cpp-%E7%BC%96%E5%86%99Windows%E4%B8%8B%E7%9A%84MemoryLeakDetector/",
            "url": "https://wiki.disenone.site/cpp-%E7%BC%96%E5%86%99Windows%E4%B8%8B%E7%9A%84MemoryLeakDetector/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "\u7f16\u5199 Windows \u4e0b\u7684 Memory Leak Detector",
            "content_html": "<p><meta property=\"og:title\" content=\"\u7f16\u5199 Windows \u4e0b\u7684 Memory Leak Detector\" /></p>\n<p><img alt=\"\" src=\"https://img.shields.io/badge/windows-10-blue.svg\">{:style=\"display: inline-block\"}\n<img alt=\"\" src=\"https://img.shields.io/badge/vs-2015-68217A.svg\">{:style=\"display: inline-block\"}</p>\n<h2>\u524d\u8a00</h2>\n<p>\u8fd9\u4e00\u9635\u5b50\u8bfb\u5b8c\u4e86\u300a\u7a0b\u5e8f\u5458\u7684\u81ea\u6211\u4fee\u517b\uff1a\u94fe\u63a5\u3001\u88c5\u8f7d\u4e0e\u5e93\u300b\uff08\u540e\u9762\u7b80\u79f0\u300a\u94fe\u63a5\u300b\uff09\uff0c\u6536\u83b7\u826f\u591a\uff0c\u5bfb\u601d\u7740\u80fd\u4e0d\u80fd\u505a\u4e9b\u76f8\u5173\u7684\u5c0f\u4ee3\u7801\u51fa\u6765\u3002\u521a\u597d\u77e5\u9053 Windows \u4e0b\u6709\u4e2a\u5185\u5b58\u6cc4\u9732\u68c0\u6d4b\u5de5\u5177 <a href=\"https://vld.codeplex.com/\">Visual Leak Detector</a>\uff0c\u8fd9\u4e2a\u5de5\u5177\u662f\u901a\u8fc7\u66ff\u6362 Windows \u4e0b\u8d1f\u8d23\u5185\u5b58\u7ba1\u7406\u7684 dll \u63a5\u53e3\u6765\u5b9e\u73b0\u8ddf\u8e2a\u5185\u5b58\u5206\u914d\u91ca\u653e\u3002\u6240\u4ee5\u51b3\u5b9a\u53c2\u8003 Visual Leak Detector \uff08\u540e\u9762\u7b80\u79f0 VLD\uff09\u6765\u505a\u4e2a\u7b80\u6613\u7684\u5185\u5b58\u6cc4\u9732\u68c0\u6d4b\u5de5\u5177\uff0c\u7406\u89e3 dll \u94fe\u63a5\u3002</p>\n<h2>\u9884\u5907\u77e5\u8bc6</h2>\n<p>\u300a\u94fe\u63a5\u300b\u4e00\u4e66\u8be6\u7ec6\u89e3\u91ca\u4e86\u5728 Linux \u548c Windows \u4e0b\u53ef\u6267\u884c\u6587\u4ef6\u7684\u94fe\u63a5\u539f\u7406\uff0c\u5176\u4e2d Windows \u4e0b\u7684\u53ef\u6267\u884c\u6587\u4ef6\u683c\u5f0f\u53eb\u505a PE\uff08Portable Executable\uff09\u6587\u4ef6\u3002\u800c DLL \u6587\u4ef6\u7684\u89e3\u91ca\u662f\u8fd9\u6837\u7684\uff1a</p>\n<blockquote>\n<p>DLL \u5373\u52a8\u6001\u94fe\u63a5\u5e93\uff08Dynamic-Link Library\uff09\u7684\u7f29\u5199\uff0c\u5b83\u76f8\u5f53\u4e8e Linux \u4e0b\u7684\u5171\u4eab\u5bf9\u8c61\u3002Windows \u7cfb\u7edf\u4e2d\u5927\u91cf\u91c7\u7528\u4e86\u8fd9\u79cd DLL \u673a\u5236\uff0c\u751a\u81f3\u5305\u62ec Windows \u7684\u5185\u6838\u7684\u7ed3\u6784\u90fd\u5f88\u5927\u7a0b\u5ea6\u4f9d\u8d56\u4e8e DLL \u673a\u5236\u3002Windows \u4e0b\u7684 DLL \u6587\u4ef6\u548c EXE \u6587\u4ef6\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u6982\u5ff5\uff0c\u5b83\u4eec\u90fd\u662f\u6709 PE \u683c\u5f0f\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u7a0d\u5fae\u6709\u4e9b\u4e0d\u540c\u7684\u662f PE \u6587\u4ef6\u5934\u90e8\u4e2d\u6709\u4e2a\u7b26\u53f7\u4f4d\u8868\u793a\u8be5\u6587\u4ef6\u662f EXE \u6216\u662f DLL\uff0c\u800c DLL \u6587\u4ef6\u7684\u6269\u5c55\u540d\u4e0d\u4e00\u5b9a\u662f .dll\uff0c\u4e5f\u6709\u53ef\u80fd\u662f\u522b\u7684\u6bd4\u5982 .ocx\uff08OCX\u63a7\u4ef6\uff09\u6216\u662f .CPL\uff08\u63a7\u5236\u9762\u677f\u7a0b\u5e8f\uff09\u3002</p>\n</blockquote>\n<p>\u8fd8\u6709\u6bd4\u5982 Python \u7684\u6269\u5c55\u6587\u4ef6 .pyd\u3002\u800c DLL \u4e2d\u6709\u5173\u6211\u4eec\u8fd9\u91cc\u5185\u5b58\u6cc4\u9732\u68c0\u6d4b\u7684\u6982\u5ff5\u662f<strong>\u7b26\u53f7\u5bfc\u51fa\u5bfc\u5165\u8868</strong>\u3002</p>\n<h4>\u7b26\u53f7\u5bfc\u51fa\u8868</h4>\n<blockquote>\n<p>\u5f53\u4e00\u4e2a PE \u9700\u8981\u5c06\u4e00\u4e9b\u51fd\u6570\u6216\u53d8\u91cf\u63d0\u4f9b\u7ed9\u5176\u4ed6 PE \u6587\u4ef6\u4f7f\u7528\u65f6\uff0c\u6211\u4eec\u628a\u8fd9\u79cd\u884c\u4e3a\u53eb\u505a<strong>\u7b26\u53f7\u5bfc\u51fa\uff08Symbol Exporting\uff09</strong></p>\n</blockquote>\n<p>\u7b80\u5355\u5730\u7406\u89e3\uff0c\u5728 Windows PE \u4e2d\uff0c\u6240\u6709\u5bfc\u51fa\u7684\u7b26\u53f7\u88ab\u96c6\u4e2d\u5b58\u653e\u5728\u88ab\u79f0\u4f5c<strong>\u5bfc\u51fa\u8868\uff08Export Table\uff09</strong>\u7684\u7ed3\u6784\u4e2d\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7b26\u53f7\u540d\u4e0e\u7b26\u53f7\u5730\u5740\u7684\u6620\u5c04\u5173\u7cfb\u3002\u9700\u8981\u5bfc\u51fa\u7684\u7b26\u53f7\u9700\u8981\u52a0\u4e0a\u4fee\u9970\u7b26<code>__declspec(dllexport)</code>\u3002</p>\n<h4>\u7b26\u53f7\u5bfc\u5165\u8868</h4>\n<p>\u7b26\u53f7\u5bfc\u5165\u8868\u5c31\u662f\u6211\u4eec\u8fd9\u91cc\u7684\u5173\u952e\u6982\u5ff5\uff0c\u5b83\u8ddf\u7b26\u53f7\u5bfc\u51fa\u8868\u76f8\u5bf9\u5e94\uff0c\u5148\u6765\u770b\u6982\u5ff5\u89e3\u91ca\uff1a</p>\n<blockquote>\n<p>\u5982\u679c\u6211\u4eec\u5728\u67d0\u4e2a\u7a0b\u5e8f\u4e2d\u4f7f\u7528\u5230\u4e86\u6765\u81ea DLL \u7684\u51fd\u6570\u6216\u8005\u53d8\u91cf\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u628a\u8fd9\u79cd\u884c\u4e3a\u53eb\u505a<strong>\u7b26\u53f7\u5bfc\u5165\uff08Symbol Importing\uff09</strong>\u3002</p>\n</blockquote>\n<p>Windows PE \u4e2d\u4fdd\u5b58\u6a21\u5757\u9700\u8981\u5bfc\u5165\u7684\u53d8\u91cf\u548c\u51fd\u6570\u7684\u7b26\u53f7\u4ee5\u53ca\u6240\u5728\u7684\u6a21\u5757\u7b49\u4fe1\u606f\u7684\u7ed3\u6784\u53eb\u505a<strong>\u5bfc\u5165\u8868\uff08Import Table\uff09</strong>\u3002Windows \u52a0\u8f7d PE \u6587\u4ef6\u65f6\uff0c\u5176\u4e2d\u4e00\u4e2a\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u5c06\u6240\u6709\u9700\u8981\u5bfc\u5165\u7684\u51fd\u6570\u5730\u5740\u786e\u5b9a\u5e76\u5c06\u5bfc\u5165\u8868\u4e2d\u7684\u5143\u7d20\u8c03\u6574\u5230\u6b63\u786e\u7684\u5730\u5740\uff0c\u4f7f\u5f97\u8fd0\u884c\u65f6\u5019\uff0c\u7a0b\u5e8f\u901a\u8fc7\u67e5\u8be2\u5bfc\u5165\u8868\u6765\u5b9a\u4f4d\u5b9e\u9645\u51fd\u6570\u7684\u5730\u5740\uff0c\u5e76\u8fdb\u884c\u8c03\u7528\u3002\u5bfc\u5165\u8868\u4e2d\u6700\u91cd\u8981\u7684\u7ed3\u6784\u662f<strong>\u5bfc\u5165\u5730\u5740\u6570\u7ec4\uff08Import Address Table\uff0cIAT\uff09</strong>\uff0c\u91cc\u9762\u5b58\u653e\u7684\u5c31\u662f\u5bfc\u5165\u7684\u51fd\u6570\u5b9e\u9645\u5730\u5740\u3002</p>\n<p>\u770b\u5230\u8fd9\u91cc\u662f\u4e0d\u662f\u5df2\u7ecf\u731c\u5230\u6211\u4eec\u8981\u5b9e\u73b0\u7684\u5185\u5b58\u6cc4\u9732\u68c0\u6d4b\u662f\u600e\u4e48\u505a :)\u3002\u6ca1\u9519\u5c31\u662f hack \u5bfc\u5165\u8868\uff0c\u5177\u4f53\u5730\u8bf4\u5c31\u662f\u628a\u9700\u8981\u68c0\u6d4b\u7684\u6a21\u5757\u7684\u5bfc\u5165\u8868\u4e2d\uff0c\u5173\u4e8e\u5185\u5b58\u7533\u8bf7\u548c\u91ca\u653e\u7684\u51fd\u6570\u7684\u5730\u5740\u6539\u6210\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u51fd\u6570\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u77e5\u9053\u6a21\u5757\u6bcf\u4e00\u6b21\u7684\u5185\u5b58\u7533\u8bf7\u548c\u91ca\u653e\u60c5\u51b5\u4e86\uff0c\u53ef\u4ee5\u5c3d\u60c5\u505a\u6211\u4eec\u60f3\u505a\u7684\u68c0\u6d4b\u3002</p>\n<p>\u6709\u5173 DLL \u94fe\u63a5\u7684\u66f4\u8be6\u7ec6\u77e5\u8bc6\u53ef\u4ee5\u81ea\u884c\u67e5\u9605\u300a\u94fe\u63a5\u300b\u6216\u8005\u5176\u4ed6\u8d44\u6599\u3002</p>\n<h2>Memory Leak Detector</h2>\n<p>\u77e5\u9053\u4e86\u539f\u7406\uff0c\u4e0b\u9762\u5c31\u662f\u6839\u636e\u539f\u7406\u6765\u5b9e\u73b0\u5185\u5b58\u6cc4\u9732\u68c0\u6d4b\u3002\u4e0b\u9762\u7684\u8bb2\u89e3\u5c06\u57fa\u4e8e\u6211\u81ea\u5df1\u7684\u5b9e\u73b0\uff0c\u6211\u653e\u5728\u4e86\u6211\u7684 Github \u4e0a\uff1a<a href=\"https://github.com/disenone/LeakDetector\">LeakDetector</a>\u3002</p>\n<h4>\u66ff\u6362\u51fd\u6570</h4>\n<p>\u5148\u6765\u770b\u5173\u952e\u7684\u51fd\u6570\uff0c\u4f4d\u4e8e<a href=\"https://github.com/disenone/LeakDetector/blob/master/LeakDetector/RealDetector.cpp\">RealDetector.cpp</a>\uff1a</p>\n<p>```cpp linenums=\"1\"\n/<em> \u628a importModule \u4e2d\u7684 IAT (Import Address Table) \u7684\u67d0\u4e2a\u51fd\u6570\u66ff\u6362\u6210\u522b\u7684\u51fd\u6570\uff0c\n * importModule \u4f1a\u8c03\u7528\u5230\u522b\u7684 module \u7684\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u5c31\u662f\u9700\u8981 patch \u7684\u51fd\u6570\uff0c\n * \u6211\u4eec\u8981\u505a\u7684\u5c31\u662f\u8ba9 import module \u6539\u6210\u8c03\u7528\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u51fd\u6570\u3002\n *\n * - importModule (IN): \u8981\u5904\u7406\u7684 module\uff0c\u8fd9\u4e2a module \u8c03\u7528\u5230\u522b\u7684 module \u7684\u9700\u8981 patch \u7684\u51fd\u6570\n *\n * - exportModuleName (IN): \u9700\u8981 patch \u7684\u51fd\u6570\u6765\u81ea\u7684 module \u540d\u5b57\n *\n * - exportModulePath (IN): export module \u6240\u5728\u7684\u8def\u5f84\uff0c\u9996\u5148\u5c1d\u8bd5\u7528 path \u6765\u52a0\u8f7d export module\uff0c\n *          \u5982\u679c\u5931\u8d25\uff0c\u5219\u7528 name \u6765\u52a0\u8f7d\n * - importName (IN): \u51fd\u6570\u540d\n *\n * - replacement (IN): \u66ff\u4ee3\u7684\u51fd\u6570\u6307\u9488\n *\n * Return Valur: \u6210\u529f true\uff0c\u5426\u5219 false\n</em>/\nbool RealDetector::patchImport(\n    HMODULE importModule,\n    LPCSTR exportModuleName,\n    LPCSTR exportModulePath,\n    LPCSTR importName,\n    LPCVOID replacement)\n{\n    HMODULE                  exportmodule;\n    IMAGE_THUNK_DATA        <em>iate;\n    IMAGE_IMPORT_DESCRIPTOR </em>idte;\n    FARPROC                  import;\n    DWORD                    protect;\n    IMAGE_SECTION_HEADER    *section;\n    ULONG                    size;</p>\n<pre><code>assert(exportModuleName != NULL);\n\nidte = (IMAGE_IMPORT_DESCRIPTOR*)ImageDirectoryEntryToDataEx((PVOID)importModule, \n    TRUE, IMAGE_DIRECTORY_ENTRY_IMPORT, &amp;size, &amp;section);\nif (idte == NULL) \n{\n    logMessage(\"patchImport failed: idte == NULL\\n\");\n    return false;\n}\nwhile (idte-&gt;FirstThunk != 0x0) \n{\n    if (strcmp((PCHAR)R2VA(importModule, idte-&gt;Name), exportModuleName) == 0) \n    {\n        break;\n    }\n    idte++;\n}\nif (idte-&gt;FirstThunk == 0x0) \n{\n    logMessage(\"patchImport failed: idte-&gt;FirstThunk == 0x0\\n\");\n    return false;\n}\n\nif (exportModulePath != NULL) \n{\n    exportmodule = GetModuleHandleA(exportModulePath);\n}\nelse \n{\n    exportmodule = GetModuleHandleA(exportModuleName);\n}\nassert(exportmodule != NULL);\nimport = GetProcAddress(exportmodule, importName);\nassert(import != NULL);\n\niate = (IMAGE_THUNK_DATA*)R2VA(importModule, idte-&gt;FirstThunk);\nwhile (iate-&gt;u1.Function != 0x0) \n{\n    if (iate-&gt;u1.Function == (DWORD_PTR)import) \n    {\n        VirtualProtect(&amp;iate-&gt;u1.Function, sizeof(iate-&gt;u1.Function), \n            PAGE_READWRITE, &amp;protect);\n        iate-&gt;u1.Function = (DWORD_PTR)replacement;\n        VirtualProtect(&amp;iate-&gt;u1.Function, sizeof(iate-&gt;u1.Function), \n            protect, &amp;protect);\n        return true;\n    }\n    iate++;\n}\n\nreturn false;\n</code></pre>\n<p>}</p>\n<p>```</p>\n<p>\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u8fd9\u4e2a\u51fd\u6570\uff0c\u5c31\u50cf\u6ce8\u91ca\u6240\u8bf4\u7684\uff0c\u8fd9\u4e2a\u51fd\u6570\u5b9e\u73b0\u7684\u529f\u80fd\u5c31\u662f\u628a IAT \u91cc\u9762\u7684\u67d0\u51fd\u6570\u7684\u5730\u5740\u6539\u6210\u53e6\u4e00\u4e2a\u51fd\u6570\u7684\u5730\u5740\u3002\u5148\u6765\u770b\u7b2c 34-35 \u884c\uff1a</p>\n<p><code>cpp\nidte = (IMAGE_IMPORT_DESCRIPTOR*)ImageDirectoryEntryToDataEx((PVOID)importModule, \n    TRUE, IMAGE_DIRECTORY_ENTRY_IMPORT, &amp;size, &amp;section);</code></p>\n<p><code>ImageDirectoryEntryToDataEx</code> \u51fd\u6570\u53ef\u4ee5\u8fd4\u56de\u6a21\u5757\u7684\u6587\u4ef6\u5934\u7684\u67d0\u7ed3\u6784\u7684\u5730\u5740\uff0c<code>IMAGE_DIRECTORY_ENTRY_IMPORT</code> \u6307\u5b9a\u8981\u5bfc\u5165\u8868\u7ed3\u6784\uff0c\u6240\u4ee5\u8fd4\u56de\u7684 <code>idte</code> \u5c31\u6307\u5411\u4e86\u6a21\u5757\u5bfc\u5165\u8868\u4e86\u3002</p>\n<p>36-40 \u884c\u5c31\u662f\u68c0\u67e5 <code>idte</code> \u6709\u6548\u300241 \u884c <code>idte-&gt;FirstThunk</code> \u6307\u5411\u7684\u5c31\u662f\u5b9e\u9645\u7684 IAT \u4e86\u3002\u6240\u4ee5 41-48 \u884c\u5c31\u662f\u5728\u6839\u636e\u6a21\u5757\u540d\u5b57\u67e5\u627e\u9700\u8981\u66ff\u6362\u7684\u51fd\u6570\u7684\u6a21\u5757\uff0c\u5982\u679c\u627e\u4e0d\u5230\uff0c\u8bf4\u660e\u6ca1\u6709\u8c03\u7528\u5230\u8be5\u6a21\u5757\u7684\u51fd\u6570\uff0c\u53ea\u80fd\u63d0\u793a\u9519\u8bef\u5e76\u8fd4\u56de\u3002</p>\n<p>\u627e\u5230\u6a21\u5757\u540e\uff0c\u81ea\u7136\u5730\uff0c\u6211\u4eec\u9700\u8981\u627e\u5230\u66ff\u6362\u7684\u90a3\u4e2a\u51fd\u6570\uff0c55-62 \u884c\u6253\u5f00\u51fd\u6570\u6240\u5c5e\u7684\u6a21\u5757\uff0c64 \u884c\u627e\u5230\u51fd\u6570\u5730\u5740\u3002\u56e0\u4e3a IAT \u6ca1\u6709\u4fdd\u5b58\u540d\u5b57\uff0c\u6240\u4ee5\u9700\u8981\u5148\u6839\u636e\u539f\u6765\u7684\u51fd\u6570\u5730\u5740\uff0c\u5b9a\u4f4d\u5230\u51fd\u6570\uff0c\u518d\u4fee\u6539\u8be5\u51fd\u6570\u5730\u5740\uff0c68-80 \u884c\u5c31\u662f\u5728\u505a\u8fd9\u4e2a\u4e8b\u60c5\u3002\u6210\u529f\u627e\u5230\u51fd\u6570\u4e4b\u540e\uff0c\u5c31\u7b80\u5355\u5730\u628a\u5730\u5740\u4fee\u6539\u6210 <code>replacement</code> \u7684\u5730\u5740\u3002</p>\n<p>\u81f3\u6b64\uff0c\u6211\u4eec\u5c31\u6210\u529f\u5730\u66ff\u6362\u4e86 IAT \u4e2d\u7684\u51fd\u6570\u4e86\u3002</p>\n<h4>\u6a21\u5757\u548c\u51fd\u6570\u540d\u5b57</h4>\n<p>\u867d\u7136\u6211\u4eec\u5df2\u7ecf\u5b9e\u73b0\u4e86\u66ff\u6362 IAT \u51fd\u6570 <code>patchImport</code>\uff0c\u4f46\u8fd9\u4e2a\u51fd\u6570\u9700\u8981\u6307\u5b9a\u6a21\u5757\u540d\u5b57\u548c\u51fd\u6570\u540d\u5b57\u5440\uff0c\u90a3\u6211\u4eec\u600e\u4e48\u77e5\u9053\u7a0b\u5e8f\u7684\u5185\u5b58\u5206\u914d\u548c\u91ca\u653e\u7528\u4e86\u4ec0\u4e48\u6a21\u5757\u548c\u51fd\u6570\u5462\uff1f\u4e3a\u4e86\u641e\u6e05\u695a\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u9700\u8981\u501f\u52a9 Windows \u4e0b\u7684\u5de5\u5177 <a href=\"http://www.dependencywalker.com/\">Dependency Walker</a>\u3002Visual Studio \u4e0b\u65b0\u5efa\u4e00\u4e2a\u5de5\u7a0b\uff0c\u5728 <code>main</code> \u51fd\u6570\u91cc\u9762\u4f7f\u7528 <code>new</code> \u6765\u7533\u8bf7\u5185\u5b58\uff0c\u7f16\u8bd1 Debug \u7248\uff0c\u4e4b\u540e\u4f7f\u7528 <code>depends.exe</code> \u6765\u6253\u5f00\u7f16\u8bd1\u51fa\u6765\u7684 exe \u6587\u4ef6\uff0c\u53ef\u4ee5\u770b\u5230\u4e00\u4e0b\u7c7b\u4f3c\u7684\u754c\u9762\uff08\u4ee5\u6211\u7684\u5de5\u7a0b <a href=\"https://github.com/disenone/LeakDetector/tree/master/LeakDetectorTest\">LeakDetectorTest</a> \u4e3a\u4f8b\uff09\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2016-6-11-memory-leak-detector/depends.png\"></p>\n<p>\u53ef\u4ee5\u770b\u5230 LeakDetectorTest.exe \u4f7f\u7528\u4e86 uscrtbased.dll \u91cc\u9762\u7684 <code>malloc</code> \u548c <code>_free_dbg</code> \uff08\u6ca1\u6709\u5728\u56fe\u4e2d\u663e\u793a\u51fa\u6765\uff09\uff0c\u8fd9\u4e24\u4e2a\u51fd\u6570\u5c31\u662f\u6211\u4eec\u9700\u8981\u66ff\u6362\u7684\u51fd\u6570\u4e86\u3002\u8981\u6ce8\u610f\u5b9e\u9645\u7684\u6a21\u5757\u51fd\u6570\u540d\u5b57\u53ef\u80fd\u8ddf\u4f60\u7684 Windows \u548c Visual Studio \u7248\u672c\u6709\u5173\uff0c\u6211\u7684\u662f Windows 10 \u548c Visual Studio 2015\uff0c\u4f60\u9700\u8981\u505a\u7684\u5c31\u662f\u7528 depends.exe \u770b\u770b\u5b9e\u9645\u8c03\u7528\u7684\u662f\u4ec0\u4e48\u51fd\u6570\u3002</p>\n<h4>\u5206\u6790\u8c03\u7528\u6808</h4>\n<p>\u8bb0\u5f55\u5185\u5b58\u5206\u914d\u9700\u8981\u8bb0\u5f55\u5f53\u65f6\u7684\u8c03\u7528\u6808\u4fe1\u606f\uff0c\u8fd9\u91cc\u6211\u4e0d\u6253\u7b97\u8be6\u7ec6\u4ecb\u7ecd Windows \u4e0b\u5982\u4f55\u62ff\u5230\u5f53\u524d\u7684\u8c03\u7528\u6808\u4fe1\u606f\uff0c\u76f8\u5173\u7684\u51fd\u6570\u662f <code>RtlCaptureStackBackTrace</code>\uff0c\u7f51\u4e0a\u6709\u8bb8\u591a\u76f8\u5173\u7684\u8d44\u6599\uff0c\u4e5f\u53ef\u4ee5\u770b\u770b\u6211\u7684\u4ee3\u7801\u91cc\u9762\u7684\u51fd\u6570 <a href=\"https://github.com/disenone/LeakDetector/blob/master/LeakDetector/RealDetector.cpp\"><code>printTrace</code></a> \u3002</p>\n<h4>\u68c0\u6d4b\u5185\u5b58\u6cc4\u9732</h4>\n<p>\u81f3\u6b64\uff0c\u6211\u4eec\u5df2\u7ecf\u628a\u9f99\u73e0\u90fd\u6536\u96c6\u5168\u4e86\uff0c\u4e0b\u9762\u6b63\u5f0f\u53ec\u5524\u795e\u9f99\u3002</p>\n<p>\u6211\u60f3\u505a\u6210\u53ef\u4ee5\u5c40\u90e8\u68c0\u6d4b\u5185\u5b58\u6cc4\u9732\uff08\u8fd9\u662f\u8ddf VLD \u4e0d\u540c\u7684\u5730\u65b9\uff0cVLD \u505a\u7684\u662f\u5168\u5c40\u7684\u68c0\u6d4b\uff0c\u5e76\u652f\u6301\u591a\u7ebf\u7a0b\uff09\u3002\u6240\u4ee5\u6211\u5728\u5b9e\u9645\u66ff\u6362\u51fd\u6570\u7684\u7c7b<code>RealDetector</code>\u4e0a\u53c8\u5c01\u88c5\u4e86\u4e00\u5c42<code>LeakDetector</code>\uff0c\u5e76\u628a<code>LeakDetector</code>\u7684\u63a5\u53e3\u66b4\u9732\u7ed9\u4f7f\u7528\u8005\u3002\u4f7f\u7528\u65f6\u53ea\u9700\u6784\u9020<code>LeakDetector</code>\uff0c\u5373\u5b8c\u6210\u51fd\u6570\u7684\u66ff\u6362\u5e76\u5f00\u59cb\u68c0\u6d4b\u5185\u5b58\u6cc4\u9732\uff0c<code>LeakDetector</code>\u6790\u6784\u65f6\u4f1a\u6062\u590d\u539f\u6765\u7684\u51fd\u6570\uff0c\u4e2d\u6b62\u5185\u5b58\u6cc4\u9732\u68c0\u6d4b\uff0c\u5e76\u6253\u5370\u5185\u5b58\u6cc4\u9732\u68c0\u6d4b\u7ed3\u679c\u3002</p>\n<p>\u7528\u4e0b\u9762\u4ee3\u7801\u6d4b\u8bd5\u4e00\u4e0b\uff1a</p>\n<p>```cpp</p>\n<h1>include \"LeakDetector.h\"</h1>\n<h1>include <iostream></h1>\n<p>using namespace std;</p>\n<p>void new_some_mem()\n{\n    char<em> c = new char[12];\n    int</em> i = new int[4];\n}</p>\n<p>int main()\n{\n    auto ld = LDTools::LeakDetector(\"LeakDetectorTest.exe\");\n    new_some_mem();\n    return 0;\n}</p>\n<p>```</p>\n<p>\u4ee3\u7801\u76f4\u63a5 <code>new</code> \u4e86\u4e00\u4e9b\u5185\u5b58\u51fa\u6765\uff0c\u6ca1\u6709\u91ca\u653e\u6389\u5c31\u76f4\u63a5\u9000\u51fa\uff0c\u7a0b\u5e8f\u6253\u5370\u7684\u7ed3\u679c\uff1a</p>\n<p>```\n============== LeakDetector::start ===============\nLeakDetector init success.\n============== LeakDetector::stop ================\nMemory Leak Detected: total 2</p>\n<p>Num 1:\n    e:\\program\\github\\leakdetector\\leakdetector\\realdetector.cpp (109): LeakDetector.dll!LDTools::RealDetector::_malloc() + 0x1c bytes\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\heap\\new_scalar.cpp (19): LeakDetectorTest.exe!operator new() + 0x9 bytes\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\heap\\new_array.cpp (15): LeakDetectorTest.exe!operator new<a href=\"\"></a> + 0x9 bytes\n    e:\\program\\github\\leakdetector\\leakdetectortest\\leakdetectortest.cpp (12): LeakDetectorTest.exe!new_some_mem() + 0x7 bytes\n    e:\\program\\github\\leakdetector\\leakdetectortest\\leakdetectortest.cpp (19): LeakDetectorTest.exe!main()\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl (74): LeakDetectorTest.exe!invoke_main() + 0x1b bytes\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl (264): LeakDetectorTest.exe!__scrt_common_main_seh() + 0x5 bytes\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl (309): LeakDetectorTest.exe!__scrt_common_main()\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\startup\\exe_main.cpp (17): LeakDetectorTest.exe!mainCRTStartup()\n    KERNEL32.DLL!BaseThreadInitThunk() + 0x24 bytes\n    ntdll.dll!RtlUnicodeStringToInteger() + 0x253 bytes\n    ntdll.dll!RtlUnicodeStringToInteger() + 0x21e bytes</p>\n<p>Num 2:\n    e:\\program\\github\\leakdetector\\leakdetector\\realdetector.cpp (109): LeakDetector.dll!LDTools::RealDetector::_malloc() + 0x1c bytes\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\heap\\new_scalar.cpp (19): LeakDetectorTest.exe!operator new() + 0x9 bytes\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\heap\\new_array.cpp (15): LeakDetectorTest.exe!operator new<a href=\"\"></a> + 0x9 bytes\n    e:\\program\\github\\leakdetector\\leakdetectortest\\leakdetectortest.cpp (11): LeakDetectorTest.exe!new_some_mem() + 0x7 bytes\n    e:\\program\\github\\leakdetector\\leakdetectortest\\leakdetectortest.cpp (19): LeakDetectorTest.exe!main()\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl (74): LeakDetectorTest.exe!invoke_main() + 0x1b bytes\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl (264): LeakDetectorTest.exe!__scrt_common_main_seh() + 0x5 bytes\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl (309): LeakDetectorTest.exe!__scrt_common_main()\n    f:\\dd\\vctools\\crt\\vcstartup\\src\\startup\\exe_main.cpp (17): LeakDetectorTest.exe!mainCRTStartup()\n    KERNEL32.DLL!BaseThreadInitThunk() + 0x24 bytes\n    ntdll.dll!RtlUnicodeStringToInteger() + 0x253 bytes\n    ntdll.dll!RtlUnicodeStringToInteger() + 0x21e bytes\n```</p>\n<p>\u7a0b\u5e8f\u6b63\u786e\u5730\u627e\u51fa\u6709\u4e24\u4e2a\u5730\u65b9\u7533\u8bf7\u7684\u5185\u5b58\u6ca1\u6709\u91ca\u653e\uff0c\u5e76\u4e14\u6253\u5370\u51fa\u4e86\u5b8c\u6574\u7684\u8c03\u7528\u6808\u4fe1\u606f\uff0c\u6211\u4eec\u9700\u8981\u7684\u529f\u80fd\u81f3\u6b64\u5df2\u7ecf\u5b8c\u6210\u4e86\u3002</p>\n<h3>\u7ed3\u8bed</h3>\n<p>\u5f53\u4f60\u8fd8\u4e0d\u4e86\u89e3\u7a0b\u5e8f\u94fe\u63a5\u3001\u88c5\u8f7d\u4e0e\u5e93\u7684\u65f6\u5019\uff0c\u4f60\u53ef\u80fd\u4f1a\u5bf9\u5982\u4f55\u627e\u5230\u5171\u4eab\u94fe\u63a5\u5e93\u7684\u51fd\u6570\u4e00\u5934\u96fe\u6c34\uff0c\u66f4\u4e0d\u8981\u8bf4\u8981\u628a\u94fe\u63a5\u5e93\u7684\u51fd\u6570\u66ff\u6362\u6210\u6211\u4eec\u81ea\u5df1\u7684\u51fd\u6570\u4e86\u3002\u8fd9\u91cc\u5c31\u4ee5\u68c0\u6d4b\u5185\u5b58\u6cc4\u9732\u4e3a\u4f8b\u5b50\uff0c\u63a2\u8ba8\u4e0b\u4e86\u5982\u4f55\u66ff\u6362 Windows DLL \u7684\u51fd\u6570\uff0c\u66f4\u8be6\u7ec6\u7684\u5b9e\u73b0\u53ef\u4ee5\u53c2\u8003 VLD \u7684\u6e90\u7801\u3002</p>\n<p>\u53e6\u5916\u60f3\u8bf4\u7684\u662f\uff0c\u300a\u7a0b\u5e8f\u5458\u7684\u81ea\u6211\u4fee\u517b\uff1a\u94fe\u63a5\u3001\u88c5\u8f7d\u4e0e\u5e93\u300b\u771f\u662f\u672c\u4e0d\u9519\u7684\u4e66\u5462\uff0c\u7eaf\u611f\u6168\u975e\u8f6f\u5e7f\u3002</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/py-Python%E6%9D%82%E8%B0%881-%E6%8E%A2%E7%A9%B6__builtins__/",
            "url": "https://wiki.disenone.site/py-Python%E6%9D%82%E8%B0%881-%E6%8E%A2%E7%A9%B6__builtins__/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Python \u6742\u8c08 1 - \u63a2\u7a76 __builtins__",
            "content_html": "<p><meta property=\"og:title\" content=\"Python \u6742\u8c08 1 - \u63a2\u7a76 __builtins__ - Disenone\" /></p>\n<h2>\u5f15\u5b50</h2>\n<p>\u6211\u4eec\u77e5\u9053\uff0c<code>__builtins__</code> \u672c\u8eab\u662f\u5728\u5168\u5c40\u547d\u540d\u7a7a\u95f4\u4e2d\u5c31\u6709\u7684\u4e00\u4e2a\u5bf9\u8c61\uff0c\u662f <code>Python</code> \u6545\u610f\u66b4\u9732\u51fa\u6765\u7ed9\u4ee3\u7801\u5c42\u7684\uff0c\u5728\u4ee3\u7801\u7684\u4efb\u610f\u5730\u65b9\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002\u4f46\u662f\u6709\u70b9\u51b7\u7684\u77e5\u8bc6\u662f\uff0c<code>__builtins__</code> \u5728 <code>main</code> \u6a21\u5757\uff08\u4e5f\u5c31\u662f <code>__main__</code>\uff0c\u6307\u7684\u90fd\u662f\u540c\u4e00\u4e2a\u6a21\u5757\uff0c\u540e\u6587\u53ef\u80fd\u4f1a\u6df7\u7528\uff09\u91cc\u9762\u662f <code>__builtin__</code> \u8fd9\u4e2a\u6a21\u5757\uff0c\u4f46\u5728\u5176\u4ed6\u6a21\u5757\u91cc\u9762\uff0c\u5b83\u8868\u793a\u7684\u662f <code>__builtin__.__dict__</code>\uff0c\u8fd9\u5c31\u6709\u70b9\u8ba9\u4eba\u83ab\u540d\u5176\u5999\u4e86\u3002\u867d\u7136\u5b98\u65b9\u4e0d\u63a8\u8350\u76f4\u63a5\u4f7f\u7528 <code>__builtins__</code>\uff0c\u4f46\u4f60\u7ed9\u6211\u641e\u4e24\u79cd\u60c5\u51b5\u662f\u600e\u4e48\u56de\u4e8b\uff1f\u672c\u6587\u6211\u4eec\u5c31\u6765\u76d8\u4e00\u76d8\u8fd9\u4e2a\u8bbe\u5b9a\u7684\u7531\u6765\uff0c\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u627e\u5230\u8fd9\u4e9b\u95ee\u9898\u7684\u7b54\u6848\uff1a<code>__builtin__</code> \u8ddf <code>__builtins__</code> \u6709\u4ec0\u4e48\u533a\u522b\uff1f<code>__builtins__</code> \u5728 <code>main</code> \u6a21\u5757\u8ddf\u5176\u4ed6\u6a21\u5757\u4e3a\u4ec0\u4e48\u4f1a\u8bbe\u5b9a\u6210\u4e0d\u540c\uff1f<code>__builtins__</code> \u662f\u5728\u54ea\u91cc\u5b9a\u4e49\u7684\uff1f</p>\n<h2><code>__builtin__</code></h2>\n<p>\u5728\u63a2\u8ba8 <code>__builtins__</code> \u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u770b\u770b <code>__builtin__</code> \u662f\u4ec0\u4e48\u3002<code>__builtin__</code> \u662f\u5b58\u653e\u6240\u6709\u5185\u5efa\u5bf9\u8c61\u7684\u6a21\u5757\uff0c\u6211\u4eec\u5e73\u5e38\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u7684 <code>Python</code> \u5185\u5efa\u5bf9\u8c61\uff0c\u672c\u8d28\u4e0a\u90fd\u662f <code>__builtin__</code> \u6a21\u5757\u91cc\u7684\u5bf9\u8c61\uff0c\u5373\u653e\u5728 <code>__builtin__.__dict__</code> \u91cc\uff0c\u5bf9\u5e94\u7740\u7684\u662f <code>Python</code> \u7684\u5185\u5efa\u540d\u5b57\u7a7a\u95f4\u3002\u8bb0\u4f4f\u8fd9\u4e2a\u5173\u952e\u77e5\u8bc6\u70b9\uff1a<code>__buintin__</code> \u662f\u4e00\u4e2a\u6a21\u5757 <code>module</code>\u3002\u6211\u4eec\u53ef\u4ee5\u5728 <code>Python</code> \u6e90\u7801\u4e2d\u627e\u5230 <code>__builtin__</code> \u6a21\u5757\u7684\u5b9a\u4e49\u548c\u4f7f\u7528\uff08\u6ce8\u610f\uff0c\u4e0b\u6587\u63d0\u5230\u7684 <code>Python</code> \u6e90\u7801\uff0c\u90fd\u662f\u6307 CPython-2.7.18 \u6e90\u7801\uff09\uff1a</p>\n<p>``` c\n// pythonrun.c\nvoid\nPy_InitializeEx(int install_sigs)\n{\n    PyInterpreterState *interp;\n    ...\n    // \u521d\u59cb\u5316 <strong>builtin</strong>\n    bimod = _PyBuiltin_Init();\n    // interp-&gt;builtins = <strong>builtin</strong>.<strong>dict</strong>\n    interp-&gt;builtins = PyModule_GetDict(bimod);\n    ...\n}</p>\n<p>// bltinmodule.c\nPyObject *\n_PyBuiltin_Init(void)\n{\n    PyObject <em>mod, </em>dict, <em>debug;\n    mod = Py_InitModule4(\"<strong>builtin</strong>\", builtin_methods,\n                         builtin_doc, (PyObject </em>)NULL,\n                         PYTHON_API_VERSION);\n    if (mod == NULL)\n        return NULL;\n    dict = PyModule_GetDict(mod);</p>\n<pre><code>// \u7ed9 dict \u52a0\u4e0a\u5185\u5efa\u7684\u5bf9\u8c61\n...\n</code></pre>\n<p>}</p>\n<p>// ceval.c\n// \u83b7\u53d6 builtins\nPyObject *\nPyEval_GetBuiltins(void)\n{\n    PyFrameObject *current_frame = PyEval_GetFrame();\n    if (current_frame == NULL)\n        return PyThreadState_GET()-&gt;interp-&gt;builtins;\n    else\n        return current_frame-&gt;f_builtins;\n}\n```</p>\n<p><code>Python</code> \u521d\u59cb\u5316\u7684\u65f6\u5019\u4f1a\u8c03\u7528 <code>_PyBuiltin_Init</code> \u6765\u521b\u5efa <code>__builtin__</code> \u6a21\u5757\uff0c\u5e76\u5728\u91cc\u9762\u6dfb\u52a0\u4e0a\u5185\u5efa\u7684\u5bf9\u8c61\uff0c\u89e3\u91ca\u5668\u672c\u8eab\u4f1a\u5f15\u7528\u4f4f <code>interp-&gt;builtins = __buintin__.__dict__</code>\uff0c\u5f53\u524d\u6267\u884c\u7684\u6808\u5e27\u7ed3\u6784\u540c\u65f6\u4e5f\u4f1a\u5f15\u7528\u4e00\u4efd <code>current_frame-&gt;f_builtins</code>\u3002\u90a3\u4e48\u5f88\u81ea\u7136\u5730\uff0c\u5f53\u6267\u884c\u4ee3\u7801\u9700\u8981\u6839\u636e\u540d\u5b57\u5bfb\u627e\u5bf9\u8c61\u7684\u65f6\u5019\uff0c<code>Python</code> \u4f1a\u53bb <code>current_frame-&gt;f_builtins</code> \u91cc\u9762\u6765\u627e\uff0c\u81ea\u7136\u5c31\u80fd\u62ff\u5230\u6240\u6709\u7684\u5185\u5efa\u5bf9\u8c61\uff1a</p>\n<p><code>c\n// ceval.c\nTARGET(LOAD_NAME)\n{\n    // \u5148\u5728 f-&gt;f_locals \u540d\u5b57\u7a7a\u95f4\u91cc\u9762\u627e\n    ...\n    if (x == NULL) {\n        // \u518d\u627e\u627e\u5168\u5c40\u7a7a\u95f4\n        x = PyDict_GetItem(f-&gt;f_globals, w);\n        if (x == NULL) {\n            // \u8fd9\u91cc\u5c31\u53bb\u5185\u5efa\u7a7a\u95f4\u627e\n            x = PyDict_GetItem(f-&gt;f_builtins, w);\n            if (x == NULL) {\n                format_exc_check_arg(\n                            PyExc_NameError,\n                            NAME_ERROR_MSG, w);\n                break;\n            }\n        }\n        Py_INCREF(x);\n    }\n    PUSH(x);\n    DISPATCH();\n}</code></p>\n<p>\u6700\u540e\uff0c\u7531\u4e8e <code>__builtin__</code> \u8fd9\u4e2a\u540d\u5b57\u5b9e\u5728\u662f\u592a\u6709\u8ff7\u60d1\u6027\u4e86\uff0c<code>Python3</code> \u4e2d\u5df2\u7ecf\u6539\u540d\u4e3a <code>builtins</code>\u3002</p>\n<h2><code>__builtins__</code></h2>\n<p><code>__builtins__</code> \u7684\u8868\u73b0\u662f\u6709\u70b9\u5947\u602a\u7684\uff1a\n* \u5728 <code>main</code> \u6a21\u5757\u4e2d\uff08<code>main</code> \u6a21\u5757\uff0c\u6216\u8005\u53eb<code>\u6700\u9ad8\u5c42\u7ea7\u4ee3\u7801\u8fd0\u884c\u6240\u5728\u73af\u5883</code>\uff0c\u662f\u7528\u6237\u6307\u5b9a\u6700\u5148\u542f\u52a8\u8fd0\u884c\u7684 <code>Python</code> \u6a21\u5757\uff0c\u4e5f\u5c31\u662f\u901a\u5e38\u6211\u4eec\u5728\u547d\u4ee4\u884c\u6267\u884c <code>python xxx.py</code> \u65f6\uff0c<code>xxx.py</code> \u8fd9\u4e2a\u6a21\u5757\uff09\uff0c<code>__builtins__ = __builtin__</code>\uff1b\n* \u5728\u5176\u4ed6\u6a21\u5757\u4e2d <code>__builtins__ = __builtin__.__dict__</code>\u3002</p>\n<p>\u76f8\u540c\u7684\u540d\u5b57\uff0c\u4f46\u5728\u4e0d\u540c\u7684\u6a21\u5757\u4e0b\u8868\u73b0\u5374\u662f\u4e0d\u76f8\u540c\u7684\uff0c\u8fd9\u6837\u7684\u8bbe\u5b9a\u5f88\u5bb9\u6613\u8ba9\u4eba\u7591\u60d1\u3002\u4e0d\u8fc7\u53ea\u8981\u77e5\u9053\u8fd9\u4e2a\u8bbe\u5b9a\uff0c\u5c31\u8db3\u591f\u652f\u6301\u4f60\u5728 <code>Python</code> \u4e2d\u4f7f\u7528 <code>__builtins__</code>\uff0c\u7591\u60d1\u5e76\u4e0d\u4f1a\u5f71\u54cd\u4f60\u5199\u51fa\u8db3\u591f\u5b89\u5168\u7684\u4ee3\u7801\uff0c\u8bf8\u5982\uff1a</p>\n<p>``` python\ndef SetBuiltins(builtins, key, val):\n    if isinstance(builtins, dict):\n        builtins[key] = val\n    else:\n        setattr(builtins, key, val)</p>\n<p>SetBuiltins(<strong>builtins</strong>, 'test', 1)\n```</p>\n<p>\u9700\u8981\u6ce8\u610f\uff0c\u5176\u5b9e\u5e76\u4e0d\u5efa\u8bae\u4f7f\u7528 <code>__builtins__</code>\uff1a</p>\n<blockquote>\n<p><strong>CPython implementation detail</strong>: Users should not touch <code>__builtins__</code>; it is strictly an implementation detail. Users wanting to override values in the builtins namespace should import the <code>__builtin__</code> (no \u2018s\u2019) module and modify its attributes appropriately.</p>\n</blockquote>\n<p>\u5f53\u7136\uff0c\u8fd9\u6837\u7684\u7591\u60d1\uff0c\u603b\u6709\u4e00\u5929\u4f1a\u8ba9\u4f60\u5fc3\u75d2\u96be\u8010\uff0c\u6211\u8fd9\u91cc\u5c31\u51b3\u5b9a\u7ee7\u7eed\u63a2\u7a76\u4e0b\u53bb\uff0c\u4e5f\u56e0\u4e3a\u8fd9\u6837\uff0c\u624d\u6709\u4e86\u8fd9\u7bc7\u6587\u7ae0\u3002\u6211\u4eec\u4e0b\u9762\u7684\u5185\u5bb9\u4f1a\u6df1\u5165\u5230 <strong>CPython implementation detail</strong> \u4e2d\u53bb\u3002</p>\n<h2>Restricted Execution</h2>\n<p>Restricted Execution \u53ef\u4ee5\u7406\u89e3\u4e3a\u6709\u9650\u5236\u5730\u6267\u884c\u4e0d\u5b89\u5168\u7684\u4ee3\u7801\uff0c\u6240\u8c13\u6709\u9650\u5236\uff0c\u53ef\u4ee5\u662f\u9650\u5236\u7f51\u7edc\u3001io \u7b49\u7b49\uff0c\u628a\u4ee3\u7801\u9650\u5236\u5728\u4e00\u5b9a\u7684\u6267\u884c\u73af\u5883\u4e2d\uff0c\u63a7\u5236\u4ee3\u7801\u7684\u6267\u884c\u6743\u9650\uff0c\u9632\u6b62\u4ee3\u7801\u5f71\u54cd\u5230\u5916\u90e8\u7684\u73af\u5883\u548c\u7cfb\u7edf\u3002\u5e38\u89c1\u7684\u7528\u4f8b\u5c31\u662f\u4e00\u4e9b\u5728\u7ebf\u4ee3\u7801\u6267\u884c\u7f51\u7ad9\uff0c\u8b6c\u5982\u8fd9\u4e2a\uff1a<a href=\"https://pythonsandbox.dev/\">pythonsandbox</a>\u3002</p>\n<p>\u8ddf\u4f60\u731c\u60f3\u7684\u4e00\u6837\uff0c<code>Python</code> \u5bf9 <code>__builtins__</code> \u7684\u8bbe\u5b9a\u662f\u8ddf Restricted Execution \u6709\u5173\u3002<code>Python</code> \u5728 2.3 \u7248\u672c\u4e4b\u524d\uff0c\u66fe\u7ecf\u63d0\u4f9b\u8fc7\u7c7b\u4f3c\u7684\u529f\u80fd <a href=\"https://docs.python.org/2.7/library/restricted.html\">Restricted Execution</a>\uff0c\u53ea\u662f\u7531\u4e8e\u540e\u6765\u88ab\u8bc1\u5b9e\u4e3a\u4e0d\u53ef\u884c\u7684\uff0c\u53ea\u597d\u628a\u8fd9\u4e2a\u529f\u80fd\u4f5c\u5e9f\u4e86\uff0c\u4f46\u4ee3\u7801\u5728 2.7.18 \u7248\u672c\u8fd8\u4fdd\u7559\u7740\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u6765\u8003\u53e4\u3002</p>\n<p>\u9996\u5148\u6765\u770b <code>Python</code> \u6e90\u7801\u91cc\u9762\u5bf9 <code>__builtins__</code> \u7684\u8bbe\u7f6e\uff1a</p>\n<p>``` c\n// pythonrun.c\nstatic void initmain(void)\n{\n    PyObject <em>m, </em>d;\n    // \u83b7\u53d6 <strong>main</strong> \u6a21\u5757\n    m = PyImport_AddModule(\"<strong>main</strong>\");\n    if (m == NULL)\n        Py_FatalError(\"can't create <strong>main</strong> module\");</p>\n<pre><code>// d = __main__.__dict__\nd = PyModule_GetDict(m);\n\n// \u8bbe\u7f6e __main__.__dict__['__builtins__']\uff0c\u5982\u679c\u5df2\u6709\uff0c\u5219\u8df3\u8fc7\nif (PyDict_GetItemString(d, \"__builtins__\") == NULL) {\n    PyObject *bimod = PyImport_ImportModule(\"__builtin__\");\n    if (bimod == NULL ||\n        PyDict_SetItemString(d, \"__builtins__\", bimod) != 0)\n        Py_FatalError(\"can't add __builtins__ to __main__\");\n    Py_XDECREF(bimod);\n}\n</code></pre>\n<p>}\n```</p>\n<p>\u5728 <code>initmain</code> \u4e2d\uff0c<code>Python</code> \u4f1a\u7ed9 <code>__main__</code> \u6a21\u5757\u8bbe\u7f6e <code>__builtins__</code> \u5c5e\u6027\uff0c\u9ed8\u8ba4\u7b49\u4e8e <code>__builtin__</code> \u6a21\u5757\uff0c\u4f46\u5982\u679c\u5df2\u6709\uff0c\u5219\u8df3\u8fc7\u4e0d\u4f1a\u91cd\u65b0\u8bbe\u7f6e\u3002\u5229\u7528\u8fd9\u4e2a\u7279\u70b9\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 <code>__main__.__builtins__</code> \u6765\u4fee\u6539\u5185\u5efa\u7684\u4e00\u4e9b\u529f\u80fd\uff0c\u4ee5\u8fbe\u5230\u9650\u5236\u4ee3\u7801\u6267\u884c\u6743\u9650\u7684\u76ee\u7684\uff0c\u5177\u4f53\u7684\u65b9\u6cd5\u5148\u6309\u4e0b\u4e0d\u8868\uff0c\u6211\u4eec\u770b\u770b <code>__builtins__</code> \u662f\u600e\u4e48\u88ab\u4f20\u9012\u7684\u3002</p>\n<h2><code>__builtins__</code> \u7684\u4f20\u9012</h2>\n<p>\u5728\u521b\u5efa\u65b0\u7684\u6808\u5e27\u7684\u65f6\u5019\uff1a</p>\n<p>```c\nPyFrameObject *\nPyFrame_New(PyThreadState <em>tstate, PyCodeObject </em>code, PyObject <em>globals,\n            PyObject </em>locals)\n{\n    ...\n    if (back == NULL || back-&gt;f_globals != globals) {\n        // \u53d6 globals['<strong>builtins</strong>'] \u4f5c\u4e3a\u65b0\u6808\u5e27\u7684 <strong>builtins</strong>\n        // builtin_object \u5c31\u662f\u5b57\u7b26\u4e32 '<strong>builtins</strong>'\n        builtins = PyDict_GetItem(globals, builtin_object);\n        if (builtins) {\n            if (PyModule_Check(builtins)) {\n                builtins = PyModule_GetDict(builtins);\n                assert(!builtins || PyDict_Check(builtins));\n            }\n            else if (!PyDict_Check(builtins))\n                builtins = NULL;\n        }\n        ...</p>\n<pre><code>}\nelse {\n    /* If we share the globals, we share the builtins.\n       Save a lookup and a call. */\n    // \u6216\u8005\u76f4\u63a5\u7ee7\u627f\u4e0a\u4e00\u5c42\u6808\u5e27\u7684 f_builtins\n    builtins = back-&gt;f_builtins;\n    assert(builtins != NULL &amp;&amp; PyDict_Check(builtins));\n    Py_INCREF(builtins);\n}\n...\nf-&gt;f_builtins = builtins;\nf-&gt;f_globals = globals;\n</code></pre>\n<p>}\n```</p>\n<p>\u521b\u5efa\u65b0\u7684\u6808\u5e27\u65f6\uff0c\u5bf9\u4e8e <code>__builtins__</code> \u7684\u5904\u7406\u4e3b\u8981\u6709\u4e24\u79cd\u60c5\u51b5\uff1a\u4e00\u79cd\u662f\u6ca1\u6709\u4e0a\u5c42\u6808\u5e27\u7684\u60c5\u51b5\u4e0b\uff0c\u53d6 <code>globals['__builtins__']</code>\uff1b\u53e6\u4e00\u79cd\u662f\u76f4\u63a5\u53d6\u4e0a\u5c42\u6808\u5e27\u7684 <code>f_builtins</code>\u3002\u8054\u5408\u8d77\u6765\u770b\u7684\u8bdd\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u5728 <code>__main__</code> \u4e2d\u8bbe\u7f6e\u597d\u7684 <code>__builtins__</code>\uff0c\u4f1a\u4e00\u76f4\u7ee7\u627f\u7ed9\u540e\u9762\u7684\u6808\u5e27\uff0c\u76f8\u5f53\u4e8e\u5171\u7528\u540c\u4e00\u4efd\u3002</p>\n<p><code>import</code> \u6a21\u5757\u65f6\uff1a</p>\n<p>```c\nstatic PyObject *\nload_compiled_module(char <em>name, char </em>cpathname, FILE <em>fp)\n{\n    long magic;\n    PyCodeObject </em>co;\n    PyObject <em>m;\n    ...\n    co = read_compiled_module(cpathname, fp);\n    ...\n    m = PyImport_ExecCodeModuleEx(name, (PyObject </em>)co, cpathname);\n    ...\n}</p>\n<p>PyObject *\nPyImport_ExecCodeModuleEx(char <em>name, PyObject </em>co, char *pathname)\n{\n    ...\n    m = PyImport_AddModule(name);\n    ...\n    // d = m.<strong>dict</strong>\n    d = PyModule_GetDict(m);</p>\n<pre><code>// \u5728\u8fd9\u91cc\u8bbe\u7f6e\u65b0\u52a0\u8f7d\u6a21\u5757\u7684 __builtins__ \u5c5e\u6027\nif (PyDict_GetItemString(d, \"__builtins__\") == NULL) {\n    if (PyDict_SetItemString(d, \"__builtins__\",\n                             PyEval_GetBuiltins()) != 0)\n        goto error;\n}\n...\n// globals = d, locals = d\nv = PyEval_EvalCode((PyCodeObject *)co, d, d);\n...\n</code></pre>\n<p>}</p>\n<p>PyObject *\nPyEval_EvalCode(PyCodeObject <em>co, PyObject </em>globals, PyObject <em>locals)\n{\n    return PyEval_EvalCodeEx(co,\n                      globals, locals,\n                      (PyObject </em><em>)NULL, 0,\n                      (PyObject </em><em>)NULL, 0,\n                      (PyObject </em>*)NULL, 0,\n                      NULL);\n}\n```</p>\n<p><code>import</code> \u5176\u4ed6\u6a21\u5757\u7684\u65f6\u5019\uff0c\u4f1a\u628a\u8be5\u6a21\u5757\u7684 <code>__builtins__</code> \u8bbe\u7f6e\u4e3a <code>PyEval_GetBuiltins()</code> \u7684\u8fd4\u56de\u7ed3\u679c\uff0c\u8fd9\u4e2a\u51fd\u6570\u6211\u4eec\u5df2\u7ecf\u8bf4\u8fc7\uff0c\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\u76f8\u5f53\u4e8e <code>current_frame-&gt;f_builtins</code>\u3002\u5bf9\u4e8e <code>__main__</code> \u6a21\u5757\u7684\u91cc\u9762\u7684 <code>import</code>\uff0c<code>current_frame</code> \u5c31\u662f <code>__main__</code> \u6a21\u5757\u7684\u6808\u5e27\uff0c<code>current_frame-&gt;f_builtins = __main__.__dict__['__builtins__']</code>\uff08\u4e0a\u6587 <code>PyFrame_New</code> \u7684\u7b2c\u4e00\u79cd\u60c5\u51b5\uff09\u3002</p>\n<p>\u52a0\u8f7d\u7684\u65b0\u6a21\u5757\uff0c\u4f1a\u4f7f\u7528 <code>PyEval_EvalCode</code> \u6765\u6267\u884c\u65b0\u6a21\u5757\u4e2d\u7684\u4ee3\u7801\uff0c\u53ef\u4ee5\u770b\u5230\uff0c\u4f20\u7ed9 <code>PyEval_EvalCode</code> \u7684\u53c2\u6570 <code>globals</code>\u3001<code>locals</code> \u5176\u5b9e\u90fd\u662f\u6a21\u5757\u81ea\u8eab\u7684 <code>__dict__</code>\uff0c\u5e76\u4e14\u6a21\u5757 <code>m.__dict__['__builtins__'] = PyEval_GetBuiltins()</code> \u3002</p>\n<p>\u7efc\u5408\u6765\u770b\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u77e5\uff0c\u4ece <code>__main__</code> \u6a21\u5757\u5f00\u59cb <code>import</code> \u7684\u6a21\u5757\uff0c\u4e5f\u4f1a\u7ee7\u627f <code>__main__</code> \u4e2d\u7684 <code>__builtins__</code>\uff0c\u5e76\u4f1a\u5728\u5185\u90e8\u7684 <code>import</code> \u4e2d\u4f20\u9012\u4e0b\u53bb\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u786e\u4fdd\uff0c\u6240\u6709\u4ece <code>__main__</code> \u52a0\u8f7d\u7684\u6a21\u5757\u548c\u5b50\u6a21\u5757\uff0c\u90fd\u80fd\u5171\u7528\u540c\u4e00\u4efd\u6765\u81ea <code>__main__</code> \u7684 <code>__builtins__</code>\u3002</p>\n<p>\u90a3\u4e48\u5982\u679c\u662f\u5728\u6a21\u5757\u4e2d\u8c03\u7528\u7684\u51fd\u6570\u5462\uff1f\u5bf9\u4e8e\u6a21\u5757\u4e2d\u7684\u51fd\u6570\uff0c\u521b\u5efa\u548c\u8c03\u7528\u65f6\uff1a</p>\n<p>```c\n// ceval.c\n// \u521b\u5efa\u51fd\u6570\nTARGET(MAKE_FUNCTION)\n{\n    v = POP(); /<em> code object </em>/</p>\n<pre><code>// \u8fd9\u91cc\u7684 f-&gt;f_globals\uff0c\u76f8\u5f53\u4e8e\u6a21\u5757\u81ea\u8eab\u7684 globals\uff0c\u7531\u4e0a\u6587\u53ef\u77e5\uff0c\u4e5f\u76f8\u5f53\u4e8e m.__dict__\nx = PyFunction_New(v, f-&gt;f_globals);\n...\n</code></pre>\n<p>}</p>\n<p>PyObject *\nPyFunction_New(PyObject <em>code, PyObject </em>globals)\n{\n    PyFunctionObject *op = PyObject_GC_New(PyFunctionObject,\n                                        &amp;PyFunction_Type);\n    ...\n    // \u8fd9\u91cc\u76f8\u5f53\u4e8e op-&gt;func_globals = globals = f-&gt;f_globals\n    op-&gt;func_globals = globals;\n}</p>\n<p>// \u8c03\u7528\u51fd\u6570\nstatic PyObject *\nfast_function(PyObject <em>func, PyObject </em><em><em>pp_stack, int n, int na, int nk)\n{\n    PyCodeObject </em>co = (PyCodeObject </em>)PyFunction_GET_CODE(func);\n    // globals = func-&gt;func_globals\n    PyObject <em>globals = PyFunction_GET_GLOBALS(func);\n    ...\n    // globals \u4f20\u7ed9 PyEval_EvalCodeEx\uff0c\u91cc\u9762\u5c31\u4f1a\u4f20\u7ed9 PyFrame_New \u6765\u521b\u5efa\u65b0\u7684\u6808\u5e27\n    return PyEval_EvalCodeEx(co, globals,\n                             (PyObject </em>)NULL, (<em>pp_stack)-n, na,\n                             (</em>pp_stack)-2*nk, nk, d, nd,\n                             PyFunction_GET_CLOSURE(func));\n}\n```</p>\n<p>\u521b\u5efa\u51fd\u6570\u65f6\uff0c\u4f1a\u628a <code>f-&gt;f_globals</code> \u5b58\u5230\u51fd\u6570\u7ed3\u6784\u4f53\u53d8\u91cf <code>func_globals</code> \u91cc\u9762\uff0c\u800c\u5bf9\u4e8e\u6a21\u5757 <code>m</code>\uff0c<code>f-&gt;f_globals = m.__dict__</code>\u3002\u51fd\u6570\u6267\u884c\u7684\u65f6\u5019\uff0c\u4f20\u7ed9 <code>PyFrame_New</code> \u7684 <code>globals</code> \u53c2\u6570\uff0c\u5c31\u662f\u521b\u5efa\u65f6\u5019\u4fdd\u5b58\u8d77\u6765\u7684 <code>func_globals</code>\uff0c<code>__builtins__</code> \u81ea\u7136\u5c31\u53ef\u4ee5\u5728 <code>func_globals</code> \u4e2d\u83b7\u53d6\u3002</p>\n<p>\u81f3\u6b64\uff0c<code>__builtins__</code> \u7684\u4f20\u9012\u662f\u80fd\u4fdd\u8bc1\u4e00\u81f4\u6027\u7684\uff0c\u6240\u6709\u6a21\u5757\u3001\u5b50\u6a21\u5757 \u3001\u51fd\u6570\uff0c\u6808\u5e27\u7b49\u90fd\u80fd\u5f15\u7528\u5230\u540c\u4e00\u4e2a\uff0c\u4e5f\u5c31\u662f\u62e5\u6709\u76f8\u540c\u7684\u5185\u5efa\u540d\u5b57\u7a7a\u95f4\u3002</p>\n<h2>\u6307\u5b9a <code>__main__</code> \u6a21\u5757\u6267\u884c</h2>\n<p>\u6211\u4eec\u5df2\u7ecf\u77e5\u9053 <code>__main__</code> \u6a21\u5757\u81ea\u8eab\u7684 <code>__builtins__</code> \u53ef\u4ee5\u4f20\u9012\u7ed9\u6240\u6709\u5b50\u6a21\u5757\u3001\u51fd\u6570\u548c\u6808\u5e27\uff0c\u800c\u5728\u547d\u4ee4\u884c\u6267\u884c <code>python a.py</code> \u65f6\uff0cPython \u4f1a\u628a <code>a.py</code> \u4f5c\u4e3a <code>__main__</code> \u6a21\u5757\u6765\u6267\u884c\uff0c\u90a3\u8fd9\u662f\u5982\u4f55\u505a\u5230\u7684\u5462\uff1a</p>\n<p>```c\n// python.c\nint\nmain(int argc, char **argv)\n{\n    ...\n    return Py_Main(argc, argv);\n}</p>\n<p>// main.c\nint\nPy_Main(int argc, char **argv)\n{\n    ...\n    // \u5c1d\u8bd5\u7528\u6a21\u5757\u7684 importer \u6765\u6267\u884c\u4ee3\u7801\n    if (filename != NULL) {\n        sts = RunMainFromImporter(filename);\n    }\n    ...\n    // \u4e00\u822c\u6211\u4eec\u81ea\u5df1\u7684 py \u6587\u4ef6\uff0c\u4f1a\u4f7f\u7528\u8fd9\u4e2a\u6765\u6267\u884c\n    sts = PyRun_AnyFileExFlags(\n            fp,\n            filename == NULL ? \"<stdin>\" : filename,\n            filename != NULL, &amp;cf) != 0;\n    }\n    ...\n}</p>\n<p>// pythonrun.c\nint\nPyRun_AnyFileExFlags(FILE <em>fp, const char </em>filename, int closeit,\n                     PyCompilerFlags *flags)\n{\n    ...\n    return PyRun_SimpleFileExFlags(fp, filename, closeit, flags);\n}</p>\n<p>int\nPyRun_SimpleFileExFlags(FILE <em>fp, const char </em>filename, int closeit,\n                        PyCompilerFlags *flags)\n{\n    ...\n    m = PyImport_AddModule(\"<strong>main</strong>\");\n    d = PyModule_GetDict(m);\n    ...\n    // \u8bbe\u7f6e <strong>file</strong> \u5c5e\u6027\n    if (PyDict_SetItemString(d, \"<strong>file</strong>\", f) &lt; 0) {\n        ...\n    }\n    ...\n    // globals = locals = d = <strong>main</strong>.<strong>dict</strong>\n    v = run_pyc_file(fp, filename, d, d, flags);\n    ...\n}</p>\n<p>static PyObject *\nrun_pyc_file(FILE <em>fp, const char </em>filename, PyObject <em>globals,\n             PyObject </em>locals, PyCompilerFlags *flags)\n{\n    ...\n    // \u4ece pyc \u6587\u4ef6\u8bfb\u53d6\u4ee3\u7801\u5bf9\u8c61 co \uff0c\u5e76\u6267\u884c\u4ee3\u7801\n    // PyEval_EvalCode \u91cc\u9762\u4e5f\u540c\u6837\u4f1a\u8c03\u7528 PyFrame_New \u521b\u5efa\u65b0\u6808\u5e27\n    v = PyEval_EvalCode(co, globals, locals);\n    ...\n}\n```</p>\n<p>\u5f53\u6267\u884c <code>python a.py</code> \u65f6\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u4f1a\u8d70\u5230 <code>PyRun_SimpleFileExFlags</code>\uff0c<code>PyRun_SimpleFileExFlags</code> \u91cc\u9762\u4f1a\u53d6\u51fa\u6765 <code>__main__.__dict__</code>\uff0c\u4f5c\u4e3a\u4ee3\u7801\u6267\u884c\u65f6\u7684 <code>globals</code> \u548c <code>locals</code>\uff0c\u6700\u7ec8\u4e5f\u4f1a\u4f20\u5230 <code>PyFrame_New</code> \u4e2d\u521b\u5efa\u65b0\u7684\u6808\u5e27\u6765\u6267\u884c <code>a.py</code>\u3002\u7ed3\u5408\u6211\u4eec\u4e0a\u6587\u63d0\u5230\u7684 <code>__builtins__</code> \u5728\u6a21\u5757\u548c\u51fd\u6570\u4e2d\u4f20\u9012\uff0c\u5c31\u53ef\u4ee5\u8ba9\u540e\u7eed\u6267\u884c\u7684\u4ee3\u7801\u90fd\u80fd\u5171\u7528\u540c\u4e00\u4efd <code>current_frame-&gt;f_builtins = __main__.__builtins__.__dict__</code>\u3002</p>\n<h2>\u518d\u8bba Restricted Execution</h2>\n<p><code>Python</code> \u5728 2.3 \u7248\u672c\u4e4b\u524d\uff0c\u66fe\u7ecf\u63d0\u4f9b\u8fc7\u7684 <a href=\"https://docs.python.org/2.7/library/restricted.html\">Restricted Execution</a>\uff0c\u5c31\u662f\u57fa\u4e8e <code>__builtins__</code> \u7684\u7279\u6027\u6765\u5236\u4f5c\u7684\u3002\u6216\u8005\u53ef\u4ee5\u8ba4\u4e3a\uff0c<code>__builtins__</code> \u4e4b\u6240\u4ee5\u8bbe\u8ba1\u6210\u5728 <code>__main__</code> \u6a21\u5757\u4e2d\u662f\u4e00\u4e2a\u6a21\u5757\u5bf9\u8c61\uff0c\u800c\u5728\u5176\u4ed6\u6a21\u5757\u4e2d\u662f\u4e00\u4e2a <code>dict</code> \u5bf9\u8c61\uff0c\u5c31\u662f\u4e3a\u4e86\u53ef\u4ee5\u5b9e\u73b0 <strong>Restricted Execution</strong>\u3002</p>\n<p>\u8003\u8651\u8fd9\u79cd\u60c5\u51b5\uff1a\u5982\u679c\u6211\u4eec\u53ef\u4ee5\u81ea\u7531\u5b9a\u5236\u81ea\u5df1\u7684 <code>__builtin__</code> \u6a21\u5757\uff0c\u5e76\u8bbe\u7f6e\u6210 <code>__main__.__builtins__</code>\uff0c\u90a3\u5c31\u76f8\u5f53\u4e8e\u540e\u7eed\u6240\u6709\u6267\u884c\u7684\u4ee3\u7801\uff0c\u90fd\u4f1a\u4f7f\u7528\u6211\u4eec\u5b9a\u5236\u7684\u6a21\u5757\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u5236\u7279\u5b9a\u7248\u672c\u7684 <code>open</code>\u3001<code>__import__</code>\u3001<code>file</code> \u7b49\u5185\u5efa\u51fd\u6570\u548c\u7c7b\u578b\uff0c\u66f4\u8fdb\u4e00\u6b65\uff0c\u8fd9\u79cd\u65b9\u5f0f\u662f\u4e0d\u662f\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u9650\u5236\u6267\u884c\u4ee3\u7801\u7684\u6743\u9650\uff0c\u9632\u6b62\u4ee3\u7801\u505a\u4e00\u4e9b\u4e0d\u5b89\u5168\u7684\u51fd\u6570\u8c03\u7528\uff0c\u6216\u8005\u8bbf\u95ee\u4e00\u4e9b\u4e0d\u5b89\u5168\u7684\u6587\u4ef6\uff1f</p>\n<p><code>Python</code> \u5f53\u65f6\u5c31\u505a\u8fc7\u8fd9\u79cd\u5c1d\u8bd5\uff0c\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\u7684\u6a21\u5757\u5c31\u53eb\u505a: <code>rexec</code>\u3002</p>\n<h3><code>rexec</code></h3>\n<p>\u6211\u65e0\u610f\u592a\u6df1\u5165\u8bb2\u89e3 <code>rexec</code> \u7684\u5b9e\u73b0\uff0c\u56e0\u4e3a\u539f\u7406\u5176\u5b9e\u4e0a\u6587\u5df2\u7ecf\u8bb2\u6e05\u695a\u4e86\uff0c\u5e76\u4e14\u8fd9\u4e2a\u6a21\u5757\u672c\u8eab\u5c31\u5df2\u7ecf\u5e9f\u5f03\uff0c\u6211\u8fd9\u4e9b\u4ec5\u7b80\u5355\u505a\u4e00\u4e9b\u5173\u952e\u4ee3\u7801\u7684\u6458\u8981\uff0c\u65b9\u4fbf\u67e5\u9605\u3002</p>\n<p>```python</p>\n<h1>rexec.py</h1>\n<p>class RExec(ihooks._Verbose):\n    ...\n    nok_builtin_names = ('open', 'file', 'reload', '<strong>import</strong>')</p>\n<pre><code>def __init__(self, hooks = None, verbose = 0):\n    ...\n    self.modules = {}\n    ...\n    self.make_builtin()\n    self.make_initial_modules()\n    self.make_sys()\n    self.loader = RModuleLoader(self.hooks, verbose)\n    self.importer = RModuleImporter(self.loader, verbose)\n\ndef make_builtin(self):\n    m = self.copy_except(__builtin__, self.nok_builtin_names)\n    m.__import__ = self.r_import\n    m.reload = self.r_reload\n    m.open = m.file = self.r_open\n\ndef add_module(self, mname):\n    m = self.modules.get(mname)\n    if m is None:\n        self.modules[mname] = m = self.hooks.new_module(mname)\n    m.__builtins__ = self.modules['__builtin__']\n    return m\n\ndef r_exec(self, code):\n    m = self.add_module('__main__')\n    exec code in m.__dict__\n\ndef r_eval(self, code):\n    m = self.add_module('__main__')\n    return eval(code, m.__dict__)\n\ndef r_execfile(self, file):\n    m = self.add_module('__main__')\n    execfile(file, m.__dict__)\n</code></pre>\n<p>```</p>\n<p><code>r_execfile</code> \u51fd\u6570\u4f1a\u628a\u6587\u4ef6\u5f53\u4f5c <code>__main__</code> \u6a21\u5757\u6765\u6267\u884c\uff0c\u53ea\u662f <code>__main__</code> \u662f\u5b9a\u5236\u8fc7\u7684\u3002<code>self.add_module('__main__')</code> \u91cc\u9762\uff0c\u4f1a\u8bbe\u7f6e\u6a21\u5757\u7684 <code>m.__builtins__ = self.modules['__builtin__']</code>\uff0c\u8fd9\u4e2a <code>__builtin__</code> \u662f\u7531 <code>make_builtin</code> \u6765\u5b9a\u5236\u751f\u6210\u7684\uff0c\u5728\u91cc\u9762\u66ff\u6362\u4e86 <code>__import__</code>\u3001<code>reload</code>\u3001<code>open</code> \u51fd\u6570\uff0c\u5e76\u5220\u9664\u4e86 <code>file</code> \u7c7b\u578b\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u80fd\u63a7\u5236\u8981\u6267\u884c\u7684\u4ee3\u7801\u5bf9\u5185\u5efa\u547d\u540d\u7a7a\u95f4\u7684\u8bbf\u95ee\u4e86\u3002</p>\n<p>\u5bf9\u4e8e\u4e00\u4e9b\u5185\u5efa\u6a21\u5757\uff0c<code>rexec</code> \u4e5f\u505a\u4e86\u5b9a\u5236\uff0c\u4fdd\u62a4\u4e0d\u5b89\u5168\u7684\u8bbf\u95ee\uff0c\u8b6c\u5982 <code>sys</code> \u6a21\u5757\uff0c\u53ea\u4fdd\u7559\u4e86\u4e00\u90e8\u5206\u7684\u5bf9\u8c61\uff0c\u5e76\u4e14\u901a\u8fc7\u5b9a\u5236\u7684 <code>self.loader</code>\u3001<code>self.importer</code>\uff0c\u6765\u5b9e\u73b0 <code>import</code> \u7684\u65f6\u5019\uff0c\u4f18\u5148\u52a0\u8f7d\u5b9a\u5236\u7684\u6a21\u5757\u3002</p>\n<p>\u5982\u679c\u5bf9\u4ee3\u7801\u7ec6\u8282\u611f\u5174\u8da3\uff0c\u8bf7\u81ea\u884c\u67e5\u9605\u76f8\u5173\u6e90\u7801\u3002</p>\n<h3><code>rexec</code> \u7684\u5931\u8d25</h3>\n<p>\u4e0a\u6587\u63d0\u5230\uff0c<code>Python 2.3</code> \u4e4b\u540e\uff0c<code>rexec</code> \u5c31\u5df2\u7ecf\u5e9f\u5f03\u4e86\uff0c\u56e0\u4e3a\u8fd9\u79cd\u65b9\u5f0f\u5df2\u7ecf\u88ab\u8bc1\u5b9e\u4e3a\u4e0d\u53ef\u884c\u3002\u5e26\u7740\u597d\u5947\u5fc3\uff0c\u6211\u4eec\u6765\u7b80\u5355\u6eaf\u6e90\u4e00\u4e0b\uff1a</p>\n<ul>\n<li>\n<p>\u5728\u793e\u533a\u6709\u4eba\u62a5\u544a\u4e86 <a href=\"https://mail.python.org/pipermail/python-dev/2002-December/031160.html\">Bug</a>\uff0c\u5e76\u5f15\u53d1\u4e86\u5f00\u53d1\u8005\u4e4b\u95f4\u7684\u8ba8\u8bba\uff1a</p>\n<blockquote>\n<p>it's never going to be safe, and I doubt it's very useful as long as it's not safe.</p>\n<p>Every change is a potential security hole.</p>\n<p>it's hard to predict what change is going to break it.</p>\n<p>I don't expect you'll ever reach the point where it'll be wise to advertise this as safe.  I certainly won't.</p>\n<p>this is only a useful occupation if you expect to eventually reach a point where you expect that there aren't any security flaws left.  Jeremy &amp; I both doubt that Python will ever reach that level, meaning that the whole exercise of fixing security flaws is a waste of time (if you know you <em>can't</em> make it safe, don't waste time trying).</p>\n<p>I agree (but I have said that in past) the best thing is to deprecate/rip out rexec.</p>\n<p>The code will still be in older versions if someone decides to pick it up and work on it as a separate project.</p>\n</blockquote>\n</li>\n<li>\n<p>\u8be5 Bug \u7684\u8d77\u56e0\u662f <code>Python</code> \u5f15\u5165\u4e86\u65b0\u5f0f\u7c7b\uff08new-style class\uff09 <code>object</code>\uff0c\u5bfc\u81f4 <code>rexec</code> \u4e0d\u80fd\u6b63\u5e38\u5de5\u4f5c\u3002\u4e8e\u662f\u5f00\u53d1\u8005\u8868\u793a\uff0c\u5728\u53ef\u9884\u89c1\u7684\u672a\u6765\uff0c\u8fd9\u79cd\u60c5\u51b5\u90fd\u5f88\u96be\u907f\u514d\uff0c\u4efb\u610f\u7684\u4fee\u6539\u90fd\u4f1a\u53ef\u80fd\u5bfc\u81f4 <code>rexec</code> \u51fa\u73b0\u6f0f\u6d1e\uff0c\u4e0d\u80fd\u6b63\u5e38\u5de5\u4f5c\uff0c\u6216\u8005\u88ab\u7a81\u7834\u6743\u9650\u7684\u9650\u5236\uff0c\u57fa\u672c\u4e0a\u65e0\u6cd5\u5b9e\u73b0\u6ca1\u6709\u6f0f\u6d1e\u5730\u53bb\u63d0\u4f9b\u4e00\u4e2a\u5b89\u5168\u73af\u5883\u7684\u613f\u666f\uff0c\u5f00\u53d1\u8005\u9700\u8981\u4e0d\u65ad\u5730\u4fee\u4fee\u8865\u8865\uff0c\u6d6a\u8d39\u5927\u91cf\u7684\u65f6\u95f4\u3002\u6700\u7ec8\uff0c<code>rexec</code> \u8fd9\u4e2a\u6a21\u5757\u5c31\u88ab\u5e9f\u5f03\u6389\u4e86\uff0c<code>Python</code> \u4e5f\u6ca1\u6709\u518d\u63d0\u4f9b\u7c7b\u4f3c\u7684\u529f\u80fd\u3002\u4f46\u5173\u4e8e <code>__builtins__</code> \u7684\u8bbe\u5b9a\uff0c\u7531\u4e8e\u517c\u5bb9\u6027\u7b49\u95ee\u9898\uff0c\u5c31\u7ee7\u7eed\u4fdd\u7559\u4e0b\u6765\u4e86\u3002</p>\n</li>\n</ul>\n<p>\u540e\u9762\u5728\u5927\u6982 2010 \u5e74\u7684\u65f6\u5019\uff0c\u6709\u4f4d\u7a0b\u5e8f\u5458\u63a8\u51fa\u4e86 <a href=\"https://github.com/vstinner/pysandbox\">pysandbox</a>\uff0c\u81f4\u529b\u4e8e\u63d0\u4f9b\u53ef\u4ee5\u66ff\u4ee3 <code>rexec</code> \u7684 <code>Python</code> \u6c99\u76d2\u73af\u5883\u3002\u4f46\u662f 3 \u5e74\u540e\uff0c\u4f5c\u8005\u4e3b\u52a8\u653e\u5f03\u4e86\u8fd9\u4e2a\u9879\u76ee\uff0c\u5e76\u8be6\u7ec6\u8bf4\u660e\u4e86\u4e3a\u4ec0\u4e48\u4f5c\u8005\u8ba4\u4e3a\u8fd9\u4e2a\u9879\u76ee\u662f\u5931\u8d25\u7684\uff1a<a href=\"https://mail.python.org/pipermail/python-dev/2013-November/130132.html\">The pysandbox project is broken</a>\uff0c\u4e5f\u6709\u5176\u4ed6\u4f5c\u8005\u64b0\u6587\u603b\u7ed3\u4e86\u8fd9\u4e2a\u9879\u76ee\u7684\u5931\u8d25\uff1a<a href=\"https://lwn.net/Articles/574215/\">The failure of pysandbox</a>\u3002\u5982\u679c\u611f\u5174\u8da3\u7684\u8bdd\uff0c\u53ef\u4ee5\u5177\u4f53\u53bb\u7ffb\u7ffb\u539f\u6587\uff0c\u6211\u8fd9\u91cc\u4e5f\u7ed9\u4e00\u4e9b\u6458\u8981\u6765\u5e2e\u52a9\u4e86\u89e3\uff1a</p>\n<blockquote>\n<p>After having work during 3 years on a pysandbox project to sandbox untrusted code, I now reached a point where I am convinced that pysandbox is broken by design. Different developers tried to convinced me before that pysandbox design is unsafe, but I had to experience it myself to be convineced.</p>\n<p>I now agree that putting a sandbox in CPython is the wrong design. There are too many ways to escape the untrusted namespace using the various introspection features of the Python language. To guarantee the [safety] of a security product, the code should be [carefully] audited and the code to review must be as small as possible. Using pysandbox, the \"code\" is the whole Python core which is a really huge code base. For example, the Python and Objects directories of Python 3.4 contain more than 126,000 lines of C code.</p>\n<p>The security of pysandbox is the security of its weakest part. A single bug is enough to escape the whole sandbox.</p>\n<p>pysandbox cannot be used in practice. To protect the untrusted namespace, pysandbox installs a lot of different protections. Because of all these protections, it becomes hard to write Python code. Basic features like \"del dict[key]\" are denied. Passing an object to a sandbox is not possible to sandbox, pysandbox is unable to proxify arbitary objects. For something more complex than evaluating \"1+(2*3)\", pysandbox cannot be used in practice, because of all these protections.</p>\n</blockquote>\n<p><strong>pysandbox</strong> \u7684\u4f5c\u8005\u8ba4\u4e3a\uff0c\u5728 <code>Python</code> \u91cc\u9762\u653e\u4e00\u4e2a\u6c99\u76d2\u73af\u5883\u662f\u9519\u8bef\u7684\u8bbe\u8ba1\uff0c\u6709\u592a\u591a\u7684\u65b9\u5f0f\u53ef\u4ee5\u4ece\u6c99\u76d2\u4e2d\u9003\u9038\u51fa\u53bb\uff0c<code>Python</code> \u63d0\u4f9b\u7684\u8bed\u8a00\u7279\u6027\u5f88\u4e30\u5bcc\uff0c<code>CPython</code> \u6e90\u7801\u7684\u4ee3\u7801\u91cf\u5f88\u5927\uff0c\u57fa\u672c\u4e0d\u53ef\u80fd\u4fdd\u8bc1\u6709\u8db3\u591f\u7684\u5b89\u5168\u6027\u3002\u800c <strong>pysandbox</strong> \u7684\u5f00\u53d1\u8fc7\u7a0b\u5c31\u662f\u5728\u4e0d\u65ad\u5730\u6253\u8865\u4e01\uff0c\u8865\u4e01\u592a\u591a\uff0c\u9650\u5236\u592a\u591a\uff0c\u4ee5\u81f3\u4e8e\u4f5c\u8005\u8ba4\u4e3a <strong>pysandbox</strong> \u5df2\u7ecf\u6ca1\u6cd5\u5b9e\u9645\u4f7f\u7528\uff0c\u56e0\u4e3a\u5f88\u591a\u7684\u8bed\u6cd5\u7279\u6027\u548c\u529f\u80fd\u90fd\u88ab\u9650\u5236\u4e0d\u80fd\u4f7f\u7528\u4e86\uff0c\u8b6c\u5982\u7b80\u5355\u7684 <code>del dict[key]</code>\u3002</p>\n<h2>Restricted Execution \u51fa\u8def\u5728\u54ea</h2>\n<p>\u65e2\u7136 <code>rexec</code> \u548c <strong>pysandbox</strong> \u8fd9\u79cd\u901a\u8fc7 Patch Python \u6765\u63d0\u4f9b\u6c99\u76d2\u73af\u5883\u7684\u65b9\u6cd5\uff08\u8fd9\u91cc\u59d1\u4e14\u628a\u8fd9\u79cd\u65b9\u6cd5\u79f0\u4f5c Patch Python\uff09\u5df2\u7ecf\u8d70\u4e0d\u901a\u4e86\uff0c\u90a3\u6211\u4e0d\u7981\u597d\u5947\uff1a\u8981\u600e\u4e48\u624d\u80fd\u7ed9 Python \u63d0\u4f9b\u4e00\u4e2a\u80fd\u7528\u7684\u6c99\u76d2\u73af\u5883\uff1f</p>\n<p>\u5728\u8fd9\u91cc\u6211\u7ee7\u7eed\u6536\u96c6\u4e86\u4e00\u4e9b\u5176\u4ed6\u7684\u5b9e\u73b0\u65b9\u6cd5\u6216\u8005\u6848\u4f8b\uff0c\u65b9\u4fbf\u53c2\u8003\u548c\u67e5\u9605\uff1a</p>\n<ul>\n<li>\n<p><a href=\"https://doc.pypy.org/en/latest/sandbox.html\">PyPy</a> \u6709\u4e00\u4e2a<a href=\"https://foss.heptapod.net/pypy/pypy/-/tree/branch/sandbox-2\">\u5206\u652f</a>\u63d0\u4f9b\u4e86\u6c99\u76d2\u7684\u529f\u80fd\uff0c\u7ed3\u5408\u989d\u5916\u7684 <a href=\"https://foss.heptapod.net/pypy/sandboxlib\">sandboxlib</a>\uff0c\u53ef\u4ee5\u81ea\u884c\u7f16\u8bd1\u51fa\u5e26\u6c99\u76d2\u73af\u5883\u7248\u672c\u7684 PyPy\u3002\u5982\u679c\u611f\u5174\u8da3\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u81ea\u884c\u914d\u7f6e\uff0c\u53c2\u8003\u8fd9\u91cc\u7684\u4e00\u4e9b<a href=\"https://foss.heptapod.net/pypy/pypy/-/issues/3192\">\u8bf4\u660e</a>\u3002PyPy \u5b9e\u73b0\u7684\u539f\u7406\u662f\u521b\u5efa\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u5b50\u8fdb\u7a0b\u7684\u6240\u6709\u8f93\u5165\u8f93\u51fa\u548c\u7cfb\u7edf\u8c03\u7528\uff0c\u90fd\u4f1a\u91cd\u5b9a\u5411\u5230\u5916\u90e8\u8fdb\u7a0b\uff0c\u7531\u5916\u90e8\u8fdb\u7a0b\u63a7\u5236\u8fd9\u4e9b\u6743\u9650\uff0c\u53e6\u5916\u4e5f\u53ef\u4ee5\u63a7\u5236\u5185\u5b58\u548c CPU \u7684\u4f7f\u7528\u91cf\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u4e2a\u5206\u652f\u4e5f\u6709\u6bb5\u65f6\u95f4\u6ca1\u6709\u65b0\u7684\u63d0\u4ea4\u4e86\uff0c\u8bf7\u8c28\u614e\u4f7f\u7528\u3002</p>\n</li>\n<li>\n<p>\u501f\u52a9\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u6c99\u76d2\u73af\u5883\u5de5\u5177\u3002<a href=\"https://en.wikipedia.org/wiki/Seccomp\">seccomp</a> \u662f Linux \u5185\u6838\u63d0\u4f9b\u7684\u8ba1\u7b97\u5b89\u5168\u5de5\u5177\uff0c<a href=\"https://github.com/seccomp/libseccomp/tree/main/src/python\">libsecoomp</a> \u63d0\u4f9b\u4e86 Python \u7ed1\u5b9a\uff0c\u53ef\u4ee5\u5185\u5d4c\u5230\u4ee3\u7801\u91cc\u9762\u4f7f\u7528\uff1b\u6216\u8005\u4f7f\u7528\u57fa\u4e8e seccomp \u5b9e\u73b0\u7684\u5de5\u5177\u6765\u6267\u884c\u4ee3\u7801\uff0c\u8b6c\u5982 <a href=\"https://firejail.wordpress.com/\">Firejail</a>\u3002<a href=\"https://apparmor.net/\">AppArmor</a> \u662f\u4e00\u4e2a Linux \u5185\u6838\u5b89\u5168\u6a21\u5757\uff0c\u5141\u8bb8\u7ba1\u7406\u5458\u63a7\u5236\u7a0b\u5e8f\u80fd\u8bbf\u95ee\u7684\u7cfb\u7edf\u8d44\u6e90\u548c\u529f\u80fd\uff0c\u4fdd\u62a4\u64cd\u4f5c\u7cfb\u7edf\u3002<a href=\"https://github.com/openedx/codejail\">codejail</a> \u662f\u57fa\u4e8e AppArmor \u5b9e\u73b0\u7684 Python \u6c99\u76d2\u73af\u5883\uff0c\u6709\u5174\u8da3\u53ef\u4ee5\u5c1d\u8bd5\u3002\u8fd8\u6709\u5f88\u591a\u7c7b\u4f3c\u7684\u5de5\u5177\uff0c\u8fd9\u91cc\u4e0d\u4e00\u4e00\u5217\u4e3e\u3002</p>\n</li>\n<li>\n<p>\u4f7f\u7528\u6c99\u76d2\u865a\u62df\u73af\u5883\u6216\u8005\u5bb9\u5668\u3002<a href=\"https://learn.microsoft.com/zh-cn/windows/security/threat-protection/windows-sandbox/windows-sandbox-overview\">Windows \u6c99\u76d2</a>\uff0c<a href=\"https://linuxcontainers.org/\">LXC</a>, <a href=\"https://www.docker.com/\">Docker</a> \u7b49\u7b49\uff0c\u8fd9\u91cc\u4e0d\u518d\u8be6\u8ff0\u3002</p>\n</li>\n</ul>\n<h2>\u603b\u7ed3</h2>\n<p>\u672c\u6587\u7bc7\u5e45\u6709\u70b9\u957f\uff0c\u611f\u8c22\u770b\u5230\u8fd9\u91cc\uff0c\u6587\u7ae0\u4e00\u5f00\u59cb\u6240\u5217\u51fa\u7684\u7591\u95ee\uff0c\u76f8\u4fe1\u90fd\u5df2\u7ecf\u89e3\u7b54\u5b8c\u6bd5\u3002</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/py-%E4%BD%BF%E7%94%A8VisualStudio2015%E7%BC%96%E8%AF%91Python2.7.11/",
            "url": "https://wiki.disenone.site/py-%E4%BD%BF%E7%94%A8VisualStudio2015%E7%BC%96%E8%AF%91Python2.7.11/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "\u4f7f\u7528 Visual Studio 2015 \u7f16\u8bd1 Python 2.7.11",
            "content_html": "<p><meta property=\"og:title\" content=\"\u4f7f\u7528 Visual Studio 2015 \u7f16\u8bd1 Python 2.7.11\" /></p>\n<p><img alt=\"\" src=\"https://img.shields.io/badge/python-2.7.11-brightgreen.svg\">{:style=\"display: inline-block\"}\n<img alt=\"\" src=\"https://img.shields.io/badge/vs-2015-68217A.svg\">{:style=\"display: inline-block\"}</p>\n<h2>\u539f\u56e0</h2>\n<p>Python 2.7 \u7684\u5b98\u65b9\u7248\u672c\u652f\u6301 Visual Studio 2010 \u4ee5\u4e0b\u7248\u672c\u6765\u7f16\u8bd1\uff0c\u53c2\u8003 <code>PCbuild\\readme.txt</code>\uff1a</p>\n<pre><code>1.  Install Microsoft Visual Studio 2008, any edition.\n2.  Install Microsoft Visual Studio 2010, any edition, or Windows SDK 7.1 and any version of Microsoft Visual Studio newer than 2010.\n</code></pre>\n<p>\u5982\u679c\u4f60\u60f3\u5728 Windows \u4e0b\u81ea\u5df1\u5012\u817e Python\uff0c\u8b6c\u5982\u7f16\u8bd1\u4e2a Debug \u7248\u672c\u3001\u81ea\u5df1\u6539\u6539\u6e90\u4ee3\u7801\u7b49\uff0c\u90a3\u4e48\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u5c31\u662f\u88c5\u4e00\u4e2a VS2010\u3002\n\u4f46\u662f\u5bf9\u6211\u4e2a\u4eba\u6765\u8bf4\uff0c \u6211\u66f4\u60f3\u8981\u7528 VS2015 \u6765\u7f16\u8bd1 Python\uff0c\u539f\u56e0\u4e3b\u8981\u6709\uff1a</p>\n<ul>\n<li>VS2010 \u5b9e\u5728\u6709\u70b9\u8fc7\u65f6\uff0c\u4f7f\u7528\u8d77\u6765\u529f\u80fd\u548c\u4f53\u9a8c\u6bd4 VS2015 \u8981\u5dee\u5f97\u591a\u3002\u4e00\u76f4\u7528\u7740 VS2015\uff0c\u8981\u6211\u518d\u88c5\u4e2a VS2010 \u5b9e\u5728\u4e0d\u613f\u610f\u3002</li>\n<li>\u7531\u4e8e\u4e00\u76f4\u7528 VS2015\uff0c\u4f60\u4f1a\u4f7f\u7528\u5b83\u6765\u5199\u4e00\u4e9b\u81ea\u5df1\u7684\u7a0b\u5e8f\uff0c\u5982\u679c\u4f60\u60f3\u8981\u628a Python \u5d4c\u5165\u8fdb\u53bb\uff0c\u90a3\u4f60\u5c31\u9700\u8981\u4f7f\u7528\u76f8\u540c\u7248\u672c\u7684 VS \u6765\u7f16\u8bd1\u4f60\u7684\u7a0b\u5e8f\uff0c\u5982\u679c\u4f7f\u7528\u4e0d\u540c\u7248\u672c\u7684 VS\uff0c\u90a3\u4f1a\u51fa\u73b0\u5404\u79cd\u65e0\u6cd5\u9884\u6599\u7684\u4e8b\u60c5\u3002<a href=\"http://siomsystems.com/mixing-visual-studio-versions/\">\u8fd9\u91cc\u6709\u66f4\u8be6\u7ec6\u7684\u89e3\u91ca</a>\u3002</li>\n</ul>\n<p>\u6240\u4ee5\u6211\u5f00\u59cb\u7740\u624b\u7528 VS2015 \u641e\u5b9a Python 2.7.11 \u7248\u672c\uff08\u5f53\u524d\u7684 Python 2.7 \u6700\u65b0\u7248\u672c\uff09\u3002</p>\n<p>\u8981\u6ce8\u610f\uff0c<strong>Python 3.x \u5df2\u7ecf\u652f\u6301\u7528 VS2015 \u6765\u7f16\u8bd1</strong>\u3002</p>\n<h2>\u6e90\u7801\u4e0b\u8f7d</h2>\n<p>Python \u7684\u7248\u672c\u5f53\u7136\u5c31\u662f 2.7.11\uff0c\u53e6\u5916\u8fd8\u6709\u4e00\u4e9b\u7b2c\u4e09\u65b9\u7684\u6a21\u5757\uff0c\u5177\u4f53\u53ef\u4ee5\u8fd0\u884c Python \u6e90\u7801\u76ee\u5f55\u4e0b <code>PCbuild\\get_externals.bat</code> \u811a\u672c\u83b7\u53d6\u6240\u6709\u7f16\u8bd1\u9700\u8981\u7684\u6a21\u5757\uff0c\u6ce8\u610f\u4f60\u9700\u8981\u5b89\u88c5 svn \uff0c\u628a svn.exe \u6dfb\u52a0\u5230\u7cfb\u7edf PATH \u91cc\u9762\u3002</p>\n<p>\u4e0b\u8f7d\u53ef\u80fd\u5f88\u4e0d\u7a33\u5b9a\uff0c\u5e76\u4e14\u6574\u4e2a\u8fc7\u7a0b\u90fd\u6709\u53ef\u80fd\u56e0\u4e3a\u7f51\u7edc\u95ee\u9898\u800c\u7ec8\u6b62\uff0c\u6240\u4ee5\u8fd8\u662f\u63a8\u8350\u76f4\u63a5\u5728\u6211\u7684github\u4e0a\u4e0b\u8f7dexternals\u76ee\u5f55\uff1a<a href=\"https://github.com/disenone/wpython-2.7.11/tree/e13f43a3b72ae2bdf4d2950c6364750ae668cbf4/externals\">\u6211\u7684 Python \u7248\u672c</a></p>\n<h2>\u7f16\u8bd1\u8fc7\u7a0b</h2>\n<h3>\u7b2c\u4e09\u65b9\u6a21\u5757</h3>\n<p>\u9996\u5148\u8981\u89e3\u51b3\u7684\u662f\u7b2c\u4e09\u65b9\u7684\u6a21\u5757\uff0c\u4e3b\u8981\u662f tcl, tk, tcltk\u3002</p>\n<p>\u4fee\u6539\u6587\u4ef6 <code>externals/tcl-8.5.15.0/win/makefile.vc</code>\uff0c\u628a 434 \u884c\u6539\u6210</p>\n<pre><code>- cdebug = -Zi -WX $(DEBUGFLAGS)\n+ cdebug = -Zi -WX- $(DEBUGFLAGS)\n</code></pre>\n<p>\u5173\u4e8e\u9009\u9879 <code>WX</code>\uff0c\u53ef\u4ee5\u770b\u5fae\u8f6f\u7684\u5b98\u65b9\u6587\u6863\uff1a<a href=\"https://msdn.microsoft.com/en-us/library/ms235592.aspx\">/WX (Treat Linker Warnings as Errors)</a></p>\n<p>\u518d\u6765\u6539<code>PCbuild/tk.vcxproj</code>\uff0c\u7528\u6587\u672c\u7f16\u8f91\u5668\u6253\u5f00\uff0c\u4fee\u6539 63, 64 \u884c</p>\n<pre><code>- &lt;TkOpts&gt;msvcrt&lt;/TkOpts&gt;\n- &lt;TkOpts Condition=\"$(Configuration) == 'Debug'\"&gt;symbols,msvcrt&lt;/TkOpts&gt;\n+ &lt;TkOpts&gt;msvcrt,noxp&lt;/TkOpts&gt;\n+ &lt;TkOpts Condition=\"$(Configuration) == 'Debug'\"&gt;symbols,msvcrt,noxp&lt;/TkOpts&gt;\n</code></pre>\n<p>\u6539<code>PCbuild/tcltk.props</code>\uff0c\u7528\u6587\u672c\u7f16\u8f91\u5668\u6253\u5f00\uff0c\u4fee\u653941\u884c</p>\n<pre><code>- &lt;BuildDirTop&gt;$(BuildDirTop)_VC9&lt;/BuildDirTop&gt;\n+ &lt;BuildDirTop&gt;$(BuildDirTop)_VC13&lt;/BuildDirTop&gt;\n</code></pre>\n<p>\u7531\u4e8e VS2015 \u53d6\u6d88\u4e86 <code>timezone</code> \u7684\u5b9a\u4e49\uff0c\u6539\u4e3a <code>_timezone</code>\uff0c\u6240\u4ee5\u4ee3\u7801\u91cc\u9762\u7528\u5230 <code>timezone</code> \u7684\u5730\u65b9\u90fd\u8981\u6539\u6210 <code>_timezone</code>\uff0c\u7b2c\u4e09\u65b9\u6a21\u5757\u53ea\u9700\u8981\u6539\u6587\u4ef6<code>externals/tcl-8.5.15.0/win/tclWinTime.c</code>\uff0c\u5728\u6587\u4ef6\u7684\u524d\u9762\u52a0\u4e0a\uff1a</p>\n<pre><code>#if defined _MSC_VER &amp;&amp; _MSC_VER &gt;= 1900\n#define timezone _timezone\n#endif\n</code></pre>\n<h3>\u6539 Python \u6e90\u7801</h3>\n<p><code>timezone</code>\u7684\u95ee\u9898\u5728 Python \u7684\u6a21\u5757 <code>time</code> \u91cc\u9762\u4e5f\u6709\uff0c\u4fee\u6539 767 \u884c</p>\n<pre><code>- #ifdef __CYGWIN__\n+ #if defined(__CYGWIN__) || defined(_MSC_VER) &amp;&amp; _MSC_VER &gt;= 1900\n</code></pre>\n<p>\u53e6\u5916\u7531\u4e8e\u5728 Windows \u4e0b Python \u7528\u4e86\u4e00\u79cd\u7279\u6b8a\u7684\u65b9\u6cd5\u6765\u68c0\u67e5\u6587\u4ef6\u53e5\u67c4\u7684\u6709\u6548\u6027\uff0c\u800c\u8fd9\u79cd\u65b9\u6cd5\u5728 VS2015 \u4e2d\u88ab\u5f7b\u5e95\u7981\u6b62\u4e86\uff0c\u4f1a\u51fa\u73b0\u7f16\u8bd1\u9519\u8bef\uff0c\u6240\u4ee5\u5148\u6539\u6389\u3002\u6587\u4ef6 <code>Include/fileobject.h</code>\uff0c73\u300180 \u884c\uff1a</p>\n<pre><code>73 - #if defined _MSC_VER &amp;&amp; _MSC_VER &gt;= 1400\n73 + #if defined _MSC_VER &amp;&amp; _MSC_VER &gt;= 1400 &amp;&amp; _MSC_VER &lt; 1900\n\n80 - #elif defined _MSC_VER &amp;&amp; _MSC_VER &gt;= 1200\n80 + #elif defined _MSC_VER &amp;&amp; _MSC_VER &gt;= 1200 &amp;&amp; _MSC_VER &lt; 1400\n</code></pre>\n<p>\u6587\u4ef6<code>Modules/posixmodule.c</code>\uff0c532 \u884c\uff1a</p>\n<pre><code>- #if defined _MSC_VER &amp;&amp; _MSC_VER &gt;= 1400\n+ #if defined _MSC_VER &amp;&amp; _MSC_VER &gt;= 1400 &amp;&amp; _MSC_VER &lt; 1900\n</code></pre>\n<p>\u81f3\u6b64\uff0cPython \u5c31\u53ef\u4ee5\u7f16\u8bd1\u901a\u8fc7\u3002\u66f4\u5177\u4f53\u7684\u4fee\u6539\u53ef\u4ee5\u770b\u6211 commit \u7684\u5185\u5bb9\uff1a<a href=\"https://github.com/disenone/wpython-2.7.11/commit/4037e2d806518dbf06ffb8ee5c46f419ef8d7edf\">modify to build by vs2015</a></p>\n<h3>\u68c0\u67e5\u65e0\u6548\u53e5\u67c4</h3>\n<p>\u867d\u7136\u7f16\u8bd1\u901a\u8fc7\u4e86\uff0c\u4f46\u7531\u4e8e\u662f\u7c97\u66b4\u5730\u5ffd\u7565\u65e0\u6548\u6587\u4ef6\u53e5\u67c4\uff0c\u76f4\u63a5\u5bfc\u81f4\u7684\u540e\u679c\u662f\u4e00\u65e6\u8bbf\u95ee\u65e0\u6548\u7684\u53e5\u67c4\uff08\u8b6c\u5982\u5bf9\u540c\u4e00\u4e2a\u6587\u4ef6<code>close</code>\u4e24\u6b21\uff09\uff0cPython \u5c31\u4f1a\u76f4\u63a5 assert failed\uff0c\u7a0b\u5e8f crash\uff0c\u8fd9\u6837\u7684 Python \u6839\u672c\u6ca1\u6cd5\u7528\u554a\u3002Python \u5c31\u662f\u7528\u4e86\u4e00\u79cd\u5f88\u7279\u6b8a\u7684\u65b9\u6cd5\u6765\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\uff0c\u53ef\u60dc\u5728 VS2015 \u91cc\u9762\u4e0d\u80fd\u7528\u4e86\uff0c\u6ce8\u91ca\u662f\u8fd9\u6837\u89e3\u91ca\u7684\uff1a</p>\n<pre><code>Microsoft CRT in VS2005 and higher will verify that a filehandle is valid and raise an assertion if it isn't.\n</code></pre>\n<p>\u5e78\u597d\u5df2\u7ecf\u6709\u4e86\u89e3\u51b3\u65b9\u6cd5\uff0c\u6211\u662f\u5728 Python \u7684 issue \u91cc\u9762\u770b\u5230\u7684\uff0c\u5730\u5740\u5728\u8fd9\u91cc\uff1a<a href=\"http://psf.upfronthosting.co.za/roundup/tracker/issue23524\">issue23524</a>, <a href=\"http://psf.upfronthosting.co.za/roundup/tracker/issue25759\">issue25759</a>\u3002\u8fd9\u79cd\u65b9\u6cd5\u4e5f\u662f\u7528\u5728\u73b0\u5728 Python 3.x \u91cc\u9762\u3002</p>\n<p>\u5177\u4f53\u5730\u8bf4\u5c31\u662f\u5728\u4f7f\u7528\u6587\u4ef6\u53e5\u67c4\u7684\u65f6\u5019\u7981\u6b62\u6389 Windows \u7684 assert crash \u673a\u5236\uff0c\u6539\u4e3a\u68c0\u67e5\u9519\u8bef\u7801\u3002\u90a3\u8981\u600e\u4e48\u7981\u6b62 Windows \u7684 assert \u673a\u5236\u5462\uff1f\u7b54\u6848\u5c31\u662f\u7528\u81ea\u5df1\u7684\u9519\u8bef\u5904\u7406\u51fd\u6570\u66ff\u4ee3 Windows \u9ed8\u8ba4\u7684\u5904\u7406\u51fd\u6570\uff0c\u5173\u952e\u7684\u4ee3\u7801\uff1a</p>\n<p>\u65b0\u5efa\u6587\u4ef6<code>PC/invalid_parameter_handler.c</code>\uff0c\u5b9a\u4e49\u6211\u4eec\u81ea\u5df1\u7684\u9519\u8bef\u5904\u7406\u51fd\u6570\uff0c\u53ef\u4ee5\u6682\u65f6\u5ffd\u7565\u53d1\u751f\u7684\u9519\u8bef</p>\n<p>```c++</p>\n<h1>ifdef _MSC_VER</h1>\n<h1>include <stdlib.h></h1>\n<h1>if _MSC_VER &gt;= 1900</h1>\n<p>/<em> pyconfig.h uses this function in the _Py_BEGIN_SUPPRESS_IPH/_Py_END_SUPPRESS_IPH\n * macros. It does not need to be defined when building using MSVC\n * earlier than 14.0 (_MSC_VER == 1900).\n </em>/</p>\n<p>static void __cdecl _silent_invalid_parameter_handler(\n    wchar_t const<em> expression,\n    wchar_t const</em> function,\n    wchar_t const* file,\n    unsigned int line,\n    uintptr_t pReserved) \n{}</p>\n<p>_invalid_parameter_handler _Py_silent_invalid_parameter_handler = _silent_invalid_parameter_handler;</p>\n<h1>endif</h1>\n<h1>endif</h1>\n<p>```</p>\n<p>\u5b9a\u4e49\u4e24\u4e2a\u5b8f\u65b9\u4fbf\u66f4\u6362\u9519\u8bef\u5904\u7406\u51fd\u6570\uff0c\u8981\u6ce8\u610f\u662f\u6682\u65f6\u7684\u66f4\u6362\uff0c\u4e4b\u540e\u662f\u9700\u8981\u6362\u56de\u7cfb\u7edf\u9ed8\u8ba4\u7684</p>\n<p>```c++</p>\n<h1>if defined _MSC_VER &amp;&amp; _MSC_VER &gt;= 1900</h1>\n<p>extern _invalid_parameter_handler _Py_silent_invalid_parameter_handler;\n#define _Py_BEGIN_SUPPRESS_IPH { _invalid_parameter_handler _Py_old_handler = \\\n    _set_thread_local_invalid_parameter_handler(_Py_silent_invalid_parameter_handler);</p>\n<h1>define _Py_END_SUPPRESS_IPH _set_thread_local_invalid_parameter_handler(_Py_old_handler); }</h1>\n<h1>else</h1>\n<h1>define _Py_BEGIN_SUPPRESS_IPH</h1>\n<h1>define _Py_END_SUPPRESS_IPH</h1>\n<h1>endif /<em> _MSC_VER &gt;= 1900 </em>/</h1>\n<p>```</p>\n<p>\u4e4b\u540e\u5728\u6709\u53ef\u80fd\u89e6\u53d1 Windows \u6587\u4ef6\u53e5\u67c4\u9519\u8bef\u7684\u5730\u65b9\uff0c\u524d\u540e\u5206\u522b\u52a0\u4e0a\u5b8f<code>_Py_BEGIN_SUPPRESS_IPH</code> \u548c <code>_Py_END_SUPPRESS_IPH</code>\uff0c\u4e4b\u540e\u518d\u68c0\u67e5\u9519\u8bef\u7801\u5c31\u53ef\u4ee5\u4e86\uff0c\u9700\u8981\u4fee\u6539\u5230\u7684\u5730\u65b9\u4e0d\u5c11\uff0c\u53c2\u8003\u522b\u4eba\u7684 commit \u6765\u4fee\u6539\uff1a\n<a href=\"https://github.com/kovidgoyal/cpython/commit/a9ec814d466d3c0139d10b69666f88eed10e4940\">\u5728\u8fd9\u91cc</a></p>\n<h2>\u7ed3\u675f</h2>\n<p>\u81f3\u6b64 Python 2.7.11 \u5c31\u53ef\u4ee5\u5728 VS2015 \u91cc\u9762\u6b63\u5e38\u7f16\u8bd1\u548c\u8fd0\u884c\u4e86\uff0c\u4e0d\u8fc7\u7531\u4e8e Python \u5b98\u65b9\u662f\u4e0d\u63a8\u8350\u8fd9\u6837\u8bbe\u7f6e</p>\n<pre><code>***WARNING***\nBuilding Python 2.7 for Windows using any toolchain that doesn't link\nagainst MSVCRT90.dll is *unsupported* as the resulting python.exe will\nnot be able to use precompiled extension modules that do link against\nMSVCRT90.dll.\n</code></pre>\n<p>\u6240\u4ee5\u4f7f\u7528\u7684\u65f6\u5019\u6700\u597d\u8981\u6ce8\u610f\u4e00\u4e0b\u3002</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/unity-Unity%E4%BA%BA%E7%89%A9%E6%8E%A7%E5%88%B6/",
            "url": "https://wiki.disenone.site/unity-Unity%E4%BA%BA%E7%89%A9%E6%8E%A7%E5%88%B6/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Unity\u4eba\u7269\u63a7\u5236",
            "content_html": "<p><meta property=\"og:title\" content=\"Unity\u4eba\u7269\u63a7\u5236\" /></p>\n<p><img alt=\"\" src=\"assets/img/2014-3-15-unity-3rdperson-control0/run_jump.gif\"></p>\n<p>\u4eba\u7269\u7684\u52a8\u4f5c\u63a7\u5236\u662f\u6e38\u620f\u91cc\u9762\u5f88\u91cd\u8981\u7684\u4e00\u90e8\u5206\uff0c\u64cd\u4f5c\u6027\u5f3a\u7684\u6e38\u620f\u80fd\u591f\u5f88\u597d\u7684\u5438\u5f15\u73a9\u5bb6\u3002\u8fd9\u91cc\u6211\u5c31\u5c1d\u8bd5\u505a\u4e00\u4e2a\u7b80\u5355\u7684\u4eba\u7269\u64cd\u4f5c\u63a7\u5236\uff0c\u4eba\u7269\u80fd\u591f\u5b8c\u6210\u57fa\u672c\u7684\u79fb\u52a8\uff0c\u5305\u62ec\u884c\u8d70\uff0c\u8df3\u8dc3\u3002</p>\n<h2>\u9700\u6c42</h2>\n<p>\u5148\u6765\u8003\u8651\u4e00\u4e0b\uff0c\u6211\u4eec\u7684\u4eba\u7269\u64cd\u4f5c\u5177\u4f53\u7684\u9700\u6c42\uff1a</p>\n<ol>\n<li>\u884c\u8d70\uff0c\u80fd\u591f\u5728\u521a\u4f53\u7684\u8868\u9762\u884c\u8d70\uff0c\u7531\u6309\u952e\u4e0a\u4e0b\u5de6\u53f3\u8f93\u5165\u6765\u63a7\u5236\uff0c\u6682\u4e0d\u8003\u8651\u52a0\u901f\u51cf\u901f\u8fc7\u7a0b</li>\n<li>\u884c\u8d70\u7684\u901f\u5ea6\u5728\u4e0d\u540c\u65b9\u5411\u4e0a\u53ef\u4ee5\u4e0d\u540c\uff0c\u4f8b\u5982\u540e\u9000\u5e94\u8be5\u6bd4\u524d\u8fdb\u6162</li>\n<li>\u8df3\u8dc3\uff0c\u7531jump\u6309\u952e\u63a7\u5236\uff0c\u4eba\u7269\u4ee5\u4e00\u5b9a\u521d\u901f\u5ea6\u4ece\u4e0a\u79bb\u5f00\u5730\u9762\uff0c\u5e76\u6162\u6162\u56de\u843d\u5230\u5730\u9762</li>\n</ol>\n<p>\u90a3\u4e48\u5927\u81f4\u7684\u601d\u8def\u5c31\u662f\uff1a\u7528\u901f\u5ea6\u6765\u63cf\u8ff0\u4eba\u7269\u7684\u8fd0\u52a8\uff0c\u901f\u5ea6\u6bcf\u4e2a\u65b9\u5411\u4e0a\u7684\u5206\u91cf\u53ef\u4ee5\u5206\u522b\u8ba1\u7b97\uff0c\u6700\u540e\u901f\u5ea6\u4e58\u4ee5\u65f6\u95f4\u5c31\u662f\u4eba\u7269\u7684\u4f4d\u7f6e\u504f\u79fb\u4e86\u3002</p>\n<h2>\u4eba\u7269\u7ec4\u4ef6\u8bbe\u7f6e</h2>\n<p>\u5728\u4e3a\u4eba\u7269\u5199\u811a\u672c\u6765\u64cd\u4f5c\u63a7\u5236\u524d\uff0c\u9700\u8981\u4e00\u4e9b\u51c6\u5907\u5de5\u4f5c\uff0c\u628a\u4eba\u7269\u7684\u76f8\u5173\u7ec4\u4ef6\u5148\u914d\u7f6e\u597d\uff1a</p>\n<ol>\n<li>\u4e3a\u4e86\u63a7\u5236\u4eba\u7269\u5e76\u4f7f\u4eba\u7269\u6709\u4e00\u4e9b\u521a\u6027\u7269\u7406\u4e0a\u7684\u8868\u73b0\u9700\u8981\u4e3a\u4eba\u7269\u6dfb\u52a0\u4e00\u4e2a<code>Character Controller Component</code></li>\n<li>\u4e3a\u4e86\u7ed3\u6784\u66f4\u5206\u660e\u4e00\u4e9b\uff0c\u5148\u628a\u5173\u4e8e\u4eba\u7269\u7684\u64cd\u4f5c\u8f93\u5165\u5206\u51fa\u6765\uff0c\u8bfb\u53d6\u8f93\u5165\u5e76\u521d\u6b65\u5904\u7406\u540e\u628a\u7ed3\u679c\u4f20\u7ed9\u4eba\u7269\u63a7\u5236\u5668\uff0c\u628a\u8fd9\u90e8\u5206\u7684\u811a\u672c\u547d\u540d\u4e3a<code>MyThirdPersonInput.cs</code>\uff1b</li>\n<li>\u771f\u6b63\u63a7\u5236\u4eba\u7269\u79fb\u52a8\u7684\u811a\u672c\u547d\u540d\u4e3a<code>MyThirdPersonController.cs</code></li>\n</ol>\n<p>\u914d\u7f6e\u540e\u7684\u7ed3\u679c\u662f\u8fd9\u6837\uff1a\n<img alt=\"\" src=\"assets/img/2014-3-15-unity-3rdperson-control0/setting.png\"></p>\n<h2>\u8f93\u5165</h2>\n<p>\u8f93\u5165\u5c31\u662f\u4e0a\u4e0b\u5de6\u53f3\u548c\u8df3\u8dc3\uff0c\u65b9\u5411\u9700\u8981\u505a\u4e00\u4e2a\u5f52\u4e00\u5316\u7684\u5904\u7406\uff1a</p>\n<p>```c#\n// get movement from input\nvar direction = new Vector3(Input.GetAxis(\"Horizontal\"), 0, \n    Input.GetAxis(\"Vertical\"));\nif (direction != Vector3.zero)\n{\n    // constrain length to [0, 1]\n    var directionLength = direction.magnitude;\n    directionLength = Math.Min(1, directionLength);\n    direction = direction.normalized * directionLength;\n}\nperson.inputMoveDirction = direction;\nperson.inputJump = Input.GetButton(\"Jump\");\n````</p>\n<h2>\u63cf\u8ff0\u79fb\u52a8\u548c\u8df3\u8dc3</h2>\n<p>\u6211\u4eec\u9700\u8981\u7528\u4e00\u4e9b\u53d8\u91cf\u6765\u63cf\u8ff0\u4eba\u7269\u7684\u52a8\u4f5c\uff0c\u4f8b\u5982\u79fb\u52a8\u901f\u5ea6\uff0c\u8df3\u8dc3\u901f\u5ea6\u7b49\uff0c\u79fb\u52a8\u7528\u4e0b\u9762\u53d8\u91cf\u63cf\u8ff0\uff1a</p>\n<p><code>c#    \n[System.Serializable]\npublic class Movement\n{\n    public float forwardSpeed = 5F;\n    public float backwardSpeed = 5F;\n    public float sidewardSpeed = 5F;\n}\npublic Movement movement = new Movement();</code></p>\n<p><code>[System.Serializable]</code>\u662f\u4e3a\u4e86\u8ba9\u8fd9\u4e9b\u53c2\u6570\u66b4\u9732\u5230Inspector\u4e0a\u3002\u8df3\u8dc3\u7684\u63cf\u8ff0\u5982\u4e0b\uff1a</p>\n<p><code>c#\n[System.Serializable]\npublic class Jumping \n{\n    public bool enable = true;      // true if can jump\n    public float jumpSpeed = 5F;    // original speed when jump\n    public float gravity = 10F;\n    public float maxFallSpeed = 20F;\n    public bool jumping = false;    // true if now in the air\n}\npublic Jumping jumping = new Jumping();</code></p>\n<h2>\u5206\u89e3\u901f\u5ea6</h2>\n<p>\u4e3a\u4e86\u65b9\u4fbf\u63cf\u8ff0\u4e0d\u540c\u65b9\u5411\u7684\u79fb\u52a8\uff0c\u628a\u65b9\u5411\u5206\u6210\u4e09\u4e2a\u5206\u91cf\uff1a\u524d\u540e\u3001\u5de6\u53f3\u3001\u4e0a\u4e0b\uff0c\u5206\u522b\u6c42\u89e3\u3002</p>\n<p>\u524d\u540e\u901f\u5ea6\u4e0d\u540c\uff0c\u6839\u636e\u6570\u503c\u7684\u6b63\u8d1f\u5224\u65ad\uff1a</p>\n<p><code>c#\nif (velocity.z &gt; 0)\n    velocity.z *= movement.forwardSpeed;\nelse\n    velocity.z *= movement.backwardSpeed;</code></p>\n<p>\u5de6\u53f3\u901f\u5ea6\u4e00\u81f4\uff1a</p>\n<p><code>c#\nvelocity.x = inputMoveDirction.x * movement.sidewardSpeed;</code></p>\n<p>\u8df3\u8dc3\u9ebb\u70e6\u4e00\u70b9\uff0c\u8981\u5224\u65ad\u5f53\u524d\u4eba\u7269\u7684\u72b6\u6001\uff1a</p>\n<ul>\n<li>\u5982\u679c\u5df2\u7ecf\u5728\u7a7a\u4e2d\uff0c\u7528\u91cd\u529b\u8ba1\u7b97\u901f\u5ea6</li>\n<li>\u5982\u679c\u5728\u5730\u4e0a\uff1a</li>\n<li>\n<ul>\n<li>\u5982\u679c\u6309\u4e0b\u8df3\u8dc3\u952e\uff0c\u901f\u5ea6\u4e3a\u8df3\u8dc3\u521d\u59cb\u901f\u5ea6</li>\n</ul>\n</li>\n<li>\n<ul>\n<li>\u5426\u5219y\u65b9\u5411\u901f\u5ea6\u4e3a0</li>\n</ul>\n</li>\n</ul>\n<p><code>c#\nif (!isOnGround)\n{\n    yVelocity = Math.Max(yVelocity - jumping.gravity * Time.deltaTime, \n        -jumping.maxFallSpeed);\n}\nelse\n{\n    if (jumping.enable &amp;&amp; inputJump)\n    {\n        yVelocity = jumping.jumpSpeed;\n    }\n    else\n        yVelocity = 0F;\n}</code></p>\n<h2>\u66f4\u65b0\u4eba\u7269\u4f4d\u7f6e</h2>\n<p>\u8ba1\u7b97\u51fa\u6765\u7684\u901f\u5ea6\u5047\u5b9a\u4e3a\u4ece\u672c\u5e27\u5f00\u59cb\u7684\u901f\u5ea6\uff0c\u90a3\u4e48\u672c\u5e27\u8ba1\u7b97\u4f4d\u7f6e\u7684\u901f\u5ea6\u5e94\u8be5\u662f\u524d\u4e00\u5e27\u8ba1\u7b97\u51fa\u6765\u7684\uff0c\u56e0\u6b64\u5728\u66f4\u65b0\u901f\u5ea6\u524d\uff0c\u5148\u8ba1\u7b97\u4eba\u7269\u7684\u65b0\u4f4d\u7f6e\uff1a</p>\n<p><code>c#\n// move to new position\nvar collisionFlag = controller.Move(velocity * Time.deltaTime);\nisOnGround = (collisionFlag &amp; CollisionFlags.CollidedBelow) != 0;</code></p>\n<p><code>controller.Move</code>\u4f1a\u8fd4\u56de<code>CollisionFlags</code>\u6765\u8868\u793a\u78b0\u649e\u7684\u72b6\u6001\uff0c\u901a\u8fc7\u8fd9\u4e2a\u72b6\u6001\u5c31\u53ef\u4ee5\u77e5\u9053\u4eba\u7269\u662f\u4e0d\u662f\u7ad9\u5728\u5730\u9762\u4e0a\u3002</p>\n<p>\u5b8c\u6574\u4ee3\u7801\uff1a</p>\n<p>MyThirdPersonInput.cs:</p>\n<p>```c#\nusing UnityEngine;\nusing System;\nusing System.Collections;\n[RequireComponent(typeof(MyThirdPersonController))]</p>\n<p>public class MyThirdPersonInput : MonoBehaviour {</p>\n<pre><code>private MyThirdPersonController person;\n\nvoid Awake()\n{\n    person = GetComponent&lt;MyThirdPersonController&gt;();\n}\n\n// Update is called once per frame\nvoid Update () \n{\n    // get movement from input\n    var direction = new Vector3(Input.GetAxis(\"Horizontal\"), 0, \n        Input.GetAxis(\"Vertical\"));\n\n    if (direction != Vector3.zero)\n    {\n        // constrain length to [0, 1]\n        var directionLength = direction.magnitude;\n\n        directionLength = Math.Min(1, directionLength);\n\n        direction = direction.normalized * directionLength;\n\n    }\n\n    person.inputMoveDirction = direction;\n    person.inputJump = Input.GetButton(\"Jump\");\n\n}\n</code></pre>\n<p>}</p>\n<p>```</p>\n<p>MyThirdPersonController.cs:</p>\n<p>```c#\nusing UnityEngine;\nusing System;\nusing System.Collections;</p>\n<p>public class MyThirdPersonController : MonoBehaviour {</p>\n<pre><code>// The current global direction we want the character to move in.\n[System.NonSerialized]\npublic Vector3 inputMoveDirction = Vector3.zero;\n\n// Is the jump button held down? We use this interface instead of checking\n// for the jump button directly so this script can also be used by AIs.\n[System.NonSerialized]\npublic bool inputJump = false;\n\n[System.Serializable]\npublic class Movement\n{\n    public float forwardSpeed = 5F;\n    public float backwardSpeed = 5F;\n    public float sidewardSpeed = 5F;\n}\npublic Movement movement = new Movement();\n\n[System.Serializable]\npublic class Jumping \n{\n    public bool enable = true;      // true if can jump\n    public float jumpSpeed = 5F;    // original speed when jump\n    public float gravity = 10F;     \n    public float maxFallSpeed = 20F;\n    public bool jumping = false;    // true if now in the air\n}\npublic Jumping jumping = new Jumping();\n\nprivate CharacterController controller;\nprivate Vector3 velocity = Vector3.zero;\nprivate bool isOnGround = true;\n// Use this for initialization\nvoid Start () \n{\n    controller = GetComponent&lt;CharacterController&gt;();\n}\n\n// Update is called once per frame\nvoid FixedUpdate() \n{\n    // move to new position\n    var collisionFlag = controller.Move(velocity * Time.deltaTime);\n    isOnGround = (collisionFlag &amp; CollisionFlags.CollidedBelow) != 0;\n\n    // update velocity\n    float yVelocity = velocity.y;\n    velocity = Vector3.zero;\n\n    // x-z plane velocity\n    if (inputMoveDirction != Vector3.zero)\n    {\n        velocity.z = inputMoveDirction.z;\n        if (velocity.z &gt; 0)\n            velocity.z *= movement.forwardSpeed;\n        else\n            velocity.z *= movement.backwardSpeed;\n\n        velocity.x = inputMoveDirction.x * movement.sidewardSpeed;\n    }\n\n    // y velocity\n    if (!isOnGround)\n    {\n        yVelocity = Math.Max(yVelocity - jumping.gravity * Time.deltaTime, \n            -jumping.maxFallSpeed);\n    }\n    else\n    {\n        if (jumping.enable &amp;&amp; inputJump)\n        {\n            yVelocity = jumping.jumpSpeed;\n        }\n        else\n            yVelocity = 0F;\n    }\n\n    velocity = transform.rotation * velocity;\n    velocity.y = yVelocity;\n}\n</code></pre>\n<p>}\n```</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/unity-Unity%E5%AE%9E%E7%8E%B0%E4%BD%93%E7%A7%AF%E5%85%89%E7%85%A7%E6%95%A3%E5%B0%84/",
            "url": "https://wiki.disenone.site/unity-Unity%E5%AE%9E%E7%8E%B0%E4%BD%93%E7%A7%AF%E5%85%89%E7%85%A7%E6%95%A3%E5%B0%84/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Unity\u5b9e\u73b0\u4f53\u79ef\u5149\u7167\u6563\u5c04 (Volumetric Light Scattering\uff0c\u4e91\u9699\u5149)",
            "content_html": "<p><meta property=\"og:title\" content=\"Unity\u5b9e\u73b0\u4f53\u79ef\u5149\u7167\u6563\u5c04 (Volumetric Light Scattering\uff0c\u4e91\u9699\u5149)\" /></p>\n<h2>\u539f\u7406</h2>\n<p>Volumetric Light Scattering \u7684\u539f\u7406\u53ef\u4ee5\u53c2\u8003\u300aGPU Gems 3\u300b<a href=\"http://http.developer.nvidia.com/GPUGems3/gpugems3_ch13.html\">\u7b2c13\u7ae0</a>\uff0c\u4e66\u4e0a\u6709\u6548\u679c\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2014-3-30-unity-light-scattering/goodeffect.png\"></p>\n<p>\u597d\u770b\u5427\uff0c\u90a3\u597d\uff0c\u6211\u4eec\u7684\u76ee\u6807\u5c31\u662f\u5b9e\u73b0\u8fd9\u79cd\u6548\u679c\u3002</p>\n<p>\u4e66\u4e0a\u4ecb\u7ecd\u4e86\u539f\u7406\uff0c\u4e00\u6761\u5173\u952e\u7684\u516c\u5f0f\u662f\uff1a</p>\n<p>\\[ L(s, \\theta, \\phi) = exposure \\times \\sum_{i=0}^n decay^i \\times weight \\times \\frac{L( s_i, \\theta_i )}{n} \\]</p>\n<p>\u6211\u7684\u7406\u89e3\u662f\uff0c\u5bf9\u4e8e\u56fe\u50cf\u4e0a\u7684\u6bcf\u4e2a\u50cf\u7d20\uff0c\u5149\u7ebf\u90fd\u6709\u53ef\u80fd\u7167\u5c04\u5230\uff0c\u90a3\u4e48\u5bf9\u8be5\u50cf\u7d20\u5230\u5149\u6e90(\u5728\u6295\u5f71\u5230\u56fe\u50cf\u4e0a\u7684\u4f4d\u7f6e)\u7684\u8fde\u7ebf\u8fdb\u884c\u91c7\u6837(\u5bf9\u5e94\u516c\u5f0f\u4e0a\\(i\\))\uff0c\u91c7\u6837\u51fa\u7684\u7ed3\u679c\u8fdb\u884c\u52a0\u6743\u5e73\u5747(\u5bf9\u5e94\u516c\u5f0f\u4e0a\\(\\sum\\))\u5e76\u4f5c\u4e3a\u8be5\u50cf\u7d20\u7684\u65b0\u7684\u989c\u8272\u503c\u3002\u53e6\u5916\u8fd8\u6709\u5173\u952e\u7684\u540e\u7f6e\u50cf\u7d20\u7740\u8272\u5668\uff0c\u4f46\u662f\u5982\u679c\u53ea\u662f\u7528\u90a3\u4e2a\u7740\u8272\u5668\u6765\u5bf9\u76f8\u673a\u6e32\u67d3\u7684\u7ed3\u679c\u8fdb\u884c\u5904\u7406\uff0c\u4f1a\u4ea7\u751f\u660e\u663e\u7684\u4eba\u5de5\u75d5\u8ff9\uff0c\u6709\u8bb8\u591a\u7684\u6761\u7eb9\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2014-3-30-unity-light-scattering/badeffect.png\"></p>\n<p>\u90a3\u4e48\u4e66\u4e0a\u7684\u6548\u679c\u662f\u600e\u4e48\u505a\u51fa\u6765\u7684\uff1f\u5176\u5b9e\u4e66\u4e0a\u5df2\u7ecf\u7ed9\u51fa\u4e86\u7b54\u6848\uff0c\u53ef\u4ee5\u7528\u4e00\u7ec4\u56fe\u6765\u9610\u8ff0\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2014-3-30-unity-light-scattering/steps.png\"></p>\n<p>\u56fea \u5c31\u662f\u7c97\u7cd9\u7684\u6548\u679c\uff0c\u7ec6\u5fc3\u5730\u53ef\u4ee5\u770b\u5230\u6709\u8bb8\u591a\u6761\u7eb9\uff0c\u5e76\u4e14\u6ca1\u6709\u906e\u6321\u4e0d\u591f\u771f\u5b9e\uff0cb\u3001c\u3001 d\u5c31\u662f\u4e3a\u4e86\u83b7\u5f97\u597d\u7684\u6548\u679c\u9700\u8981\u8fdb\u884c\u7684\u6b65\u9aa4\uff1a</p>\n<p>b. \u628a\u706f\u5149\u8f90\u5c04\u6548\u679c\u6e32\u67d3\u5230\u56fe\u50cf\u4e0a\uff0c\u5e76\u52a0\u4e0a\u7269\u4f53\u7684\u906e\u6321</p>\n<p>c. \u5bf9b\u6267\u884c Volumetric Light Scattering \u50cf\u7d20\u7740\u8272\u5668\uff0c\u5f97\u5230\u906e\u6321\u540e\u7684\u6548\u679c</p>\n<p>d. \u6dfb\u52a0\u4e0a\u628a\u771f\u5b9e\u573a\u666f\u7684\u989c\u8272</p>\n<p>\u90a3\u4e48\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u4e00\u6b65\u4e00\u6b65\u5730\u5b9e\u73b0\u3002</p>\n<h2>\u753b\u906e\u6321\u7269\u4f53</h2>\n<p>\u5728\u5b9e\u9645\u7684\u64cd\u4f5c\u4e2d\uff0c\u6211\u5148\u7528<code>RenderWithShader</code>\u6765\u628a\u4f1a\u53d1\u751f\u906e\u6321\u7684\u7269\u4f53\u753b\u6210\u9ed1\u8272\uff0c\u5176\u4ed6\u5730\u65b9\u4e3a\u767d\u8272\uff0c\u56e0\u4e3a\u8fd9\u9700\u8981\u5bf9\u6bcf\u4e2a\u9762\u7247\u8fdb\u884c\u6e32\u67d3\uff0c\u56e0\u6b64\u5bf9\u4e8e\u590d\u6742\u7684\u573a\u666f\uff0c\u4f1a\u5e26\u6765\u4e00\u5b9a\u7684\u6027\u80fd\u6d88\u8017\u3002\u573a\u666f\u4e2d\u7684\u7269\u4f53\u6709\u4e0d\u900f\u660e\u548c\u900f\u660e\u7684\uff0c\u6211\u4eec\u5e0c\u671b\u4e0d\u900f\u660e\u7684\u7269\u4f53\u4ea7\u751f\u5b8c\u5168\u7684\u5149\u7ebf\u906e\u6321\uff0c\u800c\u900f\u660e\u7684\u7269\u4f53\u5e94\u8be5\u4ea7\u751f\u90e8\u5206\u7684\u906e\u6321\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u9488\u5bf9\u4e0d\u540cRenderType\u7684\u7269\u4f53\u5199\u4e0d\u540c\u7684Shader\uff0cRenderType\u662fSubShader\u7684Tag\uff0c\u4e0d\u6e05\u695a\u7684\u8bdd\u53ef\u4ee5\u770b<a href=\"http://docs.unity3d.com/Documentation/Components/SL-SubshaderTags.html\">\u8fd9\u91cc</a>\uff0c\u5199\u597d\u4e4b\u540e\u8c03\u7528\uff1a</p>\n<p>```c#\ncamera.RenderWithShader(objectOcclusionShader, \"RenderType\");</p>\n<p><code>``</code>RenderWithShader`\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u5c31\u662f\u8981\u6c42\u6839\u636eRenderType\u6765\u66ff\u6362Shader\uff0c\u7b80\u5355\u6765\u8bf4\uff0c\u540c\u4e00\u4e2a\u7269\u4f53\u7684\u66ff\u6362\u7684Shader\u7684RenderType\u8981\u8ddf\u66ff\u6362\u524d\u4e00\u81f4\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u4e3a\u4e0d\u540c\u7684RenderType\u7684\u7269\u4f53\u4f7f\u7528\u4e0d\u540c\u7684Shader\uff1a</p>\n<p>```glsl\nShader \"Custom/ObjectOcclusion\" \n{\n    Properties \n    {\n        _MainTex (\"Base (RGB)\", 2D) = \"white\" {}\n    }\n    SubShader \n    {\n        Tags \n        {\n            \"Queue\" = \"Geometry\"\n            \"RenderType\" = \"Opaque\"\n        }\n        LOD 200\n        Pass\n        {\n            Lighting Off\n            ZTest Always Cull Off ZWrite Off\n            Fog { Mode off }\n            CGPROGRAM\n            #pragma vertex vert\n            #pragma fragment frag\n            #include \"UnityCG.cginc\"</p>\n<pre><code>        uniform sampler2D _MainTex;\n\n        v2f_img vert(appdata_img i)\n        {\n            v2f_img o;\n            o.pos = mul (UNITY_MATRIX_MVP, i.vertex);\n            return o;\n        }\n\n        half4 frag(v2f_img i): COLOR\n        {\n            return half4(0, 0, 0, 1);\n        }\n        ENDCG\n    }\n\n}\n    SubShader \n{\n    Tags \n    {\n        \"Queue\" = \"Geometry\"\n        \"RenderType\" = \"Transparent\"\n    }\n    LOD 200\n    Pass\n    {\n        Lighting Off\n        ZTest Always Cull Off ZWrite Off\n        Fog { Mode off }\n        Blend SrcAlpha OneMinusSrcAlpha     // blend for transparent objects\n        CGPROGRAM\n        #pragma vertex vert\n        #pragma fragment frag\n        #include \"UnityCG.cginc\"\n\n        uniform sampler2D _MainTex;\n\n        v2f_img vert(appdata_img i)\n        {\n            v2f_img o;\n            o.pos = mul (UNITY_MATRIX_MVP, i.vertex);\n            o.uv = MultiplyUV( UNITY_MATRIX_TEXTURE0, i.texcoord );\n            return o;\n        }\n\n        half4 frag(v2f_img i): COLOR\n        {\n            half3 output = (1, 1, 1);\n            half4 color = tex2D(_MainTex, i.uv);\n            half alpha = color.a;\n            return half4(output *(1-alpha), alpha);\n        }\n        ENDCG\n    }\n\n}\n\nFallBack \"Diffuse\"\n</code></pre>\n<p>}</p>\n<p>```</p>\n<p>\u6ce8\u610f\u4e0d\u900f\u660e\u548c\u900f\u660e\u7269\u4f53\u7684Shader\u95f4\u7684\u5dee\u522b\uff1a\u4e0d\u900f\u660e\u7684\u7269\u4f53\u76f4\u63a5\u753b\u6210\u9ed1\u8272\uff1b\u4e0d\u900f\u660e\u7269\u4f53\u9700\u8981\u6267\u884cblending\uff0c\u83b7\u53d6\u7269\u4f53\u7eb9\u7406\u4e0a\u7684alpha\u901a\u9053\uff0c\u5e76\u57fa\u4e8e\u8fd9\u4e2aalpha\u8fdb\u884cblending\u3002\u4e0a\u9762\u4ee3\u7801\u53ea\u662f\u5217\u4e3e\u4e86Opaque\u548cTransparent\uff0c\u53e6\u5916\u8fd8\u6709TreeOpaque (Shader\u8ddfOpaque\u4e00\u6837\uff0c\u53ea\u662f\u6539\u53d8RenderType) \uff0cTreeTransparentCutout (\u540cTransparent) \u7b49\u3002\u7531\u4e8e\u6307\u5b9a\u4e86RenderType\uff0c\u6240\u4ee5\u4e3a\u4e86\u5168\u9762\uff0c\u9700\u8981\u5c3d\u53ef\u80fd\u7a77\u5c3d\u573a\u666f\u4e2d\u7684\u4f1a\u53d1\u751f\u906e\u6321\u7684\u7269\u4f53\uff0c\u6211\u8fd9\u91cc\u5c31\u53ea\u6709\u524d\u9762\u63d0\u5230\u7684\u56db\u79cd\u3002\u7ed3\u679c\u5927\u81f4\u5982\u4e0b\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2014-3-30-unity-light-scattering/objectocclusion.png\"></p>\n<h2>\u7ed3\u5408\u7269\u4f53\u906e\u6321\u753b\u5149\u6e90\u8f90\u5c04</h2>\n<p>\u753b\u5149\u6e90\u7684\u8f90\u5c04\u4e0d\u96be\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u9700\u8981\u6839\u636e\u5c4f\u5e55\u7684\u5927\u5c0f\u505a\u4e00\u4e9b\u5904\u7406\uff0c\u4f7f\u5f97\u5149\u6e90\u7684\u8f90\u5c04\u72b6\u662f\u5706\u5f62\u7684\uff1a</p>\n<p>```c#\nShader \"Custom/LightRadiate\" \n{\n    Properties \n    {\n        _MainTex (\"Base (RGB)\", RECT) = \"white\" {}\n        _LightPos (\"Light Pos In Screen Space(XY)\", Vector) = (0, 0, 0, 1)\n        _LightRadius (\"Light radiation radius (Pixel)\", Float) = 50\n    }\n    SubShader \n    {\n        Tags { \"RenderType\"=\"Opaque\" }\n        LOD 200\n        Pass\n        {\n            ZTest Always Cull Off ZWrite Off\n            Fog { Mode off }\n            CGPROGRAM\n            #pragma vertex vert\n            #pragma fragment frag\n            #include \"UnityCG.cginc\"</p>\n<pre><code>        uniform sampler2D _MainTex;\n        float4 _LightPos;\n        float _LightRadius;\n\n        v2f_img vert(appdata_img i)\n        {\n            v2f_img o;\n            o.pos = mul (UNITY_MATRIX_MVP, i.vertex);\n            o.uv = MultiplyUV( UNITY_MATRIX_TEXTURE0, i.texcoord );\n            return o;\n        }\n\n        half4 frag(v2f_img i): COLOR\n        {\n            half2 deltaTexCoord = (i.uv - _LightPos.xy) * half2(_ScreenParams.x, _ScreenParams.y);\n            float dis = dot(deltaTexCoord, deltaTexCoord);\n            const float maxDis = _LightRadius * _LightRadius;\n            dis = saturate((maxDis-dis) / maxDis * 0.5);\n            return half4(dis, dis, dis, 1) * half4(tex2D(_MainTex, i.uv).rgb, 1);               \n        }\n\n        ENDCG\n    }\n} \nFallBack \"Diffuse\"\n</code></pre>\n<p>}\n```</p>\n<p>\u8fd9\u4e2aShader\u9700\u8981\u8f93\u5165\u5149\u6e90\u5728\u5c4f\u5e55\u4e0a\u7684\u4f4d\u7f6e(\u53ef\u4ee5\u7528<code>camera.WorldToViewportPoint</code>\u6765\u8ba1\u7b97\uff0c\u5f97\u5230\u7684\u662fuv\u5750\u6807)\uff0c\u7136\u540e\u6839\u636e\u6307\u5b9a\u7684\u534a\u5f84\u753b\u4e00\u4e2a\u4eae\u5ea6\u5f80\u5916\u8870\u51cf\u7684\u5706\uff0c\u5e76\u628a\u7ed3\u679c\u8ddf\u524d\u9762\u5f97\u5230\u7684\u7269\u4f53\u906e\u6321\u56fe\u50cf(\u653e\u5728<code>_MainTex</code>\u91cc)\u7ed3\u5408\uff0c\u7ed3\u679c\u5927\u81f4\u4e3a\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2014-3-30-unity-light-scattering/light.png\"></p>\n<h2>Light Scattering\u5904\u7406\uff0c\u5e76\u7ed3\u5408\u771f\u5b9e\u989c\u8272</h2>\n<p>\u8fd9\u91cc\u5c31\u8981\u7528\u5230\u4e66\u4e0a\u63d0\u4f9b\u7684Pixel Shader\uff0c\u6211\u7684\u7248\u672c\uff1a</p>\n<p>```glsl\nShader \"Custom/LightScattering\" \n{\n    Properties \n    {\n        _MainTex (\"Base (RGB)\", 2D) = \"white\" {}\n        _LightRadTex(\"Light Radiate Tex (RGB)\", 2D) = \"white\" {}\n        _LightPos (\"Light Pos In Screen Space(XY)\", Vector) = (0, 0, 0, 1)\n        _Params(\"Density Weight Decay Exposure\", Vector) = (1.0, 1.0, 1.0, 1.0)\n    }\n    SubShader \n    {\n        LOD 200\n        Pass\n        {\n            ZTest Always Cull Off ZWrite Off\n            Fog { Mode off }  <br>\n            CGPROGRAM\n            #pragma vertex vert\n            #pragma fragment frag\n            #pragma target 3.0\n            #include \"UnityCG.cginc\"</p>\n<pre><code>        uniform sampler2D _MainTex;\n        uniform sampler2D _LightRadTex;\n        uniform float4 _LightPos;\n        uniform float4 _Params;\n\n        v2f_img vert(appdata_img i)\n        {\n            v2f_img o;\n            o.pos = mul (UNITY_MATRIX_MVP, i.vertex);\n            o.uv = MultiplyUV( UNITY_MATRIX_TEXTURE0, i.texcoord );\n            return o;\n        }\n\n        half4 frag(v2f_img i): COLOR\n        {   \n            // Calculate vector from pixel to light source in screen space\n            float2 deltaTexCoord = (i.uv - _LightPos.xy);\n\n            // Divide by number of samples and scale by control factor, here I use 32 samples\n            deltaTexCoord *= 1.0f / 32 * _Params.x; //density;\n\n            // Store color.\n            half3 color = tex2D(_MainTex, i.uv).rgb;\n\n            // Store initial sample.\n            half3 light = tex2D(_LightRadTex, i.uv).rgb;\n\n            // Set up illumination decay factor.\n            half illuminationDecay = 1.0f;\n\n            for(int j = 0; j &lt; 31; ++j)\n            {\n                // Step sample location along ray.\n                i.uv -= deltaTexCoord;\n\n                // Retrieve sample at new location.\n                half3 sample = tex2D(_LightRadTex, i.uv).rgb;\n\n                // Apply sample attenuation scale/decay factors.\n                sample *= illuminationDecay * 0.03125 * _Params.y ; //weight;\n\n                // Accumulate combined light.\n                light += sample;\n\n                // Update exponential decay factor.\n                illuminationDecay *= _Params.z;             //decay;\n            }\n\n            // Output final color with a further scale control factor.\n            return half4(color+(light * _Params.w), 1); // exposure\n        }\n\n        ENDCG       \n    }\n\n} \nFallBack \"Diffuse\"\n</code></pre>\n<p>}\n```</p>\n<p>\u5927\u4f53\u4e0a\u8ddf\u4e66\u4e0a\u7684\u4e00\u81f4\uff0c\u53ea\u662f\u6211\u7684\u53c2\u6570\u9700\u8981\u5728\u7a0b\u5e8f\u4e2d\u4f20\u8fdb\u6765\uff0c\u5e76\u4e14\u7ed3\u5408\u4e86\u771f\u5b9e\u7684\u989c\u8272\u56fe\u548cLight Scattering\u56fe\uff0c\u7ed3\u679c\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2014-3-30-unity-light-scattering/effect.gif\"></p>\n<h2>\u5b8c\u6574\u4ee3\u7801</h2>\n<p>\u4ee3\u7801\u5728<a href=\"assets/img/2014-3-30-unity-light-scattering/2014-3-30-unity-light-scattering.zip\">\u8fd9\u91cc</a>\uff0c\u628a<code>cs</code>\u811a\u672c\u6dfb\u52a0\u5230\u76f8\u673a\u4e0a\u3002</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/unity-Unity%E7%94%BB%E6%B7%B1%E5%BA%A6%E5%9B%BE%E5%92%8C%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B/",
            "url": "https://wiki.disenone.site/unity-Unity%E7%94%BB%E6%B7%B1%E5%BA%A6%E5%9B%BE%E5%92%8C%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Unity\u753b\u6df1\u5ea6\u56fe(Depth Map)\u548c\u8fb9\u7f18\u68c0\u6d4b(Edge Detection)",
            "content_html": "<p><meta property=\"og:title\" content=\"Unity\u753b\u6df1\u5ea6\u56fe(Depth Map)\u548c\u8fb9\u7f18\u68c0\u6d4b(Edge Detection)\" /></p>\n<p>\u521a\u63a5\u89e6Unity\u6ca1\u591a\u4e45\uff0c\u5bf9Unity\u7684ShaderLab\u4e00\u76f4\u5f88\u611f\u5174\u8da3\uff0c\u611f\u89c9\u5b83\u53ef\u4ee5\u5feb\u901f\u5730\u5b9e\u73b0\u5404\u79cd\u5404\u6837\u7684\u663e\u793a\u6548\u679c\uff0c\u5f88\u6709\u610f\u601d\u3002\u561b\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u95e8\u90fd\u8fd8\u6ca1\u5165\u7684\u4eba\uff0c\u6211\u5c31\u6765\u641e\u4e00\u641e\u6df1\u5ea6\u56fe\u548c\u8fb9\u7f18\u68c0\u6d4b\u5427\u3002</p>\n<h1>\u5c0f\u5730\u56fe\u8bbe\u7f6e</h1>\n<p>\u56e0\u4e3a\u6211\u53ea\u662f\u505a\u4e86\u4e00\u4e2a\u5c0f\u96cf\u5f62\uff0c\u6240\u4ee5\u6211\u4e0d\u6253\u7b97\u8be6\u7ec6\u5730\u8bb2\u5982\u4f55\u53bb\u5728\u573a\u666f\u4e0a\u753b\u5c0f\u5730\u56fe\uff0c\u5927\u81f4\u4e0a\u8bf4\u6211\u505a\u4e86\u4ee5\u4e0b\u4e00\u4e9b\u4e8b\u60c5\uff1a</p>\n<ol>\n<li>\u83b7\u53d6\u573a\u666f\u7684 bounding box\uff0c\u8fd9\u4e2a\u5728\u8bbe\u7f6e\u76f8\u673a\u7684\u53c2\u6570\u548c\u4f4d\u7f6e\u65f6\u6709\u7528</li>\n<li>\u628a\u5c0f\u5730\u56fe\u76f8\u673a\u914d\u7f6e\u6210\u6b63\u4ea4\u6295\u5f71\uff0c\u6839\u636e bounding box \u8bbe\u7f6e\u76f8\u673a\u7684\u8fd1\u5e73\u9762\u548c\u8fdc\u5e73\u9762</li>\n<li>\u4e3a\u8be5\u76f8\u673a\u589e\u52a0\u4e00\u4e2a\u4eba\u7269\u76ee\u6807\uff0c\u76ee\u6807\u4f1a\u663e\u793a\u5728\u5730\u56fe\u7684\u4e2d\u5fc3</li>\n<li>\u6bcf\u6b21\u66f4\u65b0\u76f8\u673a\u7684\u4f4d\u7f6e\uff0c\u6839\u636e\u76ee\u6807\u7684\u4f4d\u7f6e\uff0c\u8fd8\u6709\u573a\u666f\u7684\u6700\u5927 y \u503c</li>\n</ol>\n<p>\u5177\u4f53\u7684\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003\u540e\u9762\u7ed9\u51fa\u7684\u4ee3\u7801\u3002</p>\n<h1>\u83b7\u53d6\u6df1\u5ea6\u56fe</h1>\n<h2>depthTextureMode \u6765\u83b7\u53d6\u6df1\u5ea6\u56fe</h2>\n<p>\u76f8\u673a\u81ea\u5df1\u53ef\u4ee5\u4fdd\u5b58DepthBuffer\u6216\u8005\u4e00\u4e2aDepthNormalBuffer(\u53ef\u7528\u6765\u505a\u8fb9\u7f18\u68c0\u6d4b)\uff0c\u53ea\u9700\u8981\u8bbe\u7f6e</p>\n<p><code>c#\nCamera.depthTextureMode = DepthTextureMode.DepthNormals;</code></p>\n<p>\u7136\u540e\u5728Shader\u91cc\u9762\u5f15\u7528</p>\n<p><code>c#\nsampler2D _CameraDepthNormalsTexture;</code></p>\n<p>\u5c31\u53ef\u4ee5\u4e86\uff0c\u5177\u4f53\u7684\u505a\u6cd5\u53ef\u4ee5\u53c2\u8003\u6211\u540e\u9762\u7ed9\u51fa\u7684\u4ee3\u7801\u3002\u5173\u4e8e\u5728Z-Buffer\u91cc\u9762\u4fdd\u5b58\u7684\u6df1\u5ea6\u503c\u8ddf\u771f\u5b9e\u4e16\u754c\u7684\u6df1\u5ea6\u7684\u5173\u7cfb\u53ef\u4ee5\u53c2\u8003\u8fd9\u4e24\u7bc7\u6587\u7ae0\uff1a\n<a href=\"http://www.sjbaker.org/steve/omniv/love_your_z_buffer.html\">Learning to Love your Z-buffer</a>,<a href=\"http://www.humus.name/temp/Linearize%20depth.txt\">Linearize depth</a>\u3002\u53e6\u5916 Unity \u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e9b\u51fd\u6570\u6765\u8ba1\u7b97\u6df1\u5ea6: <code>Linear01Depth</code>, <code>LinearEyeDepth</code> \u7b49\u3002</p>\n<p>\u8fd9\u4e0d\u662f\u6211\u8fd9\u91cc\u8ba8\u8bba\u7684\u91cd\u70b9\uff0c\u6211\u60f3\u8bf4\u7684\u662f\uff0c\u672c\u6765\u6211\u7684\u76f8\u673a\u8bbe\u7f6e\u4e3a\u6b63\u4ea4\u6295\u5f71\uff0c\u6df1\u5ea6\u5e94\u8be5\u662f\u7ebf\u6027\u7684\uff0c\u4f46\u6211\u6d4b\u8bd5\u51fa\u6765\u5374\u4e0d\u662f\u7ebf\u6027\u3002\u7136\u540e\u6211\u7528\u4e0a\u9762\u94fe\u63a5\u4ecb\u7ecd\u7684\u65b9\u6cd5\u6765\u8ba1\u7b97\u771f\u5b9e\u4e16\u754c\u7684\u6df1\u5ea6\uff0c\u4e5f\u4e00\u76f4\u90fd\u4e0d\u6b63\u786e\uff0c\u4ee5\u81f3\u4e8e\u4e00\u76f4\u8ba1\u7b97\u4e0d\u51fa\u771f\u5b9e\u7684\u7ebf\u6027\u6df1\u5ea6\uff0c\u4e0d\u77e5\u9053\u662fUnity\u7684Z_Buffer\u7684\u95ee\u9898\u8fd8\u662f\u4ec0\u4e48\uff0c\u90a3\u4f4d\u670b\u53cb\u77e5\u9053\u7684\u8bf7\u6559\u6559\u6211\u3002\u5f53\u7136\uff0c\u5982\u679c\u4e0d\u9700\u8981\u771f\u5b9e\u7684\u6df1\u5ea6\u503c\uff0c\u5355\u5355\u662f\u6bd4\u8f83\u6df1\u5ea6\u7684\u5927\u5c0f\u4e4b\u7c7b\u7684\uff0c\u7528\u4e0a\u9762\u7684\u65b9\u6cd5\u5c31\u8db3\u591f\u4e86\uff0c\u800c\u4e14\u5f88\u7b80\u5355\u3002\u4f46\u662f\u5bf9\u4e8e\u6211\u8fd9\u91cc\u6765\u8bf4\uff0c\u6211\u60f3\u8981\u628a\u771f\u5b9e\u6df1\u5ea6\u6620\u5c04\u4e3a\u989c\u8272\u503c\uff0c\u9700\u8981\u83b7\u5f97\u771f\u5b9e\u7684\u7ebf\u6027\u7684\u6df1\u5ea6\u503c\uff08\u867d\u7136\u4e5f\u662f[0, 1]\uff09\uff0c\u6211\u53ea\u597d\u7528\u53e6\u5916\u4e00\u79cd\u7528 RenderWithShader \u65b9\u6cd5\u4e86\u3002</p>\n<h2>RenderWithShader \u6765\u83b7\u53d6\u6df1\u5ea6\u56fe</h2>\n<p>\u8fd9\u79cd\u65b9\u6cd5\u5176\u5b9e\u5c31\u662f\u7528Unity Reference\u91cc\u9762\u7684\u4e00\u4e2a\u4f8b\u5b50\uff1a<a href=\"http://docs.unity3d.com/Documentation/Components/SL-ShaderReplacement.html\">Rendering with Replaced Shaders</a>\u3002\u9700\u8981\u7406\u89e3\u7684\u662f\uff0c<code>RenderWithShader</code>\u4f1a\u628a\u573a\u666f\u4e2d\u7684\u76f8\u5e94\u7684Mesh\u753b\u4e00\u904d\u3002</p>\n<p>\u521b\u5efa\u4e00\u4e2a Shader :</p>\n<p>```glsl\nShader \"Custom/DepthByReplaceShader\" \n{\nSubShader \n{\n    Tags { \"RenderType\"=\"Opaque\" }\n    Pass {\n        Fog { Mode Off }\n        CGPROGRAM\n        #pragma vertex vert\n        #pragma fragment frag\n        #include \"UnityCG.cginc\"</p>\n<pre><code>    struct v2f {\n        float4 pos : SV_POSITION;\n        float2 depth : TEXCOORD0;\n    };\n\n    v2f vert (appdata_base v) {\n        v2f o;\n        o.pos = mul (UNITY_MATRIX_MVP, v.vertex);\n        UNITY_TRANSFER_DEPTH(o.depth);\n        return o;\n    }\n\n    float4 frag(v2f i) : COLOR {\n        //UNITY_OUTPUT_DEPTH(i.depth);\n        float d = i.depth.x/i.depth.y;\n        return float4(d, d, d, 1);\n    }\n    ENDCG\n}\n</code></pre>\n<p>}\n}\n```</p>\n<p>\u4e3a\u4f60\u7684\u5c0f\u5730\u56fe\u76f8\u673a(\u6ca1\u6709\u7684\u8bdd\u521b\u5efa\u4e4b)\u6dfb\u52a0\u4e00\u4e2a\u811a\u672c\uff0c\u628a\u76f8\u673a\u914d\u7f6e\u6210\u6b63\u4ea4\u6295\u5f71\u7b49\uff0c\u5e76\u4e14\u5728 <code>Update()</code> \u91cc\u9762\u4f7f\u7528\u8fd9\u4e2a Shader \u6765\u6e32\u67d3\u573a\u666f\uff1a</p>\n<p><code>c#\ncamera.targetTexture = depthTexture;\ncamera.RenderWithShader(depthShader, \"\");</code></p>\n<p>\u6e32\u67d3\u7684\u7ed3\u679c\u5c31\u4f1a\u4fdd\u5b58\u5728 <code>depthTexture</code>\u91cc\u9762\uff0c\u5f88\u7b80\u5355\u5427\u3002</p>\n<h2>\u628a\u6df1\u5ea6\u6620\u5c04\u6210\u989c\u8272</h2>\n<p>\u8981\u5b8c\u6210\u8fd9\u4e2a\u5de5\u4f5c\uff0c\u9996\u5148\u9700\u8981\u4e00\u5f20\u989c\u8272\u56fe\uff0c\u8fd9\u5f20\u56fe\u53ef\u4ee5\u7528 Matlab \u5f88\u7b80\u5355\u5730\u751f\u6210\uff0c\u4f8b\u5982\u6211\u7528\u7684\u662f Matlab \u91cc\u9762\u7684 jet \u56fe\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2014-3-27-unity-depth-minimap/jet.png\">{ width=\"200\" }</p>\n<p>\u628a\u8fd9\u5f20\u56fe\u653e\u5230\u9879\u76ee\u76ee\u5f55 <code>Assets\\Resources</code> \u91cc\u9762\uff0c\u5c31\u53ef\u4ee5\u5728\u7a0b\u5e8f\u4e2d\u8bfb\u53d6\uff1a</p>\n<p><code>c#\ncolorMap = Resources.Load&lt;Texture2D&gt;(\"colormap\");</code></p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u5f20\u56fe\u7247\u7684 <code>Wrap Mode</code> \u5e94\u8be5\u662f <code>Clamp</code>\uff0c\u9632\u6b62\u5728\u4e24\u8fb9\u7f18\u7684\u989c\u8272\u503c\u4e4b\u95f4\u8fdb\u884c\u63d2\u503c\u3002</p>\n<p>\u4e4b\u540e\u5c31\u9700\u8981\u4f7f\u7528 <code>OnRenderImage</code> \u548c <code>Graphics.Blit</code> \u51fd\u6570\uff0c\u51fd\u6570\u7684\u539f\u578b\u4e3a\uff1a</p>\n<p><code>c#\nvoid OnRenderImage(RenderTexture src, RenderTexture dst);\nstatic void Blit(Texture source, RenderTexture dest, Material mat, int pass = -1);</code></p>\n<p>\u8fd9\u4e2a\u51fd\u6570\u7684 src \u662f\u76f8\u673a\u6e32\u67d3\u7684\u7ed3\u679c\uff0cdst \u662f\u5904\u7406\u540e\u4f20\u56de\u7ed9\u76f8\u673a\u7684\u7ed3\u679c\uff0c\u56e0\u6b64\u8fd9\u4e2a\u51fd\u6570\u901a\u5e38\u662f\u7528\u6765\u5728\u76f8\u673a\u6e32\u67d3\u5b8c\u6210\u540e\u505a\u56fe\u7247\u7684\u4e00\u4e9b\u6548\u679c\uff0c\u4f8b\u5982\u6211\u4eec\u8fd9\u91cc\u7684\u5bf9\u6df1\u5ea6\u505a\u989c\u8272\u6620\u5c04\uff0c\u8fd8\u6709\u8fb9\u7f18\u68c0\u6d4b\u3002\u505a\u6cd5\u5c31\u662f\u5728<code>OnRenderImage</code>\u4e2d\u8c03\u7528<code>Graphics.Blit</code>\uff0c\u4f20\u5165\u7279\u5b9a\u7684<code>Material</code>\uff1a</p>\n<p><code>c#\ndepthEdgeMaterial.SetTexture(\"_DepthTex\", src);\nGraphics.Blit(src, dst, depthEdgeMaterial);\nreturn;</code></p>\n<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c<code>Graphics.Blit</code>\u5b9e\u9645\u4e0a\u505a\u4e86\u8fd9\u6837\u4e00\u4ef6\u4e8b\u60c5\uff1a\u5728\u76f8\u673a\u524d\u9762\u753b\u4e00\u4e2a\u8ddf\u5c4f\u5e55\u5927\u5c0f\u4e00\u6837\u7684\u5e73\u9762\uff0c\u628a<code>src</code>\u4f5c\u4e3a\u8fd9\u4e2a\u5e73\u9762\u7684<code>_MainTex</code>\u4f20\u8fdb<code>Shader</code>\u4e2d\uff0c\u7136\u540e\u628a\u7ed3\u679c\u653e\u5230<code>dst</code>\u91cc\u9762\uff0c\u800c\u4e0d\u662f\u628a\u5b9e\u9645\u573a\u666f\u4e2d\u7684Mesh\u91cd\u65b0\u753b\u4e00\u904d\u3002</p>\n<p>\u5bf9\u989c\u8272\u6620\u5c04\u5176\u5b9e\u5c31\u662f\u628a\u6df1\u5ea6 [0, 1] \u770b\u6210\u56fe\u7247\u7684 uv\uff0c\u56e0\u4e3a\u6211\u60f3\u8ddd\u79bb\u76f8\u673a\u8fd1\u7684\u4e3a\u7ea2\u8272\uff0c\u6240\u4ee5\u6211\u5bf9\u6df1\u5ea6\u53d6\u4e86\u53cd\uff1a</p>\n<p><code>glsl\nhalf4 color = tex2D(_ColorMap, float2(saturate(1-depth), 0.5));</code></p>\n<h1>\u8fb9\u7f18\u68c0\u6d4b</h1>\n<p>\u8fb9\u7f18\u68c0\u6d4b\u9700\u8981\u7528\u5230\u4e86\u76f8\u673a\u81ea\u5df1\u7684 <code>_CameraDepthNormalsTexture</code>\uff0c\u4e3b\u8981\u662f\u7528 Normal \u7684\u503c\uff0c\u6df1\u5ea6\u8fd8\u662f\u7528\u4e4b\u524d\u8ba1\u7b97\u51fa\u6765\u7684\u3002\u5728 <code>_CameraDepthNormalsTexture</code> \u7684\u6bcf\u4e2a\u50cf\u7d20 (x, y, z, w) \u4e2d\uff0c(x, y) \u662f\u6cd5\u5411\uff0c(z, w)\u662f\u6df1\u5ea6\uff0c\u6cd5\u5411\u662f\u7528\u4e86\u4e00\u79cd\u65b9\u6cd5\u6765\u5b58\u653e\u7684\uff0c\u6709\u5174\u8da3\u53ef\u4ee5\u81ea\u5df1\u641c\u7d22\u3002</p>\n<p>\u4ee3\u7801\u662f\u53c2\u8003\u4e86 Unity \u81ea\u5e26\u7684 Image Effect \u91cc\u9762\u7684\u8fb9\u7f18\u68c0\u6d4b\uff0c\u9700\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\uff0c\u6bd4\u8f83\u5f53\u524d\u50cf\u7d20\u7684\u6cd5\u5411\u6df1\u5ea6\u548c\u90bb\u8fd1\u50cf\u7d20\u7684\u5dee\u522b\uff0c\u8db3\u591f\u5927\u6211\u4eec\u5c31\u8ba4\u4e3a\u5b58\u5728\u8fb9\u7f18\uff1a</p>\n<p>```c#\ninline half CheckSame (half2 centerNormal, half2 sampleNormal, float centerDepth, float sampleDepth)\n{\n    // difference in normals\n    // do not bother decoding normals - there's no need here\n    half2 diff = abs(centerNormal - sampleNormal);\n    half isSameNormal = (diff.x + diff.y) &lt; 0.5;</p>\n<pre><code>// difference in depth\nfloat zdiff = abs(centerDepth-sampleDepth);\n// scale the required threshold by the distance\nhalf isSameDepth = (zdiff &lt; 0.09 * centerDepth) || (centerDepth &lt; 0.1);\n\n// return:\n// 1 - if normals and depth are similar enough\n// 0 - otherwise\nreturn isSameNormal * isSameDepth;\n</code></pre>\n<p>}\n```</p>\n<p>\u5b8c\u6574\u7684 Shader \u5982\u4e0b\uff1a</p>\n<p>```glsl\nShader \"Custom/DepthColorEdge\" {</p>\n<p>Properties \n{\n    _DepthTex (\"Depth Tex\", 2D) = \"white\" {}\n    _ColorMap (\"Color Map\", 2D) = \"white\" {}\n}\n    SubShader \n    {\n        Tags { \"RenderType\"=\"Opaque\" }\n        LOD 200\n        Pass\n        {\n            ZTest Always Cull Off ZWrite Off\n            Fog { Mode off }\n            CGPROGRAM\n            #pragma vertex vert\n            #pragma fragment frag\n            #include \"UnityCG.cginc\"\n            sampler2D _CameraDepthNormalsTexture;\n            sampler2D _DepthTex;\n            uniform float4 _DepthTex_TexelSize;\n            sampler2D _ColorMap;\n            float _ZNear;\n            float _ZFar;</p>\n<pre><code>        struct v2f \n        {\n            float4 pos : SV_POSITION;\n            float2 uv[3] : TEXCOORD0;\n        };\n\n        v2f vert (appdata_base v)\n        {\n            v2f o;\n            o.pos = mul (UNITY_MATRIX_MVP, v.vertex);\n            o.uv[0] = MultiplyUV( UNITY_MATRIX_TEXTURE0, v.texcoord );\n            o.uv[1] = o.uv[0] + float2(-_DepthTex_TexelSize.x, -_DepthTex_TexelSize.y);\n            o.uv[2] = o.uv[0] + float2(+_DepthTex_TexelSize.x, -_DepthTex_TexelSize.y);\n            return o;\n        }\n\n\n        inline half CheckSame (half2 centerNormal, half2 sampleNormal, float centerDepth, float sampleDepth)\n        {\n            // difference in normals\n            // do not bother decoding normals - there's no need here\n            half2 diff = abs(centerNormal - sampleNormal);\n            half isSameNormal = (diff.x + diff.y) &lt; 0.5;\n\n            // difference in depth\n            float zdiff = abs(centerDepth-sampleDepth);\n            // scale the required threshold by the distance\n            half isSameDepth = (zdiff &lt; 0.09 * centerDepth) || (centerDepth &lt; 0.1);\n\n            // return:\n            // 1 - if normals and depth are similar enough\n            // 0 - otherwise\n            return isSameNormal * isSameDepth;\n        }\n\n        half4 frag(v2f i) : COLOR \n        {\n            // get color based on depth\n            float depth = tex2D (_DepthTex, i.uv[0]).r;\n            half4 color = tex2D(_ColorMap, float2(saturate(1-depth), 0.5));\n\n            // detect normal diff\n            half2 centerNormal = tex2D(_CameraDepthNormalsTexture, i.uv[0]).xy;\n            half2 sampleNormal1 = tex2D (_CameraDepthNormalsTexture, i.uv[1]).xy;\n            half2 sampleNormal2 = tex2D (_CameraDepthNormalsTexture, i.uv[2]).xy;\n            float sampleDepth1 = tex2D (_DepthTex, i.uv[1]).r;\n            float sampleDepth2 = tex2D (_DepthTex, i.uv[2]).r;\n            color *= CheckSame(centerNormal, sampleNormal1, depth, sampleDepth1);\n            color *= CheckSame(centerNormal, sampleNormal2, depth, sampleDepth2);\n\n            return color;\n        }\n        ENDCG\n    }\n\n}\nFallBack \"Diffuse\"\n</code></pre>\n<p>}\n```</p>\n<p>\u7ed3\u679c\u7c7b\u4f3c\u4e8e\u8fd9\u4e2a\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2014-3-27-unity-depth-minimap/topview.png\">{ width=\"200\" }</p>\n<h1>\u6df7\u5408\u771f\u5b9e\u4e16\u754c\u56fe\u50cf</h1>\n<p>\u5355\u5355\u662f\u6df1\u5ea6\u7684\u989c\u8272\u56fe\u53ef\u80fd\u6709\u70b9\u65e0\u8da3\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u6df7\u5408\u4e0a\u771f\u5b9e\u573a\u666f\u7684\u989c\u8272\u56fe\uff0c\u53ea\u9700\u8981\u518d\u5efa\u4e00\u4e2a Shader\uff0c\u4f20\u5165\u524d\u9762\u7684\u56fe\u50cf\u548c\u76f8\u673a\u7684\u771f\u5b9e\u56fe\u50cf\uff0c\u5728 <code>OnRenderImage</code> \u4e2d\u8fdb\u884c\u6df7\u5408\uff1a</p>\n<p>```glsl\nShader \"Custom/ColorMixDepth\" {\n    Properties {\n        _MainTex (\"Base (RGBA)\", 2D) = \"white\" {}\n        _DepthTex (\"Depth (RGBA)\", 2D) = \"white\" {}\n    }\n    SubShader {\n        Tags { \"RenderType\"=\"Opaque\" }\n        LOD 200</p>\n<pre><code>    CGPROGRAM\n    #pragma surface surf Lambert\n\n    sampler2D _MainTex;\n    sampler2D _DepthTex;\n\n    struct Input {\n        float2 uv_MainTex;\n        float2 uv_DepthTex;\n    };\n\n    void surf (Input IN, inout SurfaceOutput o) {\n        half4 c = tex2D (_MainTex, IN.uv_MainTex);\n        half4 d = tex2D (_DepthTex, IN.uv_DepthTex);\n        //d = d.x == 1? 0 : d;\n        o.Albedo = c.rgb*0.1 + d.rgb*0.9;\n        o.Alpha = 1;\n    }\n    ENDCG\n} \nFallBack \"Diffuse\"\n</code></pre>\n<p>}\n```</p>\n<p><code>c#\nvoid OnRenderImage(RenderTexture src, RenderTexture dst)\n{\n    // if now rendering depth map\n    if (isRenderDepth)\n    {\n        depthEdgeMaterial.SetTexture(\"_DepthTex\", src);\n        if(isUseColorMap)\n            Graphics.Blit(src, dst, depthEdgeMaterial);\n        else\n            Graphics.Blit(src, dst);\n        return;\n    }\n    // else rendering real color scene, mix the real color with depth map\n    else\n    {\n        mixMaterial.SetTexture(\"_MainTex\", src);\n        mixMaterial.SetTexture(\"_DepthTex\", depthTexture);\n        Graphics.Blit(src, dst, mixMaterial);\n        ReleaseTexture();\n    }\n}</code>\n\u4e0a\u9762\u7684\u4ee3\u7801\u5c31\u662f\u5b8c\u6210\u8fd9\u4e2a\u5de5\u4f5c\uff0c\u9700\u8981\u7406\u89e3\u7684\u662f\uff0c\u6211\u4eec\u5728\u8c03\u7528 <code>RenderWithShader</code> \u7684\u65f6\u5019\uff0c<code>OnRenderImage</code> \u4e5f\u4f1a\u88ab\u8c03\u7528\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e2a\u51fd\u6570\u88ab\u8c03\u7528\u4e86\u4e24\u6b21\uff0c\u800c\u4e24\u6b21\u8c03\u7528\u9700\u8981\u5b8c\u6210\u7684\u529f\u80fd\u662f\u4e0d\u540c\u7684\uff0c\u6240\u4ee5\u6211\u8fd9\u91cc\u7528\u4e00\u4e2a\u53d8\u91cf\u6765\u6307\u793a\u5f53\u524d\u7684\u6e32\u67d3\u72b6\u6001\u662f\u505a\u6df1\u5ea6\u56fe\u8fd8\u662f\u6df7\u5408\u3002</p>\n<h1>\u5b8c\u6574\u7684\u4ee3\u7801</h1>\n<p>\u4ee3\u7801\u6587\u4ef6\u6709\u70b9\u591a\uff0c\u5c31\u653e\u5230\u8fd9\u91cc\u4e86<a href=\"assets/img/2014-3-27-unity-depth-minimap/2014-3-27-unity-depth-minimap.zip\">depth-minimap</a>\u3002</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/unity-Unity%E7%AC%AC%E4%B8%89%E4%BA%BA%E7%A7%B0%E7%9B%B8%E6%9C%BA%E6%9E%84%E5%BB%BA%28%E4%B8%8A%29/",
            "url": "https://wiki.disenone.site/unity-Unity%E7%AC%AC%E4%B8%89%E4%BA%BA%E7%A7%B0%E7%9B%B8%E6%9C%BA%E6%9E%84%E5%BB%BA%28%E4%B8%8A%29/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Unity\u7b2c\u4e09\u4eba\u79f0\u76f8\u673a\u6784\u5efa(\u4e0a)",
            "content_html": "<p><meta property=\"og:title\" content=\"Unity\u7b2c\u4e09\u4eba\u79f0\u76f8\u673a\u6784\u5efa(\u4e0a)\" /></p>\n<p>\u6211\u60f3\u5728Unity\u4e2d\u521b\u5efa\u4e00\u4e2a\u7b2c\u4e09\u4eba\u79f0\u76f8\u673a\uff0c\u76f8\u673a\u7684\u884c\u4e3a\u53c2\u8003\u300a\u9b54\u517d\u4e16\u754c\u300b\u7684\u7b2c\u4e09\u4eba\u79f0\u76f8\u673a\uff0c\u5177\u4f53\u7684\u9700\u6c42\u662f\uff1a</p>\n<ol>\n<li>\u9f20\u6807\u5de6\u952e\uff1a\u63a7\u5236\u76f8\u673a\u56f4\u7ed5\u4eba\u7269\u65cb\u8f6c\uff0c\u4eba\u7269\u4e0d\u65cb\u8f6c</li>\n<li>\u9f20\u6807\u53f3\u952e\uff1a\u63a7\u5236\u76f8\u673a\u56f4\u7ed5\u4eba\u7269\u65cb\u8f6c\uff0c\u4eba\u7269\u7684\u524d\u65b9\u5411(Unity\u4e2d\u7684tranform.forward)\u76f8\u5e94\u65cb\u8f6c\uff0c\u4eba\u7269\u4e0a\u65b9\u5411\u4e0d\u53d8</li>\n<li>\u9f20\u6807\u5de6\u952e\u65cb\u8f6c\u540e\uff0c\u518d\u53f3\u952e\u65cb\u8f6c\uff0c\u89d2\u8272\u524d\u65b9\u5411\u9a6c\u4e0a\u6839\u636e\u5de6\u952e\u7684\u65cb\u8f6c\u505a\u8c03\u6574\uff0c\u518d\u6839\u636e\u53f3\u952e\u65cb\u8f6c\uff0c\u6b64\u65f6\u7b49\u4ef7\u4e8e\u4e24\u6b21\u90fd\u662f\u53f3\u952e\u65cb\u8f6c</li>\n<li>\u9f20\u6807\u6eda\u8f6e\uff1a\u63a7\u5236\u76f8\u673a\u8fdc\u8fd1</li>\n<li>\u76f8\u673a\u4e0d\u80fd\u7a7f\u8fc7\u4efb\u4f55\u521a\u6027\u7269\u4f53</li>\n<li>\u76f8\u673a\u5728\u79bb\u5f00\u78b0\u649e\u7684\u521a\u6027\u7269\u4f53\u540e\uff0c\u6162\u6162\u56de\u5230\u539f\u6765\u7684\u8ddd\u79bb\u4e0a</li>\n<li>\u5982\u679c\u76f8\u673a\u5728\u78b0\u5230\u7269\u4f53\u65f6\uff0c\u4f7f\u7528\u9f20\u6807\u6eda\u8f6e\u64cd\u4f5c\u76f8\u673a\u62c9\u8fd1\uff0c\u76f8\u673a\u9700\u8981\u9a6c\u4e0a\u53cd\u5e94\uff0c\u6b64\u540e\u7b2c6\u70b9\u4e0d\u518d\u53d1\u751f</li>\n<li>\u76f8\u673a\u5728\u65cb\u8f6c\u4e2d\u78b0\u5230\u5730\u9762\uff0c\u505c\u6b62\u56f4\u7ed5\u4eba\u7269\u4e0a\u4e0b\u65cb\u8f6c\uff0c\u6539\u4e3a\u56f4\u7ed5\u81ea\u8eab\u4e0a\u4e0b\u65cb\u8f6c\uff0c\u5de6\u53f3\u65cb\u8f6c\u4f9d\u7136\u662f\u56f4\u7ed5\u4eba\u7269</li>\n</ol>\n<p>\u8fd9\u4e2a\u9700\u6c42\u53ef\u4ee5\u5148\u5206\u6210\u4e24\u90e8\u5206\uff1a\u76f8\u673a\u65cb\u8f6c\uff0c\u76f8\u673a\u521a\u6027\u3002\u7b80\u5355\u8d77\u89c1\uff0c\u8fd9\u91cc\u5148\u6765\u89e3\u51b3\u76f8\u673a\u65cb\u8f6c\u7684\u95ee\u9898\uff0c\u4e5f\u5c31\u662f\u9700\u6c42\u7684\u524d3\u70b9\u3002</p>\n<h2>\u76f8\u673a\u4f4d\u7f6e\u8868\u793a</h2>\n<p>\u5728\u6b63\u5f0f\u89e3\u51b3\u76f8\u673a\u64cd\u4f5c\u524d\uff0c\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u9700\u8981\u89e3\u51b3\uff1a\u76f8\u673a\u4f4d\u7f6e\u7684\u8868\u793a\u3002\u8fd9\u53ef\u4ee5\u7528\u591a\u79cd\u65b9\u5f0f\uff1a</p>\n<ul>\n<li>\u76f8\u673a\u7684\u4e16\u754c\u5750\u6807</li>\n<li>\u76f8\u673a\u76f8\u5bf9\u4e8e\u4eba\u7269\u7684\u5750\u6807</li>\n<li>\u76f8\u673a\u5728\u4eba\u7269\u5750\u6807\u7cfb\u4e2d\u7684\u65b9\u5411\u548c\u8ddd\u79bb</li>\n</ul>\n<p>\u56e0\u4e3a\u5728\u6211\u4eec\u7684\u9700\u6c42\u4e2d\uff0c\u76f8\u673a\u662f\u6839\u636e\u4eba\u7269\u4f4d\u7f6e\u8fdb\u884c\u53d8\u6362\u7684\uff0c\u6240\u4ee5\u6211\u8fd9\u91cc\u4f7f\u7528\u7b2c\u4e09\u79cd\u65b9\u5f0f\uff0c\u800c\u4e14\u5728\u63a7\u5236\u4e2d\u76f8\u673a\u4e00\u76f4\u7784\u51c6\u4eba\u7269\uff0c\u6240\u4ee5\u5728\u76f8\u673a\u5185\u53ea\u9700\u8981\u4fdd\u5b58\u8ddd\u79bb\u4fe1\u606f\uff1a</p>\n<p><code>c#\nfloat curDistance = 5F;</code></p>\n<h2>\u76f8\u673a\u65cb\u8f6c</h2>\n<p>\u7ee7\u7eed\u7ec6\u5206\u76f8\u673a\u65cb\u8f6c\u7684\u884c\u4e3a\uff0c\u53ef\u4ee5\u5206\u6210\u5de6\u952e\u65cb\u8f6c\u548c\u53f3\u952e\u65cb\u8f6c\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u4e00\u6b65\u4e00\u6b65\u5730\u5b8c\u6210\u8fd9\u4e24\u4e2a\u65cb\u8f6c\u3002\u9996\u5148\u6211\u628a\u76f8\u673a\u8bbe\u4e3a\u4eba\u7269\u7684\u5b50\u7269\u4f53(children)\uff0c\u8fd9\u6837\u4eba\u7269\u7684\u4e00\u4e9b\u57fa\u672c\u7684\u79fb\u52a8\u76f8\u673a\u90fd\u4f1a\u81ea\u52a8\u7684\u8ddf\u8e2a\u3002</p>\n<h3>\u5de6\u952e\u65cb\u8f6c</h3>\n<p>\u5355\u5355\u770b\u5de6\u952e\u65cb\u8f6c\uff0c\u9700\u6c42\u5f88\u7b80\u5355\uff1a<strong>\u76f8\u673a\u65cb\u8f6c\uff0c\u4eba\u7269\u4e0d\u65cb\u8f6c</strong>\uff0c\u8fd9\u5c31\u76f8\u5f53\u4e8e\u4e00\u4e2a\u89c2\u5bdf\u6a21\u578b\u7684\u76f8\u673a\uff0c\u76f8\u673a\u53ef\u4ee5\u4efb\u610f\u89d2\u5ea6\u89c2\u5bdf\u4e2d\u5fc3\u7269\u4f53\u3002</p>\n<p>\u5728Unity\u4e2d\u83b7\u53d6\u9f20\u6807\u5de6\u952e\u72b6\u6001\u4f7f\u7528\u8bed\u53e5\uff1a<code>Input.GetMouseButton(0)</code>\uff08\u6ce8\uff1a\u540e\u9762\u6d89\u53ca\u5230\u4ee3\u7801\u7684\u5730\u65b9\uff0c\u90fd\u662f\u4f7f\u7528C#\uff09\uff0c\u660e\u663e\uff0c\u53f3\u952e\u5c31\u662f<code>Input.GetMouseButton(1)</code>\u3002\u83b7\u53d6\u9f20\u6807\u5149\u6807\u7684\u79fb\u52a8\u4f4d\u7f6e\uff08\u53ef\u4ee5\u7406\u89e3\u4e3a\u5e27\u4e4b\u95f4\u5149\u6807\u5728X-Y\u4e0a\u7684\u504f\u79fb\u91cf\uff09\u4fe1\u606f\u662f\uff1a<code>Input.GetAxis(\"Mouse X\"); Input.GetAxis(\"Mouse Y\")</code>\u3002\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5148\u6765\u83b7\u53d6\u9f20\u6807\u5de6\u952e\u6309\u4e0b\u540e\u5149\u6807\u7684\u79fb\u52a8\u4fe1\u606f\uff1a</p>\n<p><code>csharp\nif (Input.GetMouseButton(0))\n{\n    float x = Input.GetAxis(\"Mouse X\");\n    float y = Input.GetAxis(\"Mouse Y\");\n}</code></p>\n<p>\u4ee3\u7801\u5f88\u7b80\u5355\uff0c\u90a3\u4e0b\u9762\u5c31\u662f\u5173\u952e\u7684\u5730\u65b9\uff1a\u5982\u4f55\u63a7\u5236\u76f8\u673a\u6765\u65cb\u8f6c\u3002\u8981\u7406\u89e3\u65cb\u8f6c\uff0c\u8fd9\u91cc\u9700\u8981\u4e00\u4e9b\u5173\u4e8e\u56db\u5143\u6570\u7684\u77e5\u8bc6\uff08\u7f51\u4e0a\u8d44\u6599\u5f88\u591a\uff0c\u8fd9\u91cc\u5c31\u4e0d\u5217\u4e3e\u4e86\uff09\uff0c\u56db\u5143\u6570\u91cd\u8981\u7684\u4e00\u70b9\u662f\u5b83\u53ef\u4ee5\u5f88\u7b80\u5355\u5730\u6784\u9020\u65cb\u8f6c\uff0c\u7279\u522b\u662f\u56f4\u7ed5\u67d0\u4e2a\u5411\u91cf\u7684\u65cb\u8f6c\uff0c\u7406\u89e3\u56db\u5143\u6570\u540e\uff0c\u5b9e\u73b0\u76f8\u673a\u56f4\u7ed5\u4eba\u7269\u7684\u65cb\u8f6c\u5c31\u4e0d\u96be\u4e86\u3002</p>\n<p>\u53e6\u5916\u8fd8\u6709\u4e00\u70b9\u8981\u6ce8\u610f\u7684\u662f\uff0c\u56db\u5143\u6570\u65cb\u8f6c\u8f74\u53ea\u662f\u4e00\u4e2a\u5411\u91cf\uff0c\u4ee5\u539f\u70b9\u4e3a\u51fa\u53d1\u70b9\uff0c\u5982\u679c\u8981\u4ee5\u4e16\u754c\u5750\u6807\u7cfb\u4e2d\u7684\u67d0\u70b9<code>O</code>\u4e3a\u539f\u70b9\uff0c\u4ee5\u8be5\u70b9\u4e3a\u51fa\u53d1\u70b9\u7684\u5411\u91cf<code>V</code>\u4e3a\u65cb\u8f6c\u8f74\uff0c\u5c31\u9700\u8981\u8fdb\u884c\u5750\u6807\u7cfb\u7684\u53d8\u6362\uff0c\u7b80\u5355\u5730\u8bf4\uff0c\u5c31\u662f\u628a\u9700\u8981\u65cb\u8f6c\u7684\u70b9<code>P</code>\u53d8\u6362\u5230\uff0c\u4ee5<code>O</code>\u4e3a\u539f\u70b9\u7684\u5750\u6807\u7cfb\u4e2d\uff0c\u6839\u636e<code>V</code>\u65cb\u8f6c\uff0c\u518d\u53d8\u6362\u4f1a\u4e16\u754c\u5750\u6807\u7cfb\u3002\u6839\u636e\u8fd9\u4e9b\u64cd\u4f5c\uff0c\u53ef\u4ee5\u5199\u51fa\u4e00\u4e2a\u529f\u80fd\u51fd\u6570\uff1a</p>\n<p><code>c#\nVector3 MyRotate(Vector3 oldPosition, float angle, Vector3 axis, Vector3 axisPosition)\n{\n    // \u6784\u9020\u4e00\u4e2a\u56db\u5143\u6570\uff0c\u4ee5axis\u4e3a\u65cb\u8f6c\u8f74\uff0c\u8fd9\u662f\u5728\u4eba\u7269\u5750\u6807\u7cfb\u4e2d\u7684\u65cb\u8f6c\n    Quaternion rotation = Quaternion.AngleAxis(angle, axis);\n    // \u8fd9\u91cc\u505a\u7684\u5c31\u662f\u5750\u6807\u7cfb\u7684\u53d8\u6362\uff0c\u628a\u76f8\u673a\u7684\u4e16\u754c\u5750\u6807\u53d8\u6362\u5230\u4eba\u7269\u5750\u6807\u7cfb\u4e0b\u7684\u5750\u6807\n    Vector3 offset = oldPosition - axisPosition;\n    // \u8ba1\u7b97\u65cb\u8f6c\u5e76\u53d8\u6362\u56de\u4e16\u754c\u5750\u6807\u7cfb\u4e2d\n    return axisPosition + (rotation * offset);\n}</code>\n<code>Quaternion</code>\u662fUnity\u4e2d\u8868\u793a\u56db\u5143\u6570\u7684\u7c7b\u578b\uff0c\u52a0\u4e0a\u4e4b\u524d\u9f20\u6807\u5de6\u952e\u7684\u68c0\u6d4b\uff0c\u5c31\u53ef\u4ee5\u5b8c\u6210\u5de6\u952e\u63a7\u5236\u76f8\u673a\u5de6\u53f3\u65cb\u8f6c\u3002</p>\n<p>\u9f20\u6807\u5de6\u53f3\u79fb\u52a8\u63a7\u5236\u76f8\u673a\u5de6\u53f3\u65cb\u8f6c\u7684\u4ee3\u7801\u5c31\u53ef\u4ee5\u76f4\u63a5\u7ed9\u51fa\uff1a</p>\n<p><code>c#\nnewForward = MyRotate(newForward, x, up, Vector3.zero);</code>\n\u56e0\u4e3a\u8fd9\u91cc\u53ea\u6709\u524d\u5411\u91cf\u505a\u65cb\u8f6c\uff0c\u6ca1\u6709\u6d89\u53ca\u5230\u5750\u6807\u7cfb\u7684\u8f6c\u6362\uff0c\u6240\u4ee5\u7b2c\u56db\u4e2a\u53c2\u6570\u4e3a<code>Vector3.zero</code>\u3002</p>\n<p>\u63a7\u5236\u4e0a\u4e0b\u65cb\u8f6c\u6bd4\u5de6\u53f3\u65cb\u8f6c\u96be\u7406\u89e3\u4e00\u70b9\uff0c\u56e0\u4e3a\u6b64\u65f6\u7684\u65cb\u8f6c\u8f74\u662f\u4f1a\u4e00\u76f4\u53d8\u5316\u7684(\u8fd9\u91cc\u5047\u8bbe\u4eba\u7269\u7684up\u4e00\u76f4\u662fY\u8f74\u7684\u6b63\u65b9\u5411)\u3002\u6ce8\u610f\u7684\u76f8\u673a\u4e5f\u662f\u4e00\u76f4\u5728\u65cb\u8f6c\uff0c\u5e76\u4e14\u89c6\u70b9\u4e2d\u5fc3\u4e00\u76f4\u5bf9\u51c6\u4eba\u7269\uff0c\u90a3\u4e48\u76f8\u673a\u7684\u53f3\u65b9\u5411(right)\u5c31\u662f\u6211\u4eec\u60f3\u8981\u56f4\u7ed5\u7740\u65cb\u8f6c\u7684\u8f74\u4e86(\u628a\u76f8\u673aright\u60f3\u8c61\u6210\u4eba\u7269\u7684right)\uff0c\u8fd9\u6837\u7406\u89e3\uff0c\u90a3\u4e48\u4e0a\u4e0b\u65cb\u8f6c\u7684\u4ee3\u7801\u4e5f\u5f88\u7b80\u5355\u4e86\uff1a</p>\n<p><code>csharp\nnewForward = MyRotate(newForward, -y, transform.right, Vector3.zero);</code></p>\n<h3>\u53f3\u952e\u65cb\u8f6c</h3>\n<p>\u505a\u4e86\u5de6\u952e\u65cb\u8f6c\uff0c\u53f3\u952e\u65cb\u8f6c\u5c31\u5f88\u7b80\u5355\u4e86\uff0c\u53ea\u9700\u8981\u5728\u5de6\u53f3\u65cb\u8f6c\u7684\u65f6\u5019\u8bbe\u7f6e\u4eba\u7269\u7684\u524d\u65b9\u5411\uff1a</p>\n<p><code>csharp\nplayer.forward = Vector3.Normalize(new Vector3(oldForward.x, 0, oldForward.z));</code></p>\n<p>\u4e0a\u4e0b\u65cb\u8f6c\u8ddf\u5de6\u952e\u7684\u4ee3\u7801\u4e00\u6837\u3002</p>\n<h3>\u5148\u5de6\u952e\uff0c\u540e\u53f3\u952e</h3>\n<p>\u4e0a\u9762\u867d\u7136\u53ef\u4ee5\u5206\u522b\u5de6\u952e\u65cb\u8f6c\uff0c\u53f3\u952e\u65cb\u8f6c\uff0c\u4f46\u662f\u4e00\u65e6\u5148\u7528\u5de6\u952e\u65cb\u8f6c\uff0c\u518d\u7528\u53f3\u952e\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u95ee\u9898\u5c31\u4f1a\u51fa\u73b0\uff1a\u4eba\u7269\u7684\u524d\u65b9\u5411\u548c\u76f8\u673a\u7684\u524d\u65b9\u5411\u4e0d\u540c\u4e86\uff01\u90a3\u4e48\u76f8\u673a\u548c\u4eba\u7269\u7684\u6b63\u65b9\u5411\u5c31\u4ece\u6b64\u5206\u79bb\uff0c\u5b9e\u9645\u64cd\u4f5c\u8d77\u6765\u5f88\u5947\u602a\u3002\u90a3\u4e48\u6211\u4eec\u5728\u7528\u53f3\u952e\u65cb\u8f6c\u7684\u65f6\u5019\u5c31\u8981\u5148\u628a\u4eba\u7269\u8c03\u6574\u4e3a\u8ddf\u76f8\u673a\u7684\u6b63\u65b9\u5411\u4e00\u81f4\uff1a</p>\n<p>```csharp\nplayer.forward = Vector3.Normalize(new Vector3(oldForward.x, 0, oldForward.z));</p>\n<p>```</p>\n<hr>\n<h3>\u6b27\u62c9\u89d2\u4e07\u5411\u9501</h3>\n<p>\u81f3\u6b64\uff0c\u76f8\u673a\u7684\u65cb\u8f6c\u5dee\u4e0d\u591a\u5c31\u5b8c\u6210\uff0c\u4e0d\u8fc7\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u8981\u6ce8\u610f\uff1a\u6b27\u62c9\u89d2\u4e07\u5411\u9501\u3002\u539f\u7406\u8fd9\u91cc\u5c31\u4e0d\u7ec6\u8bb2\uff0c\u6709\u5174\u8da3\u7684\u670b\u53cb\u53ef\u4ee5\u81ea\u884c\u641c\u7d22\uff0c\u9488\u5bf9\u8fd9\u91cc\u76f8\u673a\u7684\u60c5\u51b5\uff0c\u5c31\u662f\u5f53\u76f8\u673a\u4e0a\u4e0b\u65cb\u8f6c\u5230\u8ddf\u4eba\u7269\u7684\u4e0a\u65b9\u5411\u91cd\u5408\u7684\u65f6\u5019\uff0c\u76f8\u673a\u7684\u89c6\u89d2\u4f1a\u53d1\u751f\u7a81\u53d8\u3002\u8fd9\u662f\u56e0\u4e3a\u76f8\u673a\u5230\u8fbe\u4eba\u7269\u7684\u5934\u9876\u6216\u8005\u811a\u5e95\uff0c\u76f8\u673a\u7684\u4e0a\u65b9\u5411\u4f1a\u53d1\u751f\u7a81\u53d8(\u56e0\u4e3a\u76f8\u673a\u7684\u4e0a\u65b9\u5411\u7684Y\u503c\u4e00\u76f4\u90fd\u8981\u5927\u4e8e\u96f6)\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u9650\u5236\u76f8\u673a\u7684\u4e0a\u4e0b\u65cb\u8f6c\u8303\u56f4\uff0c\u9632\u6b62\u53d1\u751f\u4e07\u5411\u9501\u3002\u64cd\u4f5c\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u9650\u5236\u76f8\u673a\u7684\u524d\u65b9\u5411\u4e0e\u4eba\u7269\u7684\u4e0a\u65b9\u5411\u7684\u5939\u89d2\u7684\u8303\u56f4\uff1a</p>\n<p><code>c#\nif ((Vector3.Dot(transform.forward, transform.parent.up) &gt;= -0.95F || y &gt; 0) &amp;&amp;\n    (Vector3.Dot(transform.forward, transform.parent.up) &lt;= 0.95F || y &lt; 0))</code></p>\n<h3>\u5b8c\u6574\u4ee3\u7801</h3>\n<p>```csharp\n// rotate oldPosition around a axis starting at axisPosition\nVector3 MyRotate(Vector3 oldPosition, float angle, Vector3 axis, Vector3 axisPosition)\n{\n    Quaternion rotation = Quaternion.AngleAxis(angle, axis);\n    Vector3 offset = oldPosition - axisPosition;\n    return axisPosition + (rotation * offset);\n}</p>\n<p>// rotate oldForward, player forward may change when use mouse RB\nVector3 RotateIt(Vector3 oldForward, Vector3 up, Vector3 right, Transform player)\n{\n    Vector3 newForward = -oldForward;\n    // mouse LB RB rotate camera and character\n    if (Input.GetMouseButton(0) ^ Input.GetMouseButton(1))\n    {\n        float x = Input.GetAxis(\"Mouse X\") * rotateSpeed;\n        float y = Input.GetAxis(\"Mouse Y\") * rotateSpeed;</p>\n<pre><code>    if (x != 0F)\n    {\n        newForward = MyRotate(newForward, x, up, Vector3.zero);\n\n        // mouse RB, character rotate together\n        if (Input.GetMouseButton(1))\n        {\n            player.forward = Vector3.Normalize(new Vector3(oldForward.x, 0, \n                oldForward.z));\n        }\n    }\n\n    if (y != 0F)\n    {\n\n        if ((Vector3.Dot(transform.forward, up) &gt;= -0.95F || y &gt; 0)\n            &amp;&amp; (Vector3.Dot(transform.forward, up) &lt;= 0.95F || y &lt; 0))\n        {\n            newForward = MyRotate(newForward, -y, transform.right, Vector3.zero);\n\n        }\n    }\n}\n\nreturn -newForward;\n</code></pre>\n<p>}\n```</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/unity-Unity%E7%AC%AC%E4%B8%89%E4%BA%BA%E7%A7%B0%E7%9B%B8%E6%9C%BA%E6%9E%84%E5%BB%BA%28%E4%B8%8B%29/",
            "url": "https://wiki.disenone.site/unity-Unity%E7%AC%AC%E4%B8%89%E4%BA%BA%E7%A7%B0%E7%9B%B8%E6%9C%BA%E6%9E%84%E5%BB%BA%28%E4%B8%8B%29/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "Unity\u7b2c\u4e09\u4eba\u79f0\u76f8\u673a\u6784\u5efa(\u4e0b)",
            "content_html": "<p><meta property=\"og:title\" content=\"Unity\u7b2c\u4e09\u4eba\u79f0\u76f8\u673a\u6784\u5efa(\u4e0b)\" /></p>\n<p>\u4e0a\u4e00\u96c6\u8bb2\u5b8c\u4e86<a href=\"unity-Unity\u7b2c\u4e09\u4eba\u79f0\u76f8\u673a\u6784\u5efa(\u4e0a).md\">\u76f8\u673a\u7684\u65cb\u8f6c</a>\uff0c\u90a3\u4e48\u73b0\u5728\u6211\u4eec\u8981\u89e3\u51b3\u7684\u95ee\u9898\u662f\u76f8\u673a\u7684\u521a\u6027\uff0c\u8981\u600e\u4e48\u505a\u5462\uff1f</p>\n<h2>\u76f8\u673a\u521a\u6027</h2>\n<p>\u56de\u987e\u4e4b\u524d\u63d0\u7684\u9700\u6c42\uff1a</p>\n<ol>\n<li>\u9f20\u6807\u6eda\u8f6e\uff1a\u63a7\u5236\u76f8\u673a\u8fdc\u8fd1</li>\n<li>\u76f8\u673a\u4e0d\u80fd\u7a7f\u8fc7\u4efb\u4f55\u521a\u6027\u7269\u4f53</li>\n<li>\u76f8\u673a\u5728\u79bb\u5f00\u78b0\u649e\u7684\u521a\u6027\u7269\u4f53\u540e\uff0c\u6162\u6162\u56de\u5230\u539f\u6765\u7684\u8ddd\u79bb\u4e0a</li>\n<li>\u5982\u679c\u76f8\u673a\u5728\u78b0\u5230\u521a\u4f53\u65f6\uff0c\u4f7f\u7528\u9f20\u6807\u6eda\u8f6e\u64cd\u4f5c\u76f8\u673a\u62c9\u8fd1\uff0c\u76f8\u673a\u9700\u8981\u9a6c\u4e0a\u53cd\u5e94\uff0c\u6b64\u540e\u7b2c6\u70b9\u4e0d\u518d\u53d1\u751f\uff1b\u78b0\u649e\u5730\u9762\u540e\u4e0d\u80fd\u8fdb\u884c\u7f29\u653e\u64cd\u4f5c</li>\n<li>\u76f8\u673a\u5728\u65cb\u8f6c\u4e2d\u78b0\u5230\u5730\u9762\uff0c\u505c\u6b62\u56f4\u7ed5\u4eba\u7269\u4e0a\u4e0b\u65cb\u8f6c\uff0c\u6539\u4e3a\u56f4\u7ed5\u81ea\u8eab\u4e0a\u4e0b\u65cb\u8f6c\uff0c\u5de6\u53f3\u65cb\u8f6c\u4f9d\u7136\u662f\u56f4\u7ed5\u4eba\u7269</li>\n</ol>\n<p>\u8fd9\u51e0\u70b9\u7684\u610f\u601d\u662f\uff1a\u76f8\u673a\u5728\u78b0\u5230\u521a\u6027\u7269\u4f53\u65f6\uff0c\u4f1a\u88ab\u8feb\u62c9\u8fd1\u8ddf\u4eba\u7269\u7684\u8ddd\u79bb\uff0c\u90a3\u4e48\u6211\u4eec\u60f3\u8981\u76f8\u673a\u5728\u79bb\u5f00\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u6162\u6162\u5730\u56de\u5230\u539f\u6765\u7684\u8ddd\u79bb\uff1b\u4f46\u662f\u5982\u679c\u5728\u81ea\u52a8\u62c9\u8fd1\u8ddd\u79bb\u540e\uff0c\u7528\u6eda\u8f6e\u518d\u624b\u52a8\u62c9\u8fd1\uff0c\u8bf4\u660e\u76f8\u673a\u79bb\u5f00\u78b0\u649e\u7684\u7269\u4f53\uff0c\u90a3\u4e48\u8fd9\u4e2a\u62c9\u8fd1\u7684\u8ddd\u79bb\u5c31\u662f\u76f8\u673a\u7684\u5b9e\u9645\u8ddd\u79bb\u3002\u4e0b\u9762\u6211\u4eec\u6765\u4e00\u70b9\u4e00\u70b9\u7684\u89e3\u8fd9\u4e9b\u9700\u6c42\u3002</p>\n<h2>\u6eda\u8f6e\u63a7\u5236</h2>\n<p>\u9f20\u6807\u6eda\u8f6e\u63a7\u5236\u5f88\u7b80\u5355\uff0c\u53ea\u9700\u8981\u77e5\u9053\u83b7\u53d6\u6eda\u8f6e\u4fe1\u606f\u662f<code>Input.GetAxis(\"Mouse ScrollWheel\")</code>\uff0c\u5e76\u8bbe\u5b9a\u8ddd\u79bb\u7684\u6700\u5927\u503c\u6700\u5c0f\u503c\u5c31ok\uff1a</p>\n<p><code>c#\npublic float mouseWheelSensitivity = 2; // control zoom speed\npublic int mouseWheelZoomMin = 2;       // min distance\npublic int mouseWheelZoomMax = 10;      // max distance\nfloat curDistance = 5F;\nfloat zoom = Input.GetAxis(\"Mouse ScrollWheel\");\nif (zoom != 0F)\n{\n    float distance = curDistance;\n    distance -= zoom * mouseWheelSensitivity;\n    distance = Math.Min(mouseWheelZoomMax, Math.Max(mouseWheelZoomMin, distance));\n    return distance;\n}</code></p>\n<p>\u8fd9\u91cc<code>playerTransform</code>\u6307\u5411\u4eba\u7269\u3002</p>\n<h2>\u4e0d\u80fd\u7a7f\u8fc7\u4efb\u4f55\u521a\u6027\u7269\u4f53</h2>\n<p>\u8fd9\u9700\u8981\u68c0\u6d4b\u76f8\u673a\u8ddf\u521a\u4f53\u7684\u63a5\u89e6\uff0c\u6709\u4e00\u4e2a\u51fd\u6570\u53ef\u4ee5\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff1a</p>\n<p><code>c#\nstatic bool Raycast(Ray ray, RaycastHit hitInfo, float distance = Mathf.Infinity, int layerMask = DefaultRaycastLayers);</code></p>\n<p>\u5177\u4f53\u7528\u6cd5\u53c2\u8003Unity\u7684<a href=\"http://docs.unity3d.com/Documentation/ScriptReference/Physics.Raycast.html\">Reference</a>\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u5b9e\u73b0\u78b0\u649e\u7684\u68c0\u6d4b\uff1a</p>\n<p><code>c#\nRaycastHit hitInfo;\nif (Physics.Raycast(playerTransform.position, desiredPosition - playerTransform.position,\n    out hitInfo, (playerTransform.position - desiredPosition).magnitude, 1))\n{\n    curDistance = hitInfo.distance;\n}</code></p>\n<p><code>targetPosition</code>\u5c31\u662f\u78b0\u649e\u7684\u4f4d\u7f6e\uff0c\u628a\u76f8\u673a\u7684\u4f4d\u7f6e\u8bbe\u5230\u78b0\u649e\u7684\u4f4d\u7f6e\u5c31\u53ef\u4ee5\u3002</p>\n<h2>\u79bb\u5f00\u521a\u4f53\u540e\uff0c\u6162\u6162\u56de\u5230\u539f\u6765\u7684\u8ddd\u79bb\u4e0a</h2>\n<p>\u8981\u5b8c\u6210\u8fd9\u4e2a\u529f\u80fd\uff0c\u9996\u5148\u8981\u5206\u522b\u8bb0\u5f55\u4e0b\u76f8\u673a\u5e94\u8be5\u5904\u4e8e\u7684\u8ddd\u79bb(<code>desiredDistance</code>)\u548c\u76ee\u524d\u8ddd\u79bb(<code>curDistance</code>)\uff0c\u628a\u6eda\u8f6e\u64cd\u4f5c\u7684\u7ed3\u679c\u7528<code>desiredDistance</code>\u5148\u5b58\u8d77\u6765\uff0c\u518d\u6839\u636e\u78b0\u649e\u8ba1\u7b97\u7269\u4f53\u7684\u65b0\u8ddd\u79bb\uff1b\n\u5728\u68c0\u6d4b\u5230\u76f8\u673a\u79bb\u5f00\u521a\u4f53\uff0c\u6216\u8005\u78b0\u649e\u5230\u66f4\u8fdc\u7684\u521a\u4f53\u65f6\u5019\uff0c\u4e0d\u80fd\u76f4\u63a5\u628a\u78b0\u649e\u7684\u4f4d\u7f6e\u8d4b\u503c\u7ed9\u76f8\u673a\uff0c\u9700\u8981\u7528\u4e00\u4e2a\u79fb\u52a8\u901f\u5ea6\u6765\u5411\u65b0\u7684\u8ddd\u79bb\u79fb\u52a8\u3002\u5148\u6765\u83b7\u53d6\u65b0\u7684\u8ddd\u79bb\uff1a</p>\n<p><code>c#\nfloat newDistance = desiredDistance;\nRaycastHit hitInfo;\nif (Physics.Raycast(playerTransform.position, desiredPosition - playerTransform.position,\n    out hitInfo, (playerTransform.position - desiredPosition).magnitude, 1))\n{\n    newDistance = hitInfo.distance;\n}</code></p>\n<p>\u90a3\u4e48\u600e\u4e48\u5224\u65ad\u76f8\u673a\u6b63\u5728\u5411\u66f4\u8fdc\u7684\u8ddd\u79bb\u79fb\u52a8\u5462\uff1f\u53ef\u4ee5\u7528<code>newDistances</code>\u548c\u5f53\u524d\u7684\u8ddd\u79bb\u8fdb\u884c\u6bd4\u8f83\uff1a</p>\n<p><code>c#\n// \u5411\u66f4\u8fd1\u7684\u8ddd\u79bb\u79fb\u52a8\nif (newDistance &lt; curDistance)\n{\n    curDistance = newDistance;\n}\n// \u5411\u66f4\u8fdc\u7684\u8ddd\u79bb\u79fb\u52a8\nelse if(newDistance &gt; curDistance)\n{\n}</code></p>\n<p>\u90a3\u4e48\u5224\u65ad\u5230\u5411\u66f4\u8fdc\u8ddd\u79bb\u79fb\u52a8\u540e\uff0c\u5c31\u5f88\u76f4\u89c2\u4e86\uff0c\u76f4\u63a5\u52a0\u4e2a\u901f\u5ea6\u6765\u79fb\u52a8\uff1a</p>\n<p>```c#\ncurDistance = Math.Min(curDistance + Time.deltaTime * autoZoomOutSpeed, newDistance);</p>\n<p>```\n\u76f8\u673a\u7684\u5927\u81f4\u884c\u4e3a\u6211\u4eec\u5df2\u7ecf\u5b8c\u6210\u4e86\uff0c\u8fd8\u6709\u4e00\u4e9b\u7ec6\u8282\u9700\u8981\u5904\u7406\u3002</p>\n<h2>\u78b0\u5230\u521a\u4f53\u540e\u6eda\u8f6e\u62c9\u8fd1\uff0c\u5730\u9762\u4e0d\u7f29\u653e</h2>\n<p>\u8fd9\u91cc\u6709\u4e24\u4e2a\u8981\u6c42\uff1a</p>\n<ol>\n<li>\u78b0\u5230\u521a\u4f53\u540e\u53ea\u80fd\u62c9\u8fd1\uff0c\u4e0d\u80fd\u62c9\u8fdc</li>\n<li>\u78b0\u5230\u5730\u9762\u540e\u4e0d\u80fd\u7f29\u653e</li>\n</ol>\n<p>\u9996\u5148\u7528\u53d8\u91cf\u6765\u4fdd\u5b58\u76f8\u673a\u7684\u78b0\u649e\u72b6\u6001\uff1a</p>\n<p><code>c#\nbool isHitGround = false;       // \u8868\u793a\u662f\u5426\u78b0\u649e\u5730\u9762\nbool isHitObject = false;       // \u8868\u793a\u662f\u5426\u78b0\u649e\u521a\u4f53(\u9664\u5f00\u5730\u9762)</code></p>\n<p>\u5728\u5224\u65ad\u6eda\u8f6e\u7f29\u653e\u7684\u65f6\u5019\u52a0\u4e0a\u6761\u4ef6\u5224\u65ad\uff1a</p>\n<p><code>c#\nif (zoom != 0F &amp;&amp; (!isHitGround || (isHitObject &amp;&amp; zoom &gt; 0F)) )\n{\n    // calculate distance\n}</code></p>\n<h2>\u78b0\u5230\u5730\u9762\u7ed5\u81ea\u8eab\u4e0a\u4e0b\u65cb\u8f6c</h2>\n<p>\u8fd9\u4e2a\u529f\u80fd\u5b9e\u73b0\u8d77\u6765\u6709\u70b9\u9ebb\u70e6\uff0c\u9700\u8981\u56e0\u4e3a\u8fd9\u65f6\u5019\u6211\u4eec\u4e4b\u524d\u5047\u8bbe\u76f8\u673a\u4e00\u76f4\u5bf9\u51c6\u4eba\u7269\u4e0d\u6210\u7acb\u4e86\uff0c\u8fd9\u65f6\u5206\u6210\u4e24\u4e2a\u5411\u91cf\uff1a<strong>\u76f8\u673a\u81ea\u8eab\u7684\u671d\u5411(<code>desireForward</code>)</strong>\u548c<strong>\u4eba\u7269\u5230\u76f8\u673a\u7684\u65b9\u5411(<code>cameraToPlayer</code>)</strong>\uff0c\u5206\u522b\u8ba1\u7b97\u8fd9\u4e24\u4e2a\u5411\u91cf\u7684\u503c\uff0c\u524d\u8005\u5c31\u51b3\u5b9a\u76f8\u673a\u7684\u671d\u5411\uff0c\u540e\u8005\u5c31\u51b3\u5b9a\u76f8\u673a\u7684\u4f4d\u7f6e\u3002\u4e3a\u4e86\u65b9\u4fbf\uff0c\u628a<a href=\"unity-Unity\u7b2c\u4e09\u4eba\u79f0\u76f8\u673a\u6784\u5efa(\u4e0a).md\">\u4e0a\u4e00\u96c6</a>\u7684\u65cb\u8f6c\u51fd\u6570\u62c6\u6210X\u65cb\u8f6c(<code>RotateX</code>)\u548cY\u65cb\u8f6c(<code>RotateY</code>)\uff0c\u90a3\u4e48\u5728\u8ba1\u7b97<code>cameraToPlayer</code>\u7684<code>RotateY</code>\u65f6\u52a0\u4e0a\u6761\u4ef6\uff1a</p>\n<p><code>c#\nif ((!isHitGround) || \n    (isHitGround &amp;&amp; transform.forward.y &lt;= cameraToPlayer.y &amp;&amp; yAngle &gt; 0))\n{\n    cameraToPlayer = RotateY(cameraToPlayer, playerTransform.up, \n        transform.right, yAngle);\n}</code></p>\n<p>\u8fd9\u4e2a\u6761\u4ef6\u6709\u4e24\u90e8\u5206\uff1a</p>\n<ul>\n<li>\u6ca1\u6709\u78b0\u5230\u5730\u9762</li>\n<li>\u78b0\u5230\u5730\u9762\uff0c\u4f46\u662f\u51c6\u5907\u79bb\u5f00\u5730\u9762</li>\n</ul>\n<p>\u7136\u540e\u7528<code>cameraToPlayer</code>\u8ba1\u7b97\u76f8\u673a\u7684\u4f4d\u7f6e\uff1a</p>\n<p><code>c#\ntransform.position = playerTransform.position - cameraToPlayer * curDistance;</code></p>\n<p>\u5e76\u4e14\u5728\u6709\u9700\u8981\u7684\u65f6\u5019(\u4e5f\u5c31\u662f\u78b0\u5230\u5730\u9762)\u8ba1\u7b97\u76f8\u673a\u7684\u671d\u5411\uff1a</p>\n<p><code>c#\nif (!isHitGround)\n{\n    transform.LookAt(playerTransform);\n}\nelse\n{\n    desireForward = RotateX(desireForward, playerTransform.up, xAngle);\n    desireForward = RotateY(desireForward, playerTransform.up, transform.right, yAngle);\n    transform.forward = desireForward;\n}</code></p>\n<p>\u8fd9\u6837\u76f8\u673a\u7684\u884c\u4e3a\u6211\u4eec\u90fd\u5b9e\u73b0\u4e86\u3002</p>\n<p>\u5b8c\u6574\u4ee3\u7801\uff1a</p>\n<p>```c#\nusing UnityEngine;\nusing System;\nusing System.Collections;</p>\n<p>// use a forward vector and distance to describe the camera position\npublic class MyThirdPersonCamera : MonoBehaviour {</p>\n<pre><code>private Transform playerTransform;      // reference to player\n\npublic float mouseWheelSensitivity = 3; // control zoom speed\npublic int mouseWheelZoomMin = 2;       // min distance\npublic int mouseWheelZoomMax = 10;      // max distance\n\npublic float rotateSpeed = 5F;          // speed of rotate around player    \npublic float autoZoomOutSpeed = 10F;    // speed of auto zoom out, camera will auto zoom out \n                                        // to pre distance when stop colliding object\nfloat curDistance = 5F;                 // distance to player\nfloat desiredDistance = 5F;             // distance should be      \nbool isHitGround = false;               // hit ground flag\nbool isHitObject = false;               // hit object(except ground) flag\n\n// Use this for initialization\nvoid Awake ()\n{\n    playerTransform = transform.parent;\n}\n\nvoid Start () \n{\n    transform.position = playerTransform.position - playerTransform.forward \n        * curDistance;\n    transform.LookAt(playerTransform);\n\n}\n\n// Update is called once per frame\nvoid Update () \n{\n    Vector3 cameraToPlayer = \n        (playerTransform.position - transform.position).normalized;\n\n    Vector3 desireForward = transform.forward;\n\n    // get new distance of zoom\n    desiredDistance = ZoomIt(curDistance, desiredDistance);\n\n    float xAngle, yAngle;\n    bool isRightDown;\n\n    // get mouse LB, RB status\n    GetMouseButtonStatus(out xAngle, out yAngle, out isRightDown);\n\n    // rotate camera by x-axis movement\n    cameraToPlayer = RotateX(cameraToPlayer, playerTransform.up, xAngle);\n\n    // if RB on, change player orientation\n    if (isRightDown)\n    {\n        playerTransform.forward = Vector3.Normalize(new Vector3(cameraToPlayer.\n            x, 0, cameraToPlayer.z));\n    }\n\n    // rotate camera by y-axis, if camera is not on ground or camera is going to leave ground\n    if ((!isHitGround) \n    || (isHitGround &amp;&amp; transform.forward.y &lt;= cameraToPlayer.y &amp;&amp; yAngle &gt; 0))\n    {\n        cameraToPlayer = RotateY(cameraToPlayer, playerTransform.up, transform.\n            right, yAngle);\n    }\n\n    // detect collision of camera to rigid body, get the distance camera should be\n    float newDistance = DealWithCollision(playerTransform.position, \n        -cameraToPlayer, desiredDistance,ref isHitGround, ref isHitObject);\n\n    // check the distance\n    if (newDistance &lt;= curDistance)\n    {\n        curDistance = newDistance;\n    }\n    else\n    {\n        // now moving to farther position, use a speed to move it\n        curDistance = Math.Min(curDistance + Time.deltaTime * autoZoomOutSpeed, \n            newDistance);\n    }\n\n    // now calculate the position\n    transform.position = playerTransform.position - cameraToPlayer * curDistance;\n\n    // calculate the camera forward, if on ground, camera will rotate on self.Space\n    if (!isHitGround)\n    {\n        transform.LookAt(playerTransform);\n    }\n    else\n    {\n        desireForward = RotateX(desireForward, playerTransform.up, xAngle);\n        desireForward = RotateY(desireForward, playerTransform.up, transform.\n            right, yAngle);\n        transform.forward = desireForward;\n    }\n}\n\n// zoom in and zoom out\nfloat ZoomIt(float curDistance, float desiredDistance)\n{\n    float zoom = Input.GetAxis(\"Mouse ScrollWheel\");\n\n    //  zoom when hit rigid body and zoom in, or not on ground\n    if (zoom != 0F &amp;&amp; (!isHitGround || (isHitObject &amp;&amp; zoom &gt; 0F)) )\n    {\n        float distance = curDistance;\n\n        distance -= zoom * mouseWheelSensitivity;\n        distance = Math.Min(mouseWheelZoomMax, Math.Max(mouseWheelZoomMin, distance));\n\n        return distance;\n    }\n    return desiredDistance;\n}\n\n// rotate oldPosition around a axis starting at axisPosition\nVector3 RotateAroundAxis(Vector3 point, float angle, Vector3 axis, Vector3 axisPosition)\n{\n    Quaternion rotation = Quaternion.AngleAxis(angle, axis);\n    Vector3 offset = point - axisPosition;\n    return axisPosition + (rotation * offset);\n}\n\nvoid GetMouseButtonStatus(out float x, out float y, out bool isRightDown)\n{\n    x = y = 0F;\n    isRightDown = false;\n    if (Input.GetMouseButton(0) ^ Input.GetMouseButton(1))\n    {\n        x = Input.GetAxis(\"Mouse X\") * rotateSpeed;\n        y = -Input.GetAxis(\"Mouse Y\") * rotateSpeed;\n        if (Input.GetMouseButton(1))\n        {\n            isRightDown = true;\n        }\n    }\n}\n\n// rotate vectorP2C(player to camera) around up while mouse x is on, return true if do rotate\nVector3 RotateX(Vector3 vectorP2C, Vector3 up, float angle)\n{\n    Vector3 newVector = vectorP2C;\n    if (angle != 0F)\n    {\n        newVector = RotateAroundAxis(newVector, angle, up, Vector3.zero);\n    }\n    return newVector;\n}\n\n// rotate vectorP2C(player to camera) around right while mouse y is on, return true is do rotate\nVector3 RotateY(Vector3 vectorP2C, Vector3 up, Vector3 right, float angle)\n{\n    Vector3 newVector = vectorP2C;\n    if (angle != 0F)\n    {\n        if ((Vector3.Dot(vectorP2C, up) &gt;= -0.99F || angle &lt; 0)\n            &amp;&amp; (Vector3.Dot(vectorP2C, up) &lt;= 0.99F || angle &gt; 0))\n        {\n            newVector = RotateAroundAxis(newVector, angle, right, Vector3.zero);\n        }\n    }\n    return newVector;\n}\n\n// return distance if no collision, else return distance to rigid body\nfloat DealWithCollision(Vector3 origin, Vector3 direction, float distance, \n    ref bool ishitGround, ref bool ishitObject)\n{\n    // collision detection\n    RaycastHit hitInfo;\n    float newDistance = distance;\n    if (Physics.Raycast(playerTransform.position, direction, out hitInfo, desiredDistance, 1))\n    {\n        if (hitInfo.collider is TerrainCollider)\n        {\n            ishitGround = true;\n            ishitObject = false;\n        }\n        else\n        {\n            ishitObject = true;\n            ishitGround = false;\n        }\n        newDistance = hitInfo.distance;\n    }\n    else\n    {\n        ishitGround = ishitObject = false;\n    }\n\n    return newDistance;\n}\n</code></pre>\n<p>}\n```</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2023-11-30T20:09:36+00:00",
            "authors": [],
            "tags": null
        },
        {
            "id": "https://wiki.disenone.site/game-%E6%B8%B8%E6%88%8FAOI%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%AE%9E%E6%B5%8B/",
            "url": "https://wiki.disenone.site/game-%E6%B8%B8%E6%88%8FAOI%E7%AE%97%E6%B3%95%E8%A7%A3%E6%9E%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%AE%9E%E6%B5%8B/?utm_source=documentation&utm_medium=RSS&utm_campaign=feed-syndication",
            "title": "\u6e38\u620f AOI \u7b97\u6cd5\u89e3\u6790\u548c\u6027\u80fd\u5b9e\u6d4b",
            "content_html": "<p><meta property=\"og:title\" content=\"\u6e38\u620f AOI \u7b97\u6cd5\u89e3\u6790\u548c\u6027\u80fd\u5b9e\u6d4b\" /></p>\n<h3>\u5f15\u5b50</h3>\n<p><code>AOI</code> (Area Of Interest) \u5728\u591a\u4eba\u5728\u7ebf\u6e38\u620f\u4e2d\u662f\u5f88\u57fa\u672c\u7684\u529f\u80fd\uff0c\u73a9\u5bb6\u9700\u8981\u63a5\u6536\u8fdb\u5165\u89c6\u91ce\u8303\u56f4\u5185\u7684\u5176\u4ed6\u73a9\u5bb6\u6216\u8005\u5b9e\u4f53 (Entity) \u7684\u4fe1\u606f\u3002\u8ba1\u7b97\u73a9\u5bb6\u89c6\u91ce\u8303\u56f4\u5185\u5b58\u5728\u54ea\u4e9b\u5b9e\u4f53\uff0c\u6709\u54ea\u4e9b\u5b9e\u4f53\u8fdb\u5165\u6216\u79bb\u5f00\u89c6\u91ce\u7684\u7b97\u6cd5\uff0c\u6211\u4eec\u4e00\u822c\u79f0\u4e4b\u4e3a <code>AOI</code> \u7b97\u6cd5\u3002</p>\n<p>\u672c\u6587\u8ba8\u8bba\u4e5d\u5bab\u683c\u548c\u5341\u5b57\u94fe\u4e24\u79cd <code>AOI</code> \u7b97\u6cd5\uff0c\u5e76\u7ed9\u51fa\u4e24\u79cd\u7b97\u6cd5\u7684\u5b9e\u6d4b\u6027\u80fd\u5206\u6790\uff0c\u8ba9\u4f60\u7528\u8d77\u6765\u5fc3\u4e2d\u6709\u6570\uff0c\u9047\u4e8b\u4e0d\u614c\u3002</p>\n<p>\u6587\u4e2d\u4f1a\u63d0\u5230\u73a9\u5bb6\u548c\u5b9e\u4f53\u4e24\u79cd\u8bcd\uff0c\u5b9e\u4f53\u662f\u6e38\u620f\u4e2d\u7269\u4f53\u7684\u6982\u5ff5\uff0c\u73a9\u5bb6\u662f\u62e5\u6709 AOI \u7684\u5b9e\u4f53\u3002</p>\n<p>\u6587\u4e2d\u4ee3\u7801\u53ef\u5728\u8fd9\u91cc\u627e\u5230\uff1a<a href=\"https://github.com/disenone/AoiTesting\">AoiTesting</a>\u3002</p>\n<h3>\u4e5d\u5bab\u683c</h3>\n<p>\u6240\u8c13\u4e5d\u5bab\u683c\uff0c\u662f\u628a\u573a\u666f\u5185\u6240\u6709\u5b9e\u4f53\u7684\u4f4d\u7f6e\u6309\u7167\u683c\u5b50\u5212\u5206\uff0c\u8b6c\u5982\u5212\u5206\u6210\u8fb9\u957f 200 \u7684\u6b63\u65b9\u5f62\uff0c\u8981\u627e\u51fa\u4e2d\u5fc3\u73a9\u5bb6 AOI \u8303\u56f4\u5185\u7684\u5176\u4ed6\u5b9e\u4f53\uff0c\u5c31\u628a\u8fd9\u4e2a\u8303\u56f4\u5185\u6d89\u53ca\u5230\u7684\u683c\u5b50\u5185\u7684\u73a9\u5bb6\u90fd\u505a\u4e00\u904d\u6bd4\u8f83\u3002</p>\n<p>\u4f8b\u5982\u573a\u666f\u6bcf 100 \u6beb\u79d2\u4f1a Tick \u4e00\u6b21\uff0c\u5728 Tick \u4e2d\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u66f4\u65b0\u73a9\u5bb6\u7684 AOI\uff1a</p>\n<ul>\n<li>\u4ee5\u73a9\u5bb6\u4f4d\u7f6e\u4e3a\u4e2d\u5fc3\uff0cAOI \u534a\u5f84\u8ba1\u7b97\u6d89\u53ca\u5230\u7684\u683c\u5b50\u96c6\u5408</li>\n<li>\u5bf9\u683c\u5b50\u96c6\u5408\u4e2d\u7684\u5b9e\u4f53\u9010\u4e2a\u8ba1\u7b97\u8ddf\u73a9\u5bb6\u7684\u8ddd\u79bb</li>\n<li>\u8ddd\u79bb\u5c0f\u4e8e AOI \u534a\u5f84\u7684\u5b9e\u4f53\u96c6\u5408\u5219\u662f\u73a9\u5bb6\u7684\u65b0\u7684 AOI</li>\n</ul>\n<p>\u4e5d\u5bab\u683c\u7b97\u6cd5\u505a\u8d77\u6765\u5f88\u7b80\u5355\uff0c\u7b97\u6cd5\u7528\u51e0\u53e5\u8bdd\u5c31\u80fd\u63cf\u8ff0\u6e05\u695a\u4e86\uff0c\u5177\u4f53\u7684\u6027\u80fd\u5206\u6790\u6211\u4eec\u7559\u5230\u540e\u9762\uff0c\u5148\u6765\u770b\u770b\u5341\u5b57\u94fe\u8868\u7b97\u6cd5\u3002</p>\n<h3>\u5341\u5b57\u94fe\u8868</h3>\n<p>\u5bf9\u4e8e 3D \u6e38\u620f\uff0c\u6211\u4eec\u4e00\u822c\u4f1a\u7ed9 X \u8f74\u548c Z \u8f74\u5750\u6807\u5206\u522b\u6784\u5efa\u6709\u5e8f\u7684\u94fe\u8868\uff0c\u6bcf\u4e2a\u5b9e\u4f53\u5728\u94fe\u8868\u4e0a\u90fd\u6709\u4e00\u4e2a\u8282\u70b9\uff0c\u5b58\u653e\u7684\u662f\u8be5\u5750\u6807\u8f74\u503c\uff0c\u6309\u7167\u503c\u9012\u589e\u7684\u987a\u5e8f\u6765\u5b58\u653e\u3002\u4f46\u5982\u679c\u53ea\u662f\u5b58\u653e\u5b9e\u4f53\u672c\u8eab\u7684\u5750\u6807\u70b9\uff0c\u8fd9\u4e24\u4e2a\u94fe\u8868\u505a\u67e5\u8be2\u7684\u6548\u7387\u4f9d\u7136\u5f88\u4f4e\u3002</p>\n<p>\u771f\u6b63\u5173\u952e\u7684\u662f\uff0c\u6211\u4eec\u5728\u94fe\u8868\u4e0a\u8fd8\u4f1a\u7ed9\u62e5\u6709 AOI \u7684\u6bcf\u4e2a\u73a9\u5bb6\u589e\u52a0\u5de6\u53f3\u4e24\u4e2a\u54e8\u5175\u8282\u70b9\u3002\u4e24\u4e2a\u54e8\u5175\u7684\u5750\u6807\u503c\u8ddf\u73a9\u5bb6\u672c\u8eab\u5750\u6807\u6b63\u597d\u76f8\u5dee\u4e86 AOI \u534a\u5f84\uff0c\u8b6c\u5982\u73a9\u5bb6 <code>P</code> \u5750\u6807\u4e3a <code>(a, b, c)</code>\uff0cAOI \u534a\u5f84\u4e3a <code>r</code> \uff0c\u90a3\u4e48\u5728 X \u8f74\u4e0a\u4f1a\u6709\u4e24\u4e2a\u54e8\u5175 <code>left_x, right_x</code>\uff0c\u5750\u6807\u503c\u5206\u522b\u4e3a <code>a - r</code> \u548c <code>a + r</code>\u3002\u7531\u4e8e\u6709\u54e8\u5175\u7684\u5b58\u5728\uff0c\u6211\u4eec\u901a\u8fc7\u8ddf\u8e2a\u54e8\u5175\u8ddf\u5176\u4ed6\u5b9e\u4f53\u8282\u70b9\u7684\u79fb\u52a8\u6765\u66f4\u65b0 AOI\u3002\u7ee7\u7eed\u524d\u9762\u7684\u4f8b\u5b50\uff0c\u4e00\u4e2a\u5b9e\u4f53 <code>E</code> \u79fb\u52a8\u5bfc\u81f4\u5728 X \u8f74\u4e0a\u7684\u8282\u70b9\u4ece <code>left_x</code> \u7684\u53f3\u8fb9\u60f3\u5de6\u8de8\u8fc7 <code>left_x</code> \u6765\u5230 <code>left_x</code> \u7684\u5de6\u8fb9\uff0c\u90a3\u4e48\u8bf4\u660e <code>E</code> \u80af\u5b9a\u662f\u79bb\u5f00\u4e86 <code>P</code> \u7684 AOI\uff1b\u540c\u7406\u5982\u679c\u5411\u53f3\u8de8\u8fc7\u4e86 <code>right_x</code> \u4e5f\u662f\u79bb\u5f00\u4e86 AOI\u3002\u76f8\u53cd\uff0c\u5982\u679c\u662f\u5411\u53f3\u8de8\u8fc7 <code>left_x</code>\uff0c\u6216\u8005\u5411\u5de6\u8de8\u8fc7 <code>right_x</code>\uff0c\u8bf4\u660e\u6709\u53ef\u80fd\u4f1a\u8fdb\u5165\u5230 <code>P</code> \u7684 AOI \u4e2d\u3002</p>\n<p>\u53ef\u4ee5\u770b\u5230\uff0c\u5341\u5b57\u94fe\u8868\u7b97\u6cd5\u8981\u6bd4\u4e5d\u5bab\u683c\u590d\u6742\u5f97\u591a\uff0c\u6211\u4eec\u9700\u8981\u7ef4\u62a4\u4e24\u6761\u6709\u5e8f\u7684\u94fe\u8868\uff0c\u5e76\u4e14\u5728\u6bcf\u4e2a\u5b9e\u4f53\u5750\u6807\u66f4\u65b0\u7684\u65f6\u5019\uff0c\u540c\u6b65\u79fb\u52a8\u94fe\u8868\u4e0a\u7684\u8282\u70b9\uff0c\u5e76\u4e14\u5728\u79fb\u52a8\u8de8\u8fc7\u5176\u4ed6\u8282\u70b9\u65f6\u66f4\u65b0 AOI\u3002</p>\n<h3>\u4e5d\u5bab\u683c\u7684\u5b9e\u73b0</h3>\n<p>\u56e0\u4e3a\u6d89\u53ca\u5230\u5b9e\u6d4b\u7684\u6027\u80fd\uff0c\u6240\u4ee5\u6211\u4eec\u5148\u6765\u7a0d\u5fae\u6df1\u5165\u4e00\u70b9\u4e5d\u5bab\u683c\u7b97\u6cd5\u7684\u5b9e\u73b0\u7ec6\u8282\uff1a</p>\n<p>```cpp\nstruct Sensor {\n  // ...\n  Nuid sensor_id;\n  float radius;\n  float radius_square;\n  PlayerPtrList aoi_players[2];\n};</p>\n<p>struct PlayerAoi {\n  // ...  <br>\n  Nuid nuid;\n  SquareId square_id;\n  int square_index;\n  Pos pos;\n  Pos last_pos;\n  Uint32 flags;\n  std::vector<Sensor> sensors;\n};\n```</p>\n<p><code>PlayerAoi</code> \u5b58\u653e\u73a9\u5bb6\u7684\u6570\u636e\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a <code>sensors</code> \u6570\u7ec4\uff0c<code>sensors</code> \u5c31\u662f\u7528\u6765\u8ba1\u7b97\u4e00\u5b9a\u8303\u56f4\u5185\u7684\u5b9e\u4f53\uff0c\u6bcf\u6b21 <code>Tick</code> \u4e4b\u540e\u628a\u8ba1\u7b97\u51fa\u6765\u7684\u5b9e\u4f53\u8ba1\u5212\u653e\u5728 <code>aoi_players</code>\u3002<code>aoi_players</code> \u662f\u5b58\u653e\u4e86\u4e24\u4e2a\u6570\u7ec4\uff0c\u7528\u4e8e\u4e0a\u4e00\u6b21 <code>Tick</code> \u7ed3\u679c\u505a\u6bd4\u8f83\uff0c\u6c42\u51fa\u8fdb\u5165\u548c\u79bb\u5f00\u73a9\u5bb6\u3002 <code>Tick</code> \u7684\u5927\u81f4\u6d41\u7a0b\u662f\u8fd9\u6837\uff1a</p>\n<p>```cpp\nAoiUpdateInfos SquareAoi::Tick() {\n  AoiUpdateInfos update_infos;\n  PlayerPtrList remove_list;</p>\n<p>for (auto&amp; elem : player_map_) {\n    auto&amp; player = *elem.second;\n    // ...\n    // \u5bf9\u6709 sensors \u7684\u73a9\u5bb6\u8ba1\u7b97 Aoi\n    if (!player.sensors.empty()) {\n      auto update_info = <em>UpdatePlayerAoi(cur_aoi_map_idx</em>, &amp;player);\n      if (!update_info.sensor_update_list.empty()) {\n        update_infos.emplace(update_info.nuid, std::move(update_info));\n      }\n    }\n    // ...\n  }</p>\n<p>// ...\n  // \u8bb0\u5f55\u73a9\u5bb6\u4e0a\u6b21\u7684\u4f4d\u7f6e\n  for (auto&amp; elem : player_map_) {\n    auto&amp; player = *elem.second;\n    player.last_pos = player.pos;\n  }\n  cur_aoi_map_idx_ = 1 - cur_aoi_map_idx_;\n  return update_infos;\n}\n```</p>\n<p><code>Tick</code> \u505a\u7684\u4e8b\u60c5\u5f88\u7b80\u5355\uff0c\u904d\u5386\u6709 <code>sensors</code> \u7684\u73a9\u5bb6\uff0c\u9010\u4e2a\u8ba1\u7b97 <code>sensor</code> \u8303\u56f4\u5185\u7684\u5b9e\u4f53\uff0c\u5373\u4e3a AOI\u3002<code>last_pos</code> \u662f\u7528\u6765\u53c2\u4e0e\u5224\u65ad\u5b9e\u4f53\u662f\u5426\u6709\u8fdb\u5165\u6216\u8005\u79bb\u5f00 AOI\uff0c<code>_UpdatePlayerAoi</code> \u7684\u4ee3\u7801\u5982\u4e0b\uff1a</p>\n<p>```cpp\nAoiUpdateInfo SquareAoi::_UpdatePlayerAoi(Uint32 cur_aoi_map_idx, PlayerAoi* pptr) {\n  AoiUpdateInfo aoi_update_info;\n  aoi_update_info.nuid = pptr-&gt;nuid;\n  Uint32 new_aoi_map_idx = 1 - cur_aoi_map_idx;</p>\n<p>for (auto&amp; sensor : pptr-&gt;sensors) {\n    auto&amp; old_aoi = sensor.aoi_players[cur_aoi_map_idx];\n    auto&amp; new_aoi = sensor.aoi_players[new_aoi_map_idx];\n    (this-&gt;<em>calc_aoi_players_func_)(</em>pptr, sensor, &amp;new_aoi);</p>\n<pre><code>SensorUpdateInfo update_info;\n\nauto&amp; enters = update_info.enters;\nauto&amp; leaves = update_info.leaves;\nfloat radius_square = sensor.radius_square;\n\n_CheckLeave(pptr, radius_square, old_aoi, &amp;leaves);\n_CheckEnter(pptr, radius_square, new_aoi, &amp;enters);\n\nif (enters.empty() &amp;&amp; leaves.empty()) {\n  continue;\n}\n\nupdate_info.sensor_id = sensor.sensor_id;\naoi_update_info.sensor_update_list.push_back(std::move(update_info));\n</code></pre>\n<p>}</p>\n<p>return aoi_update_info;\n}\n```</p>\n<p><code>old_aoi</code> \u662f\u4e0a\u4e00\u4e2a <code>Tick</code> \u8ba1\u7b97\u51fa\u6765\u7684 AOI\uff0c<code>new_aoi</code> \u662f\u672c\u6b21 <code>Tick</code> \u9700\u8981\u8ba1\u7b97\u7684 AOI\u3002<code>new_aoi</code> \u901a\u8fc7\u904d\u5386 AOI \u8303\u56f4\u5185\u7684\u6240\u6709\u683c\u5b50\u7684\u5b9e\u4f53\uff0c\u9009\u51fa\u8ddf\u73a9\u5bb6\u8ddd\u79bb\u5c0f\u4e8e AOI \u534a\u5f84\u6765\u83b7\u5f97\u3002\u4e4b\u540e\u7528 <code>_CheckLeave</code> \u548c <code>_CheckEnter</code> \u4e24\u4e2a\u51fd\u6570\uff0c\u8ba1\u7b97\u672c\u6b21 <code>Tick</code> \u79bb\u5f00\u548c\u8fdb\u5165 AOI \u7684\u5b9e\u4f53\uff0c\u8b6c\u5982\u5982\u679c <code>new_aoi</code> \u4e2d\u7684\u5b9e\u4f53 <code>last_pos</code> \u4e0d\u5728 AOI\u8303\u56f4\u5185\uff0c\u8bf4\u660e\u8be5\u5b9e\u4f53\u662f\u5728\u672c\u6b21 <code>Tick</code> \u8fdb\u5165\u5230\u4e86 AOI \u8303\u56f4\u3002\u5177\u4f53\u7684\u4ee3\u7801\u53ef\u4ee5\u770b\u6e90\u6587\u4ef6\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002</p>\n<h3>\u5341\u5b57\u94fe\u8868\u7684\u5b9e\u73b0</h3>\n<p>\u76f8\u6bd4\u8d77\u4e5d\u5bab\u683c\uff0c\u5341\u5b57\u94fe\u8868\u5b9e\u73b0\u8d77\u6765\u66f4\u590d\u6742\uff0c\u5148\u6765\u770b\u57fa\u672c\u7684\u6570\u636e\u7ed3\u6784\uff1a</p>\n<p>```cpp\nstruct CoordNode {\n  // ...\n  Uint8 type;\n  float value;\n  CoordNode <em>prev = nullptr;\n  CoordNode </em>next = nullptr;\n  PlayerAoi <em>pplayer;\n  Sensor </em>psensor;</p>\n<p>};</p>\n<p>KHASH_MAP_INIT_INT64(SensorHashMap, PlayerAoi*);</p>\n<p>struct Sensor {\n  // ...\n  Nuid sensor_id;\n  float radius;\n  float radius_square;\n  PlayerAoi *pplayer;\n  CoordNode left_x;\n  CoordNode right_x;\n  CoordNode left_z;\n  CoordNode right_z;\n  PlayerPtrList aoi_players[2];</p>\n<p>std::shared_ptr<khash_t(SensorHashMap)> aoi_player_candidates;\n};</p>\n<p>struct PlayerAoi {\n  // ...\n  Nuid nuid;\n  Pos pos;\n  Pos last_pos;\n  Uint32 flags;\n  CoordNode node_x;\n  CoordNode node_z;\n  std::vector<Sensor> sensors;\n  std::shared_ptr<boost::unordered_map\\<Nuid, std::vector\\<Nuid>>> detected_by;\n};\n```</p>\n<p><code>Sensor</code> \u548c <code>PlayerAoi</code> \u8ddf\u4e5d\u5bab\u683c\u6709\u90e8\u5206\u76f8\u4f3c\uff0c\u4e0d\u8fc7\u591a\u4e86\u94fe\u8868\u76f8\u5173\u7684\u8282\u70b9\u7ed3\u6784 <code>CoordNode</code>\u3002<code>CoordNode</code> \u5c31\u662f\u94fe\u8868\u4e0a\u7684\u4e00\u4e2a\u8282\u70b9\uff0c\u8bb0\u5f55\u4e86\u672c\u8eab\u8282\u70b9\u7684\u7c7b\u578b\u548c\u6570\u503c\uff0c\u7c7b\u578b\u6709\u4e09\u79cd\uff1a\u73a9\u5bb6\u8282\u70b9\uff0c<code>Sensor</code> \u5de6\u8282\u70b9\uff0c<code>Sensor</code> \u53f3\u8282\u70b9\u3002</p>\n<p>\u5341\u5b57\u94fe\u8868\u7684\u5927\u90e8\u5206\u5de5\u4f5c\u90fd\u662f\u5728\u7ef4\u6301\u94fe\u8868\u7684\u6709\u5e8f\uff1a</p>\n<ul>\n<li>\u73a9\u5bb6\u52a0\u5165\u65f6\u9700\u8981\u628a\u73a9\u5bb6\u8282\u70b9\u79fb\u52a8\u5230\u6709\u5e8f\u7684\u4f4d\u7f6e\u4e0a\uff0c\u5e76\u4e14\u5728\u79fb\u52a8\u73a9\u5bb6\u8282\u70b9\u7684\u540c\u65f6\uff0c\u5904\u7406\u8fdb\u5165\u6216\u8005\u79bb\u5f00\u5176\u4ed6\u73a9\u5bb6 AOI \u4e8b\u4ef6\u3002</li>\n<li>\u73a9\u5bb6\u79fb\u52a8\u5230\u6b63\u786e\u7684\u4f4d\u7f6e\u540e\uff0c<code>Sensor</code> \u5de6\u53f3\u8282\u70b9\u4ece\u73a9\u5bb6\u524d\u540e\u4f4d\u7f6e\u51fa\u53d1\uff0c\u79fb\u52a8\u5230\u6b63\u786e\u7684\u4f4d\u7f6e\uff0c\u5e76\u5904\u7406\u8de8\u8fc7\u5176\u4ed6\u73a9\u5bb6\u8282\u70b9\u65f6\u89e6\u53d1\u7684\u8fdb\u5165\u548c\u79bb\u5f00\u4e8b\u4ef6\u3002</li>\n<li>\u73a9\u5bb6\u79fb\u52a8\u65f6\uff0c\u66f4\u65b0\u73a9\u5bb6\u7684\u5750\u6807\uff0c\u5e76\u79fb\u52a8\u73a9\u5bb6\u8282\u70b9\u548c <code>Sensor</code> \u5de6\u53f3\u8282\u70b9\uff0c\u5904\u7406 AOI \u8fdb\u5165\u79bb\u5f00\u3002</li>\n</ul>\n<p>\u79fb\u52a8\u8282\u70b9\u7684\u4ee3\u7801\u5982\u4e0b\uff0c\u6bcf\u8de8\u8fc7\u4e00\u4e2a\u8282\u70b9\uff0c\u90fd\u4f1a\u8c03\u7528\u4e00\u6b21 <code>MoveCross</code> \u51fd\u6570\uff0c\u7531 <code>MoveCross</code> \u51fd\u6570\u6839\u636e\u79fb\u52a8\u65b9\u5411\uff0c\u79fb\u52a8\u8282\u70b9\u548c\u8de8\u8fc7\u8282\u70b9\u7684\u7c7b\u578b\u6765\u51b3\u5b9a\u662f\u8fdb\u5165\u8fd8\u662f\u79bb\u5f00 AOI\u3002</p>\n<p>```cpp\nvoid ListUpdateNode(CoordNode *<em>list, CoordNode </em>pnode) {\n  float value = pnode-&gt;value;</p>\n<p>if (pnode-&gt;next &amp;&amp; pnode-&gt;next-&gt;value &lt; value) {\n    // move right\n    auto cur_node = pnode-&gt;next;\n    while (1) {\n      MoveCross(MOVE_DIRECTION_RIGHT, pnode, cur_node);\n      if (!cur_node-&gt;next || cur_node-&gt;next-&gt;value &gt;= value) break;\n      cur_node = cur_node-&gt;next;\n    }</p>\n<pre><code>ListRemove(list, pnode);\nListInsertAfter(list, cur_node, pnode);\n</code></pre>\n<p>} else if (pnode-&gt;prev &amp;&amp; pnode-&gt;prev-&gt;value &gt; value) {\n    // move left\n    auto cur_node = pnode-&gt;prev;\n    while (1) {\n      MoveCross(MOVE_DIRECTION_LEFT, pnode, cur_node);\n      if (!cur_node-&gt;prev || cur_node-&gt;prev-&gt;value &lt;= value) break;\n      cur_node = cur_node-&gt;prev;\n    }</p>\n<pre><code>ListRemove(list, pnode);\nListInsertBefore(list, cur_node, pnode);\n</code></pre>\n<p>}\n}\n```</p>\n<p>\u94fe\u8868\u7684\u79fb\u52a8\u5f88\u6162\uff0c\u662f <code>O(n)</code> \u7684\u590d\u6742\u5ea6\uff0c\u7279\u522b\u662f\u5728\u73a9\u5bb6\u65b0\u52a0\u5165\u573a\u666f\u65f6\uff0c\u73a9\u5bb6\u9700\u8981\u4ece\u65e0\u7a77\u8fdc\u7684\u5730\u65b9\uff0c\u9010\u6b65\u79fb\u52a8\u5230\u6b63\u786e\u7684\u4f4d\u7f6e\u4e0a\uff0c\u4e3a\u6b64\u9700\u8981\u5927\u91cf\u904d\u5386\u7684\u8282\u70b9\uff0c\u6d88\u8017\u5f88\u5927\u3002\u4e3a\u4e86\u4f18\u5316\u6027\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u573a\u666f\u4e2d\u56fa\u5b9a\u4f4d\u7f6e\u653e\u7f6e\u706f\u5854\uff0c\u8fd9\u79cd\u706f\u5854\u5904\u7406\u4e0a\u8ddf\u73a9\u5bb6\u5927\u81f4\u76f8\u540c\uff0c\u53ea\u662f\u6bd4\u73a9\u5bb6\u591a\u8bb0\u5f55\u4e86\u4e00\u4efd <code>detected_by</code> \u6570\u636e\uff0c<code>detected_by</code> \u662f\u7528\u6765\u8bb0\u5f55\u8be5\u54e8\u5175\u5b9e\u4f53\u5904\u5728\u54ea\u4e9b <code>Sensor</code> \u8303\u56f4\u5185\u3002\u73a9\u5bb6\u9996\u6b21\u8fdb\u5165\u573a\u666f\u65f6\uff0c\u4e0d\u518d\u4ece\u6700\u8fdc\u5904\u5f00\u59cb\u79fb\u52a8\uff0c\u800c\u662f\u627e\u5230\u4e00\u4e2a\u6700\u8fd1\u7684\u706f\u5854\uff0c\u628a\u8282\u70b9\u63d2\u5165\u5230\u706f\u5854\u65c1\u8fb9\uff0c\u5e76\u901a\u8fc7\u706f\u5854\u8eab\u4e0a\u7684 <code>detected_by</code> \u6570\u636e\uff0c\u5feb\u901f\u8fdb\u5165\u5230\u8ddf\u706f\u5854\u4e00\u81f4\u7684\u5176\u4ed6\u73a9\u5bb6\u7684 AOI \u8303\u56f4\u5185\uff0c\u7136\u540e\u5f00\u59cb\u79fb\u52a8\u5230\u6b63\u786e\u7684\u4f4d\u7f6e\u4e0a\uff0c\u5f53\u7136\u79fb\u52a8\u7684\u65f6\u5019\u4e5f\u8981\u5904\u7406\u8fdb\u5165\u548c\u79bb\u5f00\u3002\u540c\u7406\uff0c\u5bf9\u4e8e <code>Sensor</code>\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5148\u7ee7\u627f\u706f\u5854\u7684\u6570\u636e\uff0c\u7136\u540e\u4ece\u706f\u5854\u7684\u4f4d\u7f6e\u4e0a\u79fb\u52a8\u5230\u6b63\u786e\u4f4d\u7f6e\u4e0a\u3002\u901a\u8fc7\u8fd9\u4e24\u79cd\u4f18\u5316\u80fd\u591f\u63d0\u5347\u4e00\u500d\u4ee5\u4e0a\u7684\u63d2\u5165\u73a9\u5bb6\u6027\u80fd\u3002</p>\n<p><code>Sensor</code> \u8eab\u4e0a\u8fd8\u6709\u4e00\u4e2a\u540d\u53eb <code>aoi_player_candidates</code> \u7684 <code>HashMap</code>\uff08\u8fd9\u91cc\u4e3a\u4e86\u6027\u80fd\uff0c\u4f7f\u7528\u4e86<a href=\"https://github.com/attractivechaos/klib/blob/master/khash.h\">khash</a>\uff09\u3002\u8282\u70b9\u79fb\u52a8\u89e6\u53d1\u7684 AOI \u4e8b\u4ef6\uff0c\u5176\u5b9e\u53ea\u80fd\u68c0\u6d4b\u5230 X-Z \u5750\u6807\u8f74\u4e0a\u8fb9\u957f\u4e3a <code>2r</code> \u7684\u6b63\u65b9\u5f62\u533a\u57df\uff0c\u4e0d\u662f\u6211\u4eec\u4e25\u683c\u610f\u4e49\u4e0a\u7684\u5706\u5f62\u533a\u57df\u7684 AOI\uff0c\u8fd9\u4e2a\u6b63\u65b9\u5f62\u7684\u533a\u57df\u5185\u7684\u5b9e\u4f53\u90fd\u88ab\u8bb0\u5f55\u5728 <code>aoi_player_candidates</code> \u4e0a\uff0c\u5e76\u5728 <code>Tick</code> \u4e2d\u904d\u5386\u8ba1\u7b97\u5706\u5f62\u533a\u57df\u5185\u7684 AOI \u8303\u56f4\uff0c\u6240\u4ee5\u79f0\u4e3a <code>candidates</code>\u3002</p>\n<p>\u6240\u6709\u5341\u5b57\u94fe\u8868\u7684\u64cd\u4f5c\u90fd\u662f\u4e3a\u4e86\u4e00\u76f4\u7ef4\u62a4\u6b63\u65b9\u5f62\u533a\u57df\u5185\u7684\u5b9e\u4f53 <code>candidates</code>\uff0c\u5341\u5b57\u94fe\u8868\u4e2d <code>Tick</code> \u505a\u7684\u64cd\u4f5c\u8ddf\u4e5d\u5bab\u683c\u51e0\u4e4e\u4e00\u81f4\uff0c\u53ea\u662f\u904d\u5386\u8ba1\u7b97 AOI \u7684 <code>candidates</code> \u4e0d\u76f8\u540c\u3002\u4e5d\u5bab\u683c\u7684 <code>candidates</code> \u662f AOI \u5706\u5f62\u533a\u57df\u6240\u8986\u76d6\u5230\u7684\u683c\u5b50\u7684\u5b9e\u4f53\uff0c\u800c\u5341\u5b57\u94fe\u8868\u5219\u662f\u7531 <code>Sensor</code> \u5de6\u53f3\u8282\u70b9\u6240\u754c\u5b9a\u7684\u8fb9\u957f\u4e3a <code>2r</code> \u7684\u6b63\u65b9\u5f62\u533a\u57df\u4e2d\u7684\u5b9e\u4f53\u3002\u5b9a\u6027\u7684\u6765\u8bf4\uff0c\u5341\u5b57\u94fe\u8868\u7684 <code>candidates</code> \u4e00\u822c\u90fd\u8981\u6bd4\u4e5d\u5bab\u683c\u5c11\uff0c\u6240\u4ee5\u5728 <code>Tick</code> \u4e2d\u7684\u904d\u5386\u6b21\u6570\u5c11\uff0c\u6027\u80fd\u66f4\u4f18\uff0c\u53ea\u662f\u5341\u5b57\u94fe\u8868\u8fd8\u6709\u5927\u91cf\u989d\u5916\u7684\u6027\u80fd\u6d88\u8017\u5728\u4e86\u7ef4\u62a4\u94fe\u8868\u4e0a\uff0c\u8fd9\u4e24\u8005\u6574\u4f53\u7684\u6027\u80fd\u5230\u5e95\u5b70\u4f18\u5b70\u52a3\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u5b9e\u6d4b\u770b\u770b\u3002</p>\n<h3>\u6027\u80fd\u5b9e\u6d4b</h3>\n<p>\u6211\u8fd9\u91cc\u5206\u522b\u6d4b\u4e86\u73a9\u5bb6\u52a0\u5165\u573a\u666f\uff08<code>Add Player</code>\uff09\uff0c\u8ba1\u7b97 AOI \u8fdb\u51fa\u4e8b\u4ef6\uff08<code>Tick</code>\uff09\uff0c\u73a9\u5bb6\u66f4\u65b0\u5750\u6807\u4f4d\u7f6e\uff08<code>Update Pos</code>\uff09\u4e09\u79cd\u60c5\u51b5\u7684\u65f6\u95f4\u6d88\u8017\u3002</p>\n<p>\u73a9\u5bb6\u521d\u59cb\u4f4d\u7f6e\u5728\u5730\u56fe\u8303\u56f4\u5185\u968f\u673a\u751f\u6210\uff0c\u7136\u540e\u628a\u73a9\u5bb6\u52a0\u5165\u573a\u666f\u3002<code>player_num</code> \u662f\u73a9\u5bb6\u6570\u91cf\uff0c<code>map_size</code> \u5219\u662f\u5730\u56fe X-Z \u5750\u6807\u8f74\u8303\u56f4\uff0c\u73a9\u5bb6\u7684\u4f4d\u7f6e\u5728\u6b64\u8303\u56f4\u5185\u5747\u5300\u968f\u673a\u751f\u6210\uff0c\u6bcf\u4e2a\u73a9\u5bb6\u90fd\u6709\u4e00\u4e2a\u534a\u5f84 <code>100</code> \u7684 <code>Sensor</code> \u4f5c\u4e3a AOI\uff0c\u8ba1\u7b97\u65f6\u95f4\u7528\u7684\u662f <code>boost::timer::cpu_timer</code>\u3002<code>player_num</code> \u5206\u522b\u9009\u4e86 <code>100, 1000, 10000</code> \u4e09\u79cd\u60c5\u51b5\uff0c\u800c <code>map_size</code> \u5219\u9009\u4e86 <code>[-50, 50], [-100, 100], [-1000, 1000], [-10000, 10000]</code> \u56db\u79cd\u60c5\u51b5\u3002</p>\n<p>\u66f4\u65b0\u73a9\u5bb6\u4f4d\u7f6e\u4f1a\u8ba9\u73a9\u5bb6\u56fa\u5b9a\u968f\u673a\u65b9\u5411\uff0c\u4ee5 <code>6m/s</code> \u7684\u901f\u5ea6\u79fb\u52a8\u3002</p>\n<p>\u672c\u6b21\u6d4b\u8bd5\u73af\u5883\u4e3a\uff1a</p>\n<ul>\n<li>CPU: Intel(R) Core(TM) i5-4590 CPU @ 3.30GHz</li>\n<li>\u7cfb\u7edf: Debian GNU/Linux 10 (buster)</li>\n<li>gcc \u7248\u672c: gcc version 8.3.0 (Debian 8.3.0-6)</li>\n<li>boost \u7248\u672c: boost_1_75_0</li>\n</ul>\n<h4>\u4e5d\u5bab\u683c\u5b9e\u6d4b</h4>\n<p>\u4e5d\u5bab\u683c\u7684\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p>```python\n===Begin Milestore: player_num = 100, map_size = (-50.000000, 50.000000)\nAdd Player (1 times) 0.000081s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.000452s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.000230s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 100, map_size = (-100.000000, 100.000000)\nAdd Player (1 times) 0.000070s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.000338s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.000185s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 100, map_size = (-1000.000000, 1000.000000)\nAdd Player (1 times) 0.000084s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.000103s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.000187s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 100, map_size = (-10000.000000, 10000.000000)\nAdd Player (1 times) 0.000084s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.000080s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.000185s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 1000, map_size = (-50.000000, 50.000000)\nAdd Player (1 times) 0.000673s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.035298s wall, 0.030000s user + 0.000000s system = 0.030000s CPU (85.0%)\nUpdate Pos (10 times) 0.001841s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 1000, map_size = (-100.000000, 100.000000)\nAdd Player (1 times) 0.000664s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.025806s wall, 0.030000s user + 0.000000s system = 0.030000s CPU (116.3%)\nUpdate Pos (10 times) 0.001842s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 1000, map_size = (-1000.000000, 1000.000000)\nAdd Player (1 times) 0.000721s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.001793s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.001849s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (540.8%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 1000, map_size = (-10000.000000, 10000.000000)\nAdd Player (1 times) 0.000885s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.000804s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.001855s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 10000, map_size = (-50.000000, 50.000000)\nAdd Player (1 times) 0.006454s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (154.9%)\nTick (1 times) 3.822028s wall, 3.800000s user + 0.020000s system = 3.820000s CPU (99.9%)\nUpdate Pos (10 times) 0.018402s wall, 0.020000s user + 0.000000s system = 0.020000s CPU (108.7%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 10000, map_size = (-100.000000, 100.000000)\nAdd Player (1 times) 0.006439s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 2.805551s wall, 2.760000s user + 0.040000s system = 2.800000s CPU (99.8%)\nUpdate Pos (10 times) 0.018489s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (54.1%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 10000, map_size = (-1000.000000, 1000.000000)\nAdd Player (1 times) 0.006698s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (149.3%)\nTick (1 times) 0.093759s wall, 0.100000s user + 0.000000s system = 0.100000s CPU (106.7%)\nUpdate Pos (10 times) 0.018350s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (54.5%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 10000, map_size = (-10000.000000, 10000.000000)\nAdd Player (1 times) 0.009046s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (110.6%)\nTick (1 times) 0.012091s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (82.7%)\nUpdate Pos (10 times) 0.019033s wall, 0.020000s user + 0.000000s system = 0.020000s CPU (105.1%)\n===End Milestore\n```</p>\n<p>\u4e5d\u5bab\u683c\u5728\u73a9\u5bb6\u6570\u91cf <code>100</code> \u65f6\uff0c\u4e09\u79cd\u64cd\u4f5c\u8017\u65f6\u90fd\u5f88\u5c0f\uff0c\u6781\u9650\u60c5\u51b5 <code>map_size = [-50, 50]</code>\uff0c\u6240\u6709\u73a9\u5bb6\u4e92\u76f8\u90fd\u5904\u4e8e AOI \u8303\u56f4\u5185\uff0c<code>Tick</code> \u8017\u65f6\u5927\u6982 <code>0.4ms</code>\u3002\u73a9\u5bb6\u52a0\u5165\u573a\u666f\u548c\u66f4\u65b0\u5750\u6807\u90fd\u662f\u7ebf\u6027\u590d\u6742\u5ea6 <code>O(player_num)</code>\uff0c\u6027\u80fd\u8868\u73b0\u90fd\u4e0d\u9519\u3002\u5728 <code>player_num = 10000, map_size = [-50, 50]</code> \u73a9\u5bb6\u4eba\u6570\u8fbe\u5230 1 \u4e07\u7684\u65f6\u5019\uff0c<code>Add Player</code> \u548c <code>Update Pos</code> \u7531\u4e8e\u90fd\u662f\u7ebf\u6027\uff0c\u51e0\u6beb\u79d2\u5185\u5c31\u80fd\u5b8c\u6210\uff0c\u4f46 <code>Tick</code> \u8017\u65f6\u5c31\u53bb\u5230 <code>3.8s</code>\uff0c\u9700\u8981\u6d88\u8017\u5927\u91cf CPU\uff0c\u5c5e\u4e8e\u4e0d\u53ef\u7528\u4e86\u3002\u4eba\u6570 1 \u4e07\uff0c\u5730\u56fe\u5927\u5c0f <code>[-1000, 1000]</code>\uff0c\u60c5\u51b5\u4e0b\uff0c<code>Tick</code> \u65f6\u95f4\u6d88\u8017\u5927\u6982 <code>94ms</code>\uff0c\u5982\u679c\u80fd\u591f\u964d\u4f4e <code>Tick</code> \u9891\u7387\u7684\u8bdd\uff0c\u8b6c\u5982\u4e00\u79d2\u4e24\u6b21\uff0c\u8fd8\u662f\u52c9\u5f3a\u5c5e\u4e8e\u53ef\u7528\u7684\u8303\u56f4\u5185\u3002</p>\n<h4>\u5341\u5b57\u94fe\u8868\u5b9e\u6d4b</h4>\n<p>\u5341\u5b57\u94fe\u8868\u7684\u6d4b\u8bd5\u7ed3\u679c\u5982\u4e0b\uff1a</p>\n<p>```python\n===Begin Milestore: player_num = 100, map_size = (-50.000000, 50.000000)\nAdd Player (1 times) 0.002057s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.000330s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.000232s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 100, map_size = (-100.000000, 100.000000)\nAdd Player (1 times) 0.001201s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.000222s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.000272s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 100, map_size = (-1000.000000, 1000.000000)\nAdd Player (1 times) 0.000288s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.000048s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.000200s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 100, map_size = (-10000.000000, 10000.000000)\nAdd Player (1 times) 0.000194s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nTick (1 times) 0.000041s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.000192s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 1000, map_size = (-50.000000, 50.000000)\nAdd Player (1 times) 0.130766s wall, 0.130000s user + 0.000000s system = 0.130000s CPU (99.4%)\nTick (1 times) 0.028091s wall, 0.020000s user + 0.000000s system = 0.020000s CPU (71.2%)\nUpdate Pos (10 times) 0.005369s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (186.2%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 1000, map_size = (-100.000000, 100.000000)\nAdd Player (1 times) 0.103015s wall, 0.100000s user + 0.000000s system = 0.100000s CPU (97.1%)\nTick (1 times) 0.019545s wall, 0.020000s user + 0.000000s system = 0.020000s CPU (102.3%)\nUpdate Pos (10 times) 0.009208s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (108.6%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 1000, map_size = (-1000.000000, 1000.000000)\nAdd Player (1 times) 0.010150s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (98.5%)\nTick (1 times) 0.000845s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.003023s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 1000, map_size = (-10000.000000, 10000.000000)\nAdd Player (1 times) 0.004950s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (202.0%)\nTick (1 times) 0.000427s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\nUpdate Pos (10 times) 0.002234s wall, 0.000000s user + 0.000000s system = 0.000000s CPU (n/a%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 10000, map_size = (-50.000000, 50.000000)\nAdd Player (1 times) 21.606402s wall, 21.040000s user + 0.570000s system = 21.610000s CPU (100.0%)\nTick (1 times) 3.696885s wall, 3.680000s user + 0.030000s system = 3.710000s CPU (100.4%)\nUpdate Pos (10 times) 0.434396s wall, 0.430000s user + 0.000000s system = 0.430000s CPU (99.0%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 10000, map_size = (-100.000000, 100.000000)\nAdd Player (1 times) 18.499235s wall, 18.470000s user + 0.020000s system = 18.490000s CPU (100.0%)\nTick (1 times) 2.292608s wall, 2.290000s user + 0.000000s system = 2.290000s CPU (99.9%)\nUpdate Pos (10 times) 1.522617s wall, 1.530000s user + 0.000000s system = 1.530000s CPU (100.5%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 10000, map_size = (-1000.000000, 1000.000000)\nAdd Player (1 times) 1.642519s wall, 1.640000s user + 0.000000s system = 1.640000s CPU (99.8%)\nTick (1 times) 0.042767s wall, 0.050000s user + 0.000000s system = 0.050000s CPU (116.9%)\nUpdate Pos (10 times) 0.202949s wall, 0.200000s user + 0.000000s system = 0.200000s CPU (98.5%)\n===End Milestore</p>\n<p>===Begin Milestore: player_num = 10000, map_size = (-10000.000000, 10000.000000)\nAdd Player (1 times) 0.571257s wall, 0.570000s user + 0.000000s system = 0.570000s CPU (99.8%)\nTick (1 times) 0.006325s wall, 0.010000s user + 0.000000s system = 0.010000s CPU (158.1%)\nUpdate Pos (10 times) 0.042568s wall, 0.040000s user + 0.000000s system = 0.040000s CPU (94.0%)\n===End Milestore\n```</p>\n<p>\u5982\u6211\u4eec\u5206\u6790\u4e00\u81f4\uff0c\u5341\u5b57\u94fe\u8868\u5728 <code>Add Player</code> \u548c <code>Update Pos</code> \u4e0a\u8017\u65f6\u66f4\u957f\uff0c\u7279\u522b\u662f <code>Add Player</code>\uff0c\u76f8\u6bd4\u4e5d\u5bab\u683c\u6027\u80fd\u5dee\u4e86\u51e0\u767e\u751a\u81f3\u4e0a\u4e07\u500d\uff08<code>100, [-50, 50]</code> \u5341\u5b57\u94fe\u8017\u65f6 <code>2ms</code>\uff0c\u800c\u4e5d\u5bab\u683c\u53ea\u6709 <code>0.08ms</code>\uff1b<code>10000, [-50, 50]</code> \u5341\u5b57\u94fe <code>21.6s</code>\uff0c\u4e5d\u5bab\u683c\u53ea\u6709 <code>6ms</code>\u3002<code>Update Pos</code> \u7684\u8017\u65f6\u4e5f\u6700\u591a\u4f1a\u6709\u767e\u500d\u7684\u5dee\u8ddd\uff0c<code>10000, [-100, 100]</code> \u5341\u5b57\u94fe\u66f4\u65b0\u73a9\u5bb6\u4f4d\u7f6e\u8017\u65f6 <code>1.5s</code>\uff0c\u800c\u4e5d\u5bab\u683c\u662f <code>18ms</code>\u3002\u53ef\u4ee5\u770b\u51fa\uff0c\u5341\u5b57\u94fe\u5728 <code>Add Player</code> \u548c <code>Update Pos</code> \u8017\u65f6\u7684\u4e0a\u4e0b\u9650\u8303\u56f4\u6bd4\u4e5d\u5bab\u683c\u8981\u5927\uff0c\u53d7\u4eba\u6570\u548c\u5730\u56fe\u5927\u5c0f\u5f71\u54cd\u66f4\u5927\uff0c\u5728\u73a9\u5bb6\u5bc6\u96c6\u7684\u533a\u57df\uff0c\u8fd9\u4e24\u4e2a\u64cd\u4f5c\u7684\u6027\u80fd\u4f1a\u6025\u901f\u4e0b\u964d\uff0c\u76f4\u81f3\u4e0d\u53ef\u7528\u3002</p>\n<p>\u53cd\u89c2\u5341\u5b57\u94fe\u7684 <code>Tick</code> \u64cd\u4f5c\uff0c\u6574\u4f53\u6027\u80fd\u786e\u5b9e\u662f\u6bd4\u4e5d\u5bab\u683c\u597d\uff0c\u6700\u597d\u7684\u60c5\u51b5\u8017\u65f6\u5927\u6982\u53ea\u6709\u4e5d\u5bab\u683c\u7684\u4e00\u534a\u5de6\u53f3\uff08 <code>1000, [-1000, 1000]</code> \u4e0b\u5341\u5b57\u94fe\u8017\u65f6 <code>0.8ms</code>\uff0c\u4e5d\u5bab\u683c <code>1.8ms</code>\uff09\uff0c\u4f46\u662f\u6700\u5dee\u7684\u60c5\u51b5\u5341\u5b57\u94fe\u4f1a\u9000\u5316\u5230\u8ddf\u4e5d\u5bab\u683c\u7684\u6027\u80fd\u63a5\u8fd1\uff08<code>10000, [-10000, 10000]</code> \u4e0b\u5341\u5b57\u94fe\u8017\u65f6 <code>3.7s</code>\uff0c\u4e5d\u5bab\u683c <code>3.8s</code>\u3002\u8fd9\u662f\u56e0\u4e3a\u7531\u4e8e\u573a\u666f\u5c0f\uff0c\u73a9\u5bb6\u4e92\u76f8\u90fd\u5728\u5f7c\u6b64\u7684 AOI \u8303\u56f4\u5185\uff0c\u5341\u5b57\u94fe <code>Tick</code> \u904d\u5386\u7684 <code>candidates</code> \u6570\u91cf, \u5176\u5b9e\u5df2\u7ecf\u8ddf\u4e5d\u5bab\u683c\u5f88\u63a5\u8fd1\u4e86\u3002</p>\n<p>\u5341\u5b57\u94fe\u4f7f\u7528\u8d77\u6765\u8981\u8fbe\u5230\u6bd4\u4e5d\u5bab\u683c\u6027\u80fd\u66f4\u4f18\uff0c\u9700\u8981\u4e00\u4e9b\u66f4\u5f3a\u7684\u5047\u8bbe\uff0c\u8b6c\u5982 <code>player_num = 1000, map_size = [-1000, 1000]</code> \u60c5\u51b5\u4e0b\uff0c<code>Tick</code> \u8017\u65f6\u5341\u5b57\u94fe\u4e3a <code>0.8ms</code> \u4e5d\u5bab\u683c <code>1.8ms</code>\uff0c<code>Update Pos</code> \u5341\u5b57\u94fe\u4e3a <code>0.3ms</code> \u4e5d\u5bab\u683c <code>0.18ms</code>\uff08\u6ce8\u610f\u6d4b\u8bd5 <code>Update Pos</code> \u65f6\u95f4\u4e3a\u6267\u884c\u4e86 10 \u6b21\u7684\u65f6\u95f4\u603b\u548c\uff09\u3002<code>Tick + Update Pos</code> \u603b\u65f6\u95f4\u4e0b\uff0c\u5341\u5b57\u94fe\u5982\u679c\u8981\u6bd4\u4e5d\u5bab\u683c\u66f4\u5c11\uff0c\u90a3 <code>Update Pos</code> \u7684\u6b21\u6570\u4e0d\u80fd\u8d85\u8fc7 <code>Tick</code> \u7684 <code>8</code> \u500d\uff0c\u6216\u8005\u8bf4\u4e24\u4e2a <code>Tick</code> \u4e4b\u95f4\uff0c<code>Update Pos</code> \u7684\u6b21\u6570\u9700\u8981\u5c0f\u4e8e <code>8</code> \u6b21\u3002\u53e6\u5916\u56e0\u4e3a\u5341\u5b57\u94fe <code>Add Player</code> \u8017\u65f6\u5de8\u5927\uff0c\u4e0d\u9002\u7528\u4e8e\u73a9\u5bb6\u77ed\u65f6\u95f4\u9891\u7e41\u51fa\u5165\u573a\u666f\u6216\u8005\u5728\u573a\u666f\u5185\u5927\u8303\u56f4\u4f20\u9001\u7684\u60c5\u51b5\uff0c\u53e6\u5916\u5982\u679c\u77ed\u65f6\u95f4\u5185\u6709\u5927\u91cf\u73a9\u5bb6\u8fdb\u5165\u573a\u666f\uff0c\u4e5f\u5f88\u5bb9\u6613\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d\uff0c\u5927\u91cf\u5360\u7528 CPU\u3002</p>\n<p>\u5bf9\u4e8e\u5341\u5b57\u94fe\u8868\uff0c\u5728\u4e00\u4e2a\u524d\u63d0\u4e4b\u4e0b\u8fd8\u80fd\u505a\u4e00\u4e2a\u4f18\u5316\uff1a\u5e72\u6389 <code>Tick</code>\uff0c\u524d\u63d0\u662f\u6e38\u620f\u80fd\u63a5\u53d7\u6b63\u65b9\u5f62\u7684 AOI\uff0c\u5e76\u4e14\u9700\u8981\u5b9e\u6d4b\u6b63\u65b9\u5f62 AOI \u5e26\u6765\u7684\u5176\u4ed6\u8bf8\u5982\u7f51\u7edc\u7b49\u6d88\u8017\u662f\u80fd\u63a5\u53d7\u7684\u3002\u5176\u5b9e\u524d\u63d0\u662f\u6bd4\u8f83\u82db\u523b\u7684\uff0c\u56e0\u4e3a\u5728\u6e38\u620f\u4e2d AOI \u8ba1\u8d39\u80fd\u5360\u7528\u7684 CPU \u901a\u5e38\u5360\u6bd4\u662f\u4e0d\u5927\u7684\uff0c\u4f46\u628a\u5706\u5f62 AOI \u6539\u6210\u65b9\u5f62 AOI \u5bfc\u81f4 AOI \u8303\u56f4\u9762\u79ef\u589e\u5927\uff0c\u8303\u56f4\u5185\u7684\u73a9\u5bb6\u6570\u91cf\u4e5f\u589e\u591a\uff0c\u5747\u5300\u5206\u5e03\u4e0b\u73a9\u5bb6\u6570\u91cf\u53ef\u80fd\u4f1a\u589e\u591a\u5230\u539f\u6765\u7684 <code>1.27</code> \u500d\u3002\u4f46\u662f\uff0c\u4e00\u65e6\u80fd\u6ee1\u8db3\u524d\u63d0\uff0c\u5341\u5b57\u94fe\u8868\u53ef\u4ee5\u505a\u5230\u4e0d\u9700\u8981 <code>Tick</code> \u6765\u5b9a\u671f\u66f4\u65b0 AOI \u4e8b\u4ef6\uff0c\u56e0\u4e3a\u5b9e\u73b0\u4e0a\u5341\u5b57\u94fe\u8868\u7684 <code>candidates</code> \u5c31\u7ef4\u62a4\u4e86\u4e00\u4efd\u65b9\u5f62\u4e0b AOI\uff0c\u539f\u6765\u53ea\u662f\u4e3a\u4e86\u8ba1\u7b97\u5706\u5f62 AOI\uff0c\u800c\u4e0d\u5f97\u4e0d\u5728 <code>Tick</code> \u4e2d\u518d\u904d\u5386\u8ba1\u7b97\u8ddd\u79bb\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5341\u5b57\u94fe\u662f\u6709\u53ef\u80fd\u80fd\u591f\u8fbe\u5230\u5f88\u597d\u7684\u6027\u80fd\uff0c\u56e0\u4e3a\u5341\u5b57\u94fe\u8868 <code>Update Pos</code> \u7684\u6027\u80fd\u53ef\u4ee5\u8ddf <code>Tick</code> \u76f8\u5dee\u51e0\u500d\u5230\u51e0\u5341\u500d\u3002</p>\n<p>\u6700\u540e\u7ed9\u51fa\u4e24\u8005\u7684\u5bf9\u6bd4\u67f1\u72b6\u56fe\uff1a</p>\n<p><img alt=\"\" src=\"assets/img/2021-11-18-aoi-tesing/add_player.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2021-11-18-aoi-tesing/tick.png\"></p>\n<p><img alt=\"\" src=\"assets/img/2021-11-18-aoi-tesing/update_pos.png\"></p>\n<h3>\u603b\u7ed3</h3>\n<p>\u672c\u6587\u6211\u4eec\u4ecb\u7ecd\u4e86\u4e24\u79cd AOI \u7b97\u6cd5\uff08\u4e5d\u5bab\u683c\u548c\u5341\u5b57\u94fe\uff09\u7684\u539f\u7406\u548c\u57fa\u672c\u5b9e\u73b0\uff0c\u5e76\u901a\u8fc7\u5b9e\u6d4b\u7684\u6570\u636e\u5206\u6790\u4e86\u8fd9\u4e24\u79cd\u7b97\u6cd5\u7684\u6027\u80fd\u4f18\u52a3\uff0c\u5e0c\u671b\u80fd\u591f\u7ed9\u8bfb\u8005\u5e26\u6765\u4e00\u4e9b\u5e2e\u52a9\u6216\u8005\u542f\u53d1\u3002</p>\n<p>\u603b\u7684\u6765\u8bf4\uff0c\u4e5d\u5bab\u683c\u6cd5\u5b9e\u73b0\u7b80\u5355\uff0c\u6027\u80fd\u5747\u8861\u4e0d\u5bb9\u6613\u62c9\u80ef\uff0c\u975e\u5e38\u9002\u5408 AOI \u4e0d\u662f\u6027\u80fd\u74f6\u9888\u7684\u6e38\u620f\u6765\u4f7f\u7528\uff0c\u4e5d\u5bab\u683c\u6cd5\u7684\u6027\u80fd\u6ce2\u52a8\u8303\u56f4\u662f\u5728\u53ef\u9884\u671f\u7684\u8303\u56f4\u5185\uff0c\u6027\u80fd\u4e0b\u9650\u6bd4\u8f83\u9ad8\uff0c\u4e5f\u4e0d\u5bb9\u6613\u5bfc\u81f4\u74f6\u9888\uff0c\u4f46\u53e6\u4e00\u65b9\u9762\u53ef\u4f18\u5316\u7a7a\u95f4\u4e5f\u4e0d\u5927\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u6bd4\u8f83\u56fa\u5b9a\u3002\u53cd\u89c2\u5341\u5b57\u94fe\u6cd5\uff0c\u5b9e\u73b0\u8981\u66f4\u590d\u6742\uff0c\u6027\u80fd\u4e0b\u9650\u6bd4\u4e5d\u5bab\u683c\u6cd5\u4f4e\uff0c\u4f46\u662f\u5982\u679c\u80fd\u591f\u6ee1\u8db3\u4e00\u4e9b\u5047\u8bbe\u548c\u524d\u63d0\uff0c\u5341\u5b57\u94fe\u53ef\u4f18\u5316\u7a7a\u95f4\u66f4\u9ad8\uff0c\u6362\u53e5\u8bdd\u8bf4\u662f\u4e0a\u9650\u662f\u53ef\u4ee5\u66f4\u9ad8\u3002\u8fd9\u4e24\u79cd\u65b9\u6cd5\u5404\u6709\u4f18\u52a3\uff0c\u6e38\u620f\u4e1a\u754c\u5185\u4e5f\u6709\u4e0d\u540c\u7684\u5f15\u64ce\u5206\u522b\u9009\u62e9\u4e86\u4e24\u8005\u4e4b\u4e00\uff0c\u5404\u53d6\u6240\u9700\uff0c\u89c1\u4ec1\u89c1\u667a\u3002</p>\n<p>\u672c\u4eba\u80fd\u529b\u6709\u9650\uff0c\u6587\u4e2d\u5185\u5bb9\u4ec5\u4ee3\u8868\u672c\u4eba\u60f3\u6cd5\uff0c\u5982\u6709\u4e0d\u8db3\u4e0d\u59a5\u4e4b\u5904\u6b22\u8fce\u7559\u8a00\u8ba8\u8bba\u3002</p>\n<p>--8&lt;-- \"footer.md\"</p>",
            "image": null,
            "date_published": "2021-11-18T00:00:00+00:00",
            "authors": [],
            "tags": null
        }
    ]
}